<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SilentStacks v2.0 â€” Literature Request Management</title>

  <!-- Strict but compatible CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data:;
    font-src 'self' data:;
    connect-src 'self' https://eutils.ncbi.nlm.nih.gov https://api.crossref.org https://clinicaltrials.gov;
  ">

  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">

  <!-- Fonts & Core Styles -->
  <link rel="preload" href="assets/fonts/reddit-sans/RedditSans-Regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="stylesheet" href="assets/fonts/reddit-sans/reddit-sans.css">
  <link rel="stylesheet" href="assets/css/style.css">

  <meta name="theme-color" content="#667eea">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%93%9A%3C/text%3E%3C/svg%3E">
</head>

<body>
  <!-- Lightweight loading screen -->
  <div id="loading-screen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:9999">
    <div style="text-align:center">
      <div style="font-size:48px;margin-bottom:8px">ğŸ“š</div>
      <div style="font-size:18px" id="loading-status">Starting SilentStacksâ€¦</div>
    </div>
  </div>

  <!-- App container (your modules populate this) -->
  <div id="app-container" style="display:none;">
    <!-- Keep the same IDs your modules expect -->
    <nav class="main-nav">
      <button class="nav-tab active" data-section="dashboard">ğŸ“Š Dashboard</button>
      <button class="nav-tab" data-section="add-request">â• Add Request</button>
      <button class="nav-tab" data-section="all-requests">ğŸ“‹ All Requests</button>
      <button class="nav-tab" data-section="workflows">ğŸ¥ ILL Workflow</button>
      <button class="nav-tab" data-section="settings">âš™ï¸ Settings</button>
      <span id="system-status" class="system-status"><span class="status-indicator">ğŸŸ¢</span></span>
    </nav>

    <main id="main-content">
      <section id="dashboard" class="section active" role="tabpanel">
        <h2>Dashboard</h2>
        <div class="dashboard-grid">
          <div class="stat-card"><div class="stat-icon">ğŸ“š</div><div class="stat-content"><h3>Total</h3><div id="total-requests">0</div></div></div>
          <div class="stat-card"><div class="stat-icon">â³</div><div class="stat-content"><h3>Pending</h3><div id="pending-requests">0</div></div></div>
          <div class="stat-card"><div class="stat-icon">ğŸš¨</div><div class="stat-content"><h3>Urgent</h3><div id="urgent-requests">0</div></div></div>
          <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-content"><h3>Completed</h3><div id="completed-requests">0</div></div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ”§</div><div class="stat-content"><h3>System Health</h3><div id="health-status">Checkingâ€¦</div></div></div>
        </div>
        <div class="recent-requests-section"><h3>Recent</h3><div id="recent-requests"></div></div>
      </section>

      <section id="add-request" class="section" role="tabpanel">
        <h2>Add New Request</h2>
        <form id="request-form" novalidate>
          <fieldset class="form-section">
            <legend>ğŸ“‹ Identifiers</legend>
            <div class="form-row">
              <div class="form-group">
                <label for="pmid">PMID</label>
                <div class="input-group">
                  <input id="pmid" name="pmid" data-type="pmid" placeholder="e.g., 16979104">
                  <button type="button" id="fetch-pmid" class="btn btn-secondary">Fetch Data</button>
                </div>
              </div>
              <div class="form-group">
                <label for="doi">DOI</label>
                <input id="doi" name="doi" data-type="doi" placeholder="10.xxxx/xxxxx">
              </div>
            </div>
          </fieldset>

          <fieldset class="form-section">
            <legend>ğŸ“– Citation</legend>
            <div class="form-group">
              <label for="title">Title <span class="required">*</span></label>
              <input id="title" name="title" required>
            </div>
            <div class="form-group">
              <label for="authors">Authors</label>
              <input id="authors" name="authors" placeholder="Last, First; Last, First">
            </div>
            <div class="form-row">
              <div class="form-group"><label for="journal">Journal</label><input id="journal" name="journal"></div>
              <div class="form-group"><label for="year">Year</label><input id="year" name="year" type="number" min="1800" max="2099"></div>
              <div class="form-group"><label for="pages">Pages</label><input id="pages" name="pages"></div>
            </div>
          </fieldset>

          <fieldset class="form-section">
            <legend>ğŸ¯ Request</legend>
            <div class="form-row">
              <div class="form-group">
                <label for="priority">Priority</label>
                <select id="priority" name="priority">
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
              <div class="form-group">
                <label for="status">Status</label>
                <select id="status" name="status">
                  <option value="pending">Pending</option>
                  <option value="in-progress">In Progress</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="notes">Notes</label>
              <textarea id="notes" name="notes" rows="3"></textarea>
            </div>
          </fieldset>

          <fieldset id="mesh-section" class="form-section" style="display:none">
            <legend>ğŸ·ï¸ MeSH Headings</legend>
            <div id="mesh-headings"></div>
          </fieldset>

          <fieldset id="trials-section" class="form-section" style="display:none">
            <legend>ğŸ§ª Clinical Trials</legend>
            <div id="clinical-trials"></div>
          </fieldset>

          <div class="form-actions">
            <button type="submit" id="submit-request" class="btn btn-primary">Add Request</button>
            <button type="button" id="clear-form" class="btn btn-secondary">Clear</button>
            <button type="button" id="save-draft" class="btn btn-outline">Save Draft</button>
          </div>
        </form>
        <div id="form-status" class="status-message" role="status" aria-live="polite"></div>
      </section>

      <section id="all-requests" class="section" role="tabpanel">
        <h2>All Requests</h2>
        <div class="controls-bar">
          <div class="search-controls">
            <div class="search-group">
              <input id="search-input" type="search" placeholder="Search requestsâ€¦">
              <button id="clear-search" class="btn btn-ghost">âœ•</button>
            </div>
            <div class="filter-controls">
              <select id="filter-status">
                <option value="all">All Status</option>
                <option value="pending">Pending</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
              <select id="filter-priority">
                <option value="all">All Priority</option>
                <option value="normal">Normal</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
          </div>
          <div class="action-controls">
            <button id="bulk-actions-btn" class="btn btn-secondary" disabled>Bulk Actions</button>
            <button id="export-btn" class="btn btn-outline">ğŸ“¤ Export</button>
            <button id="import-btn" class="btn btn-outline">ğŸ“¥ Import</button>
          </div>
        </div>

        <!-- Bulk Upload (matching your modulesâ€™ IDs) -->
        <div id="bulk-upload-panel" class="bulk-upload-panel" style="display:none">
          <h3>Bulk Upload</h3>
          <div class="upload-tabs">
            <button class="upload-tab active" data-tab="pmid">PMID List</button>
            <button class="upload-tab" data-tab="csv">CSV File</button>
            <button class="upload-tab" data-tab="docline">PMID+DOCLINE</button>
          </div>
          <div class="upload-content">
            <div id="pmid-upload" class="upload-section active">
              <textarea id="bulk-paste-textarea" rows="6" placeholder="Paste PMIDsâ€¦"></textarea>
            </div>
            <div id="csv-upload" class="upload-section">
              <input id="csv-file-input" type="file" accept=".csv" />
              <div id="csv-drop-zone" class="file-drop-zone"><p>Drag & drop CSV here</p></div>
            </div>
            <div id="docline-upload" class="upload-section">
              <textarea id="docline-textarea" rows="6" placeholder="PMID,DOCLINEâ€¦"></textarea>
            </div>
          </div>
          <div class="upload-actions">
            <button id="process-bulk-btn" class="btn btn-primary">Process Upload</button>
            <button id="cancel-bulk-btn" class="btn btn-secondary">Cancel</button>
          </div>
          <div id="bulk-status" class="status-message" role="status" aria-live="polite"></div>
        </div>

        <div class="requests-container">
          <div id="request-list" class="request-list"></div>
          <div class="list-footer">
            <div id="results-count" class="results-count">0 requests</div>
            <div id="pagination" class="pagination"></div>
          </div>
        </div>
      </section>

      <section id="workflows" class="section" role="tabpanel">
        <h2>ILL Workflow</h2>
        <div id="active-workflows" class="workflow-list"></div>
        <div class="workflow-actions">
          <button class="btn btn-primary" onclick="console.log('Start workflow')">ğŸ¥ Start</button>
          <button class="btn btn-secondary" onclick="console.log('Follow-ups')">â° Follow-ups</button>
          <button class="btn btn-outline" onclick="console.log('Export workflow')">ğŸ“Š Export</button>
        </div>
      </section>

      <section id="settings" class="section" role="tabpanel">
        <h2>Settings</h2>
        <div class="setting-group">
          <label>Theme:
            <select id="theme-select">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="high-contrast">High Contrast</option>
              <option value="auto">Auto</option>
            </select>
          </label>
        </div>
        <div class="setting-group">
          <label>API Rate Limit (rps):
            <input id="api-rate-limit" type="number" min="1" max="10" value="2">
          </label>
        </div>
        <div class="setting-group">
          <button id="backup-data" class="btn btn-primary">ğŸ’¾ Create Backup</button>
          <button id="restore-data" class="btn btn-secondary">ğŸ“¥ Restore Backup</button>
          <input id="restore-file" type="file" accept=".json" style="display:none">
        </div>
        <div class="setting-group">
          <button id="show-diagnostics" class="btn btn-outline">ğŸ”§ Diagnostics</button>
          <button id="restart-system" class="btn btn-warning">ğŸ”„ Restart</button>
        </div>
      </section>
    </main>
  </div>

  <div id="notifications" class="notifications-container" role="region" aria-label="Notifications"></div>
  <div id="modal-container" class="modal-container"></div>

  <script>
    // Simple helpers for the loader
    function updateLoadingStatus(msg){var n=document.getElementById('loading-status'); if(n) n.textContent=msg;}
    function hideLoading(){document.getElementById('loading-screen').style.display='none'; document.getElementById('app-container').style.display='block';}

    // Basic tab switching for minimal UI
    document.addEventListener('click', (e) => {
      const tab = e.target.closest('.nav-tab');
      if (!tab) return;
      const target = tab.getAttribute('data-section');
      if (!target) return;
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      tab.classList.add('active');
      const sec = document.getElementById(target);
      if (sec) sec.classList.add('active');
    });
  </script>

  <!-- Core (must come first) -->
  <script>updateLoadingStatus('Loading coreâ€¦');</script>
  <script src="core/state-manager.js"></script>
  <script src="core/event-bus.js"></script>
  <script src="core/diagnostics.js"></script>
  <script src="core/module-loder.js"></script>
  <script src="core/bootstrap.js"></script>

  <!-- Utils & Config (in modules/) -->
  <script>updateLoadingStatus('Loading utilities & configâ€¦');</script>
  <script src="modules/utils/dom-utils.js"></script>
  <script src="modules/utils/validators.js"></script>
  <script src="modules/utils/formatters.js"></script>
  <script src="modules/utils/debug-utils.js"></script>
  <script src="modules/config/app-config.js"></script>
  <script src="modules/config/api-endpoints.js"></script>
  <script src="modules/config/feature-flags.js"></script>

  <!-- Local vendor -->
  <script src="assets/js/fuse.min.js"></script>
  <script src="assets/js/papaparse.min.js"></script>

  <!-- Security & Offline helpers (present in your repo) -->
  <script src="modules/security/input-sanitizer.js"></script>
  <script src="modules/security/security-patches.js"></script>
  <script src="modules/offline/offline-manager.js"></script>

  <!-- Data layer -->
  <script>updateLoadingStatus('Loading data modulesâ€¦');</script>
  <script src="modules/data/request-manager.js"></script>
  <script src="modules/data/api-client.js"></script>
  <script src="modules/data/storage-adapter.js"></script>
  <script src="modules/data/local-api-cache.js"></script>
  <script src="modules/data/data-manager.js"></script>

  <!-- UI layer -->
  <script>updateLoadingStatus('Loading UI & workflowsâ€¦');</script>
  <script src="modules/ui/ui-controller.js"></script>
  <script src="modules/ui/forms.js"></script>
  <script src="modules/ui/search-filter.js"></script>
  <script src="modules/ui/notifications.js"></script>
  <script src="modules/ui/integrated-help.js"></script>

  <!-- Workflows -->
  <script src="modules/workflows/ill-workflow.js"></script>
  <script src="modules/workflows/bulk-upload.js"></script>
  <script src="modules/workflows/export-manager.js"></script>

  <!-- Integrations -->
  <script>updateLoadingStatus('Loading integrationsâ€¦');</script>
  <script src="modules/integrations/pubmed-integration.js"></script>
  <script src="modules/integrations/clinical-trials.js"></script>
  <script src="modules/integrations/mesh-integration.js"></script>

  <!-- Service worker registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }
  </script>

  <!-- Finalize -->
  <script>
    // Bootstrap may set window.SilentStacks.initialized; show app when ready
    const start = Date.now();
    const tick = () => {
      if (window.SilentStacks?.initialized) {
        updateLoadingStatus('Ready!');
        setTimeout(hideLoading, 200);
      } else if (Date.now() - start > 30000) {
        document.getElementById('loading-status').textContent = 'Initialization timed out â€” refresh to retry.';
      } else {
        setTimeout(tick, 100);
      }
    };
    tick();
  </script>
</body>
</html>
