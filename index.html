<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SilentStacks</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <meta name="color-scheme" content="light dark" />
</head>
<body>
  <main id="main" role="main">
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="connection-indicator connection-clean">
      <span id="connection-text">‚óè</span>
    </div>

    <!-- Header & Navigation -->
    <header class="header">
      <div class="container">
        <div class="header-brand">
          <h1>SilentStacks</h1>
          <span class="version">v2.0 - Security & Performance Ready</span>
        </div>
        
        <nav class="nav-tabs" role="tablist">
          <button class="nav-tab active" data-section="dashboard" role="tab" aria-selected="true">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            Dashboard
          </button>
          <button class="nav-tab" data-section="add-request" role="tab" aria-selected="false">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Add Request
          </button>
          <button class="nav-tab" data-section="all-requests" role="tab" aria-selected="false">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            All Requests
          </button>
          <button class="nav-tab" data-section="import-export" role="tab" aria-selected="false">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            Import/Export
          </button>
          <button class="nav-tab" data-section="settings" role="tab" aria-selected="false">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="m12 1 1.68 4.02L18 6.7l-1.02 4.98L21 12l-4.02 1.68L15.3 18l-4.98-1.02L12 21l-1.68-4.02L6 15.3l1.02-4.98L3 12l4.02-1.68L8.7 6l4.98 1.02Z"></path>
            </svg>
            Settings
          </button>
        </nav>
      </div>
    </header>

    <!-- Main Content Container -->
    <div class="main-content">
      <div class="container">
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
          <h2>Dashboard</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Total Requests</h3>
              <p class="stat-number" id="total-requests">0</p>
            </div>
            <div class="stat-card">
              <h3>Pending</h3>
              <p class="stat-number" id="pending-requests">0</p>
            </div>
            <div class="stat-card">
              <h3>Completed</h3>
              <p class="stat-number" id="completed-requests">0</p>
            </div>
            <div class="stat-card">
              <h3>Urgent</h3>
              <p class="stat-number" id="urgent-requests">0</p>
            </div>
          </div>

          <h3>Recent Requests</h3>
          <div id="recent-requests" class="request-list">
            <p class="empty-message">No recent requests</p>
          </div>
        </section>

        <!-- Add Request Section -->
        <section id="add-request" class="section">
          <h2>Add New Request</h2>
          <form id="request-form" class="request-form">
            <div class="form-group">
              <label for="pmid">PMID (PubMed ID)</label>
              <div class="input-with-button enhanced">
                <input type="text" id="pmid" name="pmid" placeholder="e.g., 16979104" data-type="pmid">
                <button type="button" id="lookup-pmid" class="lookup-btn">
                  <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                  Lookup
                </button>
              </div>
              <div id="pmid-status" class="lookup-status"></div>
            </div>

            <div class="form-group">
              <label for="doi">DOI (Digital Object Identifier)</label>
              <div class="input-with-button enhanced">
                <input type="text" id="doi" name="doi" placeholder="e.g., 10.1001/jama.2006.2221" data-type="doi">
                <button type="button" id="lookup-doi" class="lookup-btn">
                  <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                  Lookup
                </button>
              </div>
              <div id="doi-status" class="lookup-status"></div>
            </div>

            <div class="form-group">
              <label for="title">Article Title</label>
              <input type="text" id="title" name="title" placeholder="Enter article title" data-type="text">
            </div>

            <div class="form-group">
              <label for="authors">Authors</label>
              <input type="text" id="authors" name="authors" placeholder="Smith J, Johnson A, Wilson B" data-type="text">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="journal">Journal</label>
                <input type="text" id="journal" name="journal" placeholder="e.g., Nature Medicine" data-type="text">
              </div>
              <div class="form-group">
                <label for="year">Year</label>
                <input type="number" id="year" name="year" placeholder="2024" min="1900" max="2025">
              </div>
            </div>

            <div class="form-group">
              <label for="priority">Priority</label>
              <select id="priority" name="priority" class="priority-select">
                <option value="normal">Normal</option>
                <option value="rush">Rush</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>

            <div class="form-group">
              <label for="notes">Notes</label>
              <textarea id="notes" name="notes" rows="3" placeholder="Additional notes" data-type="text"></textarea>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Add Request</button>
              <button type="button" id="clear-form" class="btn btn-secondary">Clear Form</button>
            </div>
          </form>

          <!-- MeSH Section (populated by API) -->
          <div id="mesh-section" class="mesh-section" style="display: none;">
            <h4>üè∑Ô∏è MeSH Headings</h4>
            <div id="mesh-tags" class="mesh-tags-container"></div>
          </div>

          <!-- Clinical Trials Section (populated by API) -->
          <div id="clinical-trials-section" class="clinical-trials-section" style="display: none;">
            <h4>üß™ Related Clinical Trials</h4>
            <div id="clinical-trials-list" class="clinical-trials-container"></div>
          </div>
        </section>

        <!-- All Requests Section -->
        <section id="all-requests" class="section">
          <h2>All Requests</h2>
          
          <!-- Enhanced Filters -->
          <div class="enhanced-filters">
            <div class="filter-row">
              <input type="text" id="search-input" placeholder="Search requests..." class="search-input">
              <select id="status-filter" class="filter-select">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
              <select id="priority-filter" class="filter-select">
                <option value="">All Priority</option>
                <option value="urgent">Urgent</option>
                <option value="rush">Rush</option>
                <option value="normal">Normal</option>
              </select>
            </div>
            <div class="filter-row">
              <div class="results-info">
                <span id="results-count">0 requests</span>
              </div>
              <div class="bulk-toolbar">
                <label class="bulk-select-all">
                  <input type="checkbox" id="select-all"> Select All
                </label>
                <span class="bulk-count" id="bulk-count">0 selected</span>
                <button class="btn btn-danger btn-small" id="delete-selected" style="display: none;">Delete Selected</button>
              </div>
            </div>
          </div>

          <!-- Request List -->
          <div id="request-list" class="request-list">
            <p class="empty-message">No requests found</p>
          </div>
        </section>

        <!-- Import/Export Section -->
        <section id="import-export" class="section">
          <h2>Import/Export</h2>
          
          <div class="import-export-grid">
            <!-- Import Card -->
            <div class="import-export-card">
              <h3>
                <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14,2 14,8 20,8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                Import Data
              </h3>
              
              <div class="button-group">
                <button class="btn btn-primary" id="import-csv">Import CSV</button>
                <button class="btn btn-primary" id="import-json">Import JSON</button>
                <button class="btn btn-primary" id="bulk-paste">Bulk Paste</button>
              </div>
              
              <input type="file" id="import-file" accept=".csv,.json" class="file-input" style="display: none;">
              
              <div id="import-status" class="import-status"></div>
            </div>

            <!-- Export Card -->
            <div class="import-export-card">
              <h3>
                <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14,2 14,8 20,8"></polyline>
                  <line x1="12" y1="15" x2="8" y2="11"></line>
                  <line x1="12" y1="15" x2="16" y2="11"></line>
                </svg>
                Export Data
              </h3>
              
              <div class="button-group">
                <button class="btn btn-success" id="export-csv">Export CSV</button>
                <button class="btn btn-success" id="export-json">Export JSON</button>
                <button class="btn btn-success" id="export-nlm">Export NLM</button>
              </div>
              
              <div class="export-info">
                <p>Export formats include complete metadata, MeSH terms, and clinical trial information.</p>
              </div>
            </div>
          </div>

          <!-- Bulk Paste Section -->
          <div class="bulk-paste-section" style="display: none;">
            <h3>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
              </svg>
              Bulk Paste Data
            </h3>
            <p class="bulk-paste-help">
              Paste PMIDs (one per line) or CSV data. The system will automatically detect format and fetch metadata.
            </p>
            <textarea id="bulk-paste-data" placeholder="Paste PMIDs or CSV data here...

Examples:
16979104
32658653
33248227

Or CSV format:
PMID,Status,Priority
16979104,pending,normal
32658653,in-progress,rush"></textarea>
            <div class="bulk-paste-options">
              <label class="checkbox-label">
                <input type="checkbox" id="auto-fetch-metadata" checked>
                <span class="checkmark"></span>
                Auto-fetch metadata from PubMed
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="fetch-clinical-trials" checked>
                <span class="checkmark"></span>
                Include clinical trials data
              </label>
            </div>
            <button class="btn btn-primary" id="process-bulk-paste">Process Data</button>
            <button class="btn btn-secondary" id="cancel-bulk-paste">Cancel</button>
          </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
          <h2>Settings</h2>
          
          <div class="settings-form">
            <div class="form-group">
              <label for="theme-select">Theme</label>
              <select id="theme-select">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
                <option value="high-contrast">High Contrast</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="ncbi-api-key">NCBI API Key (Optional)</label>
              <input type="password" id="ncbi-api-key" placeholder="Enter API key for higher rate limits">
              <small class="form-help">Without API key: 3 requests/second. With API key: 10 requests/second.</small>
            </div>
            
            <div class="form-actions">
              <button type="button" id="save-settings" class="btn btn-primary">Save Settings</button>
              <button type="button" id="reset-settings" class="btn btn-secondary">Reset to Defaults</button>
              <button type="button" id="clear-all-data" class="btn btn-danger">Clear All Data</button>
            </div>
          </div>

          <!-- Performance Section -->
          <div class="performance-stats">
            <h4>Performance Statistics</h4>
            <div id="performance-metrics">
              <div class="storage-info">
                <h4>Storage Usage</h4>
                <div id="storage-breakdown"></div>
              </div>
            </div>
          </div>

          <!-- Diagnostics Section -->
          <div class="form-actions">
            <button type="button" id="show-diagnostics" class="btn btn-secondary">Show Diagnostics</button>
            <button type="button" id="export-diagnostics" class="btn btn-secondary">Export Health Report</button>
          </div>
        </section>

      </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="modal-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p id="loading-message">Loading...</p>
      </div>
    </div>
  </main>

  <!-- External Dependencies -->
  <script src="assets/js/fuse.min.js"></script>
  <script src="assets/js/papaparse.min.js"></script>

  <!-- Core Infrastructure (load first) -->
  <script src="core/diagnostics.js"></script>
  <script src="core/event-bus.js"></script>
  <script src="core/state-manager.js"></script>

  <!-- Security Layer (load early) -->
  <script src="modules/security/input-sanitizer.js"></script>
  <script src="modules/security/security-patches.js"></script>

  <!-- Utility Modules -->
  <script src="modules/utils/dom-utils.js"></script>
  <script src="modules/utils/validators.js"></script>
  <script src="modules/utils/formatters.js"></script>
  <script src="modules/utils/debug-utils.js"></script>

  <!-- Core bootstrap (modules are dynamically loaded by bootstrap) -->
  <script src="core/bootstrap.js" defer></script>

  <!-- Register service worker with correct GitHub Pages scope -->
  <script>
  (function () {
    if (!('serviceWorker' in navigator)) return;
    // e.g. /SilentStacksTest
    const base = location.pathname.split('/').slice(0, 2).join('/') || '';
    navigator.serviceWorker.register(`${base}/service-worker.js`, { scope: `${base}/` })
      .catch(console.error);
  })();
  </script>

  <!-- Initialize Application -->
  <script>
    // Global state initialization
    window.SilentStacks = window.SilentStacks || {};
    window.SilentStacks.state = window.SilentStacks.state || {
      selectedRequests: new Set(),
      currentTheme: 'light',
      isOnline: navigator.onLine
    };

    // Connection monitoring
    function updateConnectionStatus() {
      const isOnline = navigator.onLine;
      window.SilentStacks.state.isOnline = isOnline;
      
      const indicator = document.getElementById('connection-status');
      const text = document.getElementById('connection-text');
      
      if (indicator && text) {
        if (isOnline) {
          indicator.className = 'connection-indicator connection-clean';
          text.textContent = '‚óè';
        } else {
          indicator.className = 'connection-indicator offline';
          text.textContent = '‚ö† Offline';
        }
      }
      
      window.SilentStacks?.core?.eventBus?.emit('connection:changed', { isOnline });
    }

    // Set up connection monitoring
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    updateConnectionStatus();

    // Performance monitoring
    function monitorPerformance() {
      if (performance.memory) {
        const usedMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
        
        // Warn at 400MB
        if (usedMB > 400) {
          console.warn(`‚ö†Ô∏è High memory usage: ${usedMB}MB`);
          window.SilentStacks?.core?.eventBus?.emit('performance:warning', { memoryMB: usedMB });
        }
        
        // Critical at 600MB
        if (usedMB > 600) {
          console.error(`üö® Critical memory usage: ${usedMB}MB`);
          window.SilentStacks?.core?.eventBus?.emit('performance:critical', { memoryMB: usedMB });
        }
      }
    }

    // Monitor every 30 seconds
    setInterval(monitorPerformance, 30000);

    console.log('üöÄ SilentStacks v2.0 - Security & Performance Ready');
  </script>
</body>
</html>