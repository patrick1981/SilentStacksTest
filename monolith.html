<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="SilentStacks v2.0 - Interlibrary Loan Request Tracking System" />
<meta name="theme-color" content="#0066cc" />
<title>SilentStacks v2.0 ‚Äì ILL Request Tracking (Monolith)</title>
<style>
/* ===== SILENTSTACKS V2.0 MONOLITH (NO EXTERNAL LIBS) ===== */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary-color:#0066cc;--secondary-color:#6c757d;
  --success-color:#228b22;--danger-color:#dc3545;--warning-color:#ff6600;
  --bg-primary:#fff;--bg-secondary:#f6f7f9;--bg-card:#fff;
  --text-primary:#212529;--text-secondary:#5a6772;--text-muted:#8692a0;
  --border-color:#e3e8ef;--radius:10px;--shadow:0 1px 2px rgba(0,0,0,.05),0 6px 20px rgba(0,0,0,.06)
}
[data-theme="dark"]{
  --bg-primary:#121212;--bg-secondary:#1b1b1b;--bg-card:#1b1b1b;
  --text-primary:#fff;--text-secondary:#cbd5e1;--text-muted:#a3a3a3;
  --border-color:#2a2a2a
}
[data-theme="high-contrast"]{
  --bg-primary:#000;--bg-secondary:#000;--bg-card:#000;
  --text-primary:#fff;--text-secondary:#fff;--border-color:#fff
}
[data-theme="high-contrast"] *:focus{outline:3px solid #ff0!important;outline-offset:2px!important}
html,body{height:100%}
body{font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg-primary);color:var(--text-primary)}
.container{max-width:1200px;margin:0 auto;padding:20px}
.header{margin-bottom:24px;padding:12px 0;border-bottom:2px solid var(--border-color);text-align:center}
.header h1{font-size:2rem;font-weight:800;color:var(--primary-color)}
.header p{color:var(--text-secondary)}
.version-badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:6px;background:var(--primary-color);color:#fff;font-size:.8rem}
#connection-status{position:fixed;top:10px;right:10px;z-index:1000;padding:6px 10px;border-radius:14px;font-size:.75rem;background:var(--bg-card);border:1px solid var(--border-color)}
#connection-status.offline{background:var(--danger-color);color:#fff;font-weight:700}
.nav-tabs{display:flex;gap:8px;overflow:auto;padding:8px 0;border-bottom:2px solid var(--border-color);background:var(--bg-primary)}
.nav-tabs::-webkit-scrollbar{display:none}
.nav-tab{border:0;background:none;padding:10px 14px;border-bottom:3px solid transparent;color:var(--text-secondary);font-weight:600;cursor:pointer;white-space:nowrap;border-radius:8px 8px 0 0}
.nav-tab:hover{color:var(--primary-color)}
.nav-tab.active{border-bottom-color:var(--primary-color);color:var(--primary-color)}
.section{display:none;animation:fade .25s ease}
.section.active{display:block}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:10px 0 20px}
.stat-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
.stat-card h3{font-size:.9rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.04em}
.stat-number{font-size:2rem;font-weight:800;color:var(--primary-color)}
.request-form{max-width:950px;margin:0 auto}
.form-progress{margin:0 0 18px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px}
.progress-steps{display:flex;gap:12px;align-items:center;position:relative}
.progress-bar{position:absolute;left:8%;right:8%;top:20px;height:4px;background:#d0d7e2;border-radius:2px;opacity:.4}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary-color),var(--success-color));border-radius:2px;transition:width .25s ease}
.progress-step{flex:1;display:flex;flex-direction:column;gap:6px;align-items:center}
.step-number{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;font-weight:800;background:#e5e7eb;color:#374151;border:3px solid var(--bg-card)}
.progress-step.active .step-number{background:var(--primary-color);color:#fff}
.progress-step.completed .step-number{background:var(--success-color);color:#fff}
.fieldset{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:20px;margin-bottom:16px}
legend{font-weight:800;padding:0 10px}
.form-group{margin:14px 0}
.form-label{display:block;font-weight:700;margin-bottom:6px}
.form-label.required::after{content:" *";color:var(--danger-color)}
.form-control, .file-input, .search-input, .filter-select, .requests-table select{
  width:100%;padding:12px;border:2px solid var(--border-color);border-radius:10px;background:var(--bg-primary);color:var(--text-primary)
}
.form-control:focus, .search-input:focus, .filter-select:focus{outline:none;box-shadow:0 0 0 3px rgba(0,102,204,.25);border-color:var(--primary-color)}
.input-with-button{display:flex;gap:8px}
.input-with-button input{flex:1}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border:0;border-radius:10px;font-weight:800;cursor:pointer}
.btn-primary{background:var(--primary-color);color:#fff}
.btn-secondary{background:var(--secondary-color);color:#fff}
.btn-danger{background:var(--danger-color);color:#fff}
.btn-success{background:var(--success-color);color:#fff}
.btn-small{padding:6px 10px;font-size:.9rem}
.request-list{display:flex;flex-direction:column;gap:12px}
.request-card{position:relative;background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:14px;box-shadow:var(--shadow)}
.request-card.needs-followup{border-left:5px solid var(--warning-color)}
.request-title{font-weight:800}
.request-meta{color:var(--text-secondary);font-size:.95rem}
.request-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.tag{padding:4px 8px;border-radius:999px;background:var(--bg-secondary);border:1px solid var(--border-color);font-size:.8rem;color:var(--text-secondary)}
.priority-badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;font-size:.75rem;font-weight:800;color:#fff}
.priority-badge.urgent{background:#e74c3c}.priority-badge.rush{background:#f39c12}.priority-badge.normal{background:#4caf50}
.priority-indicator{position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:0 6px 6px 0}
.priority-indicator.urgent{background:#e74c3c}.priority-indicator.rush{background:#f39c12}.priority-indicator.normal{background:#95a5a6}
.enhanced-filters{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:14px;margin:10px 0 16px}
.filter-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.search-input{min-width:260px}
.sort-btn{padding:8px 12px;border:2px solid var(--border-color);background:var(--bg-card);border-radius:10px;cursor:pointer}
.sort-btn.sort-asc::after{content:" ‚Üë";color:var(--primary-color)} .sort-btn.sort-desc::after{content:" ‚Üì";color:var(--primary-color)}
.table-responsive{overflow:auto;margin-top:12px}
.requests-table{width:100%;border-collapse:collapse;background:var(--bg-card)}
.requests-table th, .requests-table td{padding:12px;border-bottom:1px solid var(--border-color)}
.requests-table th{position:sticky;top:0;background:var(--bg-secondary);text-align:left}
.bulk-paste{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;margin-top:16px}
#bulk-paste-data{width:100%;min-height:220px;padding:12px;border:2px solid var(--border-color);border-radius:10px;font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--bg-primary);color:var(--text-primary)}
.progress-container{margin:12px 0;padding:12px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px}
.progress-bar-container{width:100%;height:8px;background:#d0d7e2;border-radius:6px;overflow:hidden}
.progress-bar-fill{height:100%;background:var(--primary-color);transition:width .25s ease}
.sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
.empty-message{text-align:center;color:var(--text-muted);padding:30px 0}
@media (max-width:768px){.container{padding:12px}.nav-tab{padding:8px 12px}}
</style>
</head>
<body>
<a href="#main" class="sr-only">Skip to main content</a>
<div class="container" id="app" aria-live="polite">
  <header class="header">
    <h1>SilentStacks <span class="version-badge">v2.0</span></h1>
    <p>Interlibrary Loan Request Tracking</p>
  </header>

  <div id="connection-status" role="status" aria-live="polite">üåê Online</div>

  <nav class="nav-tabs" role="tablist" aria-label="Primary">
    <button class="nav-tab active" data-section="dashboard" role="tab" aria-selected="true" aria-controls="dashboard">Dashboard</button>
    <button class="nav-tab" data-section="add" role="tab" aria-selected="false" aria-controls="add">Add Request</button>
    <button class="nav-tab" data-section="all" role="tab" aria-selected="false" aria-controls="all">All Requests</button>
    <button class="nav-tab" data-section="io" role="tab" aria-selected="false" aria-controls="io">Import/Export</button>
    <button class="nav-tab" data-section="settings" role="tab" aria-selected="false" aria-controls="settings">Settings</button>
  </nav>

  <main id="main" tabindex="-1">
    <!-- Dashboard -->
    <section id="dashboard" class="section active" role="tabpanel" aria-labelledby="tab-dashboard">
      <h2>Dashboard</h2>
      <div class="stats-grid">
        <div class="stat-card"><h3>Total Requests</h3><div class="stat-number" id="stat-total">0</div></div>
        <div class="stat-card"><h3>Pending</h3><div class="stat-number" id="stat-pending">0</div></div>
        <div class="stat-card"><h3>Fulfilled</h3><div class="stat-number" id="stat-fulfilled">0</div></div>
        <div class="stat-card"><h3>Follow-up Needed</h3><div class="stat-number" id="stat-follow">0</div></div>
      </div>
      <h3>Recent Requests</h3>
      <div id="recent" class="request-list"><p class="empty-message">No recent requests</p></div>
    </section>

    <!-- Add -->
    <section id="add" class="section" role="tabpanel" aria-labelledby="tab-add">
      <h2>Add New Request</h2>
      <form id="form" class="request-form">
        <div class="form-progress" role="progressbar" aria-valuemin="1" aria-valuemax="3" aria-valuenow="1">
          <div class="progress-steps">
            <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%"></div></div>
            <div class="progress-step active" data-step="1"><span class="step-number">1</span><span>Identifiers</span></div>
            <div class="progress-step" data-step="2"><span class="step-number">2</span><span>Details</span></div>
            <div class="progress-step" data-step="3"><span class="step-number">3</span><span>Complete</span></div>
          </div>
        </div>

        <fieldset class="fieldset" id="fs-ident">
          <legend>Identifiers</legend>

          <div class="form-group">
            <label for="pmid" class="form-label">PMID</label>
            <div class="input-with-button">
              <input id="pmid" class="form-control" placeholder="e.g., 23842776" inputmode="numeric" />
              <button type="button" class="btn btn-primary" id="btn-pmid">Lookup</button>
            </div>
            <div id="pmid-status" class="sr-only" role="status" aria-live="polite"></div>
            <small class="form-help">NCBI E-utilities summary lookup</small>
          </div>

          <div class="form-group">
            <label for="doi" class="form-label">DOI</label>
            <div class="input-with-button">
              <input id="doi" class="form-control" placeholder="e.g., 10.1038/nature12373" />
              <button type="button" class="btn btn-primary" id="btn-doi">Lookup</button>
            </div>
            <div id="doi-status" class="sr-only" role="status" aria-live="polite"></div>
            <small class="form-help">Crossref works lookup</small>
          </div>

          <div class="form-group">
            <label for="nct" class="form-label">NCT ID</label>
            <div class="input-with-button">
              <input id="nct" class="form-control" placeholder="e.g., NCT01234567" />
              <button type="button" class="btn btn-primary" id="btn-nct">Lookup</button>
            </div>
            <div id="nct-status" class="sr-only" role="status" aria-live="polite"></div>
            <small class="form-help">ClinicalTrials.gov lookup</small>
          </div>

          <div class="form-group">
            <label for="docline" class="form-label">DOCLINE Request Number</label>
            <input id="docline" class="form-control" placeholder="e.g., 138ABC123" />
          </div>
        </fieldset>

        <fieldset class="fieldset" id="fs-details">
          <legend>Publication Details</legend>

          <div class="form-group">
            <label for="title" class="form-label required">Title</label>
            <input id="title" class="form-control" required />
          </div>

          <div class="form-group">
            <label for="authors" class="form-label">Authors (Last, First; ‚Ä¶)</label>
            <input id="authors" class="form-control" placeholder="Doe, Jane; Smith, John" />
          </div>

          <div class="form-group">
            <label for="journal" class="form-label">Journal</label>
            <input id="journal" class="form-control" />
          </div>

          <div class="form-group">
            <label for="year" class="form-label">Year</label>
            <input id="year" type="number" min="1900" max="2100" class="form-control" />
          </div>

          <div id="mesh-chips" class="request-tags" aria-label="MeSH tags"></div>
        </fieldset>

        <fieldset class="fieldset">
          <legend>Request Details</legend>

          <div class="form-group">
            <label for="patron-name" class="form-label">Patron Name</label>
            <input id="patron-name" class="form-control" />
          </div>

          <div class="form-group">
            <label for="patron-email" class="form-label">Patron Email</label>
            <input id="patron-email" type="email" class="form-control" />
          </div>

          <div class="form-group">
            <label for="priority" class="form-label">Priority</label>
            <select id="priority" class="form-control">
              <option value="normal">Normal</option>
              <option value="rush">Rush</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>

          <div class="form-group">
            <label for="status" class="form-label">Status</label>
            <select id="status" class="form-control">
              <option value="pending">Pending</option>
              <option value="in-progress">In Progress</option>
              <option value="fulfilled">Fulfilled</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tags" class="form-label">Tags (comma separated)</label>
            <input id="tags" class="form-control" placeholder="cardiology, review, systematic" />
          </div>

          <div class="form-group">
            <label for="notes" class="form-label">Notes</label>
            <textarea id="notes" rows="3" class="form-control"></textarea>
          </div>
        </fieldset>

        <div class="form-group" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary" type="submit">Save Request</button>
          <button class="btn btn-secondary" type="button" id="btn-clear">Clear Form</button>
        </div>
      </form>
    </section>

    <!-- All Requests -->
    <section id="all" class="section" role="tabpanel" aria-labelledby="tab-all">
      <h2>All Requests</h2>

      <div class="enhanced-filters">
        <div class="filter-row">
          <input id="search" class="search-input" placeholder="Search requests‚Ä¶" />
          <select id="filter-status" class="filter-select">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="fulfilled">Fulfilled</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <select id="filter-priority" class="filter-select">
            <option value="">All Priorities</option>
            <option value="urgent">Urgent</option>
            <option value="rush">Rush</option>
            <option value="normal">Normal</option>
          </select>
          <button id="btn-followup" class="btn btn-secondary">Follow-up Needed</button>
        </div>

        <div class="filter-row" style="justify-content:space-between;gap:8px">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span>Sort by:</span>
            <button class="sort-btn" data-field="createdAt">Date</button>
            <button class="sort-btn" data-field="priority">Priority</button>
            <button class="sort-btn" data-field="title">Title</button>
            <button class="sort-btn" data-field="status">Status</button>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <span id="results-count">0 requests</span>
            <label><input type="checkbox" id="select-all"> Select All</label>
            <button id="btn-delete" class="btn btn-danger btn-small" style="display:none">Delete Selected</button>
            <button id="toggle-view" class="btn btn-secondary btn-small">Table View</button>
          </div>
        </div>
      </div>

      <!-- Card view -->
      <div id="cards" class="request-list"><p class="empty-message">No requests found</p></div>

      <!-- Table view -->
      <div id="table-wrap" class="table-responsive" style="display:none">
        <table class="requests-table" aria-describedby="results-count">
          <thead>
            <tr>
              <th scope="col">Select</th>
              <th scope="col">Urgency</th>
              <th scope="col">Docline Number</th>
              <th scope="col">PMID</th>
              <th scope="col">Citation</th>
              <th scope="col">Patron Name</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Import/Export -->
    <section id="io" class="section" role="tabpanel" aria-labelledby="tab-io">
      <h2>Import/Export</h2>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>Export</h3>
          <p style="margin:6px 0 10px;color:var(--text-secondary)">Download your data</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="export-csv" class="btn btn-primary">Export CSV</button>
            <button id="export-json" class="btn btn-primary">Export JSON</button>
            <button id="export-nlm" class="btn btn-primary">Export NLM</button>
          </div>
        </div>
        <div class="stat-card">
          <h3>Import</h3>
          <p style="margin:6px 0 10px;color:var(--text-secondary)">Upload CSV or JSON</p>
          <input id="import-file" type="file" class="file-input" accept=".csv,.json" />
          <div id="import-status" role="status" aria-live="polite" style="margin-top:8px;color:var(--text-secondary)"></div>
        </div>
      </div>

      <div class="bulk-paste">
        <h3>Bulk Paste PMIDs</h3>
        <p style="color:var(--text-secondary)">Paste PMIDs separated by commas, spaces, or newlines.</p>
        <textarea id="bulk-paste-data" placeholder="23842776
31234567
28765432"></textarea>
        <div class="progress-container" id="bulk-progress" style="display:none">
          <div class="progress-bar-container"><div class="progress-bar-fill" id="bulk-fill" style="width:0%"></div></div>
          <div id="bulk-text" style="text-align:center;color:var(--text-secondary);font-weight:700;margin-top:6px">0%</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button id="bulk-run" class="btn btn-primary">Import PMIDs</button>
          <button id="bulk-stop" class="btn btn-secondary">Stop</button>
        </div>
        <div id="bulk-status" role="status" aria-live="polite" style="margin-top:8px;color:var(--text-secondary)"></div>
      </div>
    </section>

    <!-- Settings -->
    <section id="settings" class="section" role="tabpanel" aria-labelledby="tab-settings">
      <h2>Settings</h2>
      <form id="settings-form" class="request-form">
        <div class="form-group">
          <label for="followup-days" class="form-label">Follow-up Days</label>
          <input id="followup-days" type="number" min="1" max="30" value="5" class="form-control" />
          <small class="form-help">Mark requests as needing follow-up after this many days.</small>
        </div>

        <div class="form-group">
          <label for="theme" class="form-label">Theme</label>
          <select id="theme" class="form-control">
            <option value="light">Landio Light</option>
            <option value="dark">Landio Dark</option>
            <option value="high-contrast">Landio HC</option>
          </select>
        </div>

        <div class="form-group">
          <label for="api-key" class="form-label">PubMed API Key (optional)</label>
          <input id="api-key" class="form-control" />
        </div>

        <div class="form-group">
          <label for="crossref-email" class="form-label">Crossref Email (optional)</label>
          <input id="crossref-email" type="email" class="form-control" />
          <small class="form-help">Used for Crossref ‚Äòmailto‚Äô polite pool.</small>
        </div>

        <div class="form-group" style="display:flex;gap:8px;align-items:center">
          <label><input type="checkbox" id="enable-sw"> Enable offline caching (requires http/https)</label>
          <small class="form-help">Not available over <code>file://</code>.</small>
        </div>

        <button class="btn btn-primary" type="submit">Save Settings</button>
      </form>
    </section>
  </main>
</div>

<script>
/* ===== DATA & UTILITIES ===== */
const DB_KEY = 'silentstacks:v2';
const Settings = { followupDays:5, theme:'light', apiKey:'', crossrefMailto:'', enableSW:false };
let Requests = []; // array of records
let currentView = 'cards';
let bulkAbort = false;

const el = (q, r=document)=>r.querySelector(q);
const els = (q, r=document)=>Array.from(r.querySelectorAll(q));
const ID = ()=> (crypto?.randomUUID?.() || ('id_'+Math.random().toString(36).slice(2)));

function saveState(){ localStorage.setItem(DB_KEY, JSON.stringify({requests:Requests, settings:Settings})); }
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(DB_KEY)||'{}');
    if (Array.isArray(s.requests)) Requests = s.requests;
    Object.assign(Settings, s.settings||{});
  }catch{}
  setTheme(Settings.theme||'light');
  el('#followup-days').value = Settings.followupDays;
  el('#theme').value = Settings.theme;
  el('#api-key').value = Settings.apiKey||'';
  el('#crossref-email').value = Settings.crossrefMailto||'';
  el('#enable-sw').checked = !!Settings.enableSW;
}

/* Dates / follow-up */
const ageInDays = (iso)=> Math.floor((Date.now()-new Date(iso).getTime())/86400000);
const needsFollowup = (r)=> r.status!=='fulfilled' && ageInDays(r.createdAt)>=Number(Settings.followupDays||5);

/* NLM-ish citation */
function formatCitation(r){
  const authors = r.authors?.length ? r.authors.join(', ') : (r.authorsText||'');
  const year = r.year || (r.date?.slice(0,4)||'');
  const j = r.journal||'';
  const vol = r.volume?` ${r.volume}`:'';
  const issue = r.issue?`(${r.issue})`:'';
  const pages = r.pages?`:${r.pages}`:'';
  const doi = r.doi?` doi:${r.doi}`:'';
  return `${authors}. ${r.title||''}. ${j}.${year}${vol}${issue}${pages}.${doi}`.replace(/\s+/g,' ').trim();
}

/* Simple CSV (no external lib) */
function toCSV(rows){
  const esc = v=> v==null?'':String(v).replace(/"/g,'""');
  const headers = ["id","createdAt","updatedAt","pmid","doi","nct","docline","title","authors","journal","year","patronName","patronEmail","priority","status","tags","notes"];
  const lines = [headers.join(',')];
  for(const r of rows){
    const line = [
      r.id,r.createdAt,r.updatedAt,r.pmid,r.doi,r.nct,r.docline,r.title,
      (r.authors||[]).join('; '),r.journal,r.year,r.patronName,r.patronEmail,
      r.priority,r.status,(r.tags||[]).join(', '),r.notes
    ].map(v=> `"${esc(v)}"`).join(',');
    lines.push(line);
  }
  return lines.join('\r\n');
}
function parseCSV(text){
  // basic CSV parser for simple files: splits by lines, comma, and removes surrounding quotes
  const lines = text.replace(/\r\n/g,'\n').split('\n').filter(l=>l.trim().length);
  if (!lines.length) return [];
  const header = lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
  return lines.slice(1).map(l=>{
    const cells = l.match(/("([^"]|"")*"|[^,]*)/g).filter(x=>x!==',');
    const clean = cells.map(c=>c.replace(/^"|"$/g,'').replace(/""/g,'"'));
    const obj = {};
    header.forEach((h,i)=> obj[h] = clean[i]);
    // normalize some fields
    obj.tags = obj.tags ? obj.tags.split(',').map(s=>s.trim()).filter(Boolean) : [];
    obj.authors = obj.authors ? obj.authors.split(';').map(s=>s.trim()).filter(Boolean) : [];
    obj.year = obj.year ? Number(obj.year) : undefined;
    return obj;
  });
}

/* Download helper */
function download(filename, text){
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}

/* MeSH chips */
function renderMesh(list){
  const c = el('#mesh-chips');
  c.innerHTML = (list||[]).slice(0,8).map(m=>`<span class="tag">${m}</span>`).join('');
}

/* Extract NCT from text */
const nctFromText = (txt='')=> (txt.match(/NCT\d{8}/i)?.[0]?.toUpperCase()||'');

/* ===== API CLIENTS ===== */
const baseHeaders = ()=> ({ headers:{ 'Accept':'application/json' } });

async function fetchPubMedByPMID(pmid){
  const api = Settings.apiKey ? `&api_key=${encodeURIComponent(Settings.apiKey)}` : '';
  const url = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&retmode=json&id=${encodeURIComponent(pmid)}${api}`;
  const r = await fetch(url, baseHeaders());
  if(!r.ok) throw new Error('PubMed request failed');
  const j = await r.json();
  const s = j.result?.[pmid];
  if(!s) throw new Error('PMID not found');
  const authors = (s.authors||[]).map(a=>a.name).filter(Boolean);
  const doi = (s.articleids||[]).find(x=>x.idtype==='doi')?.value || '';
  const mesh = (s.meshheadinglist||[]).map(x=>x);
  return {
    title:s.title, journal:s.fulljournalname||s.source, year:Number(s.pubdate?.slice(0,4))||undefined,
    volume:s.volume, issue:s.issue, pages:s.pages, doi, pmid, authors, mesh, nct:nctFromText(s.title||'')
  };
}

async function fetchCrossrefByDOI(doi){
  const mail = Settings.crossrefMailto ? `?mailto=${encodeURIComponent(Settings.crossrefMailto)}` : '';
  const url = `https://api.crossref.org/works/${encodeURIComponent(doi)}${mail}`;
  const r = await fetch(url, baseHeaders()); if(!r.ok) throw new Error('Crossref request failed');
  const m = (await r.json()).message;
  const authors = (m.author||[]).map(a=>[a.family,a.given].filter(Boolean).join(', ')).filter(Boolean);
  const issued = m.issued?.['date-parts']?.[0]?.[0];
  return {
    title:m.title?.[0]||'', journal:m['container-title']?.[0]||'',
    year:issued, volume:m.volume, issue:m.issue, pages:m.page, doi:m.DOI, authors
  };
}

async function fetchTrialByNCT(nct){
  const url = `https://clinicaltrials.gov/api/v2/studies/${encodeURIComponent(nct)}`;
  const r = await fetch(url, baseHeaders()); if(!r.ok) throw new Error('NCT request failed');
  const j = await r.json();
  const brief = j?.studies?.[0]?.protocolSection?.identificationModule?.briefTitle || '';
  return { nct, trialTitle:brief };
}

/* ===== UI / RENDER ===== */
function setTheme(theme){
  document.documentElement.setAttribute('data-theme', theme==='light' ? '' : theme);
  if(theme==='light') document.documentElement.removeAttribute('data-theme');
}

function updateConnection(){
  const s = el('#connection-status');
  if(navigator.onLine){ s.textContent = 'üåê Online'; s.classList.remove('offline'); }
  else { s.textContent = '‚ö†Ô∏è Offline'; s.classList.add('offline'); }
}

function renderStats(){
  el('#stat-total').textContent = String(Requests.length);
  el('#stat-pending').textContent = String(Requests.filter(r=>r.status==='pending').length);
  el('#stat-fulfilled').textContent = String(Requests.filter(r=>r.status==='fulfilled').length);
  el('#stat-follow').textContent = String(Requests.filter(needsFollowup).length);
  const recent = Requests.slice().sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);
  const c = el('#recent');
  if(!recent.length){ c.innerHTML = '<p class="empty-message">No recent requests</p>'; return; }
  c.innerHTML = recent.map(r=>`
    <article class="request-card${needsFollowup(r)?' needs-followup':''}" data-id="${r.id}">
      <span class="priority-indicator ${r.priority||'normal'}"></span>
      <div class="request-title">${r.title||'(untitled)'} <span class="priority-badge ${r.priority||'normal'}">${r.priority||'normal'}</span></div>
      <div class="request-meta">${r.journal||''} ${r.year||''} ‚Ä¢ PMID ${r.pmid||'‚Äî'} ‚Ä¢ DOI ${r.doi||'‚Äî'}</div>
      <div class="request-tags">${(r.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
    </article>
  `).join('');
}

function renderAll(){
  const cards = el('#cards'); const tbody = el('#tbody');
  const has = Requests.length>0;
  el('#results-count').textContent = `${Requests.length} request${Requests.length===1?'':'s'}`;
  if(!has){
    cards.innerHTML = '<p class="empty-message">No requests found</p>';
    tbody.innerHTML = ''; return;
  }
  if(currentView==='cards'){
    cards.innerHTML = Requests.map(r=>`
      <article class="request-card${needsFollowup(r)?' needs-followup':''}">
        <span class="priority-indicator ${r.priority||'normal'}"></span>
        <div class="request-title">${r.title||'(untitled)'} <span class="priority-badge ${r.priority||'normal'}">${r.priority||'normal'}</span></div>
        <div class="request-meta">${r.journal||''} ${r.year||''} ‚Ä¢ PMID ${r.pmid||'‚Äî'} ‚Ä¢ DOI ${r.doi||'‚Äî'}</div>
        <div class="request-tags">${(r.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
        <div style="margin-top:8px">
          <label class="sr-only" for="status-${r.id}">Status</label>
          <select id="status-${r.id}" data-id="${r.id}" class="form-control" aria-label="Status for ${r.title||'request'}">
            <option value="pending"${r.status==='pending'?' selected':''}>Pending</option>
            <option value="in-progress"${r.status==='in-progress'?' selected':''}>In Progress</option>
            <option value="fulfilled"${r.status==='fulfilled'?' selected':''}>Fulfilled</option>
            <option value="cancelled"${r.status==='cancelled'?' selected':''}>Cancelled</option>
          </select>
        </div>
      </article>
    `).join('');
    els('select[id^="status-"]').forEach(s=>{
      s.addEventListener('change', e=>{
        const id = e.target.dataset.id;
        const rec = Requests.find(x=>x.id===id);
        if(rec){ rec.status = e.target.value; rec.updatedAt = new Date().toISOString(); saveState(); renderStats(); }
      });
    });
  } else {
    tbody.innerHTML = Requests.map(r=>`
      <tr>
        <td><input type="checkbox" class="row-check" data-id="${r.id}"></td>
        <td>${r.priority||'normal'}</td>
        <td>${r.docline||'‚Äî'}</td>
        <td>${r.pmid||'‚Äî'}</td>
        <td>${formatCitation(r)}</td>
        <td>${r.patronName||'‚Äî'}</td>
        <td>
          <select data-id="${r.id}" class="requests-table">
            <option value="pending"${r.status==='pending'?' selected':''}>Pending</option>
            <option value="in-progress"${r.status==='in-progress'?' selected':''}>In Progress</option>
            <option value="fulfilled"${r.status==='fulfilled'?' selected':''}>Fulfilled</option>
            <option value="cancelled"${r.status==='cancelled'?' selected':''}>Cancelled</option>
          </select>
        </td>
      </tr>
    `).join('');
    els('select.requests-table').forEach(s=>{
      s.addEventListener('change', e=>{
        const id = e.target.dataset.id;
        const rec = Requests.find(x=>x.id===id);
        if(rec){ rec.status = e.target.value; rec.updatedAt = new Date().toISOString(); saveState(); renderStats(); }
      });
    });
  }
}

/* ===== EVENT WIRING ===== */
function initTabs(){
  const tabs = els('.nav-tab');
  function activate(i){
    tabs.forEach(t=>{ t.classList.remove('active'); t.setAttribute('aria-selected','false'); t.tabIndex=-1; });
    const t = tabs[i]; t.classList.add('active'); t.setAttribute('aria-selected','true'); t.tabIndex=0;
    const target = t.dataset.section;
    els('.section').forEach(s=>s.classList.remove('active'));
    el('#'+target).classList.add('active');
  }
  tabs.forEach((t,i)=>{
    t.id = `tab-${t.dataset.section}`;
    t.addEventListener('click', ()=>activate(i));
    t.addEventListener('keydown', e=>{
      const keys = ['ArrowLeft','ArrowRight','Home','End'];
      if(!keys.includes(e.key)) return;
      e.preventDefault();
      let idx = i;
      if(e.key==='ArrowLeft') idx=(i-1+tabs.length)%tabs.length;
      if(e.key==='ArrowRight') idx=(i+1)%tabs.length;
      if(e.key==='Home') idx=0;
      if(e.key==='End') idx=tabs.length-1;
      tabs[idx].focus(); activate(idx);
    });
  });
}

function collectForm(){
  const authorsText = el('#authors').value.trim();
  const authors = authorsText ? authorsText.split(';').map(s=>s.trim()).filter(Boolean) : [];
  const tags = el('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  return {
    id: ID(),
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    pmid: el('#pmid').value.trim(),
    doi: el('#doi').value.trim(),
    nct: el('#nct').value.trim(),
    docline: el('#docline').value.trim(),
    title: el('#title').value.trim(),
    authors, authorsText,
    journal: el('#journal').value.trim(),
    year: Number(el('#year').value)||undefined,
    patronName: el('#patron-name').value.trim(),
    patronEmail: el('#patron-email').value.trim(),
    priority: el('#priority').value,
    status: el('#status').value,
    tags,
    notes: el('#notes').value.trim()
  };
}
function clearForm(){ els('#form input, #form textarea, #form select').forEach(n=>{ if(n.id!=='priority'&&n.id!=='status') n.value=''; }); renderMesh([]); }

/* Lookups */
function setLive(id, msg){ const n = el(id); n.classList.remove('sr-only'); n.textContent = msg; }
async function doPMID(){
  const pmid = el('#pmid').value.trim();
  if(!pmid){ setLive('#pmid-status','Enter a PMID'); return; }
  setLive('#pmid-status','Looking up PubMed‚Ä¶');
  try{
    const rec = await fetchPubMedByPMID(pmid);
    fillFields(rec);
    setLive('#pmid-status','PubMed metadata loaded');
    if(rec.doi){ fetchCrossrefByDOI(rec.doi).then(r=>fillFields(r)).catch(()=>{}); }
    if(rec.nct){ fetchTrialByNCT(rec.nct).then(r=>fillFields(r)).catch(()=>{}); }
  }catch(e){ setLive('#pmid-status', String(e.message||e)); }
}
async function doDOI(){
  const doi = el('#doi').value.trim();
  if(!doi){ setLive('#doi-status','Enter a DOI'); return; }
  setLive('#doi-status','Looking up Crossref‚Ä¶');
  try{ const rec = await fetchCrossrefByDOI(doi); fillFields(rec); setLive('#doi-status','Crossref metadata loaded'); }
  catch(e){ setLive('#doi-status', String(e.message||e)); }
}
async function doNCT(){
  const nct = el('#nct').value.trim();
  if(!nct){ setLive('#nct-status','Enter an NCT ID'); return; }
  setLive('#nct-status','Looking up ClinicalTrials‚Ä¶');
  try{ const rec = await fetchTrialByNCT(nct); fillFields(rec); setLive('#nct-status','Trial info loaded'); }
  catch(e){ setLive('#nct-status', String(e.message||e)); }
}
function setIfEmpty(sel, v){ const n = el(sel); if(n && !n.value && v!=null) n.value = v; }
function fillFields(src){
  setIfEmpty('#title', src.title);
  setIfEmpty('#journal', src.journal);
  setIfEmpty('#year', src.year);
  if(src.doi) setIfEmpty('#doi', src.doi);
  if(src.pmid) setIfEmpty('#pmid', src.pmid);
  if(src.nct) setIfEmpty('#nct', src.nct);
  if(src.authors?.length) setIfEmpty('#authors', src.authors.join('; '));
  if(src.mesh?.length) renderMesh(src.mesh);
}

/* Filters / search / sorting */
function applyFilters(base){
  const status = el('#filter-status').value;
  const pr = el('#filter-priority').value;
  let arr = base.slice();
  if(status) arr = arr.filter(r=>r.status===status);
  if(pr) arr = arr.filter(r=>r.priority===pr);
  return arr;
}
function applySearch(base){
  const q = el('#search').value.trim().toLowerCase();
  if(!q) return base.slice();
  return base.filter(r=>{
    return [
      r.title,r.journal,r.pmid,r.doi,r.nct,r.docline,r.patronName,r.patronEmail,
      (r.tags||[]).join(' '),(r.authors||[]).join(' ')
    ].some(v=> String(v||'').toLowerCase().includes(q));
  });
}
function applySort(base, field, asc=true){
  const arr = base.slice();
  arr.sort((a,b)=>{
    const A = (a[field]??'').toString().toLowerCase();
    const B = (b[field]??'').toString().toLowerCase();
    if(A<B) return asc?-1:1;
    if(A>B) return asc?1:-1;
    return 0;
  });
  return arr;
}

/* View toggling & selection */
function switchView(){
  if(currentView==='cards'){ currentView='table'; el('#cards').style.display='none'; el('#table-wrap').style.display='block'; el('#toggle-view').textContent='Card View'; }
  else { currentView='cards'; el('#cards').style.display='block'; el('#table-wrap').style.display='none'; el('#toggle-view').textContent='Table View'; }
  renderAll();
}
function toggleSelectAll(checked){
  els('.row-check').forEach(cb=> cb.checked = checked);
  el('#btn-delete').style.display = checked ? 'inline-flex' : 'none';
}
function deleteSelected(){
  const ids = els('.row-check:checked').map(cb=>cb.dataset.id);
  if(!ids.length) return;
  Requests = Requests.filter(r=> !ids.includes(r.id));
  saveState(); renderStats(); renderAll();
}

/* Import / Export */
function importJSON(text){
  try{
    const data = JSON.parse(text);
    if(Array.isArray(data)){
      for(const r of data){
        r.id = r.id || ID();
        r.createdAt = r.createdAt || new Date().toISOString();
        r.updatedAt = new Date().toISOString();
      }
      Requests = Requests.concat(data);
    } else if (Array.isArray(data.requests)) {
      Requests = Requests.concat(data.requests);
    } else if (Array.isArray(data.pmids)) {
      // accept {pmids:[...]}
      return data.pmids;
    }
    saveState(); renderStats(); renderAll();
    return null;
  }catch(e){ throw new Error('Invalid JSON'); }
}
function handleImportFile(file){
  const out = el('#import-status');
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const text = reader.result;
      if(file.name.endsWith('.json')){
        const pmids = importJSON(text);
        out.textContent = pmids ? `Parsed ${pmids.length} PMIDs from JSON.` : 'JSON imported.';
      } else {
        const rows = parseCSV(text);
        if(!rows.length){ out.textContent='No rows found.'; return; }
        for(const o of rows){
          o.id = o.id || ID();
          o.createdAt = o.createdAt || new Date().toISOString();
          o.updatedAt = new Date().toISOString();
        }
        Requests = Requests.concat(rows);
        saveState(); renderStats(); renderAll();
        out.textContent = `Imported ${rows.length} rows from CSV.`;
      }
    }catch(e){ out.textContent = String(e.message||e); }
  };
  reader.readAsText(file);
}

/* Bulk paste PMIDs */
function parsePMIDs(text){
  return Array.from(new Set((text.match(/\b\d{6,8}\b/g)||[])));
}
async function bulkImportPMIDs(pmids){
  bulkAbort = false;
  const fill = el('#bulk-fill'); const text = el('#bulk-text'); const bar = el('#bulk-progress');
  const status = el('#bulk-status');
  if(!pmids.length){ status.textContent='No PMIDs found.'; return; }
  bar.style.display='block';
  let ok=0, fail=0;
  for(let i=0;i<pmids.length;i++){
    if(bulkAbort){ status.textContent=`Stopped. Imported ${ok}, failed ${fail}.`; break; }
    try{
      const rec = await fetchPubMedByPMID(pmids[i]);
      const r = {
        id: ID(), createdAt:new Date().toISOString(), updatedAt:new Date().toISOString(),
        pmid: rec.pmid || pmids[i], doi: rec.doi||'', nct: rec.nct||'',
        docline:'', title: rec.title||'', authors:rec.authors||[], authorsText:(rec.authors||[]).join('; '),
        journal: rec.journal||'', year: rec.year, patronName:'', patronEmail:'',
        priority:'normal', status:'pending', tags:[], notes:''
      };
      Requests.push(r);
      ok++;
      if(rec.mesh?.length) renderMesh(rec.mesh);
      // light rate-limit
      await new Promise(res=>setTimeout(res, 250));
    }catch{ fail++; }
    const pct = Math.round(((i+1)/pmids.length)*100);
    fill.style.width = pct+'%'; text.textContent = `${pct}%`;
  }
  saveState(); renderStats(); renderAll();
  status.textContent = `Done. Imported ${ok}, failed ${fail}.`;
}

/* Service worker (blob, only on http/https if enabled) */
async function maybeRegisterSW(){
  if(!Settings.enableSW) return;
  if(!('serviceWorker' in navigator)) return;
  if(!(location.protocol==='http:' || location.protocol==='https:')) return;
  const code = `
    const CACHE = 'silentstacks-v2';
    self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));});
    self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim());});
    self.addEventListener('fetch', e=>{
      e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(resp=>{
        const copy = resp.clone();
        caches.open(CACHE).then(c=>c.put(e.request, copy)).catch(()=>{});
        return resp;
      }).catch(()=>r)));
    });
  `;
  const url = URL.createObjectURL(new Blob([code], {type:'text/javascript'}));
  try{ await navigator.serviceWorker.register(url); }catch{ /* silent */ }
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}

/* ===== INIT ===== */
function init(){
  loadState();
  initTabs();
  updateConnection();
  renderStats();
  renderAll();

  // online/offline
  window.addEventListener('online', updateConnection);
  window.addEventListener('offline', updateConnection);

  // lookups
  el('#btn-pmid').addEventListener('click', doPMID);
  el('#btn-doi').addEventListener('click', doDOI);
  el('#btn-nct').addEventListener('click', doNCT);

  // form
  el('#form').addEventListener('submit', e=>{
    e.preventDefault();
    const rec = collectForm();
    if(!rec.title){ alert('Title is required'); return; }
    Requests.unshift(rec);
    saveState(); clearForm(); renderStats(); renderAll();
    // progress UI
    el('#progress-fill').style.width='100%';
    setTimeout(()=>{ el('#progress-fill').style.width='0%'; }, 400);
  });
  el('#btn-clear').addEventListener('click', clearForm);

  // All: toggle view
  el('#toggle-view').addEventListener('click', switchView);
  // All: select all / delete
  el('#select-all').addEventListener('change', e=> toggleSelectAll(e.target.checked));
  el('#btn-delete').addEventListener('click', deleteSelected);

  // Filters/search/sort
  el('#search').addEventListener('input', ()=>{
    const base = applySearch(JSON.parse(localStorage.getItem(DB_KEY)||'{}').requests || Requests);
    Requests = applyFilters(base);
    renderAll();
  });
  el('#filter-status').addEventListener('change', ()=>{
    const base = applySearch(JSON.parse(localStorage.getItem(DB_KEY)||'{}').requests || Requests);
    Requests = applyFilters(base);
    renderAll();
  });
  el('#filter-priority').addEventListener('change', ()=>{
    const base = applySearch(JSON.parse(localStorage.getItem(DB_KEY)||'{}').requests || Requests);
    Requests = applyFilters(base);
    renderAll();
  });
  els('.sort-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const field = b.dataset.field;
      const asc = !b.classList.contains('sort-asc');
      els('.sort-btn').forEach(o=>o.classList.remove('sort-asc','sort-desc'));
      b.classList.add(asc?'sort-asc':'sort-desc');
      Requests = applySort(Requests, field, asc);
      renderAll();
    });
  });
  el('#btn-followup').addEventListener('click', ()=>{
    Requests = (JSON.parse(localStorage.getItem(DB_KEY)||'{}').requests||[]).filter(needsFollowup);
    renderAll();
  });

  // Import/Export
  el('#import-file').addEventListener('change', e=>{
    const f = e.target.files?.[0]; if(!f) return;
    handleImportFile(f);
    e.target.value = '';
  });
  el('#export-json').addEventListener('click', ()=> download('silentstacks.json', JSON.stringify({requests:Requests}, null, 2)));
  el('#export-csv').addEventListener('click', ()=> download('silentstacks.csv', toCSV(Requests)));
  el('#export-nlm').addEventListener('click', ()=> download('silentstacks_nlm.txt', Requests.map(formatCitation).join('\n')));

  // Bulk paste
  el('#bulk-run').addEventListener('click', ()=>{
    const text = el('#bulk-paste-data').value;
    const ids = parsePMIDs(text);
    el('#bulk-status').textContent = `Found ${ids.length} PMIDs. Starting‚Ä¶`;
    el('#bulk-progress').style.display='block';
    bulkImportPMIDs(ids);
  });
  el('#bulk-stop').addEventListener('click', ()=>{ bulkAbort = true; });

  // Settings
  el('#settings-form').addEventListener('submit', e=>{
    e.preventDefault();
    Settings.followupDays = Number(el('#followup-days').value)||5;
    Settings.theme = el('#theme').value;
    Settings.apiKey = el('#api-key').value.trim();
    Settings.crossrefMailto = el('#crossref-email').value.trim();
    Settings.enableSW = el('#enable-sw').checked;
    saveState();
    setTheme(Settings.theme);
    maybeRegisterSW();
    alert('Settings saved.');
  });

  // defer SW registration until load
  setTimeout(maybeRegisterSW, 300);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
