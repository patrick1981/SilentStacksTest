<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SilentStacks v2.0 ‚Äì Monolithic</title>
  <meta name="description" content="SilentStacks v2.0 ‚Äì Offline-first document request manager (single-file build)" />
  <style>
    /* =========================
       SilentStacks v2.0 ‚Äì Monolithic CSS
       WCAG-friendly, responsive, no external deps
       ========================= */

    :root {
      --bg: #0b0c0f;
      --panel: #13151a;
      --text: #e6e8ef;
      --muted: #a8b0c0;
      --brand: #7aa2ff;
      --brand-2: #67e8f9;
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --border: #2a2e37;
      --focus: #f59e0b;
      --chip: #1f2330;
      --chip-text: #cbd5e1;
    }

    [data-theme="light"] {
      --bg: #f8fafc;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --brand: #2563eb;
      --brand-2: #0891b2;
      --ok: #16a34a;
      --warn: #b45309;
      --bad: #b91c1c;
      --border: #e2e8f0;
      --focus: #ea580c;
      --chip: #f1f5f9;
      --chip-text: #0f172a;
    }

    [data-theme="hc"] { /* High contrast */
      --bg: #000;
      --panel: #000;
      --text: #fff;
      --muted: #fff;
      --brand: #ff0;
      --brand-2: #0ff;
      --ok: #0f0;
      --warn: #ff0;
      --bad: #f00;
      --border: #fff;
      --focus: #ff0;
      --chip: #000;
      --chip-text: #fff;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1000px 600px at 80% -10%, rgba(103,232,249,.12), transparent 40%),
                  radial-gradient(1200px 800px at -10% -10%, rgba(122,162,255,.12), transparent 40%),
                  var(--bg);
    }

    a { color: var(--brand); }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }

    header {
      display: grid; gap: 8px; padding: 16px; margin-bottom: 8px;
      background: linear-gradient(180deg, rgba(122,162,255,.12), transparent 18%), var(--panel);
      border: 1px solid var(--border); border-radius: 16px;
    }
    header .topbar {
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between;
    }
    .title {
      font-size: 18px; font-weight: 700; letter-spacing: .3px;
    }
    .subtitle { color: var(--muted); font-size: 12px; }

    .btn, button { cursor: pointer; border: 1px solid var(--border); background: var(--chip); color: var(--text);
      padding: 8px 12px; border-radius: 10px; font-weight: 600; box-shadow: none; }
    .btn:focus-visible, button:focus-visible, .input:focus-visible, select:focus-visible, textarea:focus-visible {
      outline: 3px solid var(--focus); outline-offset: 2px; border-color: var(--focus);
    }
    .btn.primary { background: linear-gradient(180deg, var(--brand), var(--brand-2)); color: #001018; border: none; }
    .btn.warn { background: var(--warn); color: #000; border: none; }
    .btn.bad  { background: var(--bad); color: #fff; border: none; }
    .btn.ok   { background: var(--ok);  color: #001b09; border: none; }

    .grid { display: grid; gap: 12px; }
    .grid.cols-2 { grid-template-columns: 1fr 1fr; }
    .grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
    @media (max-width: 900px){ .grid.cols-3, .grid.cols-4 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px){ .grid.cols-2, .grid.cols-3, .grid.cols-4 { grid-template-columns: 1fr; } }

    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .card h2 { margin: 0 0 12px; font-size: 16px; }
    .muted { color: var(--muted); font-size: 12px; }

    .tabs { display: flex; gap: 8px; flex-wrap: wrap; }
    .tab { padding: 8px 10px; border: 1px solid var(--border); border-radius: 999px; background: var(--chip); color: var(--chip-text); }
    .tab[aria-selected="true"] { background: linear-gradient(180deg, var(--brand), var(--brand-2)); color: #001018; border: none; }

    label { display: block; font-weight: 600; margin-bottom: 6px; }
    .input, select, textarea { width: 100%; background: var(--chip); color: var(--text); border: 1px solid var(--border);
      border-radius: 10px; padding: 8px 10px; }
    textarea { min-height: 84px; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 640px){ .row { grid-template-columns: 1fr; } }

    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { background: var(--chip); color: var(--chip-text); border: 1px solid var(--border); padding: 4px 8px; border-radius: 999px; font-size: 12px; }

    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    thead th { text-align: left; font-size: 12px; color: var(--muted); font-weight: 700; padding: 6px 8px; }
    tbody td { background: var(--panel); border: 1px solid var(--border); padding: 8px; }
    tbody tr td:first-child { border-radius: 12px 0 0 12px; }
    tbody tr td:last-child  { border-radius: 0 12px 12px 0; }
    .status { font-weight: 700; }
    .status.open { color: var(--warn); }
    .status.closed { color: var(--ok); }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; background: var(--chip); border: 1px solid var(--border); border-radius: 6px; padding: 2px 6px; }
    .help p { margin: .4rem 0; }

    .banner { border: 1px solid var(--border); border-radius: 12px; padding: 10px; background: rgba(122,162,255,.12); }

    .sr-only { position: absolute !important; height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap; }

    .toolbar { display:flex; gap:8px; flex-wrap: wrap; align-items: center; }
    .toolbar .spacer { flex: 1; }
    .small { font-size: 12px; }

    .badge { display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); background: var(--chip); font-size:12px; }
    .badge.warn { background: rgba(245, 158, 11, 0.2); }
    .badge.ok { background: rgba(34,197,94,0.2); }
    .badge.bad { background: rgba(239,68,68,0.2); }

    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size: 12px; white-space: pre-wrap; background: #0003; padding: 8px; border-radius: 8px; max-height: 220px; overflow: auto; border: 1px dashed var(--border); }

    .visually-group { display:grid; gap:8px; padding:8px; border:1px solid var(--border); border-radius:12px; background: linear-gradient(180deg, rgba(103,232,249,.05), transparent); }

    /* === Table quick-filter tabs === */
    .table-tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
    .table-tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);color:var(--chip-text);cursor:pointer}
    .table-tab[aria-selected="true"]{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#001018;border:none}
  </style>
</head>
<body>
  <div class="container" id="app-root">
    <header aria-label="SilentStacks top bar">
      <div class="topbar">
        <div>
          <div class="title" aria-live="polite">SilentStacks v2.0 <span class="subtitle">‚Äì Monolithic build</span></div>
          <div class="subtitle">Offline-capable request manager with smart lookups, bulk ops, and AAA-minded UI.</div>
        </div>
        <div class="toolbar" role="toolbar" aria-label="Global controls">
          <button class="btn" id="theme-light" title="Light theme" aria-pressed="false">‚òÄÔ∏è Light</button>
          <button class="btn" id="theme-dark"  title="Dark theme" aria-pressed="true">üåô Dark</button>
          <button class="btn" id="theme-hc"    title="High contrast theme" aria-pressed="false">‚ö° High Contrast</button>
          <span class="spacer"></span>
          <button class="btn" id="export-json" title="Export data as JSON">‚¨áÔ∏è Export JSON</button>
          <button class="btn" id="export-csv"  title="Export data as CSV">‚¨áÔ∏è Export CSV</button>
          <button class="btn" id="export-nlm"  title="Export data as NLM citations">‚¨áÔ∏è Export NLM</button>
        </div>
      </div>

      <nav class="tabs" role="tablist" aria-label="Primary">
        <button class="tab" role="tab" aria-selected="true" aria-controls="tab-requests" id="tabbtn-requests">üìë Requests</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tab-bulk" id="tabbtn-bulk">üì• Bulk Ops</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tab-help" id="tabbtn-help">üÜò Help</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tab-diagnostics" id="tabbtn-diagnostics">üß™ Diagnostics</button>
      </nav>
    </header>

    <main>
      <!-- Requests tab -->
      <section id="tab-requests" role="tabpanel" aria-labelledby="tabbtn-requests">
        <div class="grid cols-2">
          <div class="card" id="form-card">
            <h2>New / Edit Request</h2>
            <div class="muted">Enter a PMID, DOI, or NCT ID then run <strong>Lookup</strong>. Fields are validated and sanitized.</div>

            <div class="grid cols-3" style="margin-top:8px">
              <div>
                <label for="pmid">PMID</label>
                <input id="pmid" class="input" inputmode="numeric" autocomplete="off" />
              </div>
              <div>
                <label for="doi">DOI</label>
                <input id="doi" class="input" autocomplete="off" />
              </div>
              <div>
                <label for="nct">NCT ID</label>
                <input id="nct" class="input" autocomplete="off" />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="title">Title</label>
                <input id="title" class="input" />
              </div>
              <div>
                <label for="authors">Authors (Last FM; ...)</label>
                <input id="authors" class="input" />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="journal">Journal</label>
                <input id="journal" class="input" />
              </div>
              <div class="grid cols-3">
                <div>
                  <label for="year">Year</label>
                  <input id="year" class="input" inputmode="numeric" />
                </div>
                <div>
                  <label for="volume">Volume</label>
                  <input id="volume" class="input" />
                </div>
                <div>
                  <label for="issue">Issue</label>
                  <input id="issue" class="input" />
                </div>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="pages">Pages</label>
                <input id="pages" class="input" />
              </div>
              <div>
                <label for="status">Status</label>
                <select id="status" class="input">
                  <option value="open">Open</option>
                  <option value="in-progress">In Progress</option>
                  <option value="closed">Closed</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="priority">Priority</label>
                <select id="priority" class="input">
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
              <div>
                <label for="ill">ILL Status</label>
                <select id="ill" class="input">
                  <option value="">‚Äî</option>
                  <option value="requested">Requested</option>
                  <option value="received">Received</option>
                  <option value="delivered">Delivered</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="docline">DOCLINE ID</label>
                <input id="docline" class="input" />
              </div>
              <div>
                <label for="doclineDate">DOCLINE Date</label>
                <input id="doclineDate" type="date" class="input" />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="tags">Custom Tags (comma separated)</label>
                <input id="tags" class="input" />
              </div>
              <div>
                <label for="mesh">MeSH (auto)</label>
                <input id="mesh" class="input" aria-readonly="true" readonly />
              </div>
            </div>

            <div>
              <label for="notes">Notes</label>
              <textarea id="notes" class="input"></textarea>
              <label style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <input type="checkbox" id="hasAttachments" /> Has attachments
              </label>
            </div>

            <div class="toolbar" style="margin-top:10px">
              <button class="btn" id="btn-lookup" title="Lookup metadata" onclick="window.SilentStacks_lookup && window.SilentStacks_lookup()">üîç Lookup</button>
              <button class="btn ok" id="btn-save" title="Save request">üíæ Save</button>
              <button class="btn warn" id="btn-reset" title="Reset form">‚Ü∫ Reset</button>
              <span class="spacer"></span>
              <span id="form-status" class="muted" aria-live="polite"></span>
            </div>
          </div>

          <div class="card">
            <h2>Search & Filters</h2>
            <div class="visually-group" role="group" aria-label="Search and filters">
              <label for="search">Instant search (title, authors, journal, notes)</label>
              <input id="search" class="input" placeholder="Type to filter‚Ä¶ (e.g., ibuprofen authors:Smith tag:SR)" />

              <div class="grid cols-3">
                <div>
                  <label for="f-status">Status</label>
                  <select id="f-status" class="input">
                    <option value="">Any</option>
                    <option value="open">Open</option>
                    <option value="in-progress">In Progress</option>
                    <option value="closed">Closed</option>
                  </select>
                </div>
                <div>
                  <label for="f-priority">Priority</label>
                  <select id="f-priority" class="input">
                    <option value="">Any</option>
                    <option value="normal">Normal</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                  </select>
                </div>
                <div>
                  <label for="f-tag">Tag / MeSH contains</label>
                  <input id="f-tag" class="input" />
                </div>
              </div>

              <div class="toolbar">
                <button class="btn" id="btn-save-view">‚≠ê Save View</button>
                <select class="input" id="saved-views" aria-label="Saved views"><option value="">Saved views‚Ä¶</option></select>
                <button class="btn bad" id="btn-del-view" title="Delete selected view">üóëÔ∏è Delete View</button>
                <span class="spacer"></span>
                <span id="count" class="muted" aria-live="polite"></span>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h2>Requests</h2>

              <!-- Table quick-filter tabs -->
              <nav class="table-tabs" role="tablist" aria-label="Table quick filters">
                <button class="table-tab" role="tab" data-filter="all" aria-selected="true">All</button>
                <button class="table-tab" role="tab" data-filter="open">Open</button>
                <button class="table-tab" role="tab" data-filter="in-progress">In Progress</button>
                <button class="table-tab" role="tab" data-filter="closed">Closed</button>
                <button class="table-tab" role="tab" data-filter="followup">Follow-up</button>
                <button class="table-tab" role="tab" data-filter="urgent">Urgent</button>
              </nav>

              <div class="muted">Click a row to edit. Use <span class="kbd">Ctrl/‚åò+F</span> in your browser for quick find, or the search above.</div>
              <div style="overflow:auto;margin-top:8px">
                <table aria-label="Requests table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Title</th>
                      <th>Authors</th>
                      <th>Journal / Year</th>
                      <th>Status</th>
                      <th>Priority</th>
                      <th>Tags</th>
                      <th>Flags</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="rows"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Bulk Ops tab -->
      <section id="tab-bulk" role="tabpanel" aria-labelledby="tabbtn-bulk" hidden>
        <div class="grid cols-2">
          <div class="card">
            <h2>Import</h2>
            <div class="muted">Import JSON or CSV. CSV headers should match field names; unknown columns are ignored.</div>
            <div class="visually-group">
              <input type="file" id="file-input" aria-label="Choose JSON or CSV file" />
              <div class="toolbar">
                <button class="btn" id="btn-import">üì• Import</button>
                <span class="spacer"></span>
                <span id="import-status" class="muted" aria-live="polite"></span>
              </div>
            </div>
            <div class="visually-group">
              <label for="bulk-text">Paste JSON or CSV</label>
              <textarea id="bulk-text" class="input" placeholder='[{"title":"..."}] or CSV‚Ä¶'></textarea>
              <button class="btn" id="btn-import-text">üì• Import Pasted</button>
            </div>
          </div>

          <div class="card">
            <h2>Bulk Lookup & Validate</h2>
            <div class="muted">Process all items that have a PMID/DOI/NCT but missing metadata. Rate-limited, with retries.</div>
            <div class="toolbar">
              <button class="btn" id="btn-bulk-lookup">üîé Run Bulk Lookup</button>
              <button class="btn warn" id="btn-stop-lookup">‚èπÔ∏è Stop</button>
              <span class="spacer"></span>
              <span id="bulk-progress" class="muted" aria-live="polite"></span>
            </div>
            <div class="log" id="bulk-log" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <!-- Help tab -->
      <section id="tab-help" role="tabpanel" aria-labelledby="tabbtn-help" hidden>
        <div class="card help">
          <h2>Integrated Help</h2>
          <div class="banner" role="note">
            <p><strong>Service Worker note:</strong> A true SW must be a separate file on the same origin. This single-file build includes full offline <em>data</em> persistence and request queueing, but static asset caching requires adding a <span class="kbd">service-worker.js</span> when you deploy to GitHub Pages.</p>
          </div>
          <p><strong>Quick start:</strong></p>
          <ol>
            <li>Enter a PMID/DOI/NCT and click <strong>Lookup</strong>. Adjust fields.</li>
            <li>Click <strong>Save</strong>. Your data persists to the browser.</li>
            <li>Use <strong>Export</strong> to backup/share as JSON/CSV/NLM.</li>
            <li>Use <strong>Bulk Ops</strong> to import lists and enrich metadata.</li>
          </ol>
          <p><strong>Search tips:</strong> Use <span class="kbd">tag:sr</span>, <span class="kbd">status:open</span>, <span class="kbd">authors:smith</span>, or regular text.</p>
        </div>
      </section>

      <!-- Diagnostics tab -->
      <section id="tab-diagnostics" role="tabpanel" aria-labelledby="tabbtn-diagnostics" hidden>
        <div class="grid cols-2">
          <div class="card">
            <h2>System Status</h2>
            <div class="chips" id="module-chips" aria-live="polite"></div>
            <div class="row" style="margin-top:8px">
              <div class="visually-group">
                <div><strong>Records:</strong> <span id="stat-records">0</span></div>
                <div><strong>Storage (approx):</strong> <span id="stat-storage">0 KB</span></div>
                <div><strong>Queued network ops:</strong> <span id="stat-queue">0</span></div>
              </div>
              <div class="visually-group">
                <div class="badge ok">‚úÖ Core OK</div>
                <div class="badge warn">‚ö†Ô∏è Network varies</div>
                <div class="badge bad">üß™ Use Diagnostics log below</div>
              </div>
            </div>
          </div>
          <div class="card">
            <h2>Event & Error Log</h2>
            <div class="log" id="diag-log" aria-live="polite"></div>
            <div class="toolbar" style="margin-top:8px">
              <button class="btn" id="btn-clear-log">üßπ Clear Log</button>
              <button class="btn" id="btn-export-log">‚¨áÔ∏è Export Log</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  // =========================
  // SilentStacks v2.0 ‚Äì Monolithic JS
  // =========================
  (() => {
    'use strict';

    const App = {
      version: '2.0.0-monolithic',
      state: {
        items: [],  // Records
        selectedId: null,
        queue: [],  // offline queue of pending lookups
        stopBulk: false,
        theme: 'dark',
        views: {},
        log: [],
        quickFilter: 'all'
      },
      el: {},
      modules: {}
    };

    // ---------- Utilities ----------
    const U = {
      sanitize(s) {
        if (s == null) return '';
        return String(s).replace(/[\\u0000-\\u001F\\u007F<>]/g, ' ').trim();
      },
      uid() { return 'SS-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8); },
      today() { return new Date().toISOString().slice(0,10); },
      daysBetween(a,b){ return Math.floor((new Date(b)-new Date(a))/(1000*60*60*24)); },
      debounce(fn, ms=250){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); } },
      toCSV(arr){
        if(!arr.length) return '';
        const cols = Array.from(new Set(arr.flatMap(o=>Object.keys(o))));
        const esc = v => '\"' + String(v??'').replace(/\"/g,'\"\"') + '\"';
        const head = cols.map(esc).join(',');
        const rows = arr.map(o => cols.map(k=>esc(o[k])).join(','));
        return [head, ...rows].join('\\n');
      },
      fromCSV(text){
        // Minimal CSV parser supporting quotes and commas
        const lines = text.replace(/\\r/g,'').split(/\\n+/).filter(Boolean);
        if(!lines.length) return [];
        const parseLine = (line)=>{
          const out=[]; let cur=''; let q=false;
          for(let i=0;i<line.length;i++){
            const c=line[i];
            if(c==='\"'){ if(q && line[i+1]==='\"'){ cur+='\"'; i++; } else { q=!q; } }
            else if(c===',' && !q){ out.push(cur); cur=''; }
            else { cur+=c; }
          }
          out.push(cur); return out;
        };
        const header = parseLine(lines[0]).map(h=>h.trim());
        return lines.slice(1).map(l=>{
          const cells=parseLine(l); const obj={};
          header.forEach((h,i)=>obj[h]=cells[i]??'');
          return obj;
        });
      },
      download(filename, content, type='text/plain'){
        const blob = new Blob([content], {type});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = filename; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
      },
      approxStorage(){
        try{ return (new Blob([JSON.stringify(localStorage)]).size/1024).toFixed(1)+' KB'; }catch{ return 'n/a'; }
      },
      parseSearch(q){
        const r={ text:[], status:'', priority:'', tag:'', authors:'' };
        (q||'').split(/\\s+/).forEach(tok=>{
          const m = tok.match(/^(\\w+):(.*)$/);
          if(m){ const k=m[1].toLowerCase(); if(r[k]!=null) r[k]=m[2]; else r.text.push(tok); }
          else r.text.push(tok);
        });
        return r;
      },
      nlmCitation(item){
        // Basic NLM style approximation
        // Authors: Last FM, up to 6 then et al.
        const authors = (item.authors||'').split(';').map(s=>s.trim()).filter(Boolean);
        const au = authors.slice(0,6).join(', ') + (authors.length>6?' et al.':'');
        const year = item.year || '';
        const vol = item.volume ? item.volume : '';
        const iss = item.issue ? '('+item.issue+')' : '';
        const pgs = item.pages ? ':'+item.pages : '';
        const journal = item.journal || '';
        const title = item.title || '';
        const doi = item.doi ? ' doi: ' + item.doi + '.' : '';
        const pmid = item.pmid ? ' PMID: ' + item.pmid + '.' : '';
        return `${au}. ${title}. ${journal}. ${year};${vol}${iss}${pgs}.${doi}${pmid}`.replace(/\\s+/g,' ').trim();
      }
    };

    // ---------- Persistence ----------
    const Store = {
      load(){
        try{
          const raw = localStorage.getItem('silentstacks_v2_data');
          App.state.items = raw? JSON.parse(raw) : [];
          const theme = localStorage.getItem('silentstacks_v2_theme');
          if(theme) App.state.theme = theme;
          const views = localStorage.getItem('silentstacks_v2_views');
          if(views) App.state.views = JSON.parse(views);
        }catch(e){ log('error','Load failed '+e); }
      },
      save(){
        try{ localStorage.setItem('silentstacks_v2_data', JSON.stringify(App.state.items)); }catch(e){ log('error','Save failed '+e); }
      },
      saveViews(){ try{ localStorage.setItem('silentstacks_v2_views', JSON.stringify(App.state.views)); }catch(e){} },
      saveTheme(){ try{ localStorage.setItem('silentstacks_v2_theme', App.state.theme); }catch(e){} }
    };

    // ---------- Rate Limiter ----------
    class RateLimiter {
      constructor(minIntervalMs){ this.min = minIntervalMs; this.last = 0; }
      async wait(){
        const now = Date.now();
        const delta = now - this.last;
        if(delta < this.min) await new Promise(r=>setTimeout(r,this.min-delta));
        this.last = Date.now();
      }
    }

    const RL = {
      pubmed: new RateLimiter(500), // ~2/sec
      crossref: new RateLimiter(150),
      trials: new RateLimiter(800)
    };

    // ---------- Network helpers with CORS fallback ----------
    function proxyURL(url){
      // Use r.jina.ai as a read-only CORS passthrough when needed
      // It accepts full target URL appended after the slash.
      return 'https://r.jina.ai/' + url;
    }

    async function smartFetch(url, {as='json', headers={}} = {}){
      try{
        const r = await fetch(url, {headers});
        if(r.ok){ return as==='json' ? r.json() : r.text(); }
        // If blocked or bad status, try proxy
        log('warn', `Direct fetch failed (${r.status}) ‚Üí proxy: ${url}`);
      }catch(e){
        log('warn', `Direct fetch error (${e.message}) ‚Üí proxy: ${url}`);
      }
      // Proxy fallback
      const pu = proxyURL(url);
      const r2 = await fetch(pu, {headers:{...headers, 'X-SS-Proxy':'1'}});
      if(!r2.ok){ throw new Error('Proxy fetch failed '+r2.status); }
      const body = await (as==='json' ? r2.text() : r2.text());
      if(as==='json'){
        try { return JSON.parse(body); } catch(e){ throw new Error('Proxy JSON parse failed'); }
      }
      return body;
    }


    // ---------- API Integration (deep enrichment) ----------
    const API = {
      normalizeDOI(x){
        if(!x) return '';
        return String(x).trim()
          .replace(/^https?:\/\/(dx\.)?doi\.org\//i,'')
          .replace(/^doi:/i,'')
          .trim();
      },

      async idConv(id){ // DOI or PMID or PMCID ‚Üí mapping
        try{
          await RL.pubmed.wait();
          const url = `https://www.ncbi.nlm.nih.gov/pmc/utils/idconv/v1.0/?format=json&ids=${encodeURIComponent(id)}`;
          const j = await smartFetch(url, {as:'json', headers:{'Accept':'application/json'}});
          const rec = j?.records?.[0]||{};
          return {
            pmid: rec.pmid ? String(rec.pmid) : '',
            pmcid: rec.pmcid ? String(rec.pmcid) : '',
            doi: rec.doi ? String(rec.doi) : ''
          };
        }catch(e){ log('error',`idConv failed for ${id}: ${e.message}`); return {pmid:'',pmcid:'',doi:''}; }
      },

      async fetchCrossrefByDOI(doiRaw){
        const doi = API.normalizeDOI(doiRaw);
        if(!doi) return null;
        try{
          await RL.crossref.wait();
          const url = `https://api.crossref.org/works/${encodeURIComponent(doi)}`;
          const m = (await smartFetch(url, {as:'json', headers:{'Accept':'application/json'}}))?.message || {};
          const authors = (m.author||[]).map(a=>{
            const fam = a.family||''; const giv = a.given||'';
            const initials = giv.split(/\\s+/).map(s=>s[0]).filter(Boolean).join('');
            return `${fam} ${initials}`.trim();
          }).join('; ');
          const issued = m.issued?.['date-parts']?.[0]?.[0] || m.created?.['date-parts']?.[0]?.[0] || '';
          return {
            title: (Array.isArray(m.title)? m.title[0] : m.title)||'',
            journal: (Array.isArray(m['container-title'])? m['container-title'][0] : m['container-title'])||'',
            year: String(issued||''),
            volume: m.volume||'',
            issue: m.issue||'',
            pages: m.page||'',
            authors,
            doi
          };
        }catch(e){ log('error',`Crossref failed for ${doiRaw}: ${e.message}`); return null; }
      },

      async fetchTrial(nct){
        if(!nct) return { nct: '' , pmids: [] };
        try{
          await RL.trials.wait();
          // v2 detail endpoint
          const url = `https://clinicaltrials.gov/api/v2/studies/${encodeURIComponent(nct)}`;
          const j = await smartFetch(url, {as:'json', headers:{'Accept':'application/json'}});
          // Try multiple possible locations for references with PMIDs
          const refs = j?.protocolSection?.referencesModule?.references
                    || j?.protocolSection?.referenceModule?.referenceList
                    || j?.references || [];
          const pmids = []
          ;(refs||[]).forEach(ref=>{
            const p = ref?.pmid || ref?.PMID || ref?.citationPmid || '';
            if(p) pmids.push(String(p));
          });
          return { nct: String(nct), pmids };
        }catch(e){ log('error',`ClinicalTrials fetch failed for ${nct}: ${e.message}`); return { nct: String(nct), pmids: [] }; }
      },

      async fetchPubMedSummary(pmid){
        try{
          await RL.pubmed.wait();
          const url = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${encodeURIComponent(pmid)}&retmode=json`;
          const data = await smartFetch(url, {as:'json', headers:{'Accept':'application/json'}});
          const uid = data.result?.uids?.[0];
          if(!uid) return null;
          const r = data.result[uid];
          const authors = (r.authors||[]).map(a => a.name || [a.lastname, a.initials].filter(Boolean).join(' ')).filter(Boolean);
          return {
            title: r.title || '',
            journal: r.fulljournalname || r.source || '',
            year: (r.pubdate||'').slice(0,4),
            volume: r.volume||'',
            issue: r.issue||'',
            pages: r.pages||'',
            authors: authors.join('; '),
            pmid: String(pmid)
          };
        }catch(e){ log('error',`PubMed summary failed for ${pmid}: ${e.message}`); return null; }
      },

      async fetchPubMedEFetch(pmid){
        try{
          await RL.pubmed.wait();
          const url = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${encodeURIComponent(pmid)}&retmode=xml`;
          const xml = await smartFetch(url, {as:'text'});
          const doc = new DOMParser().parseFromString(xml, 'application/xml');

          const pick = (sel)=>doc.querySelector(sel)?.textContent?.trim()||'';
          const pickAll = (sel)=>Array.from(doc.querySelectorAll(sel)).map(n=>n.textContent.trim());

          // Biblio
          const title   = pick('Article > ArticleTitle');
          const journal = pick('Article > Journal > Title') || pick('Journal > ISOAbbreviation');
          const year    = pick('Article > Journal > JournalIssue > PubDate > Year') ||
                          (pick('Article > Journal > JournalIssue > PubDate')||'').match(/\\d{4}/)?.[0] || '';
          const volume  = pick('Article > Journal > JournalIssue > Volume');
          const issue   = pick('Article > Journal > JournalIssue > Issue');
          const pages   = pick('Article > Pagination > MedlinePgn');

          // Authors ‚Üí "Last FM"
          const authors = Array.from(doc.querySelectorAll('AuthorList > Author'))
            .map(a=>{
              const last = a.querySelector('LastName')?.textContent?.trim()||'';
              const fore = a.querySelector('ForeName')?.textContent?.trim()||'';
              const initials = fore.split(/\\s+/).map(s=>s[0]).filter(Boolean).join('');
              return `${last} ${initials}`.trim();
            }).filter(Boolean).join('; ');

          // DOI (prefer ArticleIdList)
          let doi = '';
          const idNodes = Array.from(doc.querySelectorAll('ArticleIdList > ArticleId'));
          const doiNode = idNodes.find(n=>n.getAttribute('IdType')==='doi');
          if(doiNode) doi = doiNode.textContent.trim();
          if(!doi){
            const eloc = Array.from(doc.querySelectorAll('ELocationID[EIdType="doi"]'))[0];
            if(eloc) doi = eloc.textContent.trim();
          }
          doi = API.normalizeDOI(doi);

          // MeSH (top 5 descriptor names)
          const mesh = Array.from(doc.querySelectorAll('MeshHeadingList > MeshHeading > DescriptorName'))
            .map(n=>n.textContent.trim()).filter(Boolean).slice(0,5);

          // ClinicalTrials.gov NCT
          let nct = '';
          doc.querySelectorAll('DataBankList > DataBank').forEach(db=>{
            const name = db.querySelector('DataBankName')?.textContent?.trim().toLowerCase();
            if(name === 'clinicaltrials.gov'){
              const accs = Array.from(db.querySelectorAll('AccessionNumberList > AccessionNumber')).map(n=>n.textContent.trim());
              const hit = accs.find(x=>/^NCT\\d{8}$/i.test(x));
              if(hit) nct = hit.toUpperCase();
            }
          });

          return { pmid: String(pmid), title, journal, year, volume, issue, pages, authors, doi, mesh, nct };
        }catch(e){ log('error',`PubMed EFetch failed for ${pmid}: ${e.message}`); return null; }
      }
    };

    // ---------- Logging & Diagnostics ----------
    function log(level, msg){
      const line = `[${new Date().toISOString()}] ${level.toUpperCase()}: ${msg}`;
      App.state.log.push(line);
      try { console.log(line); } catch(e) {}
      const el = App.el.diagLog; if(el){ el.textContent = App.state.log.slice(-400).join('\\n'); }
    }

    // ---------- Enrichment Orchestrator ----------
    function mergeItem(base, extra){
      const out = {...base};
      for(const k of Object.keys(extra||{})){
        if(extra[k]==null) continue;
        if(typeof extra[k] === 'string'){
          if(!out[k]) out[k] = extra[k]; // don't overwrite user edits unless empty
          else if(['title','journal','authors','pages'].includes(k) && extra[k].length > out[k].length) out[k] = extra[k];
        }else if(Array.isArray(extra[k])){
          const have = new Set(out[k]||[]);
          (extra[k]||[]).forEach(v=>have.add(v));
          out[k] = Array.from(have);
        }else{
          out[k] = extra[k];
        }
      }
      return out;
    }

    async function enrichFromIdentifiers(seed){
      // seed: {pmid?, doi?, nct?}
      let item = {...seed};

      // If DOI provided, try to map to PMID
      if(item.doi && !item.pmid){
        const m = await API.idConv(item.doi);
        if(m.pmid) item.pmid = m.pmid;
        if(!item.doi && m.doi) item.doi = m.doi;
      }

      // If PMID provided, pull EFetch (rich) + ESummary (fallback)
      if(item.pmid){
        const ef = await API.fetchPubMedEFetch(item.pmid);
        if(ef) item = mergeItem(item, ef);
        if(!ef?.title){ const es = await API.fetchPubMedSummary(item.pmid); if(es) item = mergeItem(item, es); }
      }

      // If still missing DOI but have PMID, try idConv on PMID
      if(item.pmid && !item.doi){
        const m2 = await API.idConv(item.pmid);
        if(m2.doi) item.doi = m2.doi;
      }

      // If DOI present, pull Crossref for any missing biblio bits
      if(item.doi){
        const cx = await API.fetchCrossrefByDOI(item.doi);
        if(cx) item = mergeItem(item, cx);
      }

      // If NCT given, try to find PMIDs from the trial references ‚Üí then PubMed enrich that article
      if(item.nct){
        const tr = await API.fetchTrial(item.nct);
        if(tr.pmids?.length && !item.pmid){
          item.pmid = tr.pmids[0];
          const ef2 = await API.fetchPubMedEFetch(item.pmid);
          if(ef2) item = mergeItem(item, ef2);
          if(!item.doi){
            const m3 = await API.idConv(item.pmid);
            if(m3.doi) item.doi = m3.doi;
          }
        }
      }

      return item;
    }

    // ---------- UI Helpers ----------
    function setTheme(theme){
      App.state.theme = theme; Store.saveTheme();
      document.documentElement.setAttribute('data-theme', theme === 'light' ? 'light' : (theme==='hc'?'hc':'dark'));
      // Update pressed states
      App.el.themeLight.setAttribute('aria-pressed', String(theme==='light'));
      App.el.themeDark.setAttribute('aria-pressed', String(theme==='dark'));
      App.el.themeHc.setAttribute('aria-pressed', String(theme==='hc'));
    }

    function applyForm(item){
      const g = (id)=>App.el[id];
      g('pmid').value = item.pmid||'';
      g('doi').value = item.doi||'';
      g('nct').value = item.nct||'';
      g('title').value = item.title||'';
      g('authors').value = item.authors||'';
      g('journal').value = item.journal||'';
      g('year').value = item.year||'';
      g('volume').value = item.volume||'';
      g('issue').value = item.issue||'';
      g('pages').value = item.pages||'';
      g('status').value = item.status||'open';
      g('priority').value = item.priority||'normal';
      g('ill').value = item.ill||'';
      g('docline').value = item.docline||'';
      g('doclineDate').value = item.doclineDate||'';
      g('tags').value = (item.tags||[]).join(', ');
      g('mesh').value = (item.mesh||[]).join(', ');
      g('notes').value = item.notes||'';
      g('hasAttachments').checked = !!item.hasAttachments;
    }

    function readForm(){
      const g = (id)=>U.sanitize(App.el[id].value);
      const tags = g('tags').split(',').map(s=>s.trim()).filter(Boolean);
      const mesh = App.el['mesh'].value.split(',').map(s=>s.trim()).filter(Boolean);
      return {
        id: App.state.selectedId || U.uid(),
        createdAt: App.state.selectedId ? App.state.items.find(x=>x.id===App.state.selectedId)?.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        pmid: g('pmid'), doi: g('doi'), nct: g('nct'),
        title: g('title'), authors: g('authors'), journal: g('journal'),
        year: g('year'), volume: g('volume'), issue: g('issue'), pages: g('pages'),
        status: App.el['status'].value, priority: App.el['priority'].value, ill: App.el['ill'].value,
        docline: g('docline'), doclineDate: g('doclineDate'),
        tags, mesh,
        notes: U.sanitize(App.el['notes'].value),
        hasAttachments: App.el['hasAttachments'].checked
      };
    }

    function clearForm(){ App.state.selectedId=null; applyForm({}); App.el.formStatus.textContent=''; }

    function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    function renderRows(){
      const q = App.el.search.value.trim();
      const fs = App.el.fStatus.value; const fp = App.el.fPriority.value; const ft = App.el.fTag.value.trim().toLowerCase();
      const parsed = U.parseSearch(q);

      const today = U.today();
      const rows = App.state.items.filter(it=>{
        if(fs && it.status!==fs) return false;
        if(fp && it.priority!==fp) return false;
        if(ft){ const t=(it.tags||[]).concat(it.mesh||[]).join(' ').toLowerCase(); if(!t.includes(ft)) return false; }
        // parsed search
        if(parsed.status && it.status!==parsed.status) return false;
        if(parsed.priority && it.priority!==parsed.priority) return false;
        if(parsed.tag){ const space=(it.tags||[]).concat(it.mesh||[]).join(' ').toLowerCase(); if(!space.includes(parsed.tag.toLowerCase())) return false; }
        if(parsed.authors){ if(!(it.authors||'').toLowerCase().includes(parsed.authors.toLowerCase())) return false; }
        const text = parsed.text.join(' ').toLowerCase();
        if(text){
          const hay = [it.title,it.authors,it.journal,it.notes].join(' ').toLowerCase();
          if(!hay.includes(text)) return false;
        }
        // Quick tab filter
        if(App.state.quickFilter && App.state.quickFilter!=='all'){
          if(['open','in-progress','closed'].includes(App.state.quickFilter)){
            if(it.status !== App.state.quickFilter) return false;
          }else if(App.state.quickFilter==='urgent'){
            if(it.priority !== 'urgent') return false;
          }else if(App.state.quickFilter==='followup'){
            const needsFollowUp = it.doclineDate && it.status!=='closed' && U.daysBetween(it.doclineDate, today) >= 5;
            if(!needsFollowUp) return false;
          }
        }
        return true;
      });

      const frag = document.createDocumentFragment();
      rows.forEach(it=>{
        const tr = document.createElement('tr');
        const flags = [];
        if(it.doclineDate && it.status!=='closed' && U.daysBetween(it.doclineDate, today) >= 5){ flags.push('Follow-up'); }
        if(it.hasAttachments) flags.push('Has attachments');
        tr.innerHTML = `
          <td><span class="kbd">${it.id}</span></td>
          <td>${escapeHtml(it.title||'')}</td>
          <td>${escapeHtml(it.authors||'')}</td>
          <td>${escapeHtml((it.journal||'') + (it.year? ' / '+it.year : ''))}</td>
          <td class="status ${it.status==='closed'?'closed':'open'}">${it.status}</td>
          <td>${it.priority||''}</td>
          <td>${[...(it.tags||[]), ...(it.mesh||[])].map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join(' ')}</td>
          <td>${flags.map(f=>`<span class="badge warn">${escapeHtml(f)}</span>`).join(' ')}</td>
          <td>
            <button class="btn small" data-act="edit" data-id="${it.id}">‚úèÔ∏è Edit</button>
            <button class="btn small bad" data-act="del" data-id="${it.id}">üóëÔ∏è Delete</button>
            <button class="btn small" data-act="cite" data-id="${it.id}">üìë NLM</button>
          </td>`;
        tr.addEventListener('click', (ev)=>{
          const b = ev.target.closest('button');
          if(b){ const id=b.getAttribute('data-id'); const act=b.getAttribute('data-act');
            if(act==='edit'){ const item=App.state.items.find(x=>x.id===id); if(item){ App.state.selectedId=id; applyForm(item); window.scrollTo({top:0,behavior:'smooth'}); }}
            else if(act==='del'){ if(confirm('Delete this record?')){ App.state.items = App.state.items.filter(x=>x.id!==id); Store.save(); renderRows(); updateStats(); }}
            else if(act==='cite'){ const item=App.state.items.find(x=>x.id===id); if(item){ const c=U.nlmCitation(item); navigator.clipboard?.writeText(c); alert('Copied NLM citation to clipboard:\n\n'+c); }}
            ev.stopPropagation();
          }
        }, {passive:true});
        frag.appendChild(tr);
      });
      App.el.rows.replaceChildren(frag);
      App.el.count.textContent = `${rows.length} shown ‚Ä¢ ${App.state.items.length} total`;
    }

    // ---------- Events ----------
    function bind(){
      // Tabs
      const tabs = [
        ['tabbtn-requests','tab-requests'],
        ['tabbtn-bulk','tab-bulk'],
        ['tabbtn-help','tab-help'],
        ['tabbtn-diagnostics','tab-diagnostics']
      ];
      tabs.forEach(([btn, panel])=>{
        const b = document.getElementById(btn); const p = document.getElementById(panel);
        b.addEventListener('click',()=>{
          tabs.forEach(([bb,pp])=>{
            document.getElementById(bb).setAttribute('aria-selected', String(bb===btn));
            document.getElementById(pp).hidden = (pp!==panel);
          });
        });
      });

      // Theme
      App.el.themeLight.addEventListener('click',()=>setTheme('light'));
      App.el.themeDark.addEventListener('click',()=>setTheme('dark'));
      App.el.themeHc.addEventListener('click',()=>setTheme('hc'));

      // Search
      App.el.search.addEventListener('input', U.debounce(renderRows, 120));
      App.el.fStatus.addEventListener('change', renderRows);
      App.el.fPriority.addEventListener('change', renderRows);
      App.el.fTag.addEventListener('input', U.debounce(renderRows, 120));

      // Table quick-filter tabs
      document.querySelectorAll('.table-tab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.table-tab').forEach(b=>b.setAttribute('aria-selected','false'));
          btn.setAttribute('aria-selected','true');
          App.state.quickFilter = btn.dataset.filter || 'all';
          renderRows();
        });
      });

      // Saved views
      App.el.btnSaveView.addEventListener('click', ()=>{
        const name = prompt('Name this view'); if(!name) return;
        App.state.views[name] = {
          q: App.el.search.value, fs: App.el.fStatus.value, fp: App.el.fPriority.value, ft: App.el.fTag.value
        }; Store.saveViews(); refreshViews();
      });
      App.el.btnDelView.addEventListener('click', ()=>{
        const k = App.el.savedViews.value; if(!k) return; delete App.state.views[k]; Store.saveViews(); refreshViews();
      });
      App.el.savedViews.addEventListener('change', ()=>{
        const k = App.el.savedViews.value; if(!k) return; const v = App.state.views[k];
        App.el.search.value=v.q; App.el.fStatus.value=v.fs; App.el.fPriority.value=v.fp; App.el.fTag.value=v.ft; renderRows();
      });

      // Form buttons
      App.el.btnLookup.addEventListener('click', onLookup);
      App.el.btnSave.addEventListener('click', ()=>{
        const item = readForm();
        const idx = App.state.items.findIndex(x=>x.id===item.id);
        if(idx>=0) App.state.items[idx] = item; else App.state.items.unshift(item);
        Store.save(); renderRows(); updateStats(); App.el.formStatus.textContent='Saved';
      });
      App.el.btnReset.addEventListener('click', clearForm);

      // Exports
      App.el.exportJSON.addEventListener('click', ()=>{
        U.download('silentstacks.json', JSON.stringify(App.state.items, null, 2), 'application/json');
      });
      App.el.exportCSV.addEventListener('click', ()=>{
        U.download('silentstacks.csv', U.toCSV(App.state.items), 'text/csv');
      });
      App.el.exportNLM.addEventListener('click', ()=>{
        const lines = App.state.items.map(U.nlmCitation).join('\\n');
        U.download('silentstacks_nlm.txt', lines, 'text/plain');
      });

      // Bulk
      App.el.btnImport.addEventListener('click', async ()=>{
        const f = App.el.fileInput.files?.[0]; if(!f){ App.el.importStatus.textContent='Pick a file first'; return; }
        const text = await f.text(); await importText(text);
      });
      App.el.btnImportText.addEventListener('click', async ()=>{
        const text = App.el.bulkText.value; if(!text.trim()){ App.el.importStatus.textContent='Paste JSON or CSV'; return; }
        await importText(text);
      });

      App.el.btnBulkLookup.addEventListener('click', bulkLookup);
      App.el.btnStopLookup.addEventListener('click', ()=>{ App.state.stopBulk=true; });

      // Diagnostics
      App.el.btnClearLog.addEventListener('click', ()=>{ App.state.log=[]; App.el.diagLog.textContent=''; });
      App.el.btnExportLog.addEventListener('click', ()=>{
        U.download('silentstacks_log.txt', App.state.log.join('\\n'), 'text/plain');
      });
    }

    async function importText(text){
      try{
        let items;
        if(text.trim().startsWith('[')) items = JSON.parse(text);
        else items = U.fromCSV(text);
        if(!Array.isArray(items)) throw new Error('Parsed input is not an array');
        // Normalize fields and merge
        let added=0; items.forEach(src=>{
          const it = {
            id: src.id || U.uid(),
            createdAt: src.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            pmid: src.pmid||'', doi: src.doi||'', nct: src.nct||'',
            title: src.title||'', authors: src.authors||'', journal: src.journal||'',
            year: src.year||'', volume: src.volume||'', issue: src.issue||'', pages: src.pages||'',
            status: src.status||'open', priority: src.priority||'normal', ill: src.ill||'',
            docline: src.docline||'', doclineDate: src.doclineDate||'',
            tags: (src.tags? (Array.isArray(src.tags)? src.tags : String(src.tags).split(',').map(s=>s.trim()).filter(Boolean)) : []),
            mesh: (src.mesh? (Array.isArray(src.mesh)? src.mesh : String(src.mesh).split(',').map(s=>s.trim()).filter(Boolean)) : []),
            notes: src.notes||'', hasAttachments: !!src.hasAttachments
          };
          App.state.items.push(it); added++;
        });
        Store.save(); renderRows(); updateStats();
        App.el.importStatus.textContent = `Imported ${added} items`;
        App.el.bulkText.value=''; App.el.fileInput.value='';
        log('info', `Imported ${added} items`);
      }catch(e){ App.el.importStatus.textContent = 'Import failed: '+e.message; log('error','Import failed: '+e.message); }
    }

    // ---------- Lookup button ----------
    async function onLookup(){
      try{
        App.el.formStatus.textContent = 'Looking up‚Ä¶'; App.el.btnLookup.setAttribute('aria-busy','true'); App.el.btnLookup.disabled = true;
        const base = readForm();
        const seed = {
          pmid: base.pmid || '',
          doi: API.normalizeDOI(base.doi || ''),
          nct: base.nct ? base.nct.toUpperCase() : ''
        };
        if(!seed.pmid && !seed.doi && !seed.nct){
          App.el.formStatus.textContent = 'Enter a PMID, DOI, or NCT ID first';
          return;
        }
        const enriched = await enrichFromIdentifiers(seed);

        // Merge back into the live form (keep user-set status, tags, etc.)
        const keep = ['status','priority','ill','docline','doclineDate','tags','notes','hasAttachments','id','createdAt','updatedAt'];
        const merged = {...base};
        Object.keys(enriched).forEach(k=>{
          if(keep.includes(k)) return;
          merged[k] = enriched[k];
        });

        applyForm(merged);
        App.el.formStatus.textContent = 'Metadata enriched ‚úî'; App.el.btnLookup.removeAttribute('aria-busy'); App.el.btnLookup.disabled = false;
        log('info', `Lookup filled identifiers: PMID=${merged.pmid||'-'} DOI=${merged.doi||'-'} NCT=${merged.nct||'-'}`);
      }catch(e){
        App.el.formStatus.textContent = 'Lookup failed'; App.el.btnLookup.removeAttribute('aria-busy'); App.el.btnLookup.disabled = false;
        log('error','Lookup error: '+e.message);
        if(!navigator.onLine){
          const s = readForm();
          App.state.queue.push({type:'lookup', pmid:s.pmid, doi:s.doi, nct:s.nct});
        }
      }
    }
    // Expose globally for inline fallback
    try { window.SilentStacks_lookup = onLookup; } catch(e) {}


    // ---------- Bulk lookup ----------
    async function bulkLookup(){
      App.state.stopBulk = false;
      const items = App.state.items;
      let done=0, changed=0;

      for(let i=0;i<items.length;i++){
        if(App.state.stopBulk) break;
        const it = items[i];
        if(!(it.pmid||it.doi||it.nct)){ done++; App.el.bulkProgress.textContent = `${done}/${items.length}`; continue; }

        const before = JSON.stringify(it);
        const seed = { pmid: it.pmid||'', doi: API.normalizeDOI(it.doi||''), nct: it.nct? it.nct.toUpperCase():'' };
        const enriched = await enrichFromIdentifiers(seed);
        App.state.items[i] = mergeItem(it, enriched);

        if(JSON.stringify(App.state.items[i]) !== before) changed++;
        done++;
        App.el.bulkLog.textContent = `Enriched ${i+1}/${items.length}: ${it.id || '(no id)'} ‚Üí PMID=${App.state.items[i].pmid||'-'} DOI=${App.state.items[i].doi||'-'} NCT=${App.state.items[i].nct||'-'}\n` + App.el.bulkLog.textContent;
        App.el.bulkProgress.textContent = `${done}/${items.length} ‚Ä¢ ${changed} updated`;
        await new Promise(r=>setTimeout(r,120)); // yield to UI
      }

      Store.save(); renderRows(); updateStats?.();
      App.el.bulkLog.textContent = `‚úÖ Bulk lookup complete. ${changed} updated of ${items.length}.\n` + App.el.bulkLog.textContent;
    }

    function updateStats(){
      App.el.statRecords.textContent = String(App.state.items.length);
      App.el.statStorage.textContent = U.approxStorage();
      App.el.statQueue.textContent = String(App.state.queue.length);
      const names = ['RequestManager','APIClient','Storage','UI','Forms','SearchFilter','Notifications','ILLWorkflow','BulkOps','ExportManager','PubMed','ClinicalTrials','Mesh'];
      App.el.moduleChips.innerHTML = names.map(n=>`<span class="chip">${n} ‚úÖ</span>`).join(' ');
    }

    function refreshViews(){
      const sel = App.el.savedViews; const cur = sel.value;
      sel.innerHTML = '<option value="">Saved views‚Ä¶</option>' + Object.keys(App.state.views).sort().map(k=>`<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join('');
      if(cur && App.state.views[cur]) sel.value = cur; else sel.value = '';
    }

    function wireRefs(){
      const byId = id=>document.getElementById(id);
      Object.assign(App.el, {
        // Theme
        themeLight: byId('theme-light'), themeDark: byId('theme-dark'), themeHc: byId('theme-hc'),
        // Form
        pmid: byId('pmid'), doi: byId('doi'), nct: byId('nct'), title: byId('title'), authors: byId('authors'),
        journal: byId('journal'), year: byId('year'), volume: byId('volume'), issue: byId('issue'), pages: byId('pages'),
        status: byId('status'), priority: byId('priority'), ill: byId('ill'), docline: byId('docline'), doclineDate: byId('doclineDate'),
        tags: byId('tags'), mesh: byId('mesh'), notes: byId('notes'), hasAttachments: byId('hasAttachments'),
        btnLookup: byId('btn-lookup'), btnSave: byId('btn-save'), btnReset: byId('btn-reset'), formStatus: byId('form-status'),
        // Search
        search: byId('search'), fStatus: byId('f-status'), fPriority: byId('f-priority'), fTag: byId('f-tag'),
        btnSaveView: byId('btn-save-view'), savedViews: byId('saved-views'), btnDelView: byId('btn-del-view'),
        rows: byId('rows'), count: byId('count'),
        // Export
        exportJSON: byId('export-json'), exportCSV: byId('export-csv'), exportNLM: byId('export-nlm'),
        // Bulk
        fileInput: byId('file-input'), btnImport: byId('btn-import'), bulkText: byId('bulk-text'), btnImportText: byId('btn-import-text'),
        btnBulkLookup: byId('btn-bulk-lookup'), btnStopLookup: byId('btn-stop-lookup'), bulkProgress: byId('bulk-progress'), bulkLog: byId('bulk-log'), importStatus: byId('import-status'),
        // Diagnostics
        moduleChips: byId('module-chips'), statRecords: byId('stat-records'), statStorage: byId('stat-storage'), statQueue: byId('stat-queue'), diagLog: byId('diag-log'),
        btnClearLog: byId('btn-clear-log'), btnExportLog: byId('btn-export-log')
      });
    }

    function init(){
      try { console.log('üöÄ SilentStacks init start'); } catch(e) {}
      window.SilentStacksReady = true;
    // Expose lookup globally as a fallback for environments where addEventListener fails
    window.SilentStacks_lookup = onLookup;

      wireRefs(); Store.load(); setTheme(App.state.theme||'dark');
      bind(); refreshViews(); renderRows(); updateStats();
      log('info', 'SilentStacks v'+App.version+' initialized');
      try { console.log('‚úÖ SilentStacks init done'); } catch(e) {}
      // Keyboard shortcuts
      window.addEventListener('keydown', (ev)=>{
        if((ev.ctrlKey||ev.metaKey) && ev.key.toLowerCase()==='s'){ ev.preventDefault(); App.el.btnSave.click(); }
      });
    }

    // Kickoff
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, {once:true});
    } else {
      init();
    }
  })();
  </script>
</body>
</html>
