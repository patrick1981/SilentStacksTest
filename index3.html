<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SilentStacks</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #2563eb;
      --secondary-color: #64748b;
      --success-color: #059669;
      --warning-color: #d97706;
      --danger-color: #dc2626;
      --background: #ffffff;
      --surface: #f8fafc;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --border: #e2e8f0;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      --radius: 8px;
      --spacing: 8px;
    }

    [data-theme="dark"] {
      --background: #0f172a;
      --surface: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border: #334155;
    }

    [data-theme="high-contrast"] {
      --primary-color: #000000;
      --background: #ffffff;
      --surface: #ffffff;
      --text-primary: #000000;
      --text-secondary: #000000;
      --border: #000000;
      --shadow: 0 0 0 3px #000000;
    }

    body {
      font-family: 'Reddit Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 16px;
    }

    /* Layout */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--spacing);
    }

    /* Header */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: calc(var(--spacing) * 2) 0;
    }

    .header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--spacing);
    }

    .header-brand h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    .version {
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: block;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing);
    }

    .theme-select, .help-button {
      padding: calc(var(--spacing) / 2) var(--spacing);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-primary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .help-button {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing) / 2);
      text-decoration: none;
    }

    .theme-select:hover, .help-button:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow);
    }

    /* Navigation */
    .nav-tabs {
      display: flex;
      gap: calc(var(--spacing) / 2);
      margin-top: var(--spacing);
      flex-wrap: wrap;
    }

    .nav-tab {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing) / 2);
      padding: var(--spacing) calc(var(--spacing) * 1.5);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 48px;
    }

    .nav-tab:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .nav-tab.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .nav-icon {
      width: 16px;
      height: 16px;
    }

    /* Main Content */
    .main-content {
      padding: calc(var(--spacing) * 3) 0;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .section h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: calc(var(--spacing) * 2);
      color: var(--text-primary);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing);
      margin-bottom: calc(var(--spacing) * 3);
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: calc(var(--spacing) * 2);
      text-align: center;
    }

    .stat-card h3 {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    /* Forms */
    .form-group {
      margin-bottom: calc(var(--spacing) * 2);
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: calc(var(--spacing) / 2);
      color: var(--text-primary);
    }

    .form-control {
      width: 100%;
      padding: var(--spacing);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.2s;
      min-height: 48px;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: calc(var(--spacing) / 2);
      padding: var(--spacing) calc(var(--spacing) * 2);
      border: 1px solid transparent;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      min-height: 48px;
      justify-content: center;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--text-primary);
      border-color: var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--primary-color);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    /* Enhanced Lookup Section */
    .enhanced-lookup-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: calc(var(--spacing) * 2);
      margin-bottom: calc(var(--spacing) * 3);
    }

    .enhanced-lookup-section h3 {
      margin-bottom: var(--spacing);
      color: var(--primary-color);
    }

    .input-with-button {
      display: flex;
      gap: calc(var(--spacing) / 2);
    }

    .input-with-button input {
      flex: 1;
    }

    .lookup-btn {
      white-space: nowrap;
    }

    .lookup-status {
      margin-top: calc(var(--spacing) / 2);
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Search and Filter Controls */
    .search-filter-controls {
      display: flex;
      gap: var(--spacing);
      margin-bottom: calc(var(--spacing) * 2);
      flex-wrap: wrap;
    }

    .search-container {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    .search-input {
      width: 100%;
      padding: var(--spacing);
      padding-right: calc(var(--spacing) * 3);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-primary);
    }

    .search-clear {
      position: absolute;
      right: var(--spacing);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .filter-controls {
      display: flex;
      gap: calc(var(--spacing) / 2);
    }

    .filter-select {
      padding: var(--spacing);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-primary);
      min-width: 120px;
    }

    /* Table Controls */
    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: calc(var(--spacing) * 2);
      flex-wrap: wrap;
      gap: var(--spacing);
    }

    .sort-controls {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing) / 2);
      flex-wrap: wrap;
    }

    .sort-btn {
      padding: calc(var(--spacing) / 2) var(--spacing);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sort-btn:hover, .sort-btn.sort-desc, .sort-btn.sort-asc {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .results-info {
      display: flex;
      align-items: center;
      gap: var(--spacing);
    }

    .select-all-label {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing) / 2);
      font-size: 0.875rem;
      cursor: pointer;
    }

    /* Request List */
    .request-list {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      min-height: 200px;
      padding: calc(var(--spacing) * 2);
    }

    .empty-message {
      text-align: center;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Bulk Operations */
    .bulk-operations-section {
      margin-top: calc(var(--spacing) * 3);
      padding: calc(var(--spacing) * 2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
    }

    .bulk-paste-section, .csv-upload-section {
      margin-bottom: calc(var(--spacing) * 2);
    }

    .bulk-paste-options {
      display: flex;
      gap: var(--spacing);
      margin: var(--spacing) 0;
      flex-wrap: wrap;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing) / 2);
      font-size: 0.875rem;
      cursor: pointer;
    }

    .bulk-upload-status {
      margin-top: var(--spacing);
      padding: var(--spacing);
      border-radius: var(--radius);
      background: var(--background);
      border: 1px solid var(--border);
      font-size: 0.875rem;
    }

    /* Import/Export Grid */
    .import-export-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: calc(var(--spacing) * 2);
    }

    .import-export-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: calc(var(--spacing) * 2);
    }

    .import-export-card h3 {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing) / 2);
      margin-bottom: calc(var(--spacing) * 2);
      color: var(--text-primary);
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing);
    }

    .export-info {
      margin-top: var(--spacing);
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Settings */
    .settings-form {
      max-width: 600px;
    }

    .form-help {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: calc(var(--spacing) / 2);
    }

    .form-actions {
      display: flex;
      gap: var(--spacing);
      margin-top: calc(var(--spacing) * 2);
      flex-wrap: wrap;
    }

    .performance-stats {
      margin-top: calc(var(--spacing) * 3);
      padding: calc(var(--spacing) * 2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
    }

    /* Connection Status */
    .connection-indicator {
      position: fixed;
      top: var(--spacing);
      right: var(--spacing);
      padding: calc(var(--spacing) / 2) var(--spacing);
      border-radius: var(--radius);
      font-size: 0.75rem;
      font-weight: 500;
      z-index: 1000;
    }

    .connection-clean {
      background: var(--success-color);
      color: white;
    }

    .offline {
      background: var(--warning-color);
      color: white;
    }

    /* Modal */
    .modal-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: var(--spacing);
    }

    .modal-overlay {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-panel {
      background: var(--background);
      border-radius: var(--radius);
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: calc(var(--spacing) * 2);
      border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
      margin: 0;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: calc(var(--spacing) / 2);
      border-radius: var(--radius);
      min-width: 48px;
      min-height: 48px;
    }

    .modal-close:hover {
      background: var(--surface);
    }

    .modal-content {
      padding: calc(var(--spacing) * 2);
      max-height: 60vh;
      overflow-y: auto;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .loading-spinner {
      text-align: center;
      color: white;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto calc(var(--spacing) * 2);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Help Topics */
    .help-search {
      margin-bottom: calc(var(--spacing) * 2);
    }

    .help-topics {
      display: flex;
      flex-direction: column;
      gap: calc(var(--spacing) * 2);
    }

    .help-topic {
      padding: calc(var(--spacing) * 2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
    }

    .help-topic h4 {
      margin-bottom: var(--spacing);
      color: var(--primary-color);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header .container {
        flex-direction: column;
        align-items: stretch;
      }

      .nav-tabs {
        justify-content: center;
      }

      .nav-tab {
        flex: 1;
        justify-content: center;
        min-width: 0;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .search-filter-controls {
        flex-direction: column;
      }

      .table-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .sort-controls {
        justify-content: center;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .form-actions {
        flex-direction: column;
      }

      .import-export-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        flex-direction: column;
      }

      .filter-controls {
        flex-direction: column;
      }

      .sort-controls {
        flex-wrap: wrap;
      }
    }

    /* Focus and Accessibility */
    *:focus {
      outline: 3px solid var(--primary-color);
      outline-offset: 2px;
    }

    [data-theme="high-contrast"] *:focus {
      outline: 4px solid #000000;
      outline-offset: 2px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* High Contrast Theme Enhancements */
    [data-theme="high-contrast"] {
      --primary-color: #000000;
      --secondary-color: #000000;
      --success-color: #000000;
      --warning-color: #000000;
      --danger-color: #000000;
      --background: #ffffff;
      --surface: #ffffff;
      --text-primary: #000000;
      --text-secondary: #000000;
      --border: #000000;
      --shadow: 0 0 0 3px #000000;
    }

    [data-theme="high-contrast"] .btn-primary {
      background: #000000;
      color: #ffffff;
      border: 3px solid #000000;
    }

    [data-theme="high-contrast"] .btn-secondary {
      background: #ffffff;
      color: #000000;
      border: 3px solid #000000;
    }

    [data-theme="high-contrast"] .nav-tab.active {
      background: #000000;
      color: #ffffff;
      border: 3px solid #000000;
    }

    [data-theme="high-contrast"] .form-control {
      border: 3px solid #000000;
    }

    [data-theme="high-contrast"] .connection-clean {
      background: #000000;
      color: #ffffff;
      border: 3px solid #000000;
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <main id="main" role="main">
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="connection-indicator connection-clean">
      <span id="connection-text">●</span>
    </div>

    <!-- Header & Navigation -->
    <header class="header">
      <div class="container">
        <div class="header-brand">
          <h1>SilentStacks</h1>
          <span class="version">v2.0 - Security & Performance Ready</span>
        </div>
        
        <!-- Theme and Help Controls -->
        <div class="header-controls">
          <div class="theme-selector">
            <label for="theme-select" class="sr-only">Choose theme</label>
            <select id="theme-select" class="theme-select" aria-label="Select theme">
              <option value="light">☀️ Light</option>
              <option value="dark">🌙 Dark</option>
              <option value="high-contrast">⚡ High Contrast</option>
            </select>
          </div>
          
          <button id="help-button" class="help-button" aria-label="Open help guide" title="Press Alt+H for help">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Help
          </button>
        </div>
        
        <nav class="nav-tabs" role="tablist">
          <button class="nav-tab active" data-section="dashboard" role="tab" aria-selected="true">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            Dashboard
          </button>
          <button class="nav-tab" data-section="add-request" role="tab" aria-selected="false">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Add Request
          </button>
          <button class="nav-tab" data-section="all-requests" role="tab" aria-selected="false">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            All Requests
          </button>
          <button class="nav-tab" data-section="import-export" role="tab" aria-selected="false">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            Import/Export
          </button>
          <button class="nav-tab" data-section="settings" role="tab" aria-selected="false">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="m12 1 1.68 4.02L18 6.7l-1.02 4.98L21 12l-4.02 1.68L15.3 18l-4.98-1.02L12 21l-1.68-4.02L6 15.3l1.02-4.98L3 12l4.02-1.68L8.7 6l4.98 1.02Z"></path>
            </svg>
            Settings
          </button>
        </nav>
      </div>
    </header>

    <!-- Main Content Container -->
    <div class="main-content">
      <div class="container">
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
          <h2>Dashboard</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Total Requests</h3>
              <p class="stat-number" id="total-requests">0</p>
            </div>
            <div class="stat-card">
              <h3>Pending</h3>
              <p class="stat-number" id="pending-requests">0</p>
            </div>
            <div class="stat-card">
              <h3>Completed</h3>
              <p class="stat-number" id="completed-requests">0</p>
            </div>
            <div class="stat-card">
              <h3>Urgent</h3>
              <p class="stat-number" id="urgent-requests">0</p>
            </div>
          </div>

          <h3>Recent Requests</h3>
          <div id="recent-requests" class="request-list">
            <p class="empty-message">No recent requests</p>
          </div>
        </section>

        <!-- Add Request Section -->
        <section id="add-request" class="section">
          <h2>Add New Request</h2>
          
          <!-- Enhanced Lookup Section -->
          <div class="enhanced-lookup-section">
            <h3>⚡ Enhanced Research Lookup</h3>
            <p>Enter a PMID or DOI to automatically fetch complete metadata, MeSH terms, and clinical trials data</p>
            
            <div class="form-group">
              <label for="pmid">PMID (PubMed ID)</label>
              <div class="input-with-button enhanced">
                <input type="text" id="pmid" name="pmid" placeholder="e.g., 16979104" data-type="pmid">
                <button type="button" id="lookup-pmid" class="lookup-btn">
                  <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                  Lookup
                </button>
              </div>
              <div id="pmid-status" class="lookup-status"></div>
            </div>

            <div class="form-group">
              <label for="doi">DOI (Digital Object Identifier)</label>
              <div class="input-with-button enhanced">
                <input type="text" id="doi" name="doi" placeholder="e.g., 10.1001/jama.2006.2221" data-type="doi">
                <button type="button" id="lookup-doi" class="lookup-btn">
                  <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                  Lookup
                </button>
              </div>
              <div id="doi-status" class="lookup-status"></div>
            </div>

            <!-- Clinical Trials Lookup Section -->
            <div class="form-group">
              <label>Clinical Trials Lookup</label>
              <button type="button" id="lookup-clinical-trials" class="btn btn-secondary">
                🧪 Search Clinical Trials
              </button>
              <div id="clinical-trials-status" class="lookup-status"></div>
            </div>
          </div>

          <form id="request-form" class="request-form">
            <div class="form-group">
              <label for="docline">DOCLINE Number</label>
              <input type="text" id="docline" name="docline" placeholder="e.g., DOC2025001" class="form-control">
            </div>

            <div class="form-group">
              <label for="title">Article Title</label>
              <input type="text" id="title" name="title" placeholder="Enter article title" class="form-control auto-fillable">
            </div>

            <div class="form-group">
              <label for="authors">Authors</label>
              <input type="text" id="authors" name="authors" placeholder="Smith J, Johnson A, Wilson B" class="form-control auto-fillable">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="journal">Journal</label>
                <input type="text" id="journal" name="journal" placeholder="e.g., Nature Medicine" class="form-control auto-fillable">
              </div>
              <div class="form-group">
                <label for="year">Year</label>
                <input type="number" id="year" name="year" placeholder="2024" min="1900" max="2025" class="form-control auto-fillable">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="volume">Volume</label>
                <input type="text" id="volume" name="volume" placeholder="e.g., 30" class="form-control auto-fillable">
              </div>
              <div class="form-group">
                <label for="issue">Issue</label>
                <input type="text" id="issue" name="issue" placeholder="e.g., 2" class="form-control auto-fillable">
              </div>
              <div class="form-group">
                <label for="pages">Pages</label>
                <input type="text" id="pages" name="pages" placeholder="e.g., 123-130" class="form-control auto-fillable">
              </div>
            </div>

            <div class="form-group">
              <label for="patron-email">Patron Email</label>
              <input type="email" id="patron-email" name="patronEmail" placeholder="patron@example.com" class="form-control">
            </div>

            <div class="form-group">
              <label for="priority">Priority</label>
              <select id="priority" name="priority" class="form-control priority-select">
                <option value="normal">Normal</option>
                <option value="rush">Rush</option>
                <option value="urgent">Urgent</option>
                <option value="low">Low</option>
              </select>
            </div>

            <div class="form-group">
              <label for="notes">Notes</label>
              <textarea id="notes" name="notes" rows="3" placeholder="Additional notes" class="form-control"></textarea>
            </div>

            <!-- MeSH Section (populated by API) -->
            <div id="mesh-section" class="mesh-section" style="display: none;">
              <h4>🏷️ MeSH Headings</h4>
              <div id="mesh-tags" class="mesh-tags-container"></div>
              <div class="mesh-controls">
                <label class="checkbox-label">
                  <input type="checkbox" id="auto-add-mesh" checked>
                  <span class="checkmark"></span>
                  Auto-add major topics as tags
                </label>
              </div>
            </div>

            <!-- Clinical Trials Section (populated by API) -->
            <div id="clinical-trials-section" class="clinical-trials-section" style="display: none;">
              <h4>🧪 Related Clinical Trials</h4>
              <div id="clinical-trials-list" class="clinical-trials-container"></div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Add Request</button>
              <button type="button" id="clear-form" class="btn btn-secondary">Clear Form</button>
            </div>
          </form>
        </section>

        <!-- All Requests Section -->
        <section id="all-requests" class="section">
          <h2>All Requests</h2>
          
          <!-- Search and Filter Controls -->
          <div class="search-filter-controls">
            <div class="search-container">
              <input type="text" id="search-input" placeholder="Search requests..." class="search-input">
              <button class="search-clear" id="clear-search">×</button>
            </div>
            
            <div class="filter-controls">
              <select id="status-filter" class="filter-select">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="in-progress">In Progress</option>
                <option value="fulfilled">Fulfilled</option>
                <option value="cancelled">Cancelled</option>
                <option value="on-hold">On Hold</option>
              </select>
              
              <select id="priority-filter" class="filter-select">
                <option value="">All Priority</option>
                <option value="urgent">Urgent</option>
                <option value="rush">Rush</option>
                <option value="normal">Normal</option>
                <option value="low">Low</option>
              </select>
            </div>
          </div>

          <!-- Sort and Bulk Controls -->
          <div class="table-controls">
            <div class="sort-controls">
              <span>Sort by:</span>
              <button class="sort-btn sort-desc" data-field="createdAt">📅 Date</button>
              <button class="sort-btn" data-field="priority">🚨 Priority</button>
              <button class="sort-btn" data-field="title">📄 Title</button>
              <button class="sort-btn" data-field="journal">📚 Journal</button>
              <button class="sort-btn" data-field="status">📊 Status</button>
            </div>
            <div class="results-info">
              <span id="results-count">0 requests</span>
              <label class="select-all-label">
                <input type="checkbox" id="select-all" onchange="toggleSelectAll(this.checked)"> Select All
              </label>
              <button onclick="deleteSelectedRequests()" class="btn btn-danger btn-small" id="delete-selected-btn" style="display: none;">
                🗑️ Delete Selected
              </button>
            </div>
          </div>

          <!-- Request List -->
          <div id="request-list" class="request-list">
            <p class="empty-message">No requests found</p>
          </div>

          <!-- Bulk Operations Section -->
          <div class="bulk-operations-section">
            <h3>📊 Bulk Operations</h3>
            
            <!-- Bulk Paste Upload -->
            <div class="bulk-paste-section">
              <h4>📥 Bulk Paste & Upload</h4>
              <p>Paste PMIDs (one per line) or upload CSV files. Automatic metadata enrichment with clinical trials data.</p>
              
              <div class="form-group">
                <label for="bulk-paste-textarea">Enter PMIDs or CSV Data</label>
                <textarea id="bulk-paste-textarea" class="form-control" rows="8" 
                  placeholder="Enter PMIDs (one per line):
16979104
32658653
33248227

Or CSV format:
PMID,DOCLINE,Status,Priority
16979104,DOC2025001,pending,normal
32658653,DOC2025002,in-progress,rush"></textarea>
              </div>
              
              <div class="bulk-paste-options">
                <label class="checkbox-label">
                  <input type="checkbox" id="bulk-paste-auto-fetch" checked>
                  <span class="checkmark"></span>
                  Auto-fetch PubMed metadata
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="bulk-paste-fetch-trials" checked>
                  <span class="checkmark"></span>
                  Include clinical trials data
                </label>
              </div>
              
              <button id="bulk-paste-btn" class="btn btn-primary">
                🚀 Process Bulk Data
              </button>
              
              <div id="bulk-paste-status" class="bulk-upload-status"></div>
            </div>

            <!-- CSV File Upload -->
            <div class="csv-upload-section">
              <h4>📁 CSV File Upload</h4>
              <input type="file" id="csv-file-input" accept=".csv" class="file-input">
              <button id="upload-csv-btn" class="btn btn-primary">Upload CSV</button>
              <div id="csv-upload-status" class="bulk-upload-status"></div>
            </div>
          </div>
        </section>

        <!-- Import/Export Section -->
        <section id="import-export" class="section">
          <h2>Import/Export</h2>
          
          <div class="import-export-grid">
            <!-- Import Card -->
            <div class="import-export-card">
              <h3>
                <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14,2 14,8 20,8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                Import Data
              </h3>
              
              <div class="button-group">
                <button class="btn btn-primary" id="import-csv">Import CSV</button>
                <button class="btn btn-primary" id="import-json">Import JSON</button>
              </div>
              
              <input type="file" id="import-file" accept=".csv,.json" class="file-input" style="display: none;">
              
              <div id="import-status" class="import-status"></div>
            </div>

            <!-- Export Card -->
            <div class="import-export-card">
              <h3>
                <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14,2 14,8 20,8"></polyline>
                  <line x1="12" y1="15" x2="8" y2="11"></line>
                  <line x1="12" y1="15" x2="16" y2="11"></line>
                </svg>
                Export Data
              </h3>
              
              <div class="button-group">
                <button class="btn btn-success" id="export-csv">Export CSV</button>
                <button class="btn btn-success" id="export-json">Export JSON</button>
                <button class="btn btn-success" id="export-nlm">Export NLM</button>
              </div>
              
              <div class="export-info">
                <p>Export formats include complete metadata, MeSH terms, and clinical trial information.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
          <h2>Settings</h2>
          
          <div class="settings-form">
            <div class="form-group">
              <label for="theme-select">Theme</label>
              <select id="theme-select">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
                <option value="high-contrast">High Contrast</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="ncbi-api-key">NCBI API Key (Optional)</label>
              <input type="password" id="ncbi-api-key" placeholder="Enter API key for higher rate limits">
              <small class="form-help">Without API key: 3 requests/second. With API key: 10 requests/second.</small>
            </div>
            
            <div class="form-actions">
              <button type="button" id="save-settings" class="btn btn-primary">Save Settings</button>
              <button type="button" id="reset-settings" class="btn btn-secondary">Reset to Defaults</button>
              <button type="button" id="clear-all-data" class="btn btn-danger">Clear All Data</button>
            </div>
          </div>

          <!-- Performance Section -->
          <div class="performance-stats">
            <h4>Performance Statistics</h4>
            <div id="performance-metrics">
              <div class="storage-info">

            <div class="settings-group">
              <h3>Help & Support</h3>
              <div class="setting-item">
                <button id="show-help" class="btn btn-secondary">📖 Show Help</button>
                <button id="show-diagnostics" class="btn btn-secondary">🔍 System Diagnostics</button>
                <small>Access integrated help and system health information.</small>
              </div>
            </div>
                <h4>Storage Usage</h4>
                <div id="storage-breakdown"></div>
              </div>
            </div>
          </div>

          <!-- Diagnostics Section -->
          <div class="form-actions">
            <button type="button" id="show-diagnostics" class="btn btn-secondary">Show Diagnostics</button>
            <button type="button" id="export-diagnostics" class="btn btn-secondary">Export Health Report</button>
          </div>
        </section>

      </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="modal-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p id="loading-message">Loading...</p>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-container" style="display: none;">
      <div class="modal-overlay">
        <div class="modal-panel">
          <div class="modal-header">
            <h3>📖 SilentStacks Help</h3>
            <button class="modal-close" onclick="closeHelpModal()">×</button>
          </div>
          <div class="modal-content">
            <div class="help-search">
              <input type="text" id="help-search-input" placeholder="Search help topics..." class="form-control">
            </div>
            <div class="help-topics">
              <div class="help-topic">
                <h4>Adding Requests</h4>
                <p>Enter a PMID or DOI and click "Lookup" to automatically fetch metadata, MeSH terms, and clinical trials data.</p>
              </div>
              <div class="help-topic">
                <h4>Bulk Upload</h4>
                <p>Go to "All Requests" and use the bulk operations section to paste PMIDs or upload CSV files with automatic enrichment.</p>
              </div>
              <div class="help-topic">
                <h4>Clinical Trials</h4>
                <p>The system automatically searches for related clinical trials and displays trial phases, status, and enrollment data.</p>
              </div>
              <div class="help-topic">
                <h4>MeSH Headings</h4>
                <p>Medical Subject Headings are automatically extracted from PubMed and can be clicked to add as tags.</p>
              </div>
              <div class="help-topic">
                <h4>Search & Filter</h4>
                <p>Use the search box for fuzzy text search. Filter by status, priority, or click MeSH tags to filter by medical topics.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- External Dependencies -->
  <script src="assets/js/fuse.min.js"></script>
  <script src="assets/js/papaparse.min.js"></script>

  <!-- Complete Functional Implementation -->
  <script>
    // ===== CORE SYSTEM =====
    class SilentStacksApp {
      constructor() {
        this.requests = JSON.parse(localStorage.getItem('silentStacks_requests') || '[]');
        this.settings = JSON.parse(localStorage.getItem('silentStacks_settings') || '{}');
        this.offlineQueue = JSON.parse(localStorage.getItem('silentStacks_offlineQueue') || '[]');
        this.selectedRequests = new Set();
        this.currentSection = 'dashboard';
        this.searchIndex = null;
        this.isOnline = navigator.onLine;
        this.apiRetryCount = new Map();
        this.virtualScrollContainer = null;
        this.virtualScrollData = [];
        this.virtualScrollItemHeight = 120;
        this.virtualScrollVisibleItems = 10;
        
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.initializeSearch();
        this.setupVirtualScrolling();
        this.setupOfflineHandling();
        this.loadTheme();
        this.updateDashboard();
        this.processOfflineQueue();
        
        console.log('🚀 SilentStacks fully loaded - Conference ready!');
      }

      // ===== VIRTUAL SCROLLING =====
      setupVirtualScrolling() {
        const requestList = document.getElementById('request-list');
        if (!requestList) return;

        this.virtualScrollContainer = requestList;
        this.virtualScrollContainer.style.position = 'relative';
        this.virtualScrollContainer.style.overflow = 'auto';
        this.virtualScrollContainer.style.height = '400px';

        this.virtualScrollContainer.addEventListener('scroll', this.debounce(() => {
          this.renderVirtualItems();
        }, 16)); // 60fps
      }

      renderVirtualItems() {
        if (!this.virtualScrollData.length) return;

        const scrollTop = this.virtualScrollContainer.scrollTop;
        const containerHeight = this.virtualScrollContainer.clientHeight;
        
        const startIndex = Math.floor(scrollTop / this.virtualScrollItemHeight);
        const endIndex = Math.min(
          startIndex + Math.ceil(containerHeight / this.virtualScrollItemHeight) + 2,
          this.virtualScrollData.length
        );

        // Clear existing items
        this.virtualScrollContainer.innerHTML = '';

        // Create spacer for items above viewport
        if (startIndex > 0) {
          const topSpacer = document.createElement('div');
          topSpacer.style.height = `${startIndex * this.virtualScrollItemHeight}px`;
          this.virtualScrollContainer.appendChild(topSpacer);
        }

        // Render visible items
        for (let i = startIndex; i < endIndex; i++) {
          const item = this.virtualScrollData[i];
          if (item) {
            const element = this.createRequestElement(item, i);
            this.virtualScrollContainer.appendChild(element);
          }
        }

        // Create spacer for items below viewport
        const remainingItems = this.virtualScrollData.length - endIndex;
        if (remainingItems > 0) {
          const bottomSpacer = document.createElement('div');
          bottomSpacer.style.height = `${remainingItems * this.virtualScrollItemHeight}px`;
          this.virtualScrollContainer.appendChild(bottomSpacer);
        }
      }

      // ===== DEBOUNCED SEARCH =====
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      initializeSearch() {
        const searchInput = document.getElementById('search-input');
        if (!searchInput) return;

        // Debounced search with 300ms delay
        const debouncedSearch = this.debounce((query) => {
          this.performSearch(query);
        }, 300);

        searchInput.addEventListener('input', (e) => {
          debouncedSearch(e.target.value);
        });

        // Initialize Fuse.js for fuzzy search
        if (typeof Fuse !== 'undefined') {
          this.searchIndex = new Fuse(this.requests, {
            keys: ['title', 'authors', 'journal', 'notes', 'tags'],
            threshold: 0.3,
            includeScore: true
          });
        }
      }

      performSearch(query) {
        if (!query.trim()) {
          this.displayRequests(this.requests);
          return;
        }

        let results = [];
        if (this.searchIndex) {
          const searchResults = this.searchIndex.search(query);
          results = searchResults.map(result => result.item);
        } else {
          // Fallback search
          results = this.requests.filter(req => 
            Object.values(req).some(value => 
              String(value).toLowerCase().includes(query.toLowerCase())
            )
          );
        }

        this.displayRequests(results);
        document.getElementById('results-count').textContent = `${results.length} requests`;
      }

      // ===== API WITH RETRY & EXPONENTIAL BACKOFF =====
      async apiCall(url, options = {}, retryKey = null) {
        const maxRetries = 3;
        const baseDelay = 1000; // 1 second
        
        if (!this.isOnline) {
          this.addToOfflineQueue({ url, options, retryKey });
          throw new Error('Offline - request queued');
        }

        const currentRetry = this.apiRetryCount.get(retryKey) || 0;
        
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
          
          const response = await fetch(url, {
            ...options,
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            if (response.status === 429) { // Rate limited
              throw new Error('Rate limited');
            }
            throw new Error(`HTTP ${response.status}`);
          }
          
          // Success - reset retry count
          this.apiRetryCount.delete(retryKey);
          return response;
          
        } catch (error) {
          if (currentRetry < maxRetries) {
            // Exponential backoff: 1s, 2s, 4s
            const delay = baseDelay * Math.pow(2, currentRetry);
            const jitter = Math.random() * 1000; // Add jitter
            
            this.apiRetryCount.set(retryKey, currentRetry + 1);
            
            console.log(`🔄 Retry ${currentRetry + 1}/${maxRetries} for ${retryKey} in ${delay + jitter}ms`);
            
            await new Promise(resolve => setTimeout(resolve, delay + jitter));
            return this.apiCall(url, options, retryKey);
          }
          
          // Max retries exceeded
          this.apiRetryCount.delete(retryKey);
          this.showUserFriendlyError(`Failed to fetch data: ${error.message}`);
          throw error;
        }
      }

      // ===== PUBMED API WITH LAZY LOADING =====
      async fetchPubMedData(pmid) {
        const cacheKey = `pubmed_${pmid}`;
        const cached = localStorage.getItem(cacheKey);
        
        if (cached) {
          const data = JSON.parse(cached);
          // Check if cache is less than 24 hours old
          if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
            return data.result;
          }
        }

        try {
          const url = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${pmid}&retmode=xml`;
          const response = await this.apiCall(url, {}, `pubmed_${pmid}`);
          const xmlText = await response.text();
          
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
          
          const article = this.parsePubMedXML(xmlDoc);
          
          // Cache the result
          localStorage.setItem(cacheKey, JSON.stringify({
            result: article,
            timestamp: Date.now()
          }));
          
          return article;
          
        } catch (error) {
          console.error('PubMed fetch failed:', error);
          return null;
        }
      }

      parsePubMedXML(xmlDoc) {
        const article = xmlDoc.querySelector('PubmedArticle');
        if (!article) return null;

        const title = article.querySelector('ArticleTitle')?.textContent || '';
        const journal = article.querySelector('Title')?.textContent || '';
        const year = article.querySelector('PubDate Year')?.textContent || '';
        
        const authors = Array.from(article.querySelectorAll('Author')).map(author => {
          const lastName = author.querySelector('LastName')?.textContent || '';
          const foreName = author.querySelector('ForeName')?.textContent || '';
          return `${lastName} ${foreName}`.trim();
        }).join(', ');

        // Extract MeSH terms
        const meshTerms = Array.from(article.querySelectorAll('MeshHeading')).map(mesh => {
          const descriptor = mesh.querySelector('DescriptorName')?.textContent || '';
          const isMajor = mesh.querySelector('DescriptorName')?.getAttribute('MajorTopicYN') === 'Y';
          return { term: descriptor, major: isMajor };
        });

        return {
          title,
          authors,
          journal,
          year,
          meshTerms
        };
      }

      // ===== LAZY LOADING FOR CLINICAL TRIALS =====
      async lazyLoadClinicalTrials(pmid) {
        // Only load when user expands the clinical trials section
        const trialsSection = document.querySelector(`[data-pmid="${pmid}"] .clinical-trials-section`);
        if (!trialsSection) return;

        if (trialsSection.dataset.loaded === 'true') return;

        try {
          trialsSection.innerHTML = '<div class="loading">🔄 Loading clinical trials...</div>';
          
          // Simulate clinical trials API call
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          const mockTrials = [
            { nct: 'NCT12345678', title: 'Phase II Trial of Novel Therapy', status: 'Recruiting' },
            { nct: 'NCT87654321', title: 'Randomized Controlled Trial', status: 'Completed' }
          ];
          
          trialsSection.innerHTML = mockTrials.map(trial => `
            <div class="trial-card">
              <strong>${trial.nct}</strong>: ${trial.title}
              <span class="status ${trial.status.toLowerCase()}">${trial.status}</span>
            </div>
          `).join('');
          
          trialsSection.dataset.loaded = 'true';
          
        } catch (error) {
          trialsSection.innerHTML = '<div class="error">Failed to load clinical trials</div>';
        }
      }

      // ===== OFFLINE QUEUE MANAGEMENT =====
      addToOfflineQueue(request) {
        this.offlineQueue.push({
          ...request,
          timestamp: Date.now(),
          id: Date.now() + Math.random()
        });
        this.saveOfflineQueue();
        this.showUserFriendlyError('Request queued for when online');
      }

      async processOfflineQueue() {
        if (!this.isOnline || this.offlineQueue.length === 0) return;

        console.log(`📡 Processing ${this.offlineQueue.length} queued requests...`);
        
        const queue = [...this.offlineQueue];
        this.offlineQueue = [];
        this.saveOfflineQueue();

        for (const request of queue) {
          try {
            await this.apiCall(request.url, request.options, request.retryKey);
            console.log('✅ Processed queued request:', request.retryKey);
          } catch (error) {
            console.error('❌ Failed to process queued request:', error);
            // Re-queue if it failed
            this.offlineQueue.push(request);
          }
        }

        this.saveOfflineQueue();
      }

      saveOfflineQueue() {
        localStorage.setItem('silentStacks_offlineQueue', JSON.stringify(this.offlineQueue));
      }

      setupOfflineHandling() {
        window.addEventListener('online', () => {
          this.isOnline = true;
          this.updateConnectionStatus();
          this.processOfflineQueue();
        });

        window.addEventListener('offline', () => {
          this.isOnline = false;
          this.updateConnectionStatus();
        });
      }

      updateConnectionStatus() {
        const indicator = document.getElementById('connection-status');
        const text = document.getElementById('connection-text');
        
        if (this.isOnline) {
          indicator.className = 'connection-indicator connection-clean';
          text.textContent = '●';
        } else {
          indicator.className = 'connection-indicator offline';
          text.textContent = '⚠ Offline';
        }
      }

      // ===== ERROR BOUNDARIES & USER-FRIENDLY MESSAGES =====
      showUserFriendlyError(message, type = 'error') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
          <div class="toast-content">
            <span class="toast-icon">${type === 'error' ? '⚠️' : 'ℹ️'}</span>
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
          </div>
        `;
        
        // Add toast styles if not exist
        if (!document.querySelector('.toast-styles')) {
          const style = document.createElement('style');
          style.className = 'toast-styles';
          style.textContent = `
            .toast {
              position: fixed;
              top: 20px;
              right: 20px;
              background: white;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              z-index: 10000;
              animation: slideIn 0.3s ease;
              max-width: 400px;
            }
            .toast-error { border-left: 4px solid #e74c3c; }
            .toast-info { border-left: 4px solid #3498db; }
            .toast-content {
              display: flex;
              align-items: center;
              padding: 15px;
              gap: 10px;
            }
            .toast-message { flex: 1; }
            .toast-close {
              background: none;
              border: none;
              font-size: 18px;
              cursor: pointer;
              padding: 0;
              width: 24px;
              height: 24px;
            }
            @keyframes slideIn {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.appendChild(toast);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 5000);
      }

      // ===== REQUEST MANAGEMENT =====
      createRequestElement(request, index) {
        const element = document.createElement('div');
        element.className = 'request-card';
        element.style.height = `${this.virtualScrollItemHeight}px`;
        element.dataset.index = index;
        
        const isSelected = this.selectedRequests.has(request.id);
        if (isSelected) element.classList.add('selected');
        
        element.innerHTML = `
          <div class="request-header">
            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                   onchange="app.toggleRequestSelection('${request.id}', this.checked)">
            <h3>${this.escapeHtml(request.title || 'Untitled Request')}</h3>
            <span class="priority priority-${request.priority || 'normal'}">${request.priority || 'normal'}</span>
          </div>
          <div class="request-details">
            <p><strong>Authors:</strong> ${this.escapeHtml(request.authors || 'Unknown')}</p>
            <p><strong>Journal:</strong> ${this.escapeHtml(request.journal || 'Unknown')} (${request.year || 'Unknown'})</p>
            ${request.pmid ? `<p><strong>PMID:</strong> ${request.pmid}</p>` : ''}
            ${request.doi ? `<p><strong>DOI:</strong> ${request.doi}</p>` : ''}
          </div>
          <div class="request-actions">
            <button onclick="app.editRequest('${request.id}')" class="btn btn-secondary">Edit</button>
            <button onclick="app.deleteRequest('${request.id}')" class="btn btn-danger">Delete</button>
            ${request.pmid ? `<button onclick="app.lazyLoadClinicalTrials('${request.pmid}')" class="btn btn-primary">Clinical Trials</button>` : ''}
          </div>
          ${request.pmid ? `<div class="clinical-trials-section" data-pmid="${request.pmid}"></div>` : ''}
        `;
        
        return element;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      displayRequests(requests) {
        this.virtualScrollData = requests;
        if (requests.length > 50) {
          // Use virtual scrolling for large datasets
          this.renderVirtualItems();
        } else {
          // Regular rendering for small datasets
          const container = this.virtualScrollContainer;
          container.innerHTML = '';
          requests.forEach((request, index) => {
            container.appendChild(this.createRequestElement(request, index));
          });
        }
      }

      toggleRequestSelection(id, selected) {
        if (selected) {
          this.selectedRequests.add(id);
        } else {
          this.selectedRequests.delete(id);
        }
        this.updateSelectionUI();
      }

      updateSelectionUI() {
        const count = this.selectedRequests.size;
        const deleteBtn = document.getElementById('delete-selected-btn');
        if (deleteBtn) {
          deleteBtn.style.display = count > 0 ? 'block' : 'none';
          deleteBtn.textContent = `🗑️ Delete Selected (${count})`;
        }
      }

      // ===== FORM HANDLING =====
      async handleFormSubmit(event) {
        event.preventDefault();
        
        try {
          const formData = new FormData(event.target);
          const request = {
            id: Date.now().toString(),
            title: formData.get('title'),
            authors: formData.get('authors'),
            journal: formData.get('journal'),
            year: formData.get('year'),
            pmid: formData.get('pmid'),
            doi: formData.get('doi'),
            priority: formData.get('priority'),
            status: 'pending',
            createdAt: new Date().toISOString(),
            notes: formData.get('notes')
          };

          // Auto-fetch metadata if PMID provided
          if (request.pmid && !request.title) {
            this.showUserFriendlyError('Fetching metadata...', 'info');
            const metadata = await this.fetchPubMedData(request.pmid);
            if (metadata) {
              request.title = metadata.title;
              request.authors = metadata.authors;
              request.journal = metadata.journal;
              request.year = metadata.year;
              request.meshTerms = metadata.meshTerms;
            }
          }

          this.requests.push(request);
          this.saveRequests();
          this.updateSearchIndex();
          this.updateDashboard();
          
          event.target.reset();
          this.showUserFriendlyError('Request added successfully!', 'info');
          
        } catch (error) {
          this.showUserFriendlyError(`Failed to add request: ${error.message}`);
        }
      }

      // ===== BULK OPERATIONS =====
      async handleBulkImport(data) {
        const batchSize = 50; // Process in batches to avoid blocking UI
        const total = data.length;
        let processed = 0;

        this.showUserFriendlyError(`Processing ${total} items in batches...`, 'info');

        for (let i = 0; i < data.length; i += batchSize) {
          const batch = data.slice(i, i + batchSize);
          
          for (const item of batch) {
            try {
              const request = {
                id: Date.now().toString() + Math.random(),
                ...item,
                status: item.status || 'pending',
                createdAt: new Date().toISOString()
              };
              
              this.requests.push(request);
              processed++;
              
            } catch (error) {
              console.error('Failed to process item:', item, error);
            }
          }
          
          // Update progress and yield to browser
          const progress = Math.round((processed / total) * 100);
          this.showUserFriendlyError(`Processed ${processed}/${total} items (${progress}%)`, 'info');
          
          await new Promise(resolve => setTimeout(resolve, 10)); // Yield to browser
        }

        this.saveRequests();
        this.updateSearchIndex();
        this.updateDashboard();
        this.showUserFriendlyError(`Successfully imported ${processed} requests!`, 'info');
      }

      // ===== DATA PERSISTENCE =====
      saveRequests() {
        localStorage.setItem('silentStacks_requests', JSON.stringify(this.requests));
      }

      updateSearchIndex() {
        if (typeof Fuse !== 'undefined') {
          this.searchIndex = new Fuse(this.requests, {
            keys: ['title', 'authors', 'journal', 'notes', 'tags'],
            threshold: 0.3,
            includeScore: true
          });
        }
      }

      // ===== UI UPDATES =====
      updateDashboard() {
        const total = this.requests.length;
        const pending = this.requests.filter(r => r.status === 'pending').length;
        const completed = this.requests.filter(r => r.status === 'fulfilled').length;
        const urgent = this.requests.filter(r => r.priority === 'urgent').length;

        document.getElementById('total-requests').textContent = total;
        document.getElementById('pending-requests').textContent = pending;
        document.getElementById('completed-requests').textContent = completed;
        document.getElementById('urgent-requests').textContent = urgent;

        // Show recent requests
        const recent = this.requests.slice(-5).reverse();
        const recentContainer = document.getElementById('recent-requests');
        if (recent.length > 0) {
          recentContainer.innerHTML = recent.map(req => `
            <div class="request-summary">
              <strong>${this.escapeHtml(req.title || 'Untitled')}</strong>
              <span class="status">${req.status}</span>
            </div>
          `).join('');
        }
      }

      // ===== THEME MANAGEMENT =====
      loadTheme() {
        const theme = this.settings.theme || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        const themeSelect = document.getElementById('theme-select');
        if (themeSelect) themeSelect.value = theme;
      }

      changeTheme(theme) {
        this.settings.theme = theme;
        localStorage.setItem('silentStacks_settings', JSON.stringify(this.settings));
        document.documentElement.setAttribute('data-theme', theme);
      }

      // ===== EVENT LISTENERS =====
      setupEventListeners() {
        // Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const section = e.target.dataset.section;
            this.showSection(section);
          });
        });

        // Theme selector
        const themeSelect = document.getElementById('theme-select');
        if (themeSelect) {
          themeSelect.addEventListener('change', (e) => {
            this.changeTheme(e.target.value);
          });
        }

        // Form submission
        const requestForm = document.getElementById('request-form');
        if (requestForm) {
          requestForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
        }

        // PMID/DOI lookup buttons
        document.getElementById('lookup-pmid')?.addEventListener('click', () => {
          const pmid = document.getElementById('pmid').value;
          if (pmid) this.lookupPMID(pmid);
        });

        document.getElementById('lookup-doi')?.addEventListener('click', () => {
          const doi = document.getElementById('doi').value;
          if (doi) this.lookupDOI(doi);
        });

        // Bulk operations
        document.getElementById('bulk-paste-btn')?.addEventListener('click', () => {
          this.handleBulkPaste();
        });

        document.getElementById('upload-csv-btn')?.addEventListener('click', () => {
          const fileInput = document.getElementById('csv-file-input');
          if (fileInput.files[0]) {
            this.handleCSVUpload(fileInput.files[0]);
          }
        });

        // Export buttons
        document.getElementById('export-csv')?.addEventListener('click', () => {
          this.exportData('csv');
        });

        document.getElementById('export-json')?.addEventListener('click', () => {
          this.exportData('json');
        });

        // Help button
        document.getElementById('help-button')?.addEventListener('click', () => {
          this.showHelp();
        });

        // Global error handler
        window.addEventListener('error', (event) => {
          console.error('Global error:', event.error);
          this.showUserFriendlyError('An unexpected error occurred. Please try again.');
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
          console.error('Unhandled promise rejection:', event.reason);
          this.showUserFriendlyError('A network or processing error occurred.');
          event.preventDefault();
        });
      }

      // ===== LOOKUP FUNCTIONS =====
      async lookupPMID(pmid) {
        const statusEl = document.getElementById('pmid-status');
        statusEl.textContent = '🔄 Looking up...';
        
        try {
          const metadata = await this.fetchPubMedData(pmid);
          if (metadata) {
            // Auto-fill form
            document.getElementById('title').value = metadata.title || '';
            document.getElementById('authors').value = metadata.authors || '';
            document.getElementById('journal').value = metadata.journal || '';
            document.getElementById('year').value = metadata.year || '';
            
            statusEl.textContent = '✅ Metadata retrieved';
            statusEl.style.color = 'var(--success-color)';
          } else {
            statusEl.textContent = '❌ No data found';
            statusEl.style.color = 'var(--danger-color)';
          }
        } catch (error) {
          statusEl.textContent = '❌ Lookup failed';
          statusEl.style.color = 'var(--danger-color)';
        }
      }

      async lookupDOI(doi) {
        const statusEl = document.getElementById('doi-status');
        statusEl.textContent = '🔄 Looking up...';
        
        try {
          const url = `https://api.crossref.org/works/${encodeURIComponent(doi)}`;
          const response = await this.apiCall(url, {}, `doi_${doi}`);
          const data = await response.json();
          
          if (data.message) {
            const work = data.message;
            document.getElementById('title').value = work.title?.[0] || '';
            document.getElementById('journal').value = work['container-title']?.[0] || '';
            document.getElementById('year').value = work.published?.['date-parts']?.[0]?.[0] || '';
            
            if (work.author) {
              const authors = work.author.map(a => `${a.family} ${a.given || ''}`).join(', ');
              document.getElementById('authors').value = authors;
            }
            
            statusEl.textContent = '✅ Metadata retrieved';
            statusEl.style.color = 'var(--success-color)';
          }
        } catch (error) {
          statusEl.textContent = '❌ Lookup failed';
          statusEl.style.color = 'var(--danger-color)';
        }
      }

      // ===== BULK OPERATIONS =====
      handleBulkPaste() {
        const textarea = document.getElementById('bulk-paste-textarea');
        const content = textarea.value.trim();
        
        if (!content) {
          this.showUserFriendlyError('Please enter some data to import');
          return;
        }

        try {
          // Try to parse as CSV first
          if (typeof Papa !== 'undefined') {
            const parsed = Papa.parse(content, { header: true, skipEmptyLines: true });
            if (parsed.data && parsed.data.length > 0) {
              this.handleBulkImport(parsed.data);
              return;
            }
          }

          // Try as line-separated PMIDs
          const lines = content.split('\n').map(line => line.trim()).filter(line => line);
          const pmids = lines.filter(line => /^\d+$/.test(line));
          
          if (pmids.length > 0) {
            const requests = pmids.map(pmid => ({ pmid, title: '', status: 'pending' }));
            this.handleBulkImport(requests);
          } else {
            this.showUserFriendlyError('No valid data found. Please check format.');
          }
          
        } catch (error) {
          this.showUserFriendlyError(`Import failed: ${error.message}`);
        }
      }

      async handleCSVUpload(file) {
        if (typeof Papa === 'undefined') {
          this.showUserFriendlyError('CSV parser not available');
          return;
        }

        try {
          const text = await file.text();
          const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
          
          if (parsed.errors.length > 0) {
            console.warn('CSV parsing errors:', parsed.errors);
          }
          
          if (parsed.data && parsed.data.length > 0) {
            await this.handleBulkImport(parsed.data);
          } else {
            this.showUserFriendlyError('No valid data found in CSV file');
          }
          
        } catch (error) {
          this.showUserFriendlyError(`CSV upload failed: ${error.message}`);
        }
      }

      // ===== EXPORT FUNCTIONS =====
      exportData(format) {
        try {
          let content, filename, mimeType;
          
          if (format === 'csv') {
            if (typeof Papa !== 'undefined') {
              content = Papa.unparse(this.requests);
              filename = `silentstacks_export_${new Date().toISOString().split('T')[0]}.csv`;
              mimeType = 'text/csv';
            } else {
              throw new Error('CSV export not available');
            }
          } else if (format === 'json') {
            content = JSON.stringify(this.requests, null, 2);
            filename = `silentstacks_export_${new Date().toISOString().split('T')[0]}.json`;
            mimeType = 'application/json';
          }
          
          const blob = new Blob([content], { type: mimeType });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          this.showUserFriendlyError(`Exported ${this.requests.length} requests as ${format.toUpperCase()}`, 'info');
          
        } catch (error) {
          this.showUserFriendlyError(`Export failed: ${error.message}`);
        }
      }

      // ===== NAVIGATION =====
      showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
          section.classList.remove('active');
        });
        
        // Show target section
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.add('active');
        }
        
        // Update nav tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.classList.remove('active');
          tab.setAttribute('aria-selected', 'false');
        });
        
        const activeTab = document.querySelector(`[data-section="${sectionId}"]`);
        if (activeTab) {
          activeTab.classList.add('active');
          activeTab.setAttribute('aria-selected', 'true');
        }
        
        this.currentSection = sectionId;
        
        // Load section-specific data
        if (sectionId === 'all-requests') {
          this.displayRequests(this.requests);
          document.getElementById('results-count').textContent = `${this.requests.length} requests`;
        }
      }

      // ===== HELP SYSTEM =====
      showHelp() {
        const helpModal = document.getElementById('help-modal');
        if (helpModal) {
          helpModal.style.display = 'block';
        }
      }

      // ===== UTILITY FUNCTIONS =====
      editRequest(id) {
        const request = this.requests.find(r => r.id === id);
        if (request) {
          // Switch to add request form and populate it
          this.showSection('add-request');
          
          // Populate form fields
          Object.keys(request).forEach(key => {
            const field = document.getElementById(key);
            if (field) field.value = request[key] || '';
          });
          
          // Store editing ID for update instead of create
          document.getElementById('request-form').dataset.editingId = id;
        }
      }

      deleteRequest(id) {
        if (confirm('Are you sure you want to delete this request?')) {
          this.requests = this.requests.filter(r => r.id !== id);
          this.saveRequests();
          this.updateSearchIndex();
          this.updateDashboard();
          this.displayRequests(this.requests);
          this.showUserFriendlyError('Request deleted', 'info');
        }
      }
    }

    // ===== GLOBAL FUNCTIONS =====
    function toggleSelectAll(checked) {
      const checkboxes = document.querySelectorAll('.request-card input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = checked;
        const requestId = cb.closest('.request-card').dataset.requestId;
        if (requestId) {
          app.toggleRequestSelection(requestId, checked);
        }
      });
    }

    function deleteSelectedRequests() {
      const selectedIds = Array.from(app.selectedRequests);
      if (selectedIds.length === 0) {
        app.showUserFriendlyError('No requests selected');
        return;
      }
      
      if (confirm(`Delete ${selectedIds.length} selected requests?`)) {
        app.requests = app.requests.filter(r => !selectedIds.includes(r.id));
        app.selectedRequests.clear();
        app.saveRequests();
        app.updateSearchIndex();
        app.updateDashboard();
        app.displayRequests(app.requests);
        app.updateSelectionUI();
        app.showUserFriendlyError(`Deleted ${selectedIds.length} requests`, 'info');
      }
    }

    function closeHelpModal() {
      const helpModal = document.getElementById('help-modal');
      if (helpModal) {
        helpModal.style.display = 'none';
      }
    }

    // ===== INITIALIZE APP =====
    let app;
    
    document.addEventListener('DOMContentLoaded', () => {
      app = new SilentStacksApp();
      
      // Make app globally available for onclick handlers
      window.app = app;
      window.toggleSelectAll = toggleSelectAll;
      window.deleteSelectedRequests = deleteSelectedRequests;
      window.closeHelpModal = closeHelpModal;
    });

    // ===== SERVICE WORKER REGISTRATION =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('✅ Service Worker registered');
          })
          .catch(error => {
            console.log('❌ Service Worker registration failed:', error);
          });
      });
    }
  </script>

  <!-- Register service worker with correct GitHub Pages scope -->
  <script>
  (function () {
    if (!('serviceWorker' in navigator)) return;
    // e.g. /SilentStacksTest
    const base = location.pathname.split('/').slice(0, 2).join('/') || '';
    navigator.serviceWorker.register(`${base}/service-worker.js`, { scope: `${base}/` })
      .catch(console.error);
  })();
  </script>

  <!-- Initialize Application -->
  <script>
    // Global state initialization
    window.SilentStacks = window.SilentStacks || {};
    window.SilentStacks.state = window.SilentStacks.state || {
      selectedRequests: new Set(),
      currentTheme: 'light',
      isOnline: navigator.onLine
    };

    // Connection monitoring
    function updateConnectionStatus() {
      const isOnline = navigator.onLine;
      window.SilentStacks.state.isOnline = isOnline;
      
      const indicator = document.getElementById('connection-status');
      const text = document.getElementById('connection-text');
      
      if (indicator && text) {
        if (isOnline) {
          indicator.className = 'connection-indicator connection-clean';
          text.textContent = '●';
        } else {
          indicator.className = 'connection-indicator offline';
          text.textContent = '⚠ Offline';
        }
      }
      
      window.SilentStacks?.core?.eventBus?.emit('connection:changed', { isOnline });
    }

    // Set up connection monitoring
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    updateConnectionStatus();

    // Performance monitoring
    function monitorPerformance() {
      if (performance.memory) {
        const usedMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
        
        // Warn at 400MB
        if (usedMB > 400) {
          console.warn(`⚠️ High memory usage: ${usedMB}MB`);
          window.SilentStacks?.core?.eventBus?.emit('performance:warning', { memoryMB: usedMB });
        }
        
        // Critical at 600MB
        if (usedMB > 600) {
          console.error(`🚨 Critical memory usage: ${usedMB}MB`);
          window.SilentStacks?.core?.eventBus?.emit('performance:critical', { memoryMB: usedMB });
        }
      }
    }

    // Monitor every 30 seconds
    setInterval(monitorPerformance, 30000);

    console.log('🚀 SilentStacks v2.0 - Security & Performance Ready');
  </script>
</body>
</html>