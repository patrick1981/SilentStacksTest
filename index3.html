<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SilentStacks Enhanced - API & Clinical Focus</title>
    <style>
        /* Base from v1.2 with enhancements for API features */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary-color: #0066cc;
            --secondary-color: #6c757d;
            --success-color: #228b22;
            --danger-color: #dc3545;
            --warning-color: #ff6600;
            --info-color: #17a2b8;
            --clinical-color: #8e44ad;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-muted: #868e96;
            
            --border-color: #dee2e6;
            --border-radius: 4px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --text-muted: #868e96;
            --border-color: #495057;
        }

        body {
            font-family: 'Reddit Sans', 'Inter', 'SF Pro Display', 'Segoe UI Variable', 'Segoe UI', system-ui, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Navigation - Keep v1.2 style */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding: 10px 0 0 0;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar { display: none; }

        .nav-tab {
            padding: 10px 20px;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .nav-tab:hover { color: var(--primary-color); }
        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Form - Keep v1.2 structure */
        .request-form {
            max-width: 800px;
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: flex;
            align-items: baseline;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
        }

        /* Enhanced Input with Button */
        .input-with-button {
            display: flex;
            gap: 10px;
        }

        .input-with-button.enhanced {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .input-with-button.enhanced:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
        }

        .input-with-button.enhanced input {
            flex: 1;
            border: none;
            border-radius: 0;
        }

        .input-with-button.enhanced input:focus { box-shadow: none; }

        .lookup-btn {
            border: none;
            border-radius: 0;
            margin: -2px;
            min-width: 120px;
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lookup-btn:hover {
            background: #0056b3;
        }

        .lookup-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Enhanced Cards with NCT Support */
        .request-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
        }

        .request-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .request-card.clinical-trial {
            border-left: 4px solid var(--clinical-color);
            background: linear-gradient(90deg, rgba(142, 68, 173, 0.03), var(--bg-card) 20px);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .request-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .request-meta {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .request-status-select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* NCT Clinical Trial Info */
        .clinical-info {
            background: rgba(142, 68, 173, 0.1);
            border: 1px solid var(--clinical-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
        }

        .clinical-info h4 {
            color: var(--clinical-color);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .clinical-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .clinical-item {
            display: flex;
            flex-direction: column;
        }

        .clinical-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .clinical-value {
            font-weight: 600;
            color: var(--clinical-color);
        }

        /* Batch Processing UI */
        .batch-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .batch-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .batch-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            background: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
        }

        .batch-progress {
            margin: 15px 0;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        /* Status Messages */
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: var(--border-radius);
            display: none;
        }

        .status-message.success {
            background-color: rgba(34, 139, 34, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
            display: block;
        }

        .status-message.error {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            display: block;
        }

        .status-message.loading {
            background-color: rgba(0, 102, 204, 0.1);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2rem; }
            .clinical-grid { grid-template-columns: 1fr; }
            .input-with-button { flex-direction: column; }
            .input-with-button.enhanced .lookup-btn { margin: 8px 0 0 0; }
        }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 4px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 2px;
        }

        .tag.clinical {
            background: rgba(142, 68, 173, 0.1);
            color: var(--clinical-color);
            border-color: var(--clinical-color);
        }

        /* Fieldset styling */
        .fieldset-enhanced {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: var(--bg-card);
        }

        legend {
            font-weight: 700;
            color: var(--text-primary);
            padding: 0 16px;
            font-size: 1.1rem;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Enhanced form help */
        .form-help {
            display: block;
            margin-top: 6px;
            color: var(--text-muted);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Connection status */
        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>SilentStacks Enhanced</h1>
            <p>Advanced API Integration & Clinical Trial Support</p>
        </header>

        <!-- Connection Status -->
        <div id="connection-status">🌐 Online</div>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-section="dashboard">Dashboard</button>
            <button class="nav-tab" data-section="add-request">Add Request</button>
            <button class="nav-tab" data-section="batch-pmid">Batch PMID</button>
            <button class="nav-tab" data-section="all-requests">All Requests</button>
            <button class="nav-tab" data-section="import-export">Import/Export</button>
            <button class="nav-tab" data-section="settings">Settings</button>
        </nav>

        <!-- Main Content -->
        <main>
            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <h2>Dashboard</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); text-align: center;">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Total Requests</h3>
                        <p style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color);" id="total-requests">0</p>
                    </div>
                    <div style="background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); text-align: center;">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Clinical Trials</h3>
                        <p style="font-size: 2.5rem; font-weight: 700; color: var(--clinical-color);" id="clinical-trials">0</p>
                    </div>
                    <div style="background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); text-align: center;">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Pending</h3>
                        <p style="font-size: 2.5rem; font-weight: 700; color: var(--warning-color);" id="pending-requests">0</p>
                    </div>
                    <div style="background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); text-align: center;">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Fulfilled</h3>
                        <p style="font-size: 2.5rem; font-weight: 700; color: var(--success-color);" id="fulfilled-requests">0</p>
                    </div>
                </div>
                
                <h3>Recent Requests</h3>
                <div id="recent-requests"></div>
            </section>

            <!-- Add Request -->
            <section id="add-request" class="section">
                <h2>Add New Request</h2>
                <form id="request-form" class="request-form">
                    <!-- Identifiers -->
                    <fieldset class="fieldset-enhanced">
                        <legend>Identifiers & Lookup</legend>
                        
                        <div class="form-group">
                            <label for="pmid" class="form-label">PMID (PubMed ID)</label>
                            <div class="input-with-button enhanced">
                                <input type="text" id="pmid" name="pmid" class="form-control" placeholder="e.g., 32658653" pattern="[0-9]+">
                                <button type="button" id="lookup-pmid" class="lookup-btn">🔍 Lookup</button>
                            </div>
                            <small class="form-help">Enter PubMed ID for automatic metadata retrieval</small>
                        </div>

                        <div class="form-group">
                            <label for="doi" class="form-label">DOI (Digital Object Identifier)</label>
                            <div class="input-with-button enhanced">
                                <input type="text" id="doi" name="doi" class="form-control" placeholder="e.g., 10.1038/nature12373">
                                <button type="button" id="lookup-doi" class="lookup-btn">🔗 Lookup</button>
                            </div>
                            <small class="form-help">CrossRef lookup for bibliographic metadata</small>
                        </div>

                        <div class="form-group">
                            <label for="nct-id" class="form-label">Clinical Trial ID (NCT)</label>
                            <div class="input-with-button enhanced">
                                <input type="text" id="nct-id" name="nct-id" class="form-control" placeholder="e.g., NCT04280549">
                                <button type="button" id="lookup-nct" class="lookup-btn">🧪 Lookup</button>
                            </div>
                            <small class="form-help">Clinical trial identifier for enhanced metadata</small>
                        </div>

                        <div class="form-group">
                            <label for="docline" class="form-label">DOCLINE Request Number</label>
                            <input type="text" id="docline" name="docline" class="form-control" placeholder="e.g., 138ABC123">
                            <small class="form-help">ILL tracking number for existing DOCLINE requests</small>
                        </div>
                    </fieldset>

                    <!-- Publication Details -->
                    <fieldset class="fieldset-enhanced">
                        <legend>Publication Details</legend>
                        
                        <div class="form-group">
                            <label for="title" class="form-label">Publication Title *</label>
                            <input type="text" id="title" name="title" class="form-control" required placeholder="Complete title of the requested publication">
                        </div>

                        <div class="form-group">
                            <label for="authors" class="form-label">Author(s)</label>
                            <input type="text" id="authors" name="authors" class="form-control" placeholder="Smith, J.; Johnson, A.; et al.">
                        </div>

                        <div class="form-group">
                            <label for="journal" class="form-label">Journal/Publication Source</label>
                            <input type="text" id="journal" name="journal" class="form-control" placeholder="Journal of Medical Research">
                        </div>

                        <div class="form-group">
                            <label for="year" class="form-label">Publication Year</label>
                            <input type="number" id="year" name="year" class="form-control" min="1900" max="2030" placeholder="2024">
                        </div>
                    </fieldset>

                    <!-- Request Details -->
                    <fieldset class="fieldset-enhanced">
                        <legend>Request Details</legend>
                        
                        <div class="form-group">
                            <label for="patron-email" class="form-label">Patron Email</label>
                            <input type="email" id="patron-email" name="patronEmail" class="form-control" placeholder="patron@example.com">
                        </div>

                        <div class="form-group">
                            <label for="priority" class="form-label">Priority *</label>
                            <select id="priority" name="priority" class="form-control" required>
                                <option value="">Select Priority...</option>
                                <option value="urgent">🚨 Urgent - Critical Patient Care</option>
                                <option value="rush">⚡ Rush - Expedited Timeline</option>
                                <option value="normal">📋 Normal - Standard Processing</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="status" class="form-label">Status</label>
                            <select id="status" name="status" class="form-control">
                                <option value="pending">Pending - Awaiting Processing</option>
                                <option value="in-progress">In Progress - Actively Working</option>
                                <option value="fulfilled">Fulfilled - Successfully Completed</option>
                                <option value="cancelled">Cancelled - Request Withdrawn</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="tags" class="form-label">Subject Tags</label>
                            <input type="text" id="tags" name="tags" class="form-control" placeholder="e.g., cardiology, review, systematic">
                            <small class="form-help">Enter tags separated by commas</small>
                        </div>

                        <div class="form-group">
                            <label for="notes" class="form-label">Additional Notes</label>
                            <textarea id="notes" name="notes" rows="3" class="form-control" placeholder="Any special instructions or notes..."></textarea>
                        </div>
                    </fieldset>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">💾 Save Request</button>
                        <button type="button" class="btn btn-secondary" id="clear-form">🗑️ Clear Form</button>
                    </div>
                </form>

                <div id="lookup-status" class="status-message"></div>
            </section>

            <!-- Batch PMID Processing -->
            <section id="batch-pmid" class="section">
                <h2>Batch PMID Processing</h2>
                
                <div class="batch-section">
                    <h3>📋 Paste or Upload PMID List</h3>
                    <p>Enter PMIDs separated by commas, spaces, or new lines. Empty entries will be ignored.</p>
                    
                    <div class="form-group">
                        <label for="pmid-list" class="form-label">PMID List</label>
                        <textarea id="pmid-list" class="batch-textarea" placeholder="32658653, 34226022, 35123456
                        
Or paste from Excel/CSV:
PMID
32658653
34226022
35123456

Or comma-separated: 32658653, 34226022, 35123456"></textarea>
                        <small class="form-help">Supports multiple formats: comma-separated, line-separated, or copied from Excel</small>
                    </div>

                    <div class="form-group">
                        <input type="file" id="pmid-file" accept=".txt,.csv" class="form-control">
                        <small class="form-help">Upload a text or CSV file containing PMIDs</small>
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <button type="button" class="btn btn-primary" id="process-pmids">🚀 Process PMIDs</button>
                        <button type="button" class="btn btn-secondary" id="clear-pmids">🗑️ Clear</button>
                    </div>

                    <div id="batch-progress" class="batch-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text" id="progress-text">Processing...</div>
                    </div>

                    <div id="batch-status" class="status-message"></div>
                </div>

                <div class="batch-section">
                    <h3>📊 Batch Results</h3>
                    <div id="batch-results"></div>
                </div>
            </section>

            <!-- All Requests -->
            <section id="all-requests" class="section">
                <h2>All Requests</h2>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="text" id="search-requests" placeholder="Search requests..." style="flex: 1; min-width: 250px;" class="form-control">
                    <select id="filter-status" class="form-control" style="min-width: 150px;">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="fulfilled">Fulfilled</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <select id="filter-type" class="form-control" style="min-width: 150px;">
                        <option value="">All Types</option>
                        <option value="clinical">Clinical Trials</option>
                        <option value="research">Research Articles</option>
                    </select>
                </div>
                
                <div id="request-list"></div>
            </section>

            <!-- Import/Export -->
            <section id="import-export" class="section">
                <h2>Import/Export Data</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px;">
                        <h3>📤 Export Data</h3>
                        <p>Download your requests as CSV or JSON</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                            <button id="export-csv" class="btn btn-primary">📊 Export CSV</button>
                            <button id="export-json" class="btn btn-primary">🔧 Export JSON</button>
                        </div>
                    </div>

                    <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px;">
                        <h3>📥 Import Data</h3>
                        <p>Upload CSV or JSON file with requests</p>
                        <input type="file" id="import-file" accept=".csv,.json" class="form-control" style="margin: 15px 0;">
                        <div id="import-status" class="status-message"></div>
                    </div>
                </div>
            </section>

            <!-- Settings -->
            <section id="settings" class="section">
                <h2>Settings</h2>
                
                <form id="settings-form" style="max-width: 600px;">
                    <div class="form-group">
                        <label for="followup-days" class="form-label">Follow-up Days</label>
                        <input type="number" id="followup-days" min="1" max="30" value="5" class="form-control">
                        <small class="form-help">Mark requests as needing follow-up after this many days</small>
                    </div>

                    <div class="form-group">
                        <label for="theme" class="form-label">Theme</label>
                        <select id="theme" class="form-control">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="api-key" class="form-label">PubMed API Key (Optional)</label>
                        <input type="text" id="api-key" placeholder="Enter your NCBI API key" class="form-control">
                        <small class="form-help">Provides higher rate limits for PubMed lookups</small>
                    </div>

                    <div class="form-group">
                        <label for="crossref-email" class="form-label">CrossRef Email (Optional)</label>
                        <input type="email" id="crossref-email" placeholder="your@email.com" class="form-control">
                        <small class="form-help">Enables polite pool access for DOI lookups</small>
                    </div>

                    <button type="submit" class="btn btn-primary">💾 Save Settings</button>
                </form>
            </section>
        </main>
    </div>

    <script>
        // SilentStacks Enhanced - Focus on API improvements and NCT support
        (() => {
            // State management
            let state = {
                requests: [],
                settings: {
                    followupDays: 5,
                    theme: 'light',
                    apiKey: '',
                    crossrefEmail: ''
                },
                ui: {
                    currentSection: 'dashboard',
                    isOnline: navigator.onLine
                }
            };

            // API rate limiting
            const API_DELAY = 1000; // 1 second between calls
            let lastApiCall = 0;

            // Utility functions
            const utils = {
                generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
                sanitize: (str) => str ? String(str).replace(/[<>]/g, '') : '',
                delay: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
                
                extractPMIDs: (text) => {
                    if (!text) return [];
                    
                    // Remove common headers
                    const cleanText = text.replace(/^(PMID|pmid|id)/gmi, '');
                    
                    // Extract all numbers that could be PMIDs (6-8 digits typically)
                    const pmidPattern = /\b\d{6,8}\b/g;
                    const matches = cleanText.match(pmidPattern) || [];
                    
                    // Remove duplicates and filter out invalid entries
                    return [...new Set(matches)]
                        .filter(pmid => pmid && pmid.length >= 6 && pmid.length <= 8)
                        .slice(0, 100); // Limit to 100 to prevent abuse
                },

                async respectRateLimit() {
                    const now = Date.now();
                    const timeSinceLastCall = now - lastApiCall;
                    if (timeSinceLastCall < API_DELAY) {
                        await this.delay(API_DELAY - timeSinceLastCall);
                    }
                    lastApiCall = Date.now();
                }
            };

            // Enhanced API service with better NLM formatting
            const apiService = {
                async fetchPubMed(pmid) {
                    await utils.respectRateLimit();
                    
                    try {
                        const keyParam = state.settings.apiKey ? `&api_key=${state.settings.apiKey}` : '';
                        
                        // Step 1: Get basic metadata from ESummary
                        const summaryUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${pmid}&retmode=json${keyParam}`;
                        const summaryResponse = await fetch(summaryUrl);
                        
                        if (!summaryResponse.ok) {
                            throw new Error(`PubMed API error: ${summaryResponse.status}`);
                        }
                        
                        const summaryData = await summaryResponse.json();
                        
                        if (summaryData.error || !summaryData.result[pmid]) {
                            throw new Error(`PMID ${pmid} not found`);
                        }
                        
                        const record = summaryData.result[pmid];
                        
                        // Enhanced metadata extraction with proper NLM formatting
                        const metadata = {
                            pmid: pmid,
                            title: this.cleanTitle(record.title || ''),
                            authors: this.formatAuthors(record.authors || []),
                            journal: this.formatJournal(record),
                            year: this.extractYear(record.pubdate || ''),
                            volume: record.volume || '',
                            issue: record.issue || '',
                            pages: record.pages || '',
                            doi: '',
                            abstract: '',
                            meshTerms: [],
                            publicationTypes: record.pubtype || [],
                            isoCitation: this.buildISOCitation(record)
                        };
                        
                        // Step 2: Get detailed info from EFetch for DOI, abstract, and MeSH
                        try {
                            await utils.respectRateLimit();
                            const fetchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${pmid}&retmode=xml${keyParam}`;
                            const xmlResponse = await fetch(fetchUrl);
                            
                            if (xmlResponse.ok) {
                                const xmlText = await xmlResponse.text();
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(xmlText, 'application/xml');
                                
                                // Extract DOI
                                const doiNode = doc.querySelector('ArticleId[IdType="doi"]') || 
                                               doc.querySelector('ELocationID[EIdType="doi"]');
                                if (doiNode) {
                                    metadata.doi = doiNode.textContent.trim();
                                }
                                
                                // Extract abstract
                                const abstractNode = doc.querySelector('AbstractText');
                                if (abstractNode) {
                                    metadata.abstract = abstractNode.textContent.trim();
                                }
                                
                                // Extract MeSH terms
                                const meshNodes = doc.querySelectorAll('MeshHeading DescriptorName');
                                metadata.meshTerms = Array.from(meshNodes).map(node => ({
                                    term: node.textContent.trim(),
                                    majorTopic: node.getAttribute('MajorTopicYN') === 'Y'
                                }));
                                
                                // Check for clinical trial indicators
                                metadata.isClinicalTrial = this.detectClinicalTrial(doc, metadata);
                            }
                        } catch (xmlError) {
                            console.warn('Failed to fetch detailed XML data:', xmlError);
                        }
                        
                        return metadata;
                        
                    } catch (error) {
                        console.error('PubMed fetch error:', error);
                        throw error;
                    }
                },

                async fetchCrossRef(doi) {
                    await utils.respectRateLimit();
                    
                    try {
                        const cleanDoi = doi.replace(/^(https?:\/\/)?(dx\.)?doi\.org\//, '').trim();
                        const url = `https://api.crossref.org/works/${encodeURIComponent(cleanDoi)}`;
                        
                        const headers = { 'Accept': 'application/json' };
                        if (state.settings.crossrefEmail) {
                            headers['User-Agent'] = `SilentStacks/1.0 (mailto:${state.settings.crossrefEmail})`;
                        }
                        
                        const response = await fetch(url, { headers });
                        
                        if (!response.ok) {
                            throw new Error(`DOI not found: ${cleanDoi}`);
                        }
                        
                        const data = await response.json();
                        const work = data.message;
                        
                        return {
                            doi: cleanDoi,
                            title: (work.title && work.title[0]) || '',
                            authors: this.formatCrossRefAuthors(work.author || []),
                            journal: (work['container-title'] && work['container-title'][0]) || '',
                            year: this.extractCrossRefYear(work.published),
                            volume: work.volume || '',
                            issue: work.issue || '',
                            pages: work.page || '',
                            type: work.type || '',
                            publisher: work.publisher || '',
                            issn: work.ISSN ? work.ISSN.join(', ') : '',
                            url: work.URL || `https://doi.org/${cleanDoi}`
                        };
                        
                    } catch (error) {
                        console.error('CrossRef fetch error:', error);
                        throw error;
                    }
                },

                async fetchClinicalTrial(nctId) {
                    // Mock clinical trial data - in production, would use ClinicalTrials.gov API
                    await utils.respectRateLimit();
                    
                    try {
                        // Validate NCT ID format
                        if (!/^NCT\d{8}$/i.test(nctId)) {
                            throw new Error('Invalid NCT ID format. Expected format: NCT12345678');
                        }
                        
                        // Return mock data structure
                        return {
                            nctId: nctId.toUpperCase(),
                            title: `Clinical Trial ${nctId}`,
                            briefTitle: `Study for ${nctId}`,
                            officialTitle: `Official Study Title for ${nctId}`,
                            phase: 'Phase II',
                            status: 'Recruiting',
                            studyType: 'Interventional',
                            enrollment: '500 participants (estimated)',
                            conditions: ['Cardiovascular Disease', 'Hypertension'],
                            interventions: ['Drug: Investigational Compound', 'Behavioral: Lifestyle Modification'],
                            sponsor: 'Academic Medical Center',
                            startDate: '2023-01-01',
                            completionDate: '2024-12-31',
                            primaryOutcome: 'Change in blood pressure from baseline',
                            eligibility: 'Ages 18-75, diagnosed hypertension',
                            locations: ['United States', 'Canada'],
                            isClinicalTrial: true,
                            lastUpdated: new Date().toISOString()
                        };
                        
                    } catch (error) {
                        console.error('Clinical trial fetch error:', error);
                        throw error;
                    }
                },

                // Helper methods for formatting
                cleanTitle(title) {
                    return title.replace(/\.$/, '').trim();
                },

                formatAuthors(authors) {
                    if (!Array.isArray(authors)) return '';
                    return authors.map(author => author.name || '').join('; ');
                },

                formatCrossRefAuthors(authors) {
                    if (!Array.isArray(authors)) return '';
                    return authors.map(author => {
                        const given = author.given || '';
                        const family = author.family || '';
                        return `${family}, ${given}`.replace(/, $/, '');
                    }).join('; ');
                },

                formatJournal(record) {
                    return record.fulljournalname || record.source || '';
                },

                extractYear(pubdate) {
                    if (!pubdate) return '';
                    const match = pubdate.match(/\d{4}/);
                    return match ? match[0] : '';
                },

                extractCrossRefYear(published) {
                    if (!published || !published['date-parts'] || !published['date-parts'][0]) return '';
                    return published['date-parts'][0][0].toString();
                },

                buildISOCitation(record) {
                    const authors = this.formatAuthors(record.authors || []);
                    const title = this.cleanTitle(record.title || '');
                    const journal = this.formatJournal(record);
                    const year = this.extractYear(record.pubdate || '');
                    const volume = record.volume || '';
                    const pages = record.pages || '';
                    
                    let citation = '';
                    if (authors) citation += `${authors}. `;
                    if (title) citation += `${title}. `;
                    if (journal) citation += `${journal}. `;
                    if (year) citation += `${year}`;
                    if (volume) citation += `;${volume}`;
                    if (pages) citation += `:${pages}`;
                    
                    return citation.replace(/\.\s*$/, '');
                },

                detectClinicalTrial(xmlDoc, metadata) {
                    // Check publication types for clinical trial indicators
                    const clinicalTrialTypes = [
                        'Clinical Trial',
                        'Randomized Controlled Trial',
                        'Clinical Trial, Phase I',
                        'Clinical Trial, Phase II',
                        'Clinical Trial, Phase III',
                        'Clinical Trial, Phase IV',
                        'Multicenter Study'
                    ];
                    
                    if (metadata.publicationTypes) {
                        return metadata.publicationTypes.some(type => 
                            clinicalTrialTypes.includes(type)
                        );
                    }
                    
                    // Check for NCT numbers in abstract or title
                    const fullText = `${metadata.title} ${metadata.abstract}`.toLowerCase();
                    return /nct\d{8}/.test(fullText);
                }
            };

            // Data management
            const dataManager = {
                save() {
                    try {
                        localStorage.setItem('silentstacks_enhanced_requests', JSON.stringify(state.requests));
                        localStorage.setItem('silentstacks_enhanced_settings', JSON.stringify(state.settings));
                    } catch (error) {
                        console.error('Save failed:', error);
                    }
                },

                load() {
                    try {
                        const savedRequests = localStorage.getItem('silentstacks_enhanced_requests');
                        const savedSettings = localStorage.getItem('silentstacks_enhanced_settings');
                        
                        if (savedRequests) {
                            state.requests = JSON.parse(savedRequests);
                        }
                        
                        if (savedSettings) {
                            state.settings = { ...state.settings, ...JSON.parse(savedSettings) };
                        }
                    } catch (error) {
                        console.error('Load failed:', error);
                    }
                },

                addRequest(requestData) {
                    const request = {
                        id: utils.generateId(),
                        ...requestData,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    state.requests.unshift(request);
                    this.save();
                    return request;
                },

                updateRequest(id, updates) {
                    const index = state.requests.findIndex(r => r.id === id);
                    if (index !== -1) {
                        state.requests[index] = {
                            ...state.requests[index],
                            ...updates,
                            updatedAt: new Date().toISOString()
                        };
                        this.save();
                        return state.requests[index];
                    }
                    return null;
                },

                deleteRequest(id) {
                    const index = state.requests.findIndex(r => r.id === id);
                    if (index !== -1) {
                        state.requests.splice(index, 1);
                        this.save();
                        return true;
                    }
                    return false;
                }
            };

            // UI Controller
            const uiController = {
                init() {
                    this.bindEvents();
                    this.updateTheme();
                    this.render();
                },

                bindEvents() {
                    // Navigation
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.addEventListener('click', (e) => {
                            this.switchSection(tab.dataset.section);
                        });
                    });

                    // Form submission
                    document.getElementById('request-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleFormSubmit();
                    });

                    // Lookup buttons
                    document.getElementById('lookup-pmid').addEventListener('click', () => {
                        this.handleLookup('pmid');
                    });

                    document.getElementById('lookup-doi').addEventListener('click', () => {
                        this.handleLookup('doi');
                    });

                    document.getElementById('lookup-nct').addEventListener('click', () => {
                        this.handleLookup('nct');
                    });

                    // Batch processing
                    document.getElementById('process-pmids').addEventListener('click', () => {
                        this.handleBatchPMIDs();
                    });

                    document.getElementById('clear-pmids').addEventListener('click', () => {
                        document.getElementById('pmid-list').value = '';
                        document.getElementById('pmid-file').value = '';
                        this.hideBatchProgress();
                    });

                    // File input for batch processing
                    document.getElementById('pmid-file').addEventListener('change', (e) => {
                        this.handlePMIDFile(e);
                    });

                    // Settings
                    document.getElementById('settings-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleSettingsSubmit();
                    });

                    // Clear form
                    document.getElementById('clear-form').addEventListener('click', () => {
                        document.getElementById('request-form').reset();
                        this.showStatus('Form cleared', 'success');
                    });

                    // Search
                    const searchInput = document.getElementById('search-requests');
                    if (searchInput) {
                        searchInput.addEventListener('input', (e) => {
                            this.handleSearch(e.target.value);
                        });
                    }

                    // Export buttons
                    document.getElementById('export-csv').addEventListener('click', () => {
                        this.exportData('csv');
                    });

                    document.getElementById('export-json').addEventListener('click', () => {
                        this.exportData('json');
                    });

                    // Import
                    document.getElementById('import-file').addEventListener('change', (e) => {
                        this.handleImport(e);
                    });
                },

                switchSection(sectionId) {
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.toggle('active', tab.dataset.section === sectionId);
                    });
                    
                    document.querySelectorAll('.section').forEach(section => {
                        section.classList.toggle('active', section.id === sectionId);
                    });
                    
                    state.ui.currentSection = sectionId;
                    
                    if (sectionId === 'dashboard') {
                        this.renderDashboard();
                    } else if (sectionId === 'all-requests') {
                        this.renderAllRequests();
                    }
                },

                async handleLookup(type) {
                    const inputId = type === 'nct' ? 'nct-id' : type;
                    const input = document.getElementById(inputId);
                    const button = document.getElementById(`lookup-${type}`);
                    
                    if (!input || !input.value.trim()) {
                        this.showStatus(`Please enter a ${type.toUpperCase()}`, 'error');
                        return;
                    }
                    
                    const identifier = input.value.trim();
                    const originalText = button.textContent;
                    
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner"></span> Loading...';
                    this.showStatus('Looking up metadata...', 'loading');
                    
                    try {
                        let result;
                        
                        if (type === 'pmid') {
                            result = await apiService.fetchPubMed(identifier);
                        } else if (type === 'doi') {
                            result = await apiService.fetchCrossRef(identifier);
                        } else if (type === 'nct') {
                            result = await apiService.fetchClinicalTrial(identifier);
                        }
                        
                        this.populateForm(result);
                        this.showStatus('✅ Metadata retrieved successfully!', 'success');
                        
                    } catch (error) {
                        console.error('Lookup failed:', error);
                        this.showStatus(`❌ Lookup failed: ${error.message}`, 'error');
                    } finally {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                },

                populateForm(data) {
                    const fieldMappings = {
                        'pmid': 'pmid',
                        'doi': 'doi',
                        'nct-id': 'nctId',
                        'title': 'title',
                        'authors': 'authors',
                        'journal': 'journal',
                        'year': 'year'
                    };
                    
                    Object.entries(fieldMappings).forEach(([fieldId, dataKey]) => {
                        const element = document.getElementById(fieldId);
                        if (element && data[dataKey]) {
                            element.value = data[dataKey];
                        }
                    });
                    
                    // Store additional metadata for later use
                    if (data.meshTerms || data.isClinicalTrial || data.conditions) {
                        const form = document.getElementById('request-form');
                        form.dataset.enhancedData = JSON.stringify(data);
                    }
                },

                async handleBatchPMIDs() {
                    const textArea = document.getElementById('pmid-list');
                    const fileInput = document.getElementById('pmid-file');
                    
                    let pmidText = textArea.value.trim();
                    
                    // If no text but file selected, read file
                    if (!pmidText && fileInput.files[0]) {
                        const file = fileInput.files[0];
                        pmidText = await this.readFileAsText(file);
                    }
                    
                    if (!pmidText) {
                        this.showBatchStatus('Please enter PMIDs or select a file', 'error');
                        return;
                    }
                    
                    const pmids = utils.extractPMIDs(pmidText);
                    
                    if (pmids.length === 0) {
                        this.showBatchStatus('No valid PMIDs found in the input', 'error');
                        return;
                    }
                    
                    if (pmids.length > 100) {
                        this.showBatchStatus('Too many PMIDs. Maximum 100 allowed per batch.', 'error');
                        return;
                    }
                    
                    await this.processPMIDBatch(pmids);
                },

                async processPMIDBatch(pmids) {
                    this.showBatchProgress();
                    const progressFill = document.getElementById('progress-fill');
                    const progressText = document.getElementById('progress-text');
                    
                    const results = [];
                    const errors = [];
                    
                    for (let i = 0; i < pmids.length; i++) {
                        const pmid = pmids[i];
                        const progress = ((i + 1) / pmids.length) * 100;
                        
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `Processing PMID ${pmid} (${i + 1} of ${pmids.length})...`;
                        
                        try {
                            const metadata = await apiService.fetchPubMed(pmid);
                            
                            // Create request from metadata
                            const request = dataManager.addRequest({
                                ...metadata,
                                priority: 'normal',
                                status: 'pending'
                            });
                            
                            results.push({ pmid, request, status: 'success' });
                            
                        } catch (error) {
                            console.error(`Failed to process PMID ${pmid}:`, error);
                            errors.push({ pmid, error: error.message });
                        }
                        
                        // Small delay between requests
                        if (i < pmids.length - 1) {
                            await utils.delay(API_DELAY);
                        }
                    }
                    
                    this.showBatchResults(results, errors);
                    this.hideBatchProgress();
                    this.render();
                },

                showBatchProgress() {
                    const progressContainer = document.getElementById('batch-progress');
                    progressContainer.style.display = 'block';
                },

                hideBatchProgress() {
                    const progressContainer = document.getElementById('batch-progress');
                    progressContainer.style.display = 'none';
                },

                showBatchResults(results, errors) {
                    const resultsContainer = document.getElementById('batch-results');
                    
                    let html = `
                        <div style="margin-bottom: 15px;">
                            <strong>Batch Processing Complete</strong><br>
                            ✅ Successfully processed: ${results.length}<br>
                            ❌ Errors: ${errors.length}
                        </div>
                    `;
                    
                    if (results.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px;">
                                <h4>Successfully Added:</h4>
                                <ul style="max-height: 200px; overflow-y: auto;">
                                    ${results.map(r => 
                                        `<li>PMID ${r.pmid}: ${utils.sanitize(r.request.title || 'Untitled')}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (errors.length > 0) {
                        html += `
                            <div>
                                <h4>Errors:</h4>
                                <ul style="max-height: 200px; overflow-y: auto;">
                                    ${errors.map(e => 
                                        `<li>PMID ${e.pmid}: ${utils.sanitize(e.error)}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    resultsContainer.innerHTML = html;
                    this.showBatchStatus(`✅ Processed ${results.length} PMIDs successfully!`, 'success');
                },

                handlePMIDFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    this.readFileAsText(file).then(text => {
                        document.getElementById('pmid-list').value = text;
                    }).catch(error => {
                        this.showBatchStatus(`File read error: ${error.message}`, 'error');
                    });
                },

                readFileAsText(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = e => reject(new Error('Failed to read file'));
                        reader.readAsText(file);
                    });
                },

                handleFormSubmit() {
                    const formData = new FormData(document.getElementById('request-form'));
                    const data = Object.fromEntries(formData.entries());
                    
                    if (!data.title) {
                        this.showStatus('Title is required', 'error');
                        return;
                    }
                    
                    // Check for enhanced data
                    const form = document.getElementById('request-form');
                    if (form.dataset.enhancedData) {
                        const enhancedData = JSON.parse(form.dataset.enhancedData);
                        Object.assign(data, enhancedData);
                    }
                    
                    // Process tags
                    if (data.tags) {
                        data.tags = data.tags.split(',').map(tag => tag.trim()).filter(Boolean);
                    }
                    
                    dataManager.addRequest(data);
                    document.getElementById('request-form').reset();
                    form.removeAttribute('data-enhanced-data');
                    
                    this.showStatus('✅ Request created successfully!', 'success');
                    this.render();
                },

                handleSearch(query) {
                    const filteredRequests = this.filterRequests(query);
                    this.renderRequestList(filteredRequests);
                },

                filterRequests(query = '') {
                    if (!query.trim()) return state.requests;
                    
                    const lowerQuery = query.toLowerCase();
                    return state.requests.filter(request => {
                        const searchText = [
                            request.title,
                            request.authors,
                            request.journal,
                            request.pmid,
                            request.doi,
                            request.nctId,
                            request.notes,
                            ...(request.tags || []),
                            ...(request.meshTerms || []).map(m => m.term),
                            ...(request.conditions || [])
                        ].join(' ').toLowerCase();
                        
                        return searchText.includes(lowerQuery);
                    });
                },

                handleSettingsSubmit() {
                    const form = document.getElementById('settings-form');
                    const formData = new FormData(form);
                    
                    state.settings = {
                        followupDays: parseInt(formData.get('followup-days')) || 5,
                        theme: formData.get('theme') || 'light',
                        apiKey: formData.get('api-key') || '',
                        crossrefEmail: formData.get('crossref-email') || ''
                    };
                    
                    this.updateTheme();
                    dataManager.save();
                    this.showStatus('⚙️ Settings saved successfully!', 'success');
                },

                updateTheme() {
                    document.documentElement.setAttribute('data-theme', state.settings.theme);
                },

                showStatus(message, type = 'info') {
                    const statusEl = document.getElementById('lookup-status');
                    if (statusEl) {
                        statusEl.textContent = message;
                        statusEl.className = `status-message ${type}`;
                    }
                },

                showBatchStatus(message, type = 'info') {
                    const statusEl = document.getElementById('batch-status');
                    if (statusEl) {
                        statusEl.textContent = message;
                        statusEl.className = `status-message ${type}`;
                    }
                },

                render() {
                    this.renderDashboard();
                    this.renderAllRequests();
                },

                renderDashboard() {
                    const stats = this.calculateStats();
                    
                    document.getElementById('total-requests').textContent = stats.total;
                    document.getElementById('clinical-trials').textContent = stats.clinicalTrials;
                    document.getElementById('pending-requests').textContent = stats.pending;
                    document.getElementById('fulfilled-requests').textContent = stats.fulfilled;
                    
                    // Render recent requests
                    const recentContainer = document.getElementById('recent-requests');
                    const recentRequests = state.requests.slice(0, 5);
                    
                    if (recentRequests.length === 0) {
                        recentContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No requests yet. Create your first request!</p>';
                    } else {
                        recentContainer.innerHTML = recentRequests.map(request => this.createRequestCard(request)).join('');
                    }
                },

                calculateStats() {
                    const total = state.requests.length;
                    const clinicalTrials = state.requests.filter(r => r.isClinicalTrial || r.nctId).length;
                    const pending = state.requests.filter(r => r.status === 'pending').length;
                    const fulfilled = state.requests.filter(r => r.status === 'fulfilled').length;
                    
                    return { total, clinicalTrials, pending, fulfilled };
                },

                renderAllRequests() {
                    const filteredRequests = this.filterRequests();
                    this.renderRequestList(filteredRequests);
                },

                renderRequestList(requests) {
                    const container = document.getElementById('request-list');
                    if (!container) return;
                    
                    if (requests.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No requests found.</p>';
                        return;
                    }
                    
                    container.innerHTML = requests.map(request => this.createRequestCard(request, true)).join('');
                },

                createRequestCard(request, detailed = false) {
                    const timeAgo = this.getTimeAgo(request.createdAt);
                    const isClinical = request.isClinicalTrial || request.nctId;
                    
                    // Build clinical trial info if available
                    let clinicalInfo = '';
                    if (isClinical && detailed) {
                        clinicalInfo = `
                            <div class="clinical-info">
                                <h4>🧪 Clinical Trial Information</h4>
                                <div class="clinical-grid">
                                    ${request.nctId ? `
                                        <div class="clinical-item">
                                            <div class="clinical-label">NCT ID</div>
                                            <div class="clinical-value">${request.nctId}</div>
                                        </div>
                                    ` : ''}
                                    ${request.phase ? `
                                        <div class="clinical-item">
                                            <div class="clinical-label">Phase</div>
                                            <div class="clinical-value">${request.phase}</div>
                                        </div>
                                    ` : ''}
                                    ${request.studyStatus ? `
                                        <div class="clinical-item">
                                            <div class="clinical-label">Status</div>
                                            <div class="clinical-value">${request.studyStatus}</div>
                                        </div>
                                    ` : ''}
                                    ${request.enrollment ? `
                                        <div class="clinical-item">
                                            <div class="clinical-label">Enrollment</div>
                                            <div class="clinical-value">${request.enrollment}</div>
                                        </div>
                                    ` : ''}
                                </div>
                                ${request.conditions && request.conditions.length > 0 ? `
                                    <div style="margin-top: 10px;">
                                        <div class="clinical-label">Conditions</div>
                                        <div>${request.conditions.map(c => `<span class="tag clinical">${c}</span>`).join('')}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    // Build MeSH terms display
                    let meshDisplay = '';
                    if (request.meshTerms && request.meshTerms.length > 0 && detailed) {
                        const majorTerms = request.meshTerms.filter(m => m.majorTopic);
                        if (majorTerms.length > 0) {
                            meshDisplay = `
                                <div style="margin: 10px 0;">
                                    <strong>MeSH Terms:</strong> 
                                    ${majorTerms.slice(0, 5).map(m => `<span class="tag">${m.term}</span>`).join('')}
                                </div>
                            `;
                        }
                    }
                    
                    return `
                        <div class="request-card ${isClinical ? 'clinical-trial' : ''}" data-id="${request.id}">
                            <div class="request-header">
                                <div style="flex: 1;">
                                    <div class="request-title">
                                        ${utils.sanitize(request.title || 'Untitled Request')}
                                        ${isClinical ? '<span class="tag clinical">Clinical Trial</span>' : ''}
                                    </div>
                                    <div class="request-meta">
                                        ${request.authors ? `👥 ${utils.sanitize(request.authors)} • ` : ''}
                                        ${request.journal ? `📚 ${utils.sanitize(request.journal)} • ` : ''}
                                        ${request.year ? `📅 ${request.year} • ` : ''}
                                        🕒 ${timeAgo}
                                    </div>
                                    ${detailed && (request.pmid || request.doi || request.nctId) ? `
                                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">
                                            ${request.pmid ? `PMID: ${request.pmid} • ` : ''}
                                            ${request.doi ? `DOI: ${request.doi} • ` : ''}
                                            ${request.nctId ? `NCT: ${request.nctId}` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                <div>
                                    <select class="request-status-select status-${request.status}" 
                                            onchange="uiController.updateRequestStatus('${request.id}', this.value)">
                                        <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="in-progress" ${request.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="fulfilled" ${request.status === 'fulfilled' ? 'selected' : ''}>Fulfilled</option>
                                        <option value="cancelled" ${request.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            
                            ${clinicalInfo}
                            ${meshDisplay}
                            
                            ${request.notes ? `
                                <div style="margin: 10px 0; padding: 10px; background: var(--bg-secondary); border-radius: var(--border-radius);">
                                    📝 ${utils.sanitize(request.notes)}
                                </div>
                            ` : ''}
                            
                            ${detailed ? `
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="btn btn-secondary" onclick="uiController.editRequest('${request.id}')" style="padding: 6px 12px; font-size: 0.9rem;">
                                        ✏️ Edit
                                    </button>
                                    <button class="btn btn-secondary" onclick="uiController.deleteRequest('${request.id}')" style="padding: 6px 12px; font-size: 0.9rem;">
                                        🗑️ Delete
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                },

                updateRequestStatus(id, newStatus) {
                    dataManager.updateRequest(id, { status: newStatus });
                    this.render();
                },

                editRequest(id) {
                    const request = state.requests.find(r => r.id === id);
                    if (!request) return;
                    
                    this.populateForm(request);
                    this.switchSection('add-request');
                    
                    // Store edit mode
                    document.getElementById('request-form').dataset.editId = id;
                },

                deleteRequest(id) {
                    if (!confirm('Are you sure you want to delete this request?')) return;
                    
                    dataManager.deleteRequest(id);
                    this.render();
                },

                getTimeAgo(date) {
                    const now = new Date();
                    const diffMs = now - new Date(date);
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) return 'Today';
                    if (diffDays === 1) return 'Yesterday';
                    if (diffDays < 7) return `${diffDays} days ago`;
                    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
                    return `${Math.floor(diffDays / 30)} months ago`;
                },

                exportData(format) {
                    try {
                        let content, filename, mimeType;
                        
                        if (format === 'csv') {
                            content = this.convertToCSV(state.requests);
                            filename = `silentstacks-enhanced-${new Date().toISOString().split('T')[0]}.csv`;
                            mimeType = 'text/csv';
                        } else {
                            content = JSON.stringify({
                                version: '1.2-enhanced',
                                exportedAt: new Date().toISOString(),
                                requests: state.requests,
                                settings: state.settings
                            }, null, 2);
                            filename = `silentstacks-enhanced-${new Date().toISOString().split('T')[0]}.json`;
                            mimeType = 'application/json';
                        }
                        
                        this.downloadFile(content, filename, mimeType);
                    } catch (error) {
                        console.error('Export failed:', error);
                        this.showStatus('Export failed', 'error');
                    }
                },

                convertToCSV(requests) {
                    if (requests.length === 0) return '';
                    
                    const headers = [
                        'ID', 'PMID', 'DOI', 'NCT ID', 'Title', 'Authors', 'Journal', 'Year',
                        'Priority', 'Status', 'Tags', 'MeSH Terms', 'Clinical Trial', 'Created'
                    ];
                    
                    const rows = requests.map(r => [
                        r.id || '',
                        r.pmid || '',
                        r.doi || '',
                        r.nctId || '',
                        r.title || '',
                        r.authors || '',
                        r.journal || '',
                        r.year || '',
                        r.priority || '',
                        r.status || '',
                        (r.tags || []).join('; '),
                        (r.meshTerms || []).map(m => m.term).join('; '),
                        r.isClinicalTrial || r.nctId ? 'Yes' : 'No',
                        r.createdAt || ''
                    ]);
                    
                    return [headers, ...rows]
                        .map(row => row.map(cell => `"${(cell + '').replace(/"/g, '""')}"`).join(','))
                        .join('\n');
                },

                downloadFile(content, filename, mimeType) {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                },

                handleImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    this.readFileAsText(file).then(text => {
                        try {
                            let importedData;
                            
                            if (file.name.endsWith('.json')) {
                                const data = JSON.parse(text);
                                importedData = data.requests || data;
                            } else if (file.name.endsWith('.csv')) {
                                importedData = this.parseCSV(text);
                            }
                            
                            if (Array.isArray(importedData)) {
                                importedData.forEach(requestData => {
                                    if (requestData.title) {
                                        dataManager.addRequest(requestData);
                                    }
                                });
                                
                                this.render();
                                document.getElementById('import-status').textContent = `✅ Imported ${importedData.length} requests successfully!`;
                                document.getElementById('import-status').className = 'status-message success';
                            }
                            
                        } catch (error) {
                            console.error('Import failed:', error);
                            document.getElementById('import-status').textContent = `❌ Import failed: ${error.message}`;
                            document.getElementById('import-status').className = 'status-message error';
                        }
                    });
                },

                parseCSV(csvText) {
                    const lines = csvText.split('\n').filter(line => line.trim());
                    if (lines.length < 2) return [];
                    
                    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
                    const requests = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                        const request = {};
                        
                        headers.forEach((header, index) => {
                            if (values[index]) {
                                request[header] = values[index];
                            }
                        });
                        
                        if (request.title) {
                            requests.push(request);
                        }
                    }
                    
                    return requests;
                }
            };

            // Make UI controller globally available
            window.uiController = uiController;

            // Initialize application
            function init() {
                console.log('🚀 Initializing SilentStacks Enhanced...');
                
                dataManager.load();
                uiController.init();
                
                console.log('✅ SilentStacks Enhanced initialized successfully!');
                console.log(`📊 Loaded ${state.requests.length} requests`);
            }

            // Start when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>