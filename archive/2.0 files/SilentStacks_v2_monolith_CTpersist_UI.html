<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SilentStacks - ILL Request Tracking</title>

  <!-- FIXED: Correct CSS file path -->
  <style>
    /* System Font Stack - No external files needed */
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* ===== EXISTING CSS STARTS BELOW ===== */
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Colors */
      --primary-color: #0066cc;
      --secondary-color: #6c757d;
      --success-color: #228b22;
      --danger-color: #dc3545;
      --warning-color: #ff6600;
      --info-color: #17a2b8;

      /* Backgrounds */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-card: #ffffff;

      /* Text */
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --text-muted: #868e96;


      /* Borders */
      --border-color: #dee2e6;
      --border-radius: 4px;

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* Dark Theme */
    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-card: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #adb5bd;
      --text-muted: #868e96;
      --border-color: #495057;
    }

    [data-theme="dark"] .form-progress {
      background: rgba(45, 45, 45, 0.98);
      border-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .field-priority {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .progress-bar {
      background: rgba(255, 255, 255, 0.1);
    }

    /* High Contrast Theme */
    /* High Contrast Theme */
    [data-theme="high-contrast"] {
      --bg-primary:    #000000;  /* page background */
      --bg-secondary:  #000000;  /* cards, inputs background */
      --bg-card:       #000000;
      --text-primary:  #ffffff;  /* all main text */
      --text-secondary:#ffffff;  /* labels, meta, help text */
      --border-color:  #ffffff;  /* outlines, inputs, cards */
    }


    bbody {
      font-family: 'Reddit Sans', 'Inter', 'SF Pro Display', 'Segoe UI Variable', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
      font-size: 18px; /* Increased for better readability */
      line-height: 1.6; /* Improved line spacing */
      color: var(--text-primary);
      background-color: var(--bg-primary);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px 0;
      border-bottom: 2px solid var(--border-color);
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    /* Navigation */
    .nav-tabs {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
      padding: 10px 0 0 0;
      overflow-x: auto;
      background: var(--bg-primary);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      height: 64px; /* Fixed height for consistent spacing */
    }

    .nav-tab {
      padding: 10px 20px;
      border: none;
      background: none;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .nav-tab:hover {
      color: var(--primary-color);
    }

    .nav-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    /* Sections */
    .section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Dashboard Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      text-align: center;
      box-shadow: var(--shadow-sm);
    }

    .stat-card h3 {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    /* Forms - Enhanced with Medical Library UX Research */
    .request-form, .settings-form {
      max-width: 800px;
    }

    /* Progress Indicator - Medical Form Standards */
    .form-progress {
      position: sticky;
      top: 80px; /* Below nav-tabs with gap */
      z-index: 90;
      margin: 0 -20px 2rem -20px; /* Extend to container edges */
      padding: 1.5rem 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 0;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      position: relative;
      z-index: 2;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .progress-step:hover {
      transform: translateY(-2px);
    }

    .progress-step:hover .step-number {
      transform: scale(1.1);
    }

    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
      border: 3px solid var(--bg-card);
    }

    .progress-step.active .step-number {
      background: var(--primary-color);
      color: white;
      border-color: var(--bg-card);
    }

    .progress-step.completed .step-number {
      background: var(--success-color);
      color: white;
      border-color: var(--bg-card);
    }

    .step-label {
      font-size: 0.75rem;
      font-weight: 500;
      color: #666;
      text-align: center;
    }

    .progress-step.active .step-label {
      color: var(--primary-color);
      font-weight: 600;
    }

    .progress-bar {
      position: absolute;
      top: 16px;
      left: 10%;
      right: 10%;
      height: 4px;
      background: rgba(128, 128, 128, 0.2);
      border-radius: 2px;
      overflow: hidden;
      z-index: 1;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--success-color) 100%);
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    /* Enhanced Fieldsets */
    .fieldset-enhanced {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 32px 24px 24px;
      margin-bottom: 24px;
      background: var(--bg-card);
      position: relative;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      scroll-margin-top: 200px; /* Account for nav + gap + progress sticky elements */
    }

    legend {
      font-weight: 700;
      color: var(--text-primary);
      padding: 0 16px;
      font-size: 1.25rem;
      letter-spacing: -0.5px;
      background: var(--bg-card);
    }

    /* Enhanced Form Groups */
    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    /* Enhanced Labels - Medical Form Standards */
    .form-label {
      display: flex;
      align-items: baseline;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .form-label.required::after {
      content: " *";
      color: var(--danger-color);
      font-weight: bold;
      margin-left: 4px;
    }

    /* Field Priority Indicators */
    .field-priority {
      display: inline-flex;
      align-items: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: 3px 8px;
      border-radius: 12px;
      margin-left: 8px;
      border: 1px solid var(--border-color);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Enhanced Form Controls - Medical Form Standards */
    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: all 0.3s ease;
      min-height: 44px; /* WCAG AAA touch target */
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
    }

    /* Field-specific styling */
    .identifier-field {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      letter-spacing: 0.025em;
    }

    .tracking-field {
      text-transform: uppercase;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }

    .title-field {
      font-weight: 500;
    }

    /* Form Help Text - Medical Standards */
    .form-help {
      display: block;
      margin-top: 6px;
      color: var(--text-muted);
      font-size: 0.875rem;
      line-height: 1.4;
    }

    /* Field Validation Icons */
    .field-validation-icon {
      position: absolute;
      right: 12px;
      top: 38px;
      width: 20px;
      height: 20px;
      display: none;
    }

    .field-validation-icon.valid {
      display: block;
      color: var(--success-color);
    }

    .field-validation-icon.invalid {
      display: block;
      color: var(--danger-color);
    }

    /* Input with Button - Enhanced */
    .input-with-button {
      display: flex;
      gap: 10px;
    }

    .input-with-button.enhanced {
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .input-with-button.enhanced:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
    }

    .input-with-button.enhanced input {
      flex: 1;
      border: none;
      border-radius: 0;
    }

    .input-with-button.enhanced input:focus {
      box-shadow: none;
    }

    .input-with-button.enhanced .lookup-btn {
      border: none;
      border-radius: 0;
      margin: -2px;
      min-width: 100px;
      padding: 8px 16px;
    }

    /* Buttons - Enhanced with Medical Standards */
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-height: 44px; /* WCAG AAA */
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:focus {
      outline: 3px solid var(--primary-color);
      outline-offset: 2px;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 102, 204, 0.3);
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
    }

    .btn-icon {
      font-size: 1.2em;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    /* Request List */
    .request-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .request-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 15px;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.3s ease;
    }

    .request-card:hover {
      box-shadow: var(--shadow-md);
    }

    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .request-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .request-meta {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .request-status {
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background-color: #ffc107;
      color: #000;
    }

    .status-in-progress {
      background-color: #17a2b8;
      color: white;
    }

    .status-fulfilled {
      background-color: var(--success-color);
      color: white;
    }

    .status-cancelled {
      background-color: var(--secondary-color);
      color: white;
    }

    .request-tags {
      display: flex;
      gap: 5px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .tag {
      padding: 2px 8px;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .request-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .request-actions button {
      padding: 5px 10px;
      font-size: 0.875rem;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
    }

    .filter-select {
      min-width: 150px;
    }

    /* Import/Export */
    .import-export-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }

    .card h3 {
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .card p {
      color: var(--text-secondary);
      margin-bottom: 15px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .file-input {
      margin-top: 10px;
    }

    /* Status Messages */
    .lookup-status,
    .import-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: var(--border-radius);
      display: none;
    }

    .lookup-status.success,
    .import-status.success {
      background-color: rgba(34, 139, 34, 0.1);
      color: var(--success-color);
      border: 1px solid var(--success-color);
      display: block;
    }

    .lookup-status.error,
    .import-status.error {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
      display: block;
    }

    .lookup-status.loading,
    .import-status.loading {
      background-color: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      display: block;
    }

    /* Empty State */
    .empty-message {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-style: italic;
    }

    /* Follow-up Indicator */
    .followup-indicator {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 8px;
      background-color: var(--warning-color);
      color: white;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .request-card.needs-followup {
      border-left: 4px solid var(--warning-color);
    }

    /* Form Validation States */
    .form-control.valid {
      border-color: var(--success-color);
    }

    .form-control.invalid {
      border-color: var(--danger-color);
    }

    /* High Contrast Theme Enhancements */
    [data-theme="high-contrast"] .form-progress {
      background: #ffffff;
      border: 3px solid #000000;
    }

    [data-theme="high-contrast"] .field-priority {
      background: #000000;
      color: #ffffff;
      border: 2px solid #000000;
    }

    [data-theme="high-contrast"] .btn:focus {
      outline: 4px solid #ffd700;
      outline-offset: 3px;
    }

    /* Responsive Progress Bar */
    @media (max-width: 768px) {
      .progress-steps {
        font-size: 0.7rem;
      }

      .step-number {
        width: 28px;
        height: 28px;
        font-size: 0.75rem;
      }

      .fieldset-enhanced {
        padding: 16px;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .nav-tabs {
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .filters {
        flex-direction: column;
      }

      .search-input,
      .filter-select {
        width: 100%;
      }
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Accessibility */
    :focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    /* High-Contrast Text Overlays */
    [data-theme="high-contrast"] input,
    [data-theme="high-contrast"] textarea,
    [data-theme="high-contrast"] select {
      color: var(--text-primary) !important;  /* ensure black text */
      background-color: #ffffff !important;    /* keep white background */
    }
    [data-theme="high-contrast"] ::placeholder {
      color: var(--text-primary) !important;  /* black placeholders */
    }
    [data-theme="high-contrast"] .form-help,
    [data-theme="high-contrast"] .step-label,
    [data-theme="high-contrast"] legend,
    [data-theme="high-contrast"] .empty-message {
      color: var(--text-primary) !important;
    }
    /* ——— Gold Focus Border in High-Contrast Theme ——— */
    [data-theme="high-contrast"] :focus-visible {
      outline: 3px solid gold !important;
      outline-offset: 2px !important;
    }

    /* Also tint the control’s border if it uses .form-control or .input-with-button */
    [data-theme="high-contrast"]
    .form-control:focus,
    [data-theme="high-contrast"]
    .input-with-button.enhanced:focus-within {
      border-color: gold !important;
      box-shadow: 0 0 0 2px gold !important;
    }
    /* ——— Gold Border for Active Nav Items & Drop-downs ——— */


    select:focus,
    select:active,
    .filter-select:focus,
    .filter-select:active {
      /* full gold border on open/focused dropdowns */
      outline: none; /* remove default outline */
      border: 2px solid gold !important;
      box-shadow: 0 0 0 2px gold !important;
    }
    /* ——— Gold Active Tab ONLY in High-Contrast Theme ——— */
    [data-theme="high-contrast"] .nav-tab.active {
      border-bottom: 3px solid gold !important;
      color: gold            !important;
    }

    /* ——— High-Contrast Only: form fields & dropdowns white on black ——— */
    [data-theme="high-contrast"] input,
    [data-theme="high-contrast"] textarea,
    [data-theme="high-contrast"] select,
    [data-theme="high-contrast"] .form-control {
      background-color: var(--bg-secondary) !important; /* black */
      color:            var(--text-primary) !important; /* white */
    }

    [data-theme="high-contrast"] ::placeholder {
      color: var(--text-secondary) !important; /* white placeholder */
    }
    /* Enhanced Filters & Request Management CSS */

    /* Enhanced Filters */
    .enhanced-filters {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
    }

    .filter-row {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-row:last-child {
      margin-bottom: 0;
      justify-content: space-between;
    }

    .search-input {
      flex: 1;
      min-width: 250px;
      padding: 10px 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
    }

    .filter-select {
      min-width: 150px;
      padding: 10px 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      background: var(--bg-primary);
    }

    /* Sort Controls */
    .sort-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .sort-label {
      font-weight: 600;
      color: var(--text-secondary);
      margin-right: 5px;
    }

    .sort-btn {
      padding: 8px 12px;
      border: 2px solid var(--border-color);
      background: var(--bg-card);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      position: relative;
    }

    .sort-btn:hover {
      border-color: var(--primary-color);
      background: var(--bg-secondary);
    }

    .sort-btn.sort-asc::after {
      content: " ↑";
      color: var(--primary-color);
      font-weight: bold;
    }

    .sort-btn.sort-desc::after {
      content: " ↓";
      color: var(--primary-color);
      font-weight: bold;
    }

    .results-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .select-all-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      cursor: pointer;
    }

    /* Enhanced Request Cards */
    .request-card {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
    }

    .request-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary-color);
    }

    .request-card.selected {
      border-color: var(--primary-color);
      background: rgba(0, 102, 204, 0.05);
    }

    .request-card.needs-followup {
      border-left: 4px solid var(--warning-color);
    }

    .request-header {
      display: flex;
      gap: 15px;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .request-checkbox {
      margin-top: 2px;
    }

    .request-checkbox input {
      transform: scale(1.2);
      cursor: pointer;
    }

    .request-main {
      flex: 1;
    }

    .request-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-primary);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .request-meta {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-bottom: 5px;
      line-height: 1.4;
    }

    .request-details {
      color: var(--text-muted);
      font-size: 0.85rem;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .request-status-container {
      min-width: 140px;
    }

    .request-status-select {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }

    .request-status-select.status-pending {
      background: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }

    .request-status-select.status-in-progress {
      background: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }

    .request-status-select.status-fulfilled {
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    .request-status-select.status-cancelled {
      background: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }

    .request-tags {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .tag {
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .request-notes {
      background: var(--bg-secondary);
      padding: 10px;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
      border-left: 3px solid var(--info-color);
    }

    .request-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 0.85rem;
      min-height: auto;
    }

    /* Bulk Actions */
    .bulk-actions {
      margin-bottom: 20px;
    }

    .bulk-actions-bar {
      background: var(--primary-color);
      color: white;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .selected-count {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .bulk-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .bulk-buttons select {
      padding: 8px 12px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
    }

    .bulk-buttons .btn {
      padding: 8px 15px;
      font-size: 0.9rem;
      min-height: auto;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
    }

    .bulk-buttons .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .enhanced-filters {
        padding: 15px;
      }

      .filter-row {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .sort-controls {
        justify-content: center;
      }

      .results-info {
        justify-content: space-between;
      }

      .request-header {
        flex-direction: column;
        gap: 10px;
      }

      .request-status-container {
        min-width: auto;
      }

      .request-actions {
        justify-content: center;
      }

      .bulk-actions-bar {
        flex-direction: column;
        text-align: center;
      }

      .bulk-buttons {
        justify-content: center;
      }
    }

    /* Dark Theme Adjustments */
    [data-theme="dark"] .request-status-select.status-pending {
      background: rgba(255, 193, 7, 0.2);
      border-color: #ffc107;
      color: #ffc107;
    }

    [data-theme="dark"] .request-status-select.status-in-progress {
      background: rgba(23, 162, 184, 0.2);
      border-color: #17a2b8;
      color: #17a2b8;
    }

    [data-theme="dark"] .request-status-select.status-fulfilled {
      background: rgba(40, 167, 69, 0.2);
      border-color: #28a745;
      color: #28a745;
    }

    [data-theme="dark"] .request-status-select.status-cancelled {
      background: rgba(220, 53, 69, 0.2);
      border-color: #dc3545;
      color: #dc3545;
    }

    /* High Contrast Theme */
    [data-theme="high-contrast"] .request-card.selected {
      border-color: gold;
      background: rgba(255, 215, 0, 0.1);
    }

    [data-theme="high-contrast"] .sort-btn.sort-asc::after,
    [data-theme="high-contrast"] .sort-btn.sort-desc::after {
      color: gold;
    }

    [data-theme="high-contrast"] .bulk-actions-bar {
      background: var(--text-primary);
      border: 2px solid gold;
    }
    /* Alignment Fixes for SilentStacks */

    /* Navigation Tab Fixes */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
      padding: 10px 0 0 0;
      overflow-x: auto;
      background: var(--bg-primary);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      align-items: flex-end; /* Align tabs to bottom */
    }

    .nav-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      background: none;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      min-height: 48px; /* Consistent height */
    }

    .nav-icon {
      flex-shrink: 0; /* Prevent icon compression */
      width: 20px;
      height: 20px;
    }

    /* Input with Button Alignment Fixes */
    .input-with-button.enhanced {
      display: flex;
      align-items: stretch; /* Make input and button same height */
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      overflow: hidden;
      transition: all 0.3s ease;
      min-height: 48px; /* Consistent minimum height */
    }

    .input-with-button.enhanced input {
      flex: 1;
      border: none;
      border-radius: 0;
      padding: 12px 16px;
      font-size: 1rem;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      min-height: 44px; /* Match button height */
    }

    .input-with-button.enhanced input:focus {
      outline: none;
      box-shadow: none;
    }

    .input-with-button.enhanced .lookup-btn {
      border: none;
      border-radius: 0;
      margin: 0; /* Remove any margin */
      min-width: 120px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 1rem;
      font-weight: 600;
      min-height: 48px; /* Match input height */
      flex-shrink: 0; /* Prevent button compression */
    }

    .lookup-btn .btn-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    /* Form Group Spacing Fixes */
    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    .form-label {
      display: flex;
      align-items: baseline;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 8px;
      gap: 8px; /* Space between label and priority badge */
    }

    .field-priority {
      display: inline-flex;
      align-items: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: 3px 8px;
      border-radius: 12px;
      margin-left: auto; /* Push to right side */
      border: 1px solid var(--border-color);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      flex-shrink: 0;
    }

    /* Standard Form Controls */
    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: all 0.3s ease;
      min-height: 48px; /* WCAG AAA touch target */
      box-sizing: border-box;
    }

    /* Button Alignment Fixes */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-height: 48px; /* WCAG AAA */
      text-decoration: none;
      box-sizing: border-box;
    }

    .btn-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    /* Form Actions Alignment */
    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Progress Indicator Fixes */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      position: relative;
      z-index: 2;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      flex: 1;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .step-number {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1rem;
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
      border: 3px solid var(--bg-card);
    }

    .step-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #666;
      text-align: center;
      line-height: 1.2;
    }

    /* Fieldset Improvements */
    .fieldset-enhanced {
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 32px 24px 24px;
      margin-bottom: 24px;
      background: var(--bg-card);
      position: relative;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    legend {
      font-weight: 700;
      color: var(--text-primary);
      padding: 0 16px;
      font-size: 1.25rem;
      letter-spacing: -0.5px;
      background: var(--bg-card);
      margin-left: -8px; /* Align with border */
    }

    /* Help Text Alignment */
    .form-help {
      display: block;
      margin-top: 6px;
      color: var(--text-muted);
      font-size: 0.875rem;
      line-height: 1.4;
      padding-left: 2px; /* Slight indent for alignment */
    }

    /* Responsive Fixes */
    @media (max-width: 768px) {
      .nav-tab {
        padding: 10px 16px;
        font-size: 0.9rem;
        min-height: 44px;
      }

      .nav-icon {
        width: 18px;
        height: 18px;
      }

      .input-with-button.enhanced {
        flex-direction: column;
      }

      .input-with-button.enhanced .lookup-btn {
        min-width: auto;
        width: 100%;
        margin-top: 8px;
      }

      .form-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
    /* Theme Text Color Fixes */

    /* Sort Button Text Colors */
    .sort-btn {
      padding: 8px 12px;
      border: 2px solid var(--border-color);
      background: var(--bg-card);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      position: relative;
      color: var(--text-primary); /* Use theme text color */
    }

    .sort-btn:hover {
      border-color: var(--primary-color);
      background: var(--bg-secondary);
      color: var(--text-primary); /* Maintain theme color on hover */
    }

    .sort-btn.sort-asc::after {
      content: " ↑";
      color: var(--primary-color);
      font-weight: bold;
    }

    .sort-btn.sort-desc::after {
      content: " ↓";
      color: var(--primary-color);
      font-weight: bold;
    }

    /* Sort Label Color */
    .sort-label {
      font-weight: 600;
      color: var(--text-secondary); /* Use theme secondary text */
      margin-right: 5px;
    }

    /* Filter Select Text Colors */
    .filter-select {
      min-width: 150px;
      padding: 10px 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      background: var(--bg-primary);
      color: var(--text-primary); /* Use theme text color */
    }

    .filter-select option {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    /* Results Info Text */
    .results-info {
      display: flex;
      gap: 20px;
      align-items: center;
      color: var(--text-primary); /* Use theme text color */
    }

    .select-all-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-primary); /* Use theme text color */
    }

    /* Enhanced Filters Text */
    .enhanced-filters {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      color: var(--text-primary); /* Ensure all text inherits theme color */
    }

    /* Dark Theme Specific Fixes */
    [data-theme="dark"] .sort-btn {
      color: var(--text-primary);
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .sort-btn:hover {
      color: var(--text-primary);
      background: var(--bg-secondary);
    }

    [data-theme="dark"] .filter-select {
      color: var(--text-primary);
      background: var(--bg-primary);
    }

    [data-theme="dark"] .filter-select option {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    /* High Contrast Theme Fixes */
    [data-theme="high-contrast"] .sort-btn {
      color: var(--text-primary);
      background: var(--bg-card);
      border: 2px solid var(--border-color);
    }

    [data-theme="high-contrast"] .sort-btn:hover {
      color: var(--text-primary);
      background: var(--bg-secondary);
      border-color: gold;
    }

    [data-theme="high-contrast"] .sort-btn.sort-asc::after,
    [data-theme="high-contrast"] .sort-btn.sort-desc::after {
      color: gold;
    }

    [data-theme="high-contrast"] .filter-select {
      color: var(--text-primary);
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
    }

    /* General Text Color Inheritance Fix */
    .enhanced-filters * {
      color: inherit; /* Ensure child elements inherit theme colors */
    }

    /* Specific element overrides to ensure theme compliance */
    #results-count {
      color: var(--text-primary);
    }

    .sort-controls {
      color: var(--text-primary);
    }

    /* Button text color fixes */
    .btn {
      color: inherit; /* Let button color be set by specific button classes */
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white; /* Primary buttons always white text */
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white; /* Secondary buttons always white text */
    }
    /* Remove Navbar Scrollbar */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
      padding: 10px 0 0 0;
      background: var(--bg-primary);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      align-items: flex-end;

      /* Hide scrollbar but allow scrolling if needed */
      overflow-x: auto;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }

    .nav-tabs::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }

    /* Ensure tabs don't wrap and maintain minimum sizes */
    .nav-tab {
      flex-shrink: 0; /* Prevent tabs from shrinking too much */
      min-width: fit-content;
    }
    /* Mandatory Field Indicators */

    /* Required field asterisk styling */
    .form-label.required::after {
      content: " *";
      color: var(--danger-color);
      font-weight: bold;
      margin-left: 4px;
    }

    /* Optional field indicator */
    .form-label.optional::after {
      content: " (optional)";
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.85em;
      margin-left: 4px;
    }

    /* Enhanced field priority indicators */
    .field-priority.required {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
      border-color: var(--danger-color);
    }

    .field-priority.preferred {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .field-priority.optional {
      background: var(--bg-secondary);
      color: var(--text-muted);
      border-color: var(--border-color);
    }

    /* Form validation states */
    .form-control.required:invalid {
      border-color: var(--danger-color);
      box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
    }

    .form-control.required:valid {
      border-color: var(--success-color);
    }

    /* Required field help text */
    .form-help.required::before {
      content: "⚠️ Required: ";
      color: var(--danger-color);
      font-weight: 600;
    }

    /* Priority levels styling */
    .priority-high {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
      border-color: var(--danger-color);
    }

    .priority-medium {
      background: rgba(255, 193, 7, 0.1);
      color: #856404;
      border-color: #ffc107;
    }

    .priority-low {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success-color);
      border-color: var(--success-color);
    }
    /* Enhanced SilentStacks CSS - Add this to the END of your existing style.css */

    /* === NAVBAR SCROLLBAR FIX === */
    .nav-tabs {
      overflow-x: auto;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }

    .nav-tabs::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }

    .nav-tab {
      flex-shrink: 0;
      min-width: fit-content;
    }

    /* === MANDATORY FIELD INDICATORS === */
    .form-label.required::after {
      content: " *";
      color: var(--danger-color);
      font-weight: bold;
      margin-left: 4px;
    }

    .form-label.optional::after {
      content: " (optional)";
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.85em;
      margin-left: 4px;
    }

    .field-priority.required {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
      border-color: var(--danger-color);
    }

    .field-priority.preferred {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .field-priority.optional {
      background: var(--bg-secondary);
      color: var(--text-muted);
      border-color: var(--border-color);
    }

    /* === PRIORITY SYSTEM === */
    .priority-select {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .priority-urgent {
      background: #ffebee !important;
      border-color: #f44336 !important;
      color: #c62828 !important;
    }

    .priority-rush {
      background: #fff3e0 !important;
      border-color: #ff9800 !important;
      color: #ef6c00 !important;
    }

    .priority-normal {
      background: #e8f5e8 !important;
      border-color: #4caf50 !important;
      color: #2e7d32 !important;
    }

    /* Priority badges in cards */
    .priority-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 8px;
    }

    .priority-badge.urgent { background: #f44336; color: white; }
    .priority-badge.rush { background: #ff9800; color: white; }
    .priority-badge.normal { background: #4caf50; color: white; }

    /* === ENHANCED STATUS COLORS === */
    .request-status-select.status-pending {
      background: #fff8e1 !important;
      border-color: #ffc107 !important;
      color: #f57f17 !important;
    }

    .request-status-select.status-in-progress {
      background: #e3f2fd !important;
      border-color: #2196f3 !important;
      color: #0d47a1 !important;
    }

    .request-status-select.status-fulfilled {
      background: #e8f5e8 !important;
      border-color: #4caf50 !important;
      color: #2e7d32 !important;
    }

    .request-status-select.status-cancelled {
      background: #fafafa !important;
      border-color: #9e9e9e !important;
      color: #424242 !important;
    }

    /* === TAG COLOR SYSTEM === */
    .tag-color-1 { background: #f44336; color: white; }
    .tag-color-2 { background: #ff9800; color: white; }
    .tag-color-3 { background: #4caf50; color: white; }
    .tag-color-4 { background: #2196f3; color: white; }
    .tag-color-5 { background: #9c27b0; color: white; }
    .tag-color-default { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }

    /* === THEME TEXT COLOR FIXES === */
    .sort-btn {
      color: var(--text-primary) !important;
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    .sort-btn:hover {
      color: var(--text-primary) !important;
      background: var(--bg-secondary);
    }

    .sort-label {
      color: var(--text-secondary) !important;
    }

    .filter-select {
      color: var(--text-primary) !important;
      background: var(--bg-primary) !important;
    }

    .results-info {
      color: var(--text-primary) !important;
    }

    .select-all-label {
      color: var(--text-primary) !important;
    }

    .enhanced-filters {
      color: var(--text-primary) !important;
    }

    /* === RECENT REQUEST CARDS === */
    .recent-request-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 10px;
      transition: box-shadow 0.3s ease;
    }

    .recent-request-card:hover {
      box-shadow: var(--shadow-md);
    }

    .recent-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .recent-meta {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .recent-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
    }

    .recent-status.status-pending { background: #ffc107; color: #000; }
    .recent-status.status-in-progress { background: #2196f3; color: white; }
    .recent-status.status-fulfilled { background: #4caf50; color: white; }
    .recent-status.status-cancelled { background: #9e9e9e; color: white; }

    /* === PRIORITY FILTER === */
    .priority-filter {
      min-width: 120px;
      padding: 10px 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .sort-btn[data-field="priority"] {
      background: linear-gradient(90deg, #f44336 0%, #ff9800 50%, #4caf50 100%);
      color: white !important;
      border: 2px solid transparent;
    }

    .sort-btn[data-field="priority"]:hover {
      background: linear-gradient(90deg, #d32f2f 0%, #f57c00 50%, #388e3c 100%);
      color: white !important;
    }

    /* === BULK OPERATIONS === */
    .bulk-actions-bar {
      background: var(--primary-color);
      color: white;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .bulk-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .bulk-buttons select {
      padding: 8px 12px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .bulk-buttons .btn {
      padding: 8px 15px;
      font-size: 0.9rem;
      min-height: auto;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
    }

    .bulk-buttons .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* === DARK THEME FIXES === */
    [data-theme="dark"] .priority-urgent {
      background: rgba(244, 67, 54, 0.2) !important;
      border-color: #f44336 !important;
      color: #ffcdd2 !important;
    }

    [data-theme="dark"] .priority-rush {
      background: rgba(255, 152, 0, 0.2) !important;
      border-color: #ff9800 !important;
      color: #ffe0b2 !important;
    }

    [data-theme="dark"] .priority-normal {
      background: rgba(76, 175, 80, 0.2) !important;
      border-color: #4caf50 !important;
      color: #c8e6c9 !important;
    }

    [data-theme="dark"] .request-status-select.status-pending {
      background: rgba(255, 193, 7, 0.2) !important;
      border-color: #ffc107 !important;
      color: #ffc107 !important;
    }

    [data-theme="dark"] .request-status-select.status-in-progress {
      background: rgba(33, 150, 243, 0.2) !important;
      border-color: #2196f3 !important;
      color: #2196f3 !important;
    }

    [data-theme="dark"] .request-status-select.status-fulfilled {
      background: rgba(76, 175, 80, 0.2) !important;
      border-color: #4caf50 !important;
      color: #4caf50 !important;
    }

    [data-theme="dark"] .request-status-select.status-cancelled {
      background: rgba(158, 158, 158, 0.2) !important;
      border-color: #9e9e9e !important;
      color: #9e9e9e !important;
    }

    /* === HIGH CONTRAST THEME === */
    [data-theme="high-contrast"] .priority-urgent {
      background: #000000 !important;
      border: 3px solid #ff0000 !important;
      color: #ffffff !important;
    }

    [data-theme="high-contrast"] .priority-rush {
      background: #000000 !important;
      border: 3px solid #ff9900 !important;
      color: #ffffff !important;
    }

    [data-theme="high-contrast"] .priority-normal {
      background: #000000 !important;
      border: 3px solid #00ff00 !important;
      color: #ffffff !important;
    }

    [data-theme="high-contrast"] .sort-btn.sort-asc::after,
    [data-theme="high-contrast"] .sort-btn.sort-desc::after {
      color: gold;
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .bulk-actions-bar {
        flex-direction: column;
        text-align: center;
      }

      .bulk-buttons {
        justify-content: center;
      }

      .priority-filter {
        min-width: auto;
        width: 100%;
      }
    }
    /* === CENTER ADD REQUEST FORM === */
    .request-form {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .form-progress {
      max-width: 900px;
      margin: 0 auto 2rem auto;
      position: sticky;
      top: 80px;
      z-index: 90;
      padding: 1.5rem 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 0;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #add-request h2 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--text-primary);
    }
    /* === FILE INPUT FIXES FOR ALL THEMES === */
    .file-input {
      margin-top: 10px;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 16px;
      width: 100%;
    }

    .file-input:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Dark theme specific fixes */
    [data-theme="dark"] .file-input {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .file-input::file-selector-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      margin-right: 12px;
    }

    /* High contrast theme fixes */
    [data-theme="high-contrast"] .file-input {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 3px solid var(--border-color);
    }

    [data-theme="high-contrast"] .file-input::file-selector-button {
      background: var(--text-primary);
      color: var(--bg-primary);
      border: 2px solid var(--border-color);
      padding: 8px 16px;
      border-radius: 4px;
      margin-right: 12px;
    }

    /* Import status text fixes */
    .import-status {
      color: var(--text-primary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      padding: 10px;
      border-radius: var(--border-radius);
      margin-top: 10px;
    }

    .import-status.success {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success-color);
      border-color: var(--success-color);
    }

    .import-status.error {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
      border-color: var(--danger-color);
    }
    .tag-color-picker {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 1000;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      min-width: 120px;
      backdrop-filter: blur(10px);
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.2s ease;
    }

    .tag-color-picker.active {
      opacity: 1;
      transform: translateY(0);
    }

    .color-option {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .color-option:hover {
      transform: scale(1.1);
      border-color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .color-option:focus {
      outline: 3px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Enhanced color options */
    .color-option.color-1 { background: #e74c3c; }
    .color-option.color-2 { background: #f39c12; }
    .color-option.color-3 { background: #27ae60; }
    .color-option.color-4 { background: #3498db; }
    .color-option.color-5 { background: #9b59b6; }
    .color-option.color-6 { background: #e91e63; }
    .color-option.color-7 { background: #00bcd4; }
    .color-option.color-8 { background: #ff5722; }

    .color-option.color-default {
      background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
      linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
      linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
      background-size: 8px 8px;
      background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
      border: 2px solid var(--border-color);
    }

    /* Selected state indicator */
    .color-option.selected::after {
      content: "✓";
      color: white;
      font-weight: bold;
      font-size: 16px;
      text-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
    }

    .color-option.color-default.selected::after {
      color: var(--text-primary);
      text-shadow: 0 0 3px rgba(255, 255, 255, 0.7);
    }

    /* Enhanced tag display */
    .tag-colorable {
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .tag-colorable:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Updated tag color classes with better contrast */
    .tag-color-1 { background: #e74c3c !important; color: white !important; border-color: #c0392b !important; }
    .tag-color-2 { background: #f39c12 !important; color: white !important; border-color: #d68910 !important; }
    .tag-color-3 { background: #27ae60 !important; color: white !important; border-color: #229954 !important; }
    .tag-color-4 { background: #3498db !important; color: white !important; border-color: #2980b9 !important; }
    .tag-color-5 { background: #9b59b6 !important; color: white !important; border-color: #8e44ad !important; }
    .tag-color-6 { background: #e91e63 !important; color: white !important; border-color: #c2185b !important; }
    .tag-color-7 { background: #00bcd4 !important; color: white !important; border-color: #0097a7 !important; }
    .tag-color-8 { background: #ff5722 !important; color: white !important; border-color: #d84315 !important; }

    /* === PROGRESS STEP ENHANCEMENTS === */
    .progress-step {
      transition: all 0.3s ease;
    }

    .progress-step:hover {
      transform: translateY(-2px);
    }

    .progress-step:hover .step-number {
      transform: scale(1.1);
    }

    .progress-step.completed .step-number {
      background: var(--success-color) !important;
      color: white !important;
      border-color: var(--bg-card) !important;
    }

    .progress-step.completed .step-label {
      color: var(--success-color) !important;
      font-weight: 600 !important;
    }

    /* Smooth scrolling for fieldsets */
    .fieldset-enhanced {
      scroll-margin-top: 200px;
    }

    /* === PRIORITY INDICATORS === */
    .priority-indicator {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      border-radius: 0 2px 2px 0;
    }

    .priority-indicator.urgent { background: #e74c3c; }
    .priority-indicator.rush { background: #f39c12; }
    .priority-indicator.normal { background: #95a5a6; }

    /* === ACCESSIBILITY IMPROVEMENTS === */
    /* Focus indicators for high contrast mode */
    [data-theme="high-contrast"] .progress-step:focus {
      outline: 3px solid gold !important;
      outline-offset: 2px !important;
    }

    [data-theme="high-contrast"] .color-option:focus {
      outline: 3px solid gold !important;
      outline-offset: 2px !important;
    }

    /* === DARK THEME ADJUSTMENTS === */
    [data-theme="dark"] .tag-color-picker {
      background: var(--bg-card);
      border-color: var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .color-option.color-default {
      background: linear-gradient(45deg, #333 25%, transparent 25%),
      linear-gradient(-45deg, #333 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #333 75%),
      linear-gradient(-45deg, transparent 75%, #333 75%);
      background-size: 8px 8px;
      background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
    }

    /* === RESPONSIVE ADJUSTMENTS === */
    @media (max-width: 768px) {
      .tag-color-picker {
        position: fixed;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%);
        padding: 16px;
        border-radius: 12px;
      }

      .color-option {
        width: 40px;
        height: 40px;
      }

      .progress-step {
        font-size: 0.8rem;
      }

      .step-number {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
      }
    }

    /* === ANIMATION KEYFRAMES === */
    @keyframes colorPickerSlide {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .tag-color-picker.active {
      animation: colorPickerSlide 0.2s ease-out;
    }
    /* === HIGH CONTRAST THEME FIXES === */
    /* Add these to your style.css file to fix the white background issue */

    /* High Contrast Theme - Complete Override */
    [data-theme="high-contrast"] {
      --bg-primary:    #000000 !important;  /* page background */
      --bg-secondary:  #000000 !important;  /* cards, inputs background */
      --bg-card:       #000000 !important;
      --text-primary:  #ffffff !important;  /* all main text */
      --text-secondary:#ffffff !important;  /* labels, meta, help text */
      --border-color:  #ffffff !important;  /* outlines, inputs, cards */
    }

    /* Force background colors in high contrast */
    [data-theme="high-contrast"] body {
      background-color: #000000 !important;
      color: #ffffff !important;
    }

    [data-theme="high-contrast"] .container {
      background-color: #000000 !important;
    }

    [data-theme="high-contrast"] .main-content {
      background-color: #000000 !important;
    }

    [data-theme="high-contrast"] .section {
      background-color: #000000 !important;
    }

    /* Request cards in high contrast */
    [data-theme="high-contrast"] .request-card {
      background: #000000 !important;
      border: 3px solid #ffffff !important;
      color: #ffffff !important;
    }

    [data-theme="high-contrast"] .enhanced-filters {
      background: #000000 !important;
      border: 3px solid #ffffff !important;
      color: #ffffff !important;
    }

    /* Form elements in high contrast */
    [data-theme="high-contrast"] .form-control,
    [data-theme="high-contrast"] .search-input,
    [data-theme="high-contrast"] .filter-select {
      background: #000000 !important;
      color: #ffffff !important;
      border: 3px solid #ffffff !important;
    }

    [data-theme="high-contrast"] .form-control:focus,
    [data-theme="high-contrast"] .search-input:focus,
    [data-theme="high-contrast"] .filter-select:focus {
      border-color: #ffff00 !important;
      box-shadow: 0 0 0 3px #ffff00 !important;
    }

    /* Navigation in high contrast */
    [data-theme="high-contrast"] .nav-tabs {
      background: #000000 !important;
      border-bottom: 3px solid #ffffff !important;
    }

    [data-theme="high-contrast"] .nav-tab {
      color: #ffffff !important;
      background: #000000 !important;
    }

    [data-theme="high-contrast"] .nav-tab.active {
      color: #ffff00 !important;
      border-bottom-color: #ffff00 !important;
    }

    /* Buttons in high contrast */
    [data-theme="high-contrast"] .btn {
      background: #000000 !important;
      color: #ffffff !important;
      border: 3px solid #ffffff !important;
    }

    [data-theme="high-contrast"] .btn:hover,
    [data-theme="high-contrast"] .btn:focus {
      border-color: #ffff00 !important;
      color: #ffff00 !important;
    }

    [data-theme="high-contrast"] .btn-primary {
      background: #000000 !important;
      border-color: #ffff00 !important;
      color: #ffff00 !important;
    }

    /* Sort buttons in high contrast */
    [data-theme="high-contrast"] .sort-btn {
      background: #000000 !important;
      color: #ffffff !important;
      border: 3px solid #ffffff !important;
    }

    [data-theme="high-contrast"] .sort-btn:hover {
      border-color: #ffff00 !important;
      color: #ffff00 !important;
    }

    [data-theme="high-contrast"] .sort-btn.sort-asc::after,
    [data-theme="high-contrast"] .sort-btn.sort-desc::after {
      color: #ffff00 !important;
    }
    /* === BULK ENTRY TEXTAREA SIZE FIX === */
    /* Add this to your style.css file */

    /* Make bulk paste textarea much larger and more usable */
    #bulk-paste-data {
      width: 100%;
      min-height: 300px; /* Much taller - was probably around 100px */
      max-height: 500px; /* Allow it to grow but not too much */
      padding: 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* Monospace for CSV data */
      font-size: 14px;
      line-height: 1.4;
      background: var(--bg-primary);
      color: var(--text-primary);
      resize: vertical; /* Allow users to resize vertically */
      transition: all 0.3s ease;
    }

    #bulk-paste-data:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
    }

    #bulk-paste-data::placeholder {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Bulk paste section styling improvements */
    .bulk-paste-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 24px;
      margin-top: 30px;
      box-shadow: var(--shadow-sm);
    }

    .bulk-paste-section h3 {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: var(--text-primary);
    }

    .bulk-paste-help {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .bulk-paste-help strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Better spacing for the button */
    .bulk-paste-section button {
      margin-top: 15px;
      width: 100%;
      max-width: 300px;
    }

    /* Dark theme adjustments */
    [data-theme="dark"] #bulk-paste-data {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    [data-theme="dark"] #bulk-paste-data::placeholder {
      color: var(--text-muted);
    }

    /* High contrast theme adjustments */
    [data-theme="high-contrast"] #bulk-paste-data {
      background: #000000 !important;
      color: #ffffff !important;
      border: 3px solid #ffffff !important;
      font-size: 16px; /* Larger for better readability */
    }

    [data-theme="high-contrast"] #bulk-paste-data:focus {
      border-color: #ffff00 !important;
      box-shadow: 0 0 0 3px #ffff00 !important;
    }

    [data-theme="high-contrast"] #bulk-paste-data::placeholder {
      color: #cccccc !important;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      #bulk-paste-data {
        min-height: 250px;
        font-size: 16px; /* Prevent zoom on iOS */
      }

      .bulk-paste-section {
        padding: 16px;
      }

      .bulk-paste-section button {
        width: 100%;
        max-width: none;
      }
    }
    /* === PRECISE DARK THEME FIX === */
    /* Add this to your style.css file to fix the white sections */

    /* Fix the main container and page background */
    [data-theme="dark"] html {
      background-color: #1a1a1a !important;
    }

    [data-theme="dark"] body {
      background-color: #1a1a1a !important;
    }

    [data-theme="dark"] .container {
      background-color: #1a1a1a !important;
    }

    /* Fix the header section */
    [data-theme="dark"] .header {
      background-color: #1a1a1a !important;
      border-bottom-color: #495057 !important;
    }

    /* Fix all main content sections */
    [data-theme="dark"] .main-content {
      background-color: #1a1a1a !important;
    }

    [data-theme="dark"] .section {
      background-color: #1a1a1a !important;
    }

    [data-theme="dark"] #dashboard {
      background-color: #1a1a1a !important;
    }

    [data-theme="dark"] #add-request {
      background-color: #1a1a1a !important;
    }

    [data-theme="dark"] #all-requests {
      background-color: #1a1a1a !important;
    }

    [data-theme="dark"] #import-export {
      background-color: #1a1a1a !important;
    }

    [data-theme="dark"] #settings {
      background-color: #1a1a1a !important;
    }

    /* Fix any nested divs that might have white backgrounds */
    [data-theme="dark"] .section > div:not(.stat-card):not(.request-card):not(.enhanced-filters):not(.card) {
      background-color: transparent !important;
    }

    /* Ensure headings are visible */
    [data-theme="dark"] .section h2,
    [data-theme="dark"] .section h3 {
      color: #ffffff !important;
    }
    [data-theme="dark"] {
      --text-primary: #ffffff !important;
      --text-secondary: #e0e0e0 !important;
      --text-muted: #b0b0b0 !important;
    }

    [data-theme="dark"] body,
    [data-theme="dark"] .container,
    [data-theme="dark"] .section,
    [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3,
    [data-theme="dark"] p, [data-theme="dark"] span, [data-theme="dark"] div,
    [data-theme="dark"] label, [data-theme="dark"] .form-label {
      color: #ffffff !important;
    }

    [data-theme="dark"] .form-help,
    [data-theme="dark"] small {
      color: #e0e0e0 !important;
    }

    [data-theme="dark"] .empty-message {
      color: #b0b0b0 !important;
      font-weight: 500;
    }

    /* 2. Fix progress line hover issue */
    .progress-step:hover::before {
      display: none;
    }

    .progress-step {
      position: relative;
      z-index: 10;
    }

    .progress-bar {
      z-index: 1;
    }

    /* 3. Larger nav icons for better UX/accessibility */
    .nav-icon {
      width: 24px !important;
      height: 24px !important;
      margin-right: 12px;
    }

    .nav-tab {
      padding: 16px 24px !important;
      font-size: 1.1rem !important;
      min-height: 56px !important; /* WCAG AAA touch target */
    }

    /* Better spacing between nav items */
    .nav-tabs {
      gap: 4px;
    }

    /* 4. Improve contrast for accessibility (WCAG AAA 7:1 ratio) */

    /* Online/Offline indicator - better contrast */
    .online-indicator {
      background: #00c851 !important; /* High contrast green */
      color: #000000 !important;
      font-weight: 700 !important;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .offline-indicator {
      background: #ff4444 !important; /* High contrast red */
      color: #ffffff !important;
      font-weight: 700 !important;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Better contrast for "No recent requests" */
    .empty-message {
      color: #666666 !important; /* Better contrast ratio */
      font-weight: 600 !important;
      font-size: 1.1rem !important;
      text-align: center;
      padding: 40px 20px;
      background: rgba(100, 100, 100, 0.1);
      border-radius: 8px;
      border: 2px dashed #999999;
    }

    [data-theme="dark"] .empty-message {
      color: #cccccc !important;
      background: rgba(255, 255, 255, 0.05);
      border-color: #666666;
    }

    /* Fix missing form labels - ensure all labels are visible */
    .form-label {
      font-weight: 600 !important;
      font-size: 1rem !important;
      margin-bottom: 8px !important;
      color: var(--text-primary) !important;
      display: block !important;
    }

    /* Ensure all form elements have proper contrast */
    .form-control, .search-input, .filter-select {
      border: 2px solid #999999 !important;
      color: #000000 !important;
      background: #ffffff !important;
    }

    [data-theme="dark"] .form-control,
    [data-theme="dark"] .search-input,
    [data-theme="dark"] .filter-select {
      border: 2px solid #666666 !important;
      color: #ffffff !important;
      background: #2d2d2d !important;
    }

    /* Focus states with high contrast */
    .form-control:focus,
    .search-input:focus,
    .filter-select:focus {
      outline: 3px solid #0066cc !important;
      outline-offset: 2px !important;
      border-color: #0066cc !important;
    }

    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .search-input:focus,
    [data-theme="dark"] .filter-select:focus {
      outline: 3px solid #66b3ff !important;
      border-color: #66b3ff !important;
    }

    /* High contrast mode improvements */
    [data-theme="high-contrast"] .online-indicator {
      background: #00ff00 !important;
      color: #000000 !important;
      border: 2px solid #000000 !important;
    }

    [data-theme="high-contrast"] .offline-indicator {
      background: #ff0000 !important;
      color: #ffffff !important;
      border: 2px solid #ffffff !important;
    }

    [data-theme="high-contrast"] .empty-message {
      color: #ffffff !important;
      background: #000000 !important;
      border: 3px solid #ffffff !important;
    }

    /* Navigation icon improvements for accessibility */
    .nav-tab:focus {
      outline: 3px solid #0066cc !important;
      outline-offset: 2px !important;
    }

    [data-theme="dark"] .nav-tab:focus {
      outline: 3px solid #66b3ff !important;
    }

    [data-theme="high-contrast"] .nav-tab:focus {
      outline: 3px solid #ffff00 !important;
    }
    /* === PROGRESS INDICATOR CSS === */
    /* Add this to your style.css for import progress indicators */

    .progress-container {
      margin: 16px 0;
      padding: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 4px;
      transition: width 0.3s ease;
      animation: progressPulse 2s infinite;
    }

    .progress-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-align: center;
      font-weight: 500;
    }

    @keyframes progressPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Dark theme progress indicators */
    [data-theme="dark"] .progress-container {
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .progress-bar-container {
      background: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .progress-text {
      color: var(--text-secondary);
    }

    /* High contrast theme */
    [data-theme="high-contrast"] .progress-bar-fill {
      background: #ffff00;
    }

    [data-theme="high-contrast"] .progress-container {
      border: 2px solid var(--border-color);
    }
    /* === SIMPLE CONNECTION STATUS FIX === */
    /* Add this to your style.css to override the existing connection status */

    #connection-status {
      position: fixed !important;
      top: 10px !important;
      right: 10px !important;
      z-index: 10000 !important;
      padding: 6px 12px !important;
      border-radius: 16px !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
      background: transparent !important;
      color: #000000 !important;
      border: 1px solid #e0e0e0 !important;
    }

    /* Dark theme connection status */
    [data-theme="dark"] #connection-status {
      color: #ffffff !important;
      border-color: #495057 !important;
    }

    /* High contrast theme */
    [data-theme="high-contrast"] #connection-status {
      color: #ffffff !important;
      background: #000000 !important;
      border: 2px solid #ffffff !important;
    }

    /* Optional: subtle hover effect */
    #connection-status:hover {
      background: rgba(0, 0, 0, 0.05) !important;
    }

    [data-theme="dark"] #connection-status:hover {
      background: rgba(255, 255, 255, 0.05) !important;
    }

    /* Remove any existing online/offline indicator styles */
    .online-indicator,
    .offline-indicator {
      background: transparent !important;
      color: #000000 !important;
      border: 1px solid #e0e0e0 !important;
      padding: 6px 12px !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
    }

    [data-theme="dark"] .online-indicator,
    [data-theme="dark"] .offline-indicator {
      color: #ffffff !important;
      border-color: #495057 !important;
    }
    .app-logo {
      height: 48px;
      width: auto;
      object-fit: contain;
    }

    /* SVG-specific optimizations */
    .app-logo[src$=".svg"] {
      height: 48px;
      width: auto;
      /* SVGs scale perfectly, so no additional properties needed */
    }

    .connection-clean {
      background: transparent !important;
      color: #666666 !important;
      font-weight: 400 !important;
      font-size: 0.7rem !important;
      opacity: 0.7 !important;
      box-shadow: none !important;
    }

    .connection-indicator.offline {
      background: #ff4444 !important;
      color: white !important;
      opacity: 1 !important;
      font-weight: 600 !important;
    }

  </style>
  <!-- <link rel="icon" type="image/x-icon" href="logo/favicon.ico"> -->
  <!-- <link rel="icon" type="image/png" sizes="16x16" href="logo/favicon-16x16.png"> -->
  <!-- <link rel="icon" type="image/png" sizes="32x32" href="logo/favicon-32x32.png"> -->
  <!-- <link rel="apple-touch-icon" sizes="180x180" href="logo/apple-touch-icon.png"> -->
  <!-- <link rel="icon" type="image/png" sizes="192x192" href="logo/android-chrome-192x192.png"> -->
  <!-- <link rel="icon" type="image/png" sizes="512x512" href="logo/android-chrome-512x512.png"> -->

  <!-- Local Dependencies for Offline Support -->



  <!--<script src="assets/js/documentation.js"></script>-->



<style>
/* v2 chips + mild polish */
.chips { display:flex; flex-wrap:wrap; gap:.375rem; }
.chip { display:inline-flex; align-items:center; padding:.22rem .55rem; border-radius:999px; border:1.5px solid currentColor; font-size:.85rem; line-height:1.2; white-space:nowrap; cursor:pointer; }
.chip.mesh { color:#0a7a4b; }
.chip.phase { color:#a43b00; }
.chip.status { color:#0a58b7; }
.chip.sponsor { color:#444; }
.chip.pmid { color:#1d4ed8; }
.chip.suggest { color:#065f46; }
.chip:focus-visible { outline:3px solid #1a73e8; outline-offset:2px; }
.table-chips { margin-top:.25rem; display:flex; flex-wrap:wrap; gap:.25rem; }
</style>

</head>
<body>
<div class="container">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo-container">
        <!-- <img src="logo/silentstacks-logo.svg" alt="SilentStacks Logo" class="app-logo">-->
        <div class="header-text">
          <h1>SilentStacks <span class="version-badge">V 1.2</span></h1>
          <p>Interlibrary Loan Request Tracking</p>
        </div>
      </div>

      <!-- Online/Offline Status Indicator -->
      <div class="status-indicator-container">
        <div  class="online-indicator">
          <span class="status-dot"></span>
          <span class="status-text">Online</span>
        </div>
      </div>
    </div>
    <!-- Navigation -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-section="dashboard">
        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Dashboard
      </button>
      <button class="nav-tab" data-section="add-request">
        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
        Add Request
      </button>
      <button class="nav-tab" data-section="all-requests">
        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        All Requests
      </button>
      <button class="nav-tab" data-section="import-export">
        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14,2 14,8 20,8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10,9 9,9 8,9"></polyline>
        </svg>
        Import/Export
      </button>
      <button class="nav-tab" data-section="settings">
        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="m12 1 1.68 4.02L18 6.7l-1.02 4.98L21 12l-4.02 1.68L15.3 18l-4.98-1.02L12 21l-1.68-4.02L6 15.3l1.02-4.98L3 12l4.02-1.68L8.7 6l4.98 1.02z"></path>
        </svg>
        Settings
      </button>
    </nav>

    <!-- Main Content -->
  </header>
  <main class="main-content">
    <!-- Dashboard Section -->
    <section id="dashboard" class="section active">
      <h2>Dashboard</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Requests</h3>
          <p class="stat-number" id="total-requests">0</p>
        </div>
        <div class="stat-card">
          <h3>Pending</h3>
          <p class="stat-number" id="pending-requests">0</p>
        </div>
        <div class="stat-card">
          <h3>Fulfilled</h3>
          <p class="stat-number" id="fulfilled-requests">0</p>
        </div>
        <div class="stat-card">
          <h3>Follow-up Needed</h3>
          <p class="stat-number" id="followup-requests">0</p>
        </div>
      </div>

      <h3>Recent Requests</h3>
      <div id="recent-requests" class="request-list">
        <p class="empty-message">No recent requests</p>
      </div>
    </section>

    <!-- Add Request Section -->
    <section id="add-request" class="section">
      <h2>Add New Request</h2>
      <form id="request-form" class="request-form">
        <!-- Progress Indicator -->
        <div class="form-progress" role="progressbar" aria-valuenow="1" aria-valuemin="1" aria-valuemax="3">
          <div class="progress-steps">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 33%"></div>
            </div>
            <div class="progress-step active" data-step="1" data-target="identifiers-section">
              <span class="step-number">1</span>
              <span class="step-label">Identifiers</span>
            </div>
            <div class="progress-step" data-step="2" data-target="details-section">
              <span class="step-number">2</span>
              <span class="step-label">Details</span>
            </div>
            <div class="progress-step" data-step="3" data-target="request-section">
              <span class="step-number">3</span>
              <span class="step-label">Complete</span>
            </div>
          </div>
        </div>

        <!-- Identifiers -->
        <fieldset class="fieldset-enhanced" id="identifiers-section">
          <legend>Identifiers</legend>

          <div class="form-group">
            <label for="pmid" class="form-label optional">
              PMID (PubMed ID)
              <span class="field-priority preferred">Preferred</span>
            </label>
            <div class="input-with-button enhanced">
              <input type="text" id="pmid" name="pmid" class="form-control identifier-field"
                     placeholder="e.g., 23842776" pattern="[0-9]+"
                     aria-describedby="pmid-help">
              <button type="button" id="lookup-pmid" class="btn btn-primary lookup-btn">
                <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.35-4.35"></path>
                </svg>
                Lookup
              </button>
            </div>
            <small id="pmid-help" class="form-help">Enter PubMed ID for automatic title, author, and journal retrieval</small>

            <!-- FIXED: Status message moved here for PMID -->
            <div id="pmid-status" class="lookup-status"></div>
          </div>

          <div class="form-group">
            <label for="doi" class="form-label optional">
              DOI (Digital Object Identifier)
              <span class="field-priority optional">Alternative</span>
            </label>
            <div class="input-with-button enhanced">
              <input type="text" id="doi" name="doi" class="form-control identifier-field"
                     placeholder="e.g., 10.1038/nature12373"
                     aria-describedby="doi-help">
              <button type="button" id="lookup-doi" class="btn btn-primary lookup-btn">
                <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                </svg>
                Lookup
              </button>
            </div>
            <small id="doi-help" class="form-help">CrossRef lookup for bibliographic metadata</small>

            <!-- FIXED: Status message moved here for DOI -->
            <div id="doi-status" class="lookup-status"></div>
          </div>

          <div class="form-group">
            <label for="docline" class="form-label optional">DOCLINE Request Number</label>
            <input type="text" id="docline" name="docline" class="form-control tracking-field"
                   placeholder="e.g., 138ABC123" aria-describedby="docline-help">
            <small id="docline-help" class="form-help">ILL tracking number for existing DOCLINE requests</small>
          </div>
        </fieldset>

        <!-- Publication Details -->
        <fieldset class="fieldset-enhanced" id="details-section">
          <legend>Publication Details</legend>

          <div class="form-group">
            <label for="title" class="form-label required">Publication Title</label>
            <input type="text" id="title" name="title" class="form-control title-field"
                   required aria-describedby="title-help"
                   placeholder="Complete title of the requested publication">
            <small id="title-help" class="form-help required">Full title as it appears in the source publication</small>
            <div class="field-validation-icon"></div>
          </div>

          <div class="form-group">
            <label for="authors" class="form-label optional">Author(s)</label>
            <input type="text" id="authors" name="authors" class="form-control author-field"
                   placeholder="Smith, J.; Johnson, A.; et al."
                   aria-describedby="authors-help">
            <small id="authors-help" class="form-help">Author names in Last, First Initial format separated by semicolons</small>
          </div>

          <div class="form-group">
            <label for="journal" class="form-label optional">Journal/Publication Source</label>
            <input type="text" id="journal" name="journal" class="form-control journal-field"
                   placeholder="Journal of Medical Research"
                   aria-describedby="journal-help">
            <small id="journal-help" class="form-help">Full journal name, book title, or publication source</small>
          </div>

          <div class="form-group">
            <label for="year" class="form-label optional">Publication Year</label>
            <input type="number" id="year" name="year" class="form-control year-field"
                   min="1900" max="2030" placeholder="2024"
                   aria-describedby="year-help">
            <small id="year-help" class="form-help">4-digit publication year</small>
          </div>
        </fieldset>

        <!-- Request Details -->
        <fieldset class="fieldset-enhanced" id="request-section">
          <legend>Request Details</legend>

          <div class="form-group">
            <label for="patron-email" class="form-label optional">Patron Email</label>
            <input type="email" id="patron-email" name="patronEmail" class="form-control"
                   placeholder="patron@example.com"
                   aria-describedby="email-help">
            <small id="email-help" class="form-help">Contact email for the requesting patron</small>
          </div>

          <div class="form-group">
            <label for="priority" class="form-label required">Request Priority</label>
            <select id="priority" name="priority" class="form-control priority-select" required aria-describedby="priority-help">
              <option value="">Select Priority...</option>
              <option value="urgent">Urgent - Critical Patient Care</option>
              <option value="rush">Rush - Expedited Timeline</option>
              <option value="normal">Normal - Standard Processing</option>
            </select>
            <small id="priority-help" class="form-help required">Priority determines processing timeline and resource allocation</small>
          </div>

          <div class="form-group">
            <label for="status" class="form-label optional">Request Status</label>
            <select id="status" name="status" class="form-control request-status-select" aria-describedby="status-help">
              <option value="pending">Pending - Awaiting Processing</option>
              <option value="in-progress">In Progress - Actively Working</option>
              <option value="fulfilled">Fulfilled - Successfully Completed</option>
              <option value="cancelled">Cancelled - Request Withdrawn</option>
            </select>
            <small id="status-help" class="form-help">Current status of the ILL request</small>
          </div>

          <div class="form-group">
            <label for="tags" class="form-label optional">Subject Tags</label>
            <input type="text" id="tags" name="tags" class="form-control"
                   placeholder="e.g., cardiology, review, systematic"
                   aria-describedby="tags-help">
            <small id="tags-help" class="form-help">Enter tags separated by commas. Click tags in request cards to change their colors.</small>
          </div>

          <div class="form-group">
            <label for="notes" class="form-label optional">Additional Notes</label>
            <textarea id="notes" name="notes" rows="3" class="form-control"
                      placeholder="Any special instructions or notes..."
                      aria-describedby="notes-help"></textarea>
            <small id="notes-help" class="form-help">Internal notes about this request</small>
          </div>
        </fieldset>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Save Request
          </button>
          <button type="button" class="btn btn-secondary" id="clear-form">
            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18l-2 13H5L3 6z"></path>
              <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Clear Form
          </button>
        </div>
      </form>

      <!-- REMOVED: Old lookup status - now inline with each lookup -->
    </section>

    <!-- Enhanced All Requests Section -->
    <section id="all-requests" class="section">
      <h2>All Requests</h2>

      <!-- Enhanced Filters -->
      <div class="enhanced-filters">
        <div class="filter-row">
          <input type="text" id="search-requests" placeholder="Search requests..." class="search-input">
          <select id="filter-status" class="filter-select">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="fulfilled">Fulfilled</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <select id="priority-filter" class="filter-select priority-filter">
            <option value="">All Priorities</option>
            <option value="urgent">Urgent</option>
            <option value="rush">Rush</option>
            <option value="normal">Normal</option>
          </select>
          <select id="date-range" class="filter-select">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="overdue">Overdue</option>
          </select>
          <button id="filter-followup" class="btn btn-secondary">
            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Follow-up Needed
          </button>
        </div>

        <!-- Sort and Results -->
        <div class="filter-row">
          <div class="sort-controls">
            <span class="sort-label">Sort by:</span>
            <button class="sort-btn sort-desc" data-field="createdAt">📅 Date</button>
            <button class="sort-btn" data-field="priority">🚨 Priority</button>
            <button class="sort-btn" data-field="title">📄 Title</button>
            <button class="sort-btn" data-field="journal">📚 Journal</button>
            <button class="sort-btn" data-field="status">📊 Status</button>
          </div>
          <div class="results-info">
            <span id="results-count">0 requests</span>
            <label class="select-all-label">
              <input type="checkbox" id="select-all" onchange="toggleSelectAll(this.checked)"> Select All
            </label>
            <!-- FIXED: Added btn-danger class -->
            <button onclick="deleteSelectedRequests()" class="btn btn-danger btn-small" id="delete-selected-btn" style="display: none;">
              🗑️ Delete Selected
            </button>
            <!-- v2.0: Toggle between card and table view -->
            <button id="toggle-view" class="btn btn-secondary btn-small" aria-pressed="false" aria-label="Toggle table view" title="Toggle between card and table views">
              📄 Table View
            </button>
          </div>
        </div>
      </div>

      <!-- Request List -->
      <div id="request-list" class="request-list">
        <p class="empty-message">No requests found</p>
      </div>

      <!-- v2.0 Table View -->
      <!-- New markup inserted to support the table-based layout required by the v2.0 spec.
                 This does not modify existing elements; it provides an additional container
                 that can be toggled via JavaScript. -->
      <div id="requests-table-container" class="table-responsive" aria-label="Requests Table" style="display: none; margin-top: 1rem;">
        <table id="requests-table" class="requests-table" style="width:100%; border-collapse: collapse;">
          <thead>
          <tr>
            <th>Urgency</th>
            <th>Docline Number</th>
            <th>PMID</th>
            <th>Citation</th>
            <th>Patron Name</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody id="requests-tbody">
          </tbody>
        </table>
      </div>
    </section>

    <!-- Import/Export Section -->
    <section id="import-export" class="section">
      <h2>Import/Export Data</h2>

      <div class="import-export-grid">
        <!-- Export Card -->
        <div class="card">
          <h3>
            <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            Export Data
          </h3>
          <p>Download your ILL requests as CSV or JSON</p>
          <div class="button-group">
            <button id="export-csv" class="btn btn-primary">
              <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
              </svg>
              Export as CSV
            </button>
            <button id="export-json" class="btn btn-primary">
              <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
              </svg>
              Export as JSON
            </button>
          </div>
        </div>

        <!-- Import Card -->
        <div class="card">
          <h3>
            <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            Import Data
          </h3>
          <p>Upload CSV or JSON file with ILL requests</p>
          <input type="file" id="import-file" accept=".csv,.json" class="file-input">
          <div id="import-status" class="import-status"></div>
        </div>
      </div>

      <!-- Bulk Paste Section -->
      <div class="bulk-paste-section">
        <h3>
          <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
          </svg>
          Bulk Paste Data
        </h3>
        <p class="bulk-paste-help">Paste CSV data directly from your clipboard (Excel, Google Sheets, etc.)</p>
        <textarea id="bulk-paste-data" placeholder="Paste CSV data here with headers like: PMID, Title, Authors, Journal, Year, Priority..."></textarea>
        <p class="bulk-paste-help"><strong>Supported headers:</strong> PMID/pmid, DOI/doi, Title/title, Authors/authors, Journal/journal, Year/year, Priority/priority, Notes/notes</p>
        <button id="bulk-paste-btn" class="btn btn-primary">
          <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10,9 9,9 8,9"></polyline>
          </svg>
          Import Pasted Data
        </button>
      </div>
    </section>

    <!-- Settings Section -->
    <section id="settings" class="section">
      <h2>Settings</h2>

      <form id="settings-form" class="settings-form">
        <div class="form-group">
          <label for="followup-days">Follow-up Days</label>
          <input type="number" id="followup-days" min="1" max="30" value="5">
          <small>Mark requests as needing follow-up after this many days</small>
        </div>

        <div class="form-group">
          <label for="theme">Theme</label>
          <select id="theme">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="high-contrast">High Contrast</option>
          </select>
        </div>

        <div class="form-group">
          <label for="api-key">PubMed API Key (Optional)</label>
          <input type="text" id="api-key" placeholder="Enter your NCBI API key">
          <small>Provides higher rate limits for PubMed lookups</small>
        </div>

        <div class="form-group">
          <label for="crossref-email">Crossref Email (Optional)</label>
          <input type="email" id="crossref-email" placeholder="your@email.com">
          <small>Enables polite pool access for DOI lookups</small>
        </div>

        <button type="submit" class="btn btn-primary">
          <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="m12 1 1.68 4.02L18 6.7l-1.02 4.98L21 12l-4.02 1.68L15.3 18l-4.98-1.02L12 21l-1.68-4.02L6 15.3l1.02-4.98L3 12l4.02-1.68L8.7 6l4.98 1.02z"></path>
          </svg>
          Save Settings
        </button>
      </form>
    </section>
  </main>
</div>

<!-- JavaScript -->
<!-- <script src="assets/js/app.js"></script> -->
<script>
  /**
   * Fuse.js v7.1.0 - Lightweight fuzzy-search (http://fusejs.io)
   *
   * Copyright (c) 2025 Kiro Risk (http://kiro.me)
   * All Rights Reserved. Apache Software License 2.0
   *
   * http://www.apache.org/licenses/LICENSE-2.0
   */
  var e,t;e=this,t=function(){"use strict";function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function t(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach((function(e){o(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,v(r.key),r)}}function u(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,t,n){return(t=v(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&s(e,t)}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}function s(e,t){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},s(e,t)}function h(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=a(e);if(t){var i=a(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return h(this,n)}}function f(e){return function(e){if(Array.isArray(e))return d(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?d(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function v(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function g(e){return Array.isArray?Array.isArray(e):"[object Array]"===M(e)}var y=1/0;function p(e){return null==e?"":function(e){if("string"==typeof e)return e;var t=e+"";return"0"==t&&1/e==-y?"-0":t}(e)}function A(e){return"string"==typeof e}function m(e){return"number"==typeof e}function C(e){return!0===e||!1===e||function(e){return k(e)&&null!==e}(e)&&"[object Boolean]"==M(e)}function k(e){return"object"===n(e)}function E(e){return null!=e}function F(e){return!e.trim().length}function M(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}var b=function(e){return"Missing ".concat(e," property in key")},D=function(e){return"Property 'weight' in key '".concat(e,"' must be a positive integer")},B=Object.prototype.hasOwnProperty,x=function(){function e(t){var n=this;r(this,e),this._keys=[],this._keyMap={};var i=0;t.forEach((function(e){var t=w(e);n._keys.push(t),n._keyMap[t.id]=t,i+=t.weight})),this._keys.forEach((function(e){e.weight/=i}))}return u(e,[{key:"get",value:function(e){return this._keyMap[e]}},{key:"keys",value:function(){return this._keys}},{key:"toJSON",value:function(){return JSON.stringify(this._keys)}}]),e}();function w(e){var t=null,n=null,r=null,i=1,u=null;if(A(e)||g(e))r=e,t=S(e),n=L(e);else{if(!B.call(e,"name"))throw new Error(b("name"));var o=e.name;if(r=o,B.call(e,"weight")&&(i=e.weight)<=0)throw new Error(D(o));t=S(o),n=L(o),u=e.getFn}return{path:t,id:n,weight:i,src:r,getFn:u}}function S(e){return g(e)?e:e.split(".")}function L(e){return g(e)?e.join("."):e}var _={useExtendedSearch:!1,getFn:function(e,t){var n=[],r=!1;return function e(t,i,u){if(E(t))if(i[u]){var o=t[i[u]];if(!E(o))return;if(u===i.length-1&&(A(o)||m(o)||C(o)))n.push(p(o));else if(g(o)){r=!0;for(var c=0,a=o.length;c<a;c+=1)e(o[c],i,u+1)}else i.length&&e(o,i,u+1)}else n.push(t)}(e,A(t)?t.split("."):t,0),r?n:n[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1},O=t(t(t(t({},{isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:function(e,t){return e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1}}),{includeMatches:!1,findAllMatches:!1,minMatchCharLength:1}),{location:0,threshold:.6,distance:100}),_),j=/[^ ]+/g,I=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.getFn,i=void 0===n?O.getFn:n,u=t.fieldNormWeight,o=void 0===u?O.fieldNormWeight:u;r(this,e),this.norm=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,n=new Map,r=Math.pow(10,t);return{get:function(t){var i=t.match(j).length;if(n.has(i))return n.get(i);var u=1/Math.pow(i,.5*e),o=parseFloat(Math.round(u*r)/r);return n.set(i,o),o},clear:function(){n.clear()}}}(o,3),this.getFn=i,this.isCreated=!1,this.setIndexRecords()}return u(e,[{key:"setSources",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.docs=e}},{key:"setIndexRecords",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.records=e}},{key:"setKeys",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.keys=t,this._keysMap={},t.forEach((function(t,n){e._keysMap[t.id]=n}))}},{key:"create",value:function(){var e=this;!this.isCreated&&this.docs.length&&(this.isCreated=!0,A(this.docs[0])?this.docs.forEach((function(t,n){e._addString(t,n)})):this.docs.forEach((function(t,n){e._addObject(t,n)})),this.norm.clear())}},{key:"add",value:function(e){var t=this.size();A(e)?this._addString(e,t):this._addObject(e,t)}},{key:"removeAt",value:function(e){this.records.splice(e,1);for(var t=e,n=this.size();t<n;t+=1)this.records[t].i-=1}},{key:"getValueForItemAtKeyId",value:function(e,t){return e[this._keysMap[t]]}},{key:"size",value:function(){return this.records.length}},{key:"_addString",value:function(e,t){if(E(e)&&!F(e)){var n={v:e,i:t,n:this.norm.get(e)};this.records.push(n)}}},{key:"_addObject",value:function(e,t){var n=this,r={i:t,$:{}};this.keys.forEach((function(t,i){var u=t.getFn?t.getFn(e):n.getFn(e,t.path);if(E(u))if(g(u)){for(var o=[],c=[{nestedArrIndex:-1,value:u}];c.length;){var a=c.pop(),s=a.nestedArrIndex,h=a.value;if(E(h))if(A(h)&&!F(h)){var l={v:h,i:s,n:n.norm.get(h)};o.push(l)}else g(h)&&h.forEach((function(e,t){c.push({nestedArrIndex:t,value:e})}))}r.$[i]=o}else if(A(u)&&!F(u)){var f={v:u,n:n.norm.get(u)};r.$[i]=f}})),this.records.push(r)}},{key:"toJSON",value:function(){return{keys:this.keys,records:this.records}}}]),e}();function $(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.getFn,i=void 0===r?O.getFn:r,u=n.fieldNormWeight,o=void 0===u?O.fieldNormWeight:u,c=new I({getFn:i,fieldNormWeight:o});return c.setKeys(e.map(w)),c.setSources(t),c.create(),c}function R(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.errors,r=void 0===n?0:n,i=t.currentLocation,u=void 0===i?0:i,o=t.expectedLocation,c=void 0===o?0:o,a=t.distance,s=void 0===a?O.distance:a,h=t.ignoreLocation,l=void 0===h?O.ignoreLocation:h,f=r/e.length;if(l)return f;var d=Math.abs(c-u);return s?f+d/s:d?1:f}var N=32;function P(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=r.location,u=void 0===i?O.location:i,o=r.distance,c=void 0===o?O.distance:o,a=r.threshold,s=void 0===a?O.threshold:a,h=r.findAllMatches,l=void 0===h?O.findAllMatches:h,f=r.minMatchCharLength,d=void 0===f?O.minMatchCharLength:f,v=r.includeMatches,g=void 0===v?O.includeMatches:v,y=r.ignoreLocation,p=void 0===y?O.ignoreLocation:y;if(t.length>N)throw new Error("Pattern length exceeds max of ".concat(N,"."));for(var A,m=t.length,C=e.length,k=Math.max(0,Math.min(u,C)),E=s,F=k,M=d>1||g,b=M?Array(C):[];(A=e.indexOf(t,F))>-1;){var D=R(t,{currentLocation:A,expectedLocation:k,distance:c,ignoreLocation:p});if(E=Math.min(D,E),F=A+m,M)for(var B=0;B<m;)b[A+B]=1,B+=1}F=-1;for(var x=[],w=1,S=m+C,L=1<<m-1,_=0;_<m;_+=1){for(var j=0,I=S;j<I;)R(t,{errors:_,currentLocation:k+I,expectedLocation:k,distance:c,ignoreLocation:p})<=E?j=I:S=I,I=Math.floor((S-j)/2+j);S=I;var $=Math.max(1,k-I+1),P=l?C:Math.min(k+I,C)+m,W=Array(P+2);W[P+1]=(1<<_)-1;for(var z=P;z>=$;z-=1){var T=z-1,K=n[e.charAt(T)];if(M&&(b[T]=+!!K),W[z]=(W[z+1]<<1|1)&K,_&&(W[z]|=(x[z+1]|x[z])<<1|1|x[z+1]),W[z]&L&&(w=R(t,{errors:_,currentLocation:T,expectedLocation:k,distance:c,ignoreLocation:p}))<=E){if(E=w,(F=T)<=k)break;$=Math.max(1,2*k-F)}}if(R(t,{errors:_+1,currentLocation:k,expectedLocation:k,distance:c,ignoreLocation:p})>E)break;x=W}var q={isMatch:F>=0,score:Math.max(.001,w)};if(M){var J=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:O.minMatchCharLength,n=[],r=-1,i=-1,u=0,o=e.length;u<o;u+=1){var c=e[u];c&&-1===r?r=u:c||-1===r||((i=u-1)-r+1>=t&&n.push([r,i]),r=-1)}return e[u-1]&&u-r>=t&&n.push([r,u-1]),n}(b,d);J.length?g&&(q.indices=J):q.isMatch=!1}return q}function W(e){for(var t={},n=0,r=e.length;n<r;n+=1){var i=e.charAt(n);t[i]=(t[i]||0)|1<<r-n-1}return t}var z=String.prototype.normalize?function(e){return e.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,"")}:function(e){return e},T=function(){function e(t){var n=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},u=i.location,o=void 0===u?O.location:u,c=i.threshold,a=void 0===c?O.threshold:c,s=i.distance,h=void 0===s?O.distance:s,l=i.includeMatches,f=void 0===l?O.includeMatches:l,d=i.findAllMatches,v=void 0===d?O.findAllMatches:d,g=i.minMatchCharLength,y=void 0===g?O.minMatchCharLength:g,p=i.isCaseSensitive,A=void 0===p?O.isCaseSensitive:p,m=i.ignoreDiacritics,C=void 0===m?O.ignoreDiacritics:m,k=i.ignoreLocation,E=void 0===k?O.ignoreLocation:k;if(r(this,e),this.options={location:o,threshold:a,distance:h,includeMatches:f,findAllMatches:v,minMatchCharLength:y,isCaseSensitive:A,ignoreDiacritics:C,ignoreLocation:E},t=A?t:t.toLowerCase(),t=C?z(t):t,this.pattern=t,this.chunks=[],this.pattern.length){var F=function(e,t){n.chunks.push({pattern:e,alphabet:W(e),startIndex:t})},M=this.pattern.length;if(M>N){for(var b=0,D=M%N,B=M-D;b<B;)F(this.pattern.substr(b,N),b),b+=N;if(D){var x=M-N;F(this.pattern.substr(x),x)}}else F(this.pattern,0)}}return u(e,[{key:"searchIn",value:function(e){var t=this.options,n=t.isCaseSensitive,r=t.ignoreDiacritics,i=t.includeMatches;if(e=n?e:e.toLowerCase(),e=r?z(e):e,this.pattern===e){var u={isMatch:!0,score:0};return i&&(u.indices=[[0,e.length-1]]),u}var o=this.options,c=o.location,a=o.distance,s=o.threshold,h=o.findAllMatches,l=o.minMatchCharLength,d=o.ignoreLocation,v=[],g=0,y=!1;this.chunks.forEach((function(t){var n=t.pattern,r=t.alphabet,u=t.startIndex,o=P(e,n,r,{location:c+u,distance:a,threshold:s,findAllMatches:h,minMatchCharLength:l,includeMatches:i,ignoreLocation:d}),p=o.isMatch,A=o.score,m=o.indices;p&&(y=!0),g+=A,p&&m&&(v=[].concat(f(v),f(m)))}));var p={isMatch:y,score:y?g/this.chunks.length:1};return y&&i&&(p.indices=v),p}}]),e}(),K=function(){function e(t){r(this,e),this.pattern=t}return u(e,[{key:"search",value:function(){}}],[{key:"isMultiMatch",value:function(e){return q(e,this.multiRegex)}},{key:"isSingleMatch",value:function(e){return q(e,this.singleRegex)}}]),e}();function q(e,t){var n=e.match(t);return n?n[1]:null}var J=function(e){c(n,e);var t=l(n);function n(e){return r(this,n),t.call(this,e)}return u(n,[{key:"search",value:function(e){var t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}}],[{key:"type",get:function(){return"exact"}},{key:"multiRegex",get:function(){return/^="(.*)"$/}},{key:"singleRegex",get:function(){return/^=(.*)$/}}]),n}(K),U=function(e){c(n,e);var t=l(n);function n(e){return r(this,n),t.call(this,e)}return u(n,[{key:"search",value:function(e){var t=-1===e.indexOf(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}}],[{key:"type",get:function(){return"inverse-exact"}},{key:"multiRegex",get:function(){return/^!"(.*)"$/}},{key:"singleRegex",get:function(){return/^!(.*)$/}}]),n}(K),V=function(e){c(n,e);var t=l(n);function n(e){return r(this,n),t.call(this,e)}return u(n,[{key:"search",value:function(e){var t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}}],[{key:"type",get:function(){return"prefix-exact"}},{key:"multiRegex",get:function(){return/^\^"(.*)"$/}},{key:"singleRegex",get:function(){return/^\^(.*)$/}}]),n}(K),G=function(e){c(n,e);var t=l(n);function n(e){return r(this,n),t.call(this,e)}return u(n,[{key:"search",value:function(e){var t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}}],[{key:"type",get:function(){return"inverse-prefix-exact"}},{key:"multiRegex",get:function(){return/^!\^"(.*)"$/}},{key:"singleRegex",get:function(){return/^!\^(.*)$/}}]),n}(K),H=function(e){c(n,e);var t=l(n);function n(e){return r(this,n),t.call(this,e)}return u(n,[{key:"search",value:function(e){var t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}}],[{key:"type",get:function(){return"suffix-exact"}},{key:"multiRegex",get:function(){return/^"(.*)"\$$/}},{key:"singleRegex",get:function(){return/^(.*)\$$/}}]),n}(K),Q=function(e){c(n,e);var t=l(n);function n(e){return r(this,n),t.call(this,e)}return u(n,[{key:"search",value:function(e){var t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}}],[{key:"type",get:function(){return"inverse-suffix-exact"}},{key:"multiRegex",get:function(){return/^!"(.*)"\$$/}},{key:"singleRegex",get:function(){return/^!(.*)\$$/}}]),n}(K),X=function(e){c(n,e);var t=l(n);function n(e){var i,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=u.location,c=void 0===o?O.location:o,a=u.threshold,s=void 0===a?O.threshold:a,h=u.distance,l=void 0===h?O.distance:h,f=u.includeMatches,d=void 0===f?O.includeMatches:f,v=u.findAllMatches,g=void 0===v?O.findAllMatches:v,y=u.minMatchCharLength,p=void 0===y?O.minMatchCharLength:y,A=u.isCaseSensitive,m=void 0===A?O.isCaseSensitive:A,C=u.ignoreDiacritics,k=void 0===C?O.ignoreDiacritics:C,E=u.ignoreLocation,F=void 0===E?O.ignoreLocation:E;return r(this,n),(i=t.call(this,e))._bitapSearch=new T(e,{location:c,threshold:s,distance:l,includeMatches:d,findAllMatches:g,minMatchCharLength:p,isCaseSensitive:m,ignoreDiacritics:k,ignoreLocation:F}),i}return u(n,[{key:"search",value:function(e){return this._bitapSearch.searchIn(e)}}],[{key:"type",get:function(){return"fuzzy"}},{key:"multiRegex",get:function(){return/^"(.*)"$/}},{key:"singleRegex",get:function(){return/^(.*)$/}}]),n}(K),Y=function(e){c(n,e);var t=l(n);function n(e){return r(this,n),t.call(this,e)}return u(n,[{key:"search",value:function(e){for(var t,n=0,r=[],i=this.pattern.length;(t=e.indexOf(this.pattern,n))>-1;)n=t+i,r.push([t,n-1]);var u=!!r.length;return{isMatch:u,score:u?0:1,indices:r}}}],[{key:"type",get:function(){return"include"}},{key:"multiRegex",get:function(){return/^'"(.*)"$/}},{key:"singleRegex",get:function(){return/^'(.*)$/}}]),n}(K),Z=[J,Y,V,G,Q,H,U,X],ee=Z.length,te=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/,ne=new Set([X.type,Y.type]),re=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=n.isCaseSensitive,u=void 0===i?O.isCaseSensitive:i,o=n.ignoreDiacritics,c=void 0===o?O.ignoreDiacritics:o,a=n.includeMatches,s=void 0===a?O.includeMatches:a,h=n.minMatchCharLength,l=void 0===h?O.minMatchCharLength:h,f=n.ignoreLocation,d=void 0===f?O.ignoreLocation:f,v=n.findAllMatches,g=void 0===v?O.findAllMatches:v,y=n.location,p=void 0===y?O.location:y,A=n.threshold,m=void 0===A?O.threshold:A,C=n.distance,k=void 0===C?O.distance:C;r(this,e),this.query=null,this.options={isCaseSensitive:u,ignoreDiacritics:c,includeMatches:s,minMatchCharLength:l,findAllMatches:g,ignoreLocation:d,location:p,threshold:m,distance:k},t=u?t:t.toLowerCase(),t=c?z(t):t,this.pattern=t,this.query=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e.split("|").map((function(e){for(var n=e.trim().split(te).filter((function(e){return e&&!!e.trim()})),r=[],i=0,u=n.length;i<u;i+=1){for(var o=n[i],c=!1,a=-1;!c&&++a<ee;){var s=Z[a],h=s.isMultiMatch(o);h&&(r.push(new s(h,t)),c=!0)}if(!c)for(a=-1;++a<ee;){var l=Z[a],f=l.isSingleMatch(o);if(f){r.push(new l(f,t));break}}}return r}))}(this.pattern,this.options)}return u(e,[{key:"searchIn",value:function(e){var t=this.query;if(!t)return{isMatch:!1,score:1};var n=this.options,r=n.includeMatches,i=n.isCaseSensitive,u=n.ignoreDiacritics;e=i?e:e.toLowerCase(),e=u?z(e):e;for(var o=0,c=[],a=0,s=0,h=t.length;s<h;s+=1){var l=t[s];c.length=0,o=0;for(var d=0,v=l.length;d<v;d+=1){var g=l[d],y=g.search(e),p=y.isMatch,A=y.indices,m=y.score;if(!p){a=0,o=0,c.length=0;break}if(o+=1,a+=m,r){var C=g.constructor.type;ne.has(C)?c=[].concat(f(c),f(A)):c.push(A)}}if(o){var k={isMatch:!0,score:a/o};return r&&(k.indices=c),k}}return{isMatch:!1,score:1}}}],[{key:"condition",value:function(e,t){return t.useExtendedSearch}}]),e}(),ie=[];function ue(e,t){for(var n=0,r=ie.length;n<r;n+=1){var i=ie[n];if(i.condition(e,t))return new i(e,t)}return new T(e,t)}var oe="$and",ce="$or",ae="$path",se="$val",he=function(e){return!(!e[oe]&&!e[ce])},le=function(e){return o({},oe,Object.keys(e).map((function(t){return o({},t,e[t])})))};function fe(e,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).auto,r=void 0===n||n;return he(e)||(e=le(e)),function e(n){var i=Object.keys(n),u=function(e){return!!e[ae]}(n);if(!u&&i.length>1&&!he(n))return e(le(n));if(function(e){return!g(e)&&k(e)&&!he(e)}(n)){var o=u?n[ae]:i[0],c=u?n[se]:n[o];if(!A(c))throw new Error(function(e){return"Invalid value for key ".concat(e)}(o));var a={keyId:L(o),pattern:c};return r&&(a.searcher=ue(c,t)),a}var s={children:[],operator:i[0]};return i.forEach((function(t){var r=n[t];g(r)&&r.forEach((function(t){s.children.push(e(t))}))})),s}(e)}function de(e,t){var n=e.matches;t.matches=[],E(n)&&n.forEach((function(e){if(E(e.indices)&&e.indices.length){var n={indices:e.indices,value:e.value};e.key&&(n.key=e.key.src),e.idx>-1&&(n.refIndex=e.idx),t.matches.push(n)}}))}function ve(e,t){t.score=e.score}var ge=function(){function e(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},u=arguments.length>2?arguments[2]:void 0;r(this,e),this.options=t(t({},O),i),this.options.useExtendedSearch,this._keyStore=new x(this.options.keys),this.setCollection(n,u)}return u(e,[{key:"setCollection",value:function(e,t){if(this._docs=e,t&&!(t instanceof I))throw new Error("Incorrect 'index' type");this._myIndex=t||$(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}},{key:"add",value:function(e){E(e)&&(this._docs.push(e),this._myIndex.add(e))}},{key:"remove",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){return!1},t=[],n=0,r=this._docs.length;n<r;n+=1){var i=this._docs[n];e(i,n)&&(this.removeAt(n),n-=1,r-=1,t.push(i))}return t}},{key:"removeAt",value:function(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}},{key:"getIndex",value:function(){return this._myIndex}},{key:"search",value:function(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).limit,n=void 0===t?-1:t,r=this.options,i=r.includeMatches,u=r.includeScore,o=r.shouldSort,c=r.sortFn,a=r.ignoreFieldNorm,s=A(e)?A(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(e,t){var n=t.ignoreFieldNorm,r=void 0===n?O.ignoreFieldNorm:n;e.forEach((function(e){var t=1;e.matches.forEach((function(e){var n=e.key,i=e.norm,u=e.score,o=n?n.weight:null;t*=Math.pow(0===u&&o?Number.EPSILON:u,(o||1)*(r?1:i))})),e.score=t}))}(s,{ignoreFieldNorm:a}),o&&s.sort(c),m(n)&&n>-1&&(s=s.slice(0,n)),function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.includeMatches,i=void 0===r?O.includeMatches:r,u=n.includeScore,o=void 0===u?O.includeScore:u,c=[];return i&&c.push(de),o&&c.push(ve),e.map((function(e){var n=e.idx,r={item:t[n],refIndex:n};return c.length&&c.forEach((function(t){t(e,r)})),r}))}(s,this._docs,{includeMatches:i,includeScore:u})}},{key:"_searchStringList",value:function(e){var t=ue(e,this.options),n=this._myIndex.records,r=[];return n.forEach((function(e){var n=e.v,i=e.i,u=e.n;if(E(n)){var o=t.searchIn(n),c=o.isMatch,a=o.score,s=o.indices;c&&r.push({item:n,idx:i,matches:[{score:a,value:n,norm:u,indices:s}]})}})),r}},{key:"_searchLogical",value:function(e){var t=this,n=fe(e,this.options),r=function e(n,r,i){if(!n.children){var u=n.keyId,o=n.searcher,c=t._findMatches({key:t._keyStore.get(u),value:t._myIndex.getValueForItemAtKeyId(r,u),searcher:o});return c&&c.length?[{idx:i,item:r,matches:c}]:[]}for(var a=[],s=0,h=n.children.length;s<h;s+=1){var l=e(n.children[s],r,i);if(l.length)a.push.apply(a,f(l));else if(n.operator===oe)return[]}return a},i=this._myIndex.records,u={},o=[];return i.forEach((function(e){var t=e.$,i=e.i;if(E(t)){var c=r(n,t,i);c.length&&(u[i]||(u[i]={idx:i,item:t,matches:[]},o.push(u[i])),c.forEach((function(e){var t,n=e.matches;(t=u[i].matches).push.apply(t,f(n))})))}})),o}},{key:"_searchObjectList",value:function(e){var t=this,n=ue(e,this.options),r=this._myIndex,i=r.keys,u=r.records,o=[];return u.forEach((function(e){var r=e.$,u=e.i;if(E(r)){var c=[];i.forEach((function(e,i){c.push.apply(c,f(t._findMatches({key:e,value:r[i],searcher:n})))})),c.length&&o.push({idx:u,item:r,matches:c})}})),o}},{key:"_findMatches",value:function(e){var t=e.key,n=e.value,r=e.searcher;if(!E(n))return[];var i=[];if(g(n))n.forEach((function(e){var n=e.v,u=e.i,o=e.n;if(E(n)){var c=r.searchIn(n),a=c.isMatch,s=c.score,h=c.indices;a&&i.push({score:s,key:t,value:n,idx:u,norm:o,indices:h})}}));else{var u=n.v,o=n.n,c=r.searchIn(u),a=c.isMatch,s=c.score,h=c.indices;a&&i.push({score:s,key:t,value:u,norm:o,indices:h})}return i}}]),e}();return ge.version="7.1.0",ge.createIndex=$,ge.parseIndex=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.getFn,r=void 0===n?O.getFn:n,i=t.fieldNormWeight,u=void 0===i?O.fieldNormWeight:i,o=e.keys,c=e.records,a=new I({getFn:r,fieldNormWeight:u});return a.setKeys(o),a.setIndexRecords(c),a},ge.config=O,function(){ie.push.apply(ie,arguments)}(re),ge},"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Fuse=t();

  /* @license
Papa Parse
v5.4.1
https://github.com/mholt/PapaParse
License: MIT
*/
  ! function(e, t) {
    "function" == typeof define && define.amd ? define([], t) : "object" == typeof module && "undefined" != typeof exports ? module.exports = t() : e.Papa = t()
  }(this, function s() {
    "use strict";
    var f = "undefined" != typeof self ? self : "undefined" != typeof window ? window : void 0 !== f ? f : {};
    var n = !f.document && !!f.postMessage,
            o = f.IS_PAPA_WORKER || !1,
            a = {},
            u = 0,
            b = {
              parse: function(e, t) {
                var r = (t = t || {}).dynamicTyping || !1;
                J(r) && (t.dynamicTypingFunction = r, r = {});
                if (t.dynamicTyping = r, t.transform = !!J(t.transform) && t.transform, t.worker && b.WORKERS_SUPPORTED) {
                  var i = function() {
                    if (!b.WORKERS_SUPPORTED) return !1;
                    var e = (r = f.URL || f.webkitURL || null, i = s.toString(), b.BLOB_URL || (b.BLOB_URL = r.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ", "(", i, ")();"], {
                              type: "text/javascript"
                            })))),
                            t = new f.Worker(e);
                    var r, i;
                    return t.onmessage = _, t.id = u++, a[t.id] = t
                  }();
                  return i.userStep = t.step, i.userChunk = t.chunk, i.userComplete = t.complete, i.userError = t.error, t.step = J(t.step), t.chunk = J(t.chunk), t.complete = J(t.complete), t.error = J(t.error), delete t.worker, void i.postMessage({
                    input: e,
                    config: t,
                    workerId: i.id
                  })
                }
                var n = null;
                b.NODE_STREAM_INPUT, "string" == typeof e ? (e = function(e) {
                  if (65279 === e.charCodeAt(0)) return e.slice(1);
                  return e
                }(e), n = t.download ? new l(t) : new p(t)) : !0 === e.readable && J(e.read) && J(e.on) ? n = new g(t) : (f.File && e instanceof File || e instanceof Object) && (n = new c(t));
                return n.stream(e)
              },
              unparse: function(e, t) {
                var n = !1,
                        _ = !0,
                        m = ",",
                        y = "\r\n",
                        s = '"',
                        a = s + s,
                        r = !1,
                        i = null,
                        o = !1;
                ! function() {
                  if ("object" != typeof t) return;
                  "string" != typeof t.delimiter || b.BAD_DELIMITERS.filter(function(e) {
                    return -1 !== t.delimiter.indexOf(e)
                  }).length || (m = t.delimiter);
                  ("boolean" == typeof t.quotes || "function" == typeof t.quotes || Array.isArray(t.quotes)) && (n = t.quotes);
                  "boolean" != typeof t.skipEmptyLines && "string" != typeof t.skipEmptyLines || (r = t.skipEmptyLines);
                  "string" == typeof t.newline && (y = t.newline);
                  "string" == typeof t.quoteChar && (s = t.quoteChar);
                  "boolean" == typeof t.header && (_ = t.header);
                  if (Array.isArray(t.columns)) {
                    if (0 === t.columns.length) throw new Error("Option columns is empty");
                    i = t.columns
                  }
                  void 0 !== t.escapeChar && (a = t.escapeChar + s);
                  ("boolean" == typeof t.escapeFormulae || t.escapeFormulae instanceof RegExp) && (o = t.escapeFormulae instanceof RegExp ? t.escapeFormulae : /^[=+\-@\t\r].*$/)
                }();
                var u = new RegExp(Q(s), "g");
                "string" == typeof e && (e = JSON.parse(e));
                if (Array.isArray(e)) {
                  if (!e.length || Array.isArray(e[0])) return h(null, e, r);
                  if ("object" == typeof e[0]) return h(i || Object.keys(e[0]), e, r)
                } else if ("object" == typeof e) return "string" == typeof e.data && (e.data = JSON.parse(e.data)), Array.isArray(e.data) && (e.fields || (e.fields = e.meta && e.meta.fields || i), e.fields || (e.fields = Array.isArray(e.data[0]) ? e.fields : "object" == typeof e.data[0] ? Object.keys(e.data[0]) : []), Array.isArray(e.data[0]) || "object" == typeof e.data[0] || (e.data = [e.data])), h(e.fields || [], e.data || [], r);
                throw new Error("Unable to serialize unrecognized input");

                function h(e, t, r) {
                  var i = "";
                  "string" == typeof e && (e = JSON.parse(e)), "string" == typeof t && (t = JSON.parse(t));
                  var n = Array.isArray(e) && 0 < e.length,
                          s = !Array.isArray(t[0]);
                  if (n && _) {
                    for (var a = 0; a < e.length; a++) 0 < a && (i += m), i += v(e[a], a);
                    0 < t.length && (i += y)
                  }
                  for (var o = 0; o < t.length; o++) {
                    var u = n ? e.length : t[o].length,
                            h = !1,
                            f = n ? 0 === Object.keys(t[o]).length : 0 === t[o].length;
                    if (r && !n && (h = "greedy" === r ? "" === t[o].join("").trim() : 1 === t[o].length && 0 === t[o][0].length), "greedy" === r && n) {
                      for (var d = [], l = 0; l < u; l++) {
                        var c = s ? e[l] : l;
                        d.push(t[o][c])
                      }
                      h = "" === d.join("").trim()
                    }
                    if (!h) {
                      for (var p = 0; p < u; p++) {
                        0 < p && !f && (i += m);
                        var g = n && s ? e[p] : p;
                        i += v(t[o][g], p)
                      }
                      o < t.length - 1 && (!r || 0 < u && !f) && (i += y)
                    }
                  }
                  return i
                }

                function v(e, t) {
                  if (null == e) return "";
                  if (e.constructor === Date) return JSON.stringify(e).slice(1, 25);
                  var r = !1;
                  o && "string" == typeof e && o.test(e) && (e = "'" + e, r = !0);
                  var i = e.toString().replace(u, a);
                  return (r = r || !0 === n || "function" == typeof n && n(e, t) || Array.isArray(n) && n[t] || function(e, t) {
                    for (var r = 0; r < t.length; r++)
                      if (-1 < e.indexOf(t[r])) return !0;
                    return !1
                  }(i, b.BAD_DELIMITERS) || -1 < i.indexOf(m) || " " === i.charAt(0) || " " === i.charAt(i.length - 1)) ? s + i + s : i
                }
              }
            };
    if (b.RECORD_SEP = String.fromCharCode(30), b.UNIT_SEP = String.fromCharCode(31), b.BYTE_ORDER_MARK = "\ufeff", b.BAD_DELIMITERS = ["\r", "\n", '"', b.BYTE_ORDER_MARK], b.WORKERS_SUPPORTED = !n && !!f.Worker, b.NODE_STREAM_INPUT = 1, b.LocalChunkSize = 10485760, b.RemoteChunkSize = 5242880, b.DefaultDelimiter = ",", b.Parser = E, b.ParserHandle = r, b.NetworkStreamer = l, b.FileStreamer = c, b.StringStreamer = p, b.ReadableStreamStreamer = g, f.jQuery) {
      var d = f.jQuery;
      d.fn.parse = function(o) {
        var r = o.config || {},
                u = [];
        return this.each(function(e) {
          if (!("INPUT" === d(this).prop("tagName").toUpperCase() && "file" === d(this).attr("type").toLowerCase() && f.FileReader) || !this.files || 0 === this.files.length) return !0;
          for (var t = 0; t < this.files.length; t++) u.push({
            file: this.files[t],
            inputElem: this,
            instanceConfig: d.extend({}, r)
          })
        }), e(), this;

        function e() {
          if (0 !== u.length) {
            var e, t, r, i, n = u[0];
            if (J(o.before)) {
              var s = o.before(n.file, n.inputElem);
              if ("object" == typeof s) {
                if ("abort" === s.action) return e = "AbortError", t = n.file, r = n.inputElem, i = s.reason, void(J(o.error) && o.error({
                  name: e
                }, t, r, i));
                if ("skip" === s.action) return void h();
                "object" == typeof s.config && (n.instanceConfig = d.extend(n.instanceConfig, s.config))
              } else if ("skip" === s) return void h()
            }
            var a = n.instanceConfig.complete;
            n.instanceConfig.complete = function(e) {
              J(a) && a(e, n.file, n.inputElem), h()
            }, b.parse(n.file, n.instanceConfig)
          } else J(o.complete) && o.complete()
        }

        function h() {
          u.splice(0, 1), e()
        }
      }
    }

    function h(e) {
      this._handle = null, this._finished = !1, this._completed = !1, this._halted = !1, this._input = null, this._baseIndex = 0, this._partialLine = "", this._rowCount = 0, this._start = 0, this._nextChunk = null, this.isFirstChunk = !0, this._completeResults = {
        data: [],
        errors: [],
        meta: {}
      },
              function(e) {
                var t = w(e);
                t.chunkSize = parseInt(t.chunkSize), e.step || e.chunk || (t.chunkSize = null);
                this._handle = new r(t), (this._handle.streamer = this)._config = t
              }.call(this, e), this.parseChunk = function(e, t) {
        if (this.isFirstChunk && J(this._config.beforeFirstChunk)) {
          var r = this._config.beforeFirstChunk(e);
          void 0 !== r && (e = r)
        }
        this.isFirstChunk = !1, this._halted = !1;
        var i = this._partialLine + e;
        this._partialLine = "";
        var n = this._handle.parse(i, this._baseIndex, !this._finished);
        if (!this._handle.paused() && !this._handle.aborted()) {
          var s = n.meta.cursor;
          this._finished || (this._partialLine = i.substring(s - this._baseIndex), this._baseIndex = s), n && n.data && (this._rowCount += n.data.length);
          var a = this._finished || this._config.preview && this._rowCount >= this._config.preview;
          if (o) f.postMessage({
            results: n,
            workerId: b.WORKER_ID,
            finished: a
          });
          else if (J(this._config.chunk) && !t) {
            if (this._config.chunk(n, this._handle), this._handle.paused() || this._handle.aborted()) return void(this._halted = !0);
            n = void 0, this._completeResults = void 0
          }
          return this._config.step || this._config.chunk || (this._completeResults.data = this._completeResults.data.concat(n.data), this._completeResults.errors = this._completeResults.errors.concat(n.errors), this._completeResults.meta = n.meta), this._completed || !a || !J(this._config.complete) || n && n.meta.aborted || (this._config.complete(this._completeResults, this._input), this._completed = !0), a || n && n.meta.paused || this._nextChunk(), n
        }
        this._halted = !0
      }, this._sendError = function(e) {
        J(this._config.error) ? this._config.error(e) : o && this._config.error && f.postMessage({
          workerId: b.WORKER_ID,
          error: e,
          finished: !1
        })
      }
    }

    function l(e) {
      var i;
      (e = e || {}).chunkSize || (e.chunkSize = b.RemoteChunkSize), h.call(this, e), this._nextChunk = n ? function() {
        this._readChunk(), this._chunkLoaded()
      } : function() {
        this._readChunk()
      }, this.stream = function(e) {
        this._input = e, this._nextChunk()
      }, this._readChunk = function() {
        if (this._finished) this._chunkLoaded();
        else {
          if (i = new XMLHttpRequest, this._config.withCredentials && (i.withCredentials = this._config.withCredentials), n || (i.onload = v(this._chunkLoaded, this), i.onerror = v(this._chunkError, this)), i.open(this._config.downloadRequestBody ? "POST" : "GET", this._input, !n), this._config.downloadRequestHeaders) {
            var e = this._config.downloadRequestHeaders;
            for (var t in e) i.setRequestHeader(t, e[t])
          }
          if (this._config.chunkSize) {
            var r = this._start + this._config.chunkSize - 1;
            i.setRequestHeader("Range", "bytes=" + this._start + "-" + r)
          }
          try {
            i.send(this._config.downloadRequestBody)
          } catch (e) {
            this._chunkError(e.message)
          }
          n && 0 === i.status && this._chunkError()
        }
      }, this._chunkLoaded = function() {
        4 === i.readyState && (i.status < 200 || 400 <= i.status ? this._chunkError() : (this._start += this._config.chunkSize ? this._config.chunkSize : i.responseText.length, this._finished = !this._config.chunkSize || this._start >= function(e) {
          var t = e.getResponseHeader("Content-Range");
          if (null === t) return -1;
          return parseInt(t.substring(t.lastIndexOf("/") + 1))
        }(i), this.parseChunk(i.responseText)))
      }, this._chunkError = function(e) {
        var t = i.statusText || e;
        this._sendError(new Error(t))
      }
    }

    function c(e) {
      var i, n;
      (e = e || {}).chunkSize || (e.chunkSize = b.LocalChunkSize), h.call(this, e);
      var s = "undefined" != typeof FileReader;
      this.stream = function(e) {
        this._input = e, n = e.slice || e.webkitSlice || e.mozSlice, s ? ((i = new FileReader).onload = v(this._chunkLoaded, this), i.onerror = v(this._chunkError, this)) : i = new FileReaderSync, this._nextChunk()
      }, this._nextChunk = function() {
        this._finished || this._config.preview && !(this._rowCount < this._config.preview) || this._readChunk()
      }, this._readChunk = function() {
        var e = this._input;
        if (this._config.chunkSize) {
          var t = Math.min(this._start + this._config.chunkSize, this._input.size);
          e = n.call(e, this._start, t)
        }
        var r = i.readAsText(e, this._config.encoding);
        s || this._chunkLoaded({
          target: {
            result: r
          }
        })
      }, this._chunkLoaded = function(e) {
        this._start += this._config.chunkSize, this._finished = !this._config.chunkSize || this._start >= this._input.size, this.parseChunk(e.target.result)
      }, this._chunkError = function() {
        this._sendError(i.error)
      }
    }

    function p(e) {
      var r;
      h.call(this, e = e || {}), this.stream = function(e) {
        return r = e, this._nextChunk()
      }, this._nextChunk = function() {
        if (!this._finished) {
          var e, t = this._config.chunkSize;
          return t ? (e = r.substring(0, t), r = r.substring(t)) : (e = r, r = ""), this._finished = !r, this.parseChunk(e)
        }
      }
    }

    function g(e) {
      h.call(this, e = e || {});
      var t = [],
              r = !0,
              i = !1;
      this.pause = function() {
        h.prototype.pause.apply(this, arguments), this._input.pause()
      }, this.resume = function() {
        h.prototype.resume.apply(this, arguments), this._input.resume()
      }, this.stream = function(e) {
        this._input = e, this._input.on("data", this._streamData), this._input.on("end", this._streamEnd), this._input.on("error", this._streamError)
      }, this._checkIsFinished = function() {
        i && 1 === t.length && (this._finished = !0)
      }, this._nextChunk = function() {
        this._checkIsFinished(), t.length ? this.parseChunk(t.shift()) : r = !0
      }, this._streamData = v(function(e) {
        try {
          t.push("string" == typeof e ? e : e.toString(this._config.encoding)), r && (r = !1, this._checkIsFinished(), this.parseChunk(t.shift()))
        } catch (e) {
          this._streamError(e)
        }
      }, this), this._streamError = v(function(e) {
        this._streamCleanUp(), this._sendError(e)
      }, this), this._streamEnd = v(function() {
        this._streamCleanUp(), i = !0, this._streamData("")
      }, this), this._streamCleanUp = v(function() {
        this._input.removeListener("data", this._streamData), this._input.removeListener("end", this._streamEnd), this._input.removeListener("error", this._streamError)
      }, this)
    }

    function r(m) {
      var a, o, u, i = Math.pow(2, 53),
              n = -i,
              s = /^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,
              h = /^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,
              t = this,
              r = 0,
              f = 0,
              d = !1,
              e = !1,
              l = [],
              c = {
                data: [],
                errors: [],
                meta: {}
              };
      if (J(m.step)) {
        var p = m.step;
        m.step = function(e) {
          if (c = e, _()) g();
          else {
            if (g(), 0 === c.data.length) return;
            r += e.data.length, m.preview && r > m.preview ? o.abort() : (c.data = c.data[0], p(c, t))
          }
        }
      }

      function y(e) {
        return "greedy" === m.skipEmptyLines ? "" === e.join("").trim() : 1 === e.length && 0 === e[0].length
      }

      function g() {
        return c && u && (k("Delimiter", "UndetectableDelimiter", "Unable to auto-detect delimiting character; defaulted to '" + b.DefaultDelimiter + "'"), u = !1), m.skipEmptyLines && (c.data = c.data.filter(function(e) {
          return !y(e)
        })), _() && function() {
          if (!c) return;

          function e(e, t) {
            J(m.transformHeader) && (e = m.transformHeader(e, t)), l.push(e)
          }
          if (Array.isArray(c.data[0])) {
            for (var t = 0; _() && t < c.data.length; t++) c.data[t].forEach(e);
            c.data.splice(0, 1)
          } else c.data.forEach(e)
        }(),
                function() {
                  if (!c || !m.header && !m.dynamicTyping && !m.transform) return c;

                  function e(e, t) {
                    var r, i = m.header ? {} : [];
                    for (r = 0; r < e.length; r++) {
                      var n = r,
                              s = e[r];
                      m.header && (n = r >= l.length ? "__parsed_extra" : l[r]), m.transform && (s = m.transform(s, n)), s = v(n, s), "__parsed_extra" === n ? (i[n] = i[n] || [], i[n].push(s)) : i[n] = s
                    }
                    return m.header && (r > l.length ? k("FieldMismatch", "TooManyFields", "Too many fields: expected " + l.length + " fields but parsed " + r, f + t) : r < l.length && k("FieldMismatch", "TooFewFields", "Too few fields: expected " + l.length + " fields but parsed " + r, f + t)), i
                  }
                  var t = 1;
                  !c.data.length || Array.isArray(c.data[0]) ? (c.data = c.data.map(e), t = c.data.length) : c.data = e(c.data, 0);
                  m.header && c.meta && (c.meta.fields = l);
                  return f += t, c
                }()
      }

      function _() {
        return m.header && 0 === l.length
      }

      function v(e, t) {
        return r = e, m.dynamicTypingFunction && void 0 === m.dynamicTyping[r] && (m.dynamicTyping[r] = m.dynamicTypingFunction(r)), !0 === (m.dynamicTyping[r] || m.dynamicTyping) ? "true" === t || "TRUE" === t || "false" !== t && "FALSE" !== t && (function(e) {
          if (s.test(e)) {
            var t = parseFloat(e);
            if (n < t && t < i) return !0
          }
          return !1
        }(t) ? parseFloat(t) : h.test(t) ? new Date(t) : "" === t ? null : t) : t;
        var r
      }

      function k(e, t, r, i) {
        var n = {
          type: e,
          code: t,
          message: r
        };
        void 0 !== i && (n.row = i), c.errors.push(n)
      }
      this.parse = function(e, t, r) {
        var i = m.quoteChar || '"';
        if (m.newline || (m.newline = function(e, t) {
          e = e.substring(0, 1048576);
          var r = new RegExp(Q(t) + "([^]*?)" + Q(t), "gm"),
                  i = (e = e.replace(r, "")).split("\r"),
                  n = e.split("\n"),
                  s = 1 < n.length && n[0].length < i[0].length;
          if (1 === i.length || s) return "\n";
          for (var a = 0, o = 0; o < i.length; o++) "\n" === i[o][0] && a++;
          return a >= i.length / 2 ? "\r\n" : "\r"
        }(e, i)), u = !1, m.delimiter) J(m.delimiter) && (m.delimiter = m.delimiter(e), c.meta.delimiter = m.delimiter);
        else {
          var n = function(e, t, r, i, n) {
            var s, a, o, u;
            n = n || [",", "\t", "|", ";", b.RECORD_SEP, b.UNIT_SEP];
            for (var h = 0; h < n.length; h++) {
              var f = n[h],
                      d = 0,
                      l = 0,
                      c = 0;
              o = void 0;
              for (var p = new E({
                comments: i,
                delimiter: f,
                newline: t,
                preview: 10
              }).parse(e), g = 0; g < p.data.length; g++)
                if (r && y(p.data[g])) c++;
                else {
                  var _ = p.data[g].length;
                  l += _, void 0 !== o ? 0 < _ && (d += Math.abs(_ - o), o = _) : o = _
                } 0 < p.data.length && (l /= p.data.length - c), (void 0 === a || d <= a) && (void 0 === u || u < l) && 1.99 < l && (a = d, s = f, u = l)
            }
            return {
              successful: !!(m.delimiter = s),
              bestDelimiter: s
            }
          }(e, m.newline, m.skipEmptyLines, m.comments, m.delimitersToGuess);
          n.successful ? m.delimiter = n.bestDelimiter : (u = !0, m.delimiter = b.DefaultDelimiter), c.meta.delimiter = m.delimiter
        }
        var s = w(m);
        return m.preview && m.header && s.preview++, a = e, o = new E(s), c = o.parse(a, t, r), g(), d ? {
          meta: {
            paused: !0
          }
        } : c || {
          meta: {
            paused: !1
          }
        }
      }, this.paused = function() {
        return d
      }, this.pause = function() {
        d = !0, o.abort(), a = J(m.chunk) ? "" : a.substring(o.getCharIndex())
      }, this.resume = function() {
        t.streamer._halted ? (d = !1, t.streamer.parseChunk(a, !0)) : setTimeout(t.resume, 3)
      }, this.aborted = function() {
        return e
      }, this.abort = function() {
        e = !0, o.abort(), c.meta.aborted = !0, J(m.complete) && m.complete(c), a = ""
      }
    }

    function Q(e) {
      return e.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")
    }

    function E(j) {
      var z, M = (j = j || {}).delimiter,
              P = j.newline,
              U = j.comments,
              q = j.step,
              N = j.preview,
              B = j.fastMode,
              K = z = void 0 === j.quoteChar || null === j.quoteChar ? '"' : j.quoteChar;
      if (void 0 !== j.escapeChar && (K = j.escapeChar), ("string" != typeof M || -1 < b.BAD_DELIMITERS.indexOf(M)) && (M = ","), U === M) throw new Error("Comment character same as delimiter");
      !0 === U ? U = "#" : ("string" != typeof U || -1 < b.BAD_DELIMITERS.indexOf(U)) && (U = !1), "\n" !== P && "\r" !== P && "\r\n" !== P && (P = "\n");
      var W = 0,
              H = !1;
      this.parse = function(i, t, r) {
        if ("string" != typeof i) throw new Error("Input must be a string");
        var n = i.length,
                e = M.length,
                s = P.length,
                a = U.length,
                o = J(q),
                u = [],
                h = [],
                f = [],
                d = W = 0;
        if (!i) return L();
        if (j.header && !t) {
          var l = i.split(P)[0].split(M),
                  c = [],
                  p = {},
                  g = !1;
          for (var _ in l) {
            var m = l[_];
            J(j.transformHeader) && (m = j.transformHeader(m, _));
            var y = m,
                    v = p[m] || 0;
            for (0 < v && (g = !0, y = m + "_" + v), p[m] = v + 1; c.includes(y);) y = y + "_" + v;
            c.push(y)
          }
          if (g) {
            var k = i.split(P);
            k[0] = c.join(M), i = k.join(P)
          }
        }
        if (B || !1 !== B && -1 === i.indexOf(z)) {
          for (var b = i.split(P), E = 0; E < b.length; E++) {
            if (f = b[E], W += f.length, E !== b.length - 1) W += P.length;
            else if (r) return L();
            if (!U || f.substring(0, a) !== U) {
              if (o) {
                if (u = [], I(f.split(M)), F(), H) return L()
              } else I(f.split(M));
              if (N && N <= E) return u = u.slice(0, N), L(!0)
            }
          }
          return L()
        }
        for (var w = i.indexOf(M, W), R = i.indexOf(P, W), C = new RegExp(Q(K) + Q(z), "g"), S = i.indexOf(z, W);;)
          if (i[W] !== z)
            if (U && 0 === f.length && i.substring(W, W + a) === U) {
              if (-1 === R) return L();
              W = R + s, R = i.indexOf(P, W), w = i.indexOf(M, W)
            } else if (-1 !== w && (w < R || -1 === R)) f.push(i.substring(W, w)), W = w + e, w = i.indexOf(M, W);
            else {
              if (-1 === R) break;
              if (f.push(i.substring(W, R)), D(R + s), o && (F(), H)) return L();
              if (N && u.length >= N) return L(!0)
            } else
            for (S = W, W++;;) {
              if (-1 === (S = i.indexOf(z, S + 1))) return r || h.push({
                type: "Quotes",
                code: "MissingQuotes",
                message: "Quoted field unterminated",
                row: u.length,
                index: W
              }), T();
              if (S === n - 1) return T(i.substring(W, S).replace(C, z));
              if (z !== K || i[S + 1] !== K) {
                if (z === K || 0 === S || i[S - 1] !== K) {
                  -1 !== w && w < S + 1 && (w = i.indexOf(M, S + 1)), -1 !== R && R < S + 1 && (R = i.indexOf(P, S + 1));
                  var O = A(-1 === R ? w : Math.min(w, R));
                  if (i.substr(S + 1 + O, e) === M) {
                    f.push(i.substring(W, S).replace(C, z)), i[W = S + 1 + O + e] !== z && (S = i.indexOf(z, W)), w = i.indexOf(M, W), R = i.indexOf(P, W);
                    break
                  }
                  var x = A(R);
                  if (i.substring(S + 1 + x, S + 1 + x + s) === P) {
                    if (f.push(i.substring(W, S).replace(C, z)), D(S + 1 + x + s), w = i.indexOf(M, W), S = i.indexOf(z, W), o && (F(), H)) return L();
                    if (N && u.length >= N) return L(!0);
                    break
                  }
                  h.push({
                    type: "Quotes",
                    code: "InvalidQuotes",
                    message: "Trailing quote on quoted field is malformed",
                    row: u.length,
                    index: W
                  }), S++
                }
              } else S++
            }
        return T();

        function I(e) {
          u.push(e), d = W
        }

        function A(e) {
          var t = 0;
          if (-1 !== e) {
            var r = i.substring(S + 1, e);
            r && "" === r.trim() && (t = r.length)
          }
          return t
        }

        function T(e) {
          return r || (void 0 === e && (e = i.substring(W)), f.push(e), W = n, I(f), o && F()), L()
        }

        function D(e) {
          W = e, I(f), f = [], R = i.indexOf(P, W)
        }

        function L(e) {
          return {
            data: u,
            errors: h,
            meta: {
              delimiter: M,
              linebreak: P,
              aborted: H,
              truncated: !!e,
              cursor: d + (t || 0)
            }
          }
        }

        function F() {
          q(L()), u = [], h = []
        }
      }, this.abort = function() {
        H = !0
      }, this.getCharIndex = function() {
        return W
      }
    }

    function _(e) {
      var t = e.data,
              r = a[t.workerId],
              i = !1;
      if (t.error) r.userError(t.error, t.file);
      else if (t.results && t.results.data) {
        var n = {
          abort: function() {
            i = !0, m(t.workerId, {
              data: [],
              errors: [],
              meta: {
                aborted: !0
              }
            })
          },
          pause: y,
          resume: y
        };
        if (J(r.userStep)) {
          for (var s = 0; s < t.results.data.length && (r.userStep({
            data: t.results.data[s],
            errors: t.results.errors,
            meta: t.results.meta
          }, n), !i); s++);
          delete t.results
        } else J(r.userChunk) && (r.userChunk(t.results, n, t.file), delete t.results)
      }
      t.finished && !i && m(t.workerId, t.results)
    }

    function m(e, t) {
      var r = a[e];
      J(r.userComplete) && r.userComplete(t), r.terminate(), delete a[e]
    }

    function y() {
      throw new Error("Not implemented.")
    }

    function w(e) {
      if ("object" != typeof e || null === e) return e;
      var t = Array.isArray(e) ? [] : {};
      for (var r in e) t[r] = w(e[r]);
      return t
    }

    function v(e, t) {
      return function() {
        e.apply(t, arguments)
      }
    }

    function J(e) {
      return "function" == typeof e
    }
    return o && (f.onmessage = function(e) {
      var t = e.data;
      void 0 === b.WORKER_ID && t && (b.WORKER_ID = t.workerId);
      if ("string" == typeof t.input) f.postMessage({
        workerId: b.WORKER_ID,
        results: b.parse(t.input, t.config),
        finished: !0
      });
      else if (f.File && t.input instanceof File || t.input instanceof Object) {
        var r = b.parse(t.input, t.config);
        r && f.postMessage({
          workerId: b.WORKER_ID,
          results: r,
          finished: !0
        })
      }
    }), (l.prototype = Object.create(h.prototype)).constructor = l, (c.prototype = Object.create(h.prototype)).constructor = c, (p.prototype = Object.create(p.prototype)).constructor = p, (g.prototype = Object.create(h.prototype)).constructor = g, b
  });

  // Offline Manager for SilentStacks
  class OfflineManager {
    constructor() {
      this.isOnline = navigator.onLine;
      this.apiQueue = JSON.parse(localStorage.getItem('silentstacks_api_queue') || '[]');
      this.connectionIndicator = this.createConnectionIndicator();

      this.bindEvents();
      this.updateConnectionStatus();
      this.processQueue();
    }

    createConnectionIndicator() {
      const indicator = document.createElement('div');
      indicator.id = 'connection-status';
      indicator.style.cssText = `
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 10000;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    `;
      document.body.appendChild(indicator);
      return indicator;
    }

    bindEvents() {
      window.addEventListener('online', () => {
        this.isOnline = true;
        this.updateConnectionStatus();
        this.processQueue();
      });

      window.addEventListener('offline', () => {
        this.isOnline = false;
        this.updateConnectionStatus();
      });
    }

    updateConnectionStatus() {
      const themes = document.documentElement.getAttribute('data-theme');

      if (this.isOnline) {
        this.connectionIndicator.textContent = '🌐 Online';
        this.connectionIndicator.style.background = 'transparent';
        this.connectionIndicator.style.color = '#666666';
        this.connectionIndicator.style.fontWeight = '400';
        this.connectionIndicator.style.fontSize = '0.7rem';
        this.connectionIndicator.style.opacity = '0.7';
        this.connectionIndicator.style.boxShadow = 'none';
        this.connectionIndicator.style.border = 'none';
        this.connectionIndicator.style.padding = '4px 8px';

      } else {
        this.connectionIndicator.textContent = '📴 Offline';
        this.connectionIndicator.style.background = '#ff4444';
        this.connectionIndicator.style.color = 'white';
        this.connectionIndicator.style.opacity = '1';
        this.connectionIndicator.style.fontWeight = '600';

      }

      // Queue indicator
      if (this.apiQueue.length > 0) {
        this.connectionIndicator.textContent += ` (${this.apiQueue.length} queued)`;
      }
    }

    queueApiCall(type, identifier, callback) {
      if (this.isOnline) {
        // If online, execute immediately
        this.executeApiCall(type, identifier, callback);
        return;
      }

      // If offline, queue for later
      const queueItem = {
        id: Date.now(),
        type: type, // 'pmid' or 'doi'
        identifier: identifier,
        timestamp: new Date().toISOString(),
        callback: callback.toString() // Store function as string
      };

      this.apiQueue.push(queueItem);
      localStorage.setItem('silentstacks_api_queue', JSON.stringify(this.apiQueue));
      this.updateConnectionStatus();

      // Show offline placeholder data
      this.showOfflinePlaceholder(type, identifier);
    }

    async executeApiCall(type, identifier, callback) {
      try {
        let result;
        if (type === 'pmid') {
          result = await window.fetchPubMed(identifier);
        } else if (type === 'doi') {
          result = await window.fetchCrossRef(identifier);
        }

        if (typeof callback === 'function') {
          callback(null, result);
        }
      } catch (error) {
        if (typeof callback === 'function') {
          callback(error, null);
        }
      }
    }

    async processQueue() {
      if (!this.isOnline || this.apiQueue.length === 0) return;

      const processedIds = [];

      for (const item of this.apiQueue) {
        try {
          await this.executeApiCall(item.type, item.identifier, null);
          processedIds.push(item.id);

          // Show success notification
          this.showNotification(`✅ Processed queued ${item.type.toUpperCase()}: ${item.identifier}`);

          // Small delay between requests to be polite
          await new Promise(resolve => setTimeout(resolve, 1000));
        } catch (error) {
          console.warn(`Failed to process queued ${item.type}:`, error);
        }
      }

      // Remove processed items
      this.apiQueue = this.apiQueue.filter(item => !processedIds.includes(item.id));
      localStorage.setItem('silentstacks_api_queue', JSON.stringify(this.apiQueue));
      this.updateConnectionStatus();
    }

    showOfflinePlaceholder(type, identifier) {
      const placeholderData = {
        pmid: {
          pmid: identifier,
          title: `[QUEUED] Article ${identifier} - Will lookup when online`,
          authors: 'Authors will be retrieved when online',
          journal: 'Journal information pending',
          year: 'Year pending',
          doi: 'DOI pending'
        },
        doi: {
          doi: identifier,
          title: `[QUEUED] Article with DOI ${identifier} - Will lookup when online`,
          authors: 'Authors will be retrieved when online',
          journal: 'Journal information pending',
          year: 'Year pending',
          pmid: 'PMID pending'
        }
      };

      if (window.populateForm && placeholderData[type]) {
        window.populateForm(placeholderData[type]);
      }

      this.showNotification(`📴 Offline: ${type.toUpperCase()} lookup queued for when connection returns`);
    }

    showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
      position: fixed;
      top: 60px;
      right: 10px;
      z-index: 10001;
      padding: 12px 16px;
      background: ${type === 'error' ? '#dc3545' : '#17a2b8'};
      color: white;
      border-radius: 8px;
      font-size: 0.9rem;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    `;
      notification.textContent = message;
      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);

      // Auto remove after 5 seconds
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // API for disabling online features would reduce functionality
    // Better to queue and show offline status
    getConnectionStatus() {
      return {
        isOnline: this.isOnline,
        queuedRequests: this.apiQueue.length,
        lastOnline: this.isOnline ? new Date() : localStorage.getItem('silentstacks_last_online')
      };
    }
  }

  // Initialize offline manager when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.offlineManager = new OfflineManager();
    });
  } else {
    window.offlineManager = new OfflineManager();
  }

  // Complete SilentStacks App.js with All Critical Fixes Applied + Offline Support
  (() => {
    // === Constants & State ===
    const MAX_IMPORT = 100;
    const settings = { followupDays: 5, theme: 'light', apiKey: '', crossrefEmail: '' };
    let requests = [];
    let followupOnly = false;
    let fuse;
    let currentEdit = null;
    let selectedRequests = new Set();
    let globalTags = new Map(); // For tag color customization
    let currentStep = 1;
    const totalSteps = 3;
    let currentSortField = 'createdAt';
    let currentSortDirection = 'desc';

    // === DOM Elements ===
    const els = {
      followupDays: document.getElementById('followup-days'),
      theme: document.getElementById('theme'),
      apiKey: document.getElementById('api-key'),
      crossrefEmail: document.getElementById('crossref-email'),
      status: document.getElementById('lookup-status'),
      pmidInput: document.getElementById('pmid'),
      doiInput: document.getElementById('doi'),
      titleInput: document.getElementById('title'),
      authorsInput: document.getElementById('authors'),
      journalInput: document.getElementById('journal'),
      yearInput: document.getElementById('year'),
      doclineInput: document.getElementById('docline'),
      patronEmailInput: document.getElementById('patron-email'),
      statusSelect: document.getElementById('status'),
      tagsInput: document.getElementById('tags'),
      notesInput: document.getElementById('notes'),
      form: document.getElementById('request-form'),
      clearBtn: document.getElementById('clear-form'),
      search: document.getElementById('search-requests'),
      statusFilter: document.getElementById('filter-status'),
      followupFilter: document.getElementById('filter-followup'),
      importFile: document.getElementById('import-file'),
      exportCsv: document.getElementById('export-csv'),
      exportJson: document.getElementById('export-json'),
      requestList: document.getElementById('request-list'),
      navTabs: document.querySelectorAll('.nav-tab'),
      sections: document.querySelectorAll('.section'),
      stats: {
        total: document.getElementById('total-requests'),
        pending: document.getElementById('pending-requests'),
        fulfilled: document.getElementById('fulfilled-requests'),
        followup: document.getElementById('followup-requests')
      }
    };

    // === Persistence ===
    function loadSettings() {
      try {
        const saved = localStorage.getItem('silentstacks_settings');
        if (saved) {
          Object.assign(settings, JSON.parse(saved));
        }
      } catch (e) {
        console.warn('Failed to load settings:', e);
      }
      if (els.followupDays) els.followupDays.value = settings.followupDays;
      if (els.theme) els.theme.value = settings.theme;
      if (els.apiKey) els.apiKey.value = settings.apiKey;
      if (els.crossrefEmail) els.crossrefEmail.value = settings.crossrefEmail;
    }

    function loadRequests() {
      try {
        const saved = localStorage.getItem('silentstacks_requests');
        requests = saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.warn('Failed to load requests:', e);
        requests = [];
      }
    }

    function loadGlobalTags() {
      try {
        const saved = localStorage.getItem('silentstacks_tags');
        if (saved) {
          const tagsArray = JSON.parse(saved);
          globalTags = new Map(tagsArray);
        }
      } catch (e) {
        console.warn('Failed to load tags:', e);
      }
    }

    function saveAll() {
      try {
        localStorage.setItem('silentstacks_settings', JSON.stringify(settings));
        localStorage.setItem('silentstacks_requests', JSON.stringify(requests));
        localStorage.setItem('silentstacks_tags', JSON.stringify([...globalTags]));
      } catch (e) {
        console.error('Failed to save data:', e);
      }
    }

    // === Theme & Navigation ===
    function applyTheme() {
      document.documentElement.setAttribute('data-theme', settings.theme);
    }

    function switchSection(tabEl) {
      els.navTabs.forEach(t => t.classList.toggle('active', t === tabEl));
      els.sections.forEach(s => s.classList.toggle('active', s.id === tabEl.dataset.section));
    }

    // === Status UI ===
    function setStatus(message, type = '') {
      if (els.status) {
        els.status.textContent = message;
        els.status.className = ['lookup-status', type].filter(Boolean).join(' ');
      }
    }

    // === OFFLINE-AWARE FETCH FUNCTIONS ===
    async function fetchPubMed(pmid) {
      console.log(`Fetching PubMed data for PMID: ${pmid}`);

      // Check if offline and queue the request
      if (window.offlineManager && !window.offlineManager.isOnline) {
        window.offlineManager.queueApiCall('pmid', pmid, null);
        // Return placeholder data immediately
        return {
          pmid: pmid,
          title: `[QUEUED] Article ${pmid} - Will lookup when online`,
          authors: 'Authors will be retrieved when online',
          journal: 'Journal information pending',
          year: 'Year pending',
          doi: 'DOI pending'
        };
      }

      try {
        const keyParam = settings.apiKey ? `&api_key=${settings.apiKey}` : '';

        // Step 1: Get basic metadata from ESummary
        const summaryUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${pmid}&retmode=json${keyParam}`;
        console.log('Fetching summary:', summaryUrl);

        const summaryResponse = await fetch(summaryUrl);
        if (!summaryResponse.ok) {
          throw new Error(`ESummary failed: ${summaryResponse.status}`);
        }

        const summaryData = await summaryResponse.json();
        console.log('Summary response:', summaryData);

        if (summaryData.error) {
          throw new Error(`PubMed error: ${summaryData.error}`);
        }

        const record = summaryData.result[pmid];
        if (!record || record.error) {
          throw new Error(`PMID ${pmid} not found`);
        }

        // Build basic metadata
        const meta = {
          pmid: pmid,
          title: record.title || '',
          authors: (record.authors || []).map(author => author.name).join('; '),
          journal: record.fulljournalname || record.source || '',
          year: (record.pubdate || '').split(' ')[0] || '',
          doi: '' // Will be filled by EFetch
        };

        console.log('Basic metadata:', meta);

        // Step 2: Get DOI from EFetch XML
        const fetchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${pmid}&retmode=xml${keyParam}`;
        console.log('Fetching XML for DOI:', fetchUrl);

        const xmlResponse = await fetch(fetchUrl);
        if (!xmlResponse.ok) {
          console.warn(`EFetch failed: ${xmlResponse.status}, continuing without DOI`);
          return meta;
        }

        const xmlText = await xmlResponse.text();
        console.log('XML response length:', xmlText.length);

        // Parse XML for DOI
        const parser = new DOMParser();
        const doc = parser.parseFromString(xmlText, 'application/xml');

        // Multiple strategies to find DOI
        let doi = '';

        // Strategy 1: ArticleId with IdType="doi"
        const doiNode1 = doc.querySelector('ArticleId[IdType="doi"]');
        if (doiNode1) {
          doi = doiNode1.textContent.trim();
          console.log('Found DOI (method 1):', doi);
        }

        // Strategy 2: ArticleId containing "10." (DOI prefix)
        if (!doi) {
          const articleIds = doc.querySelectorAll('ArticleId');
          for (const node of articleIds) {
            const text = node.textContent.trim();
            if (text.startsWith('10.')) {
              doi = text;
              console.log('Found DOI (method 2):', doi);
              break;
            }
          }
        }

        // Strategy 3: Look in ELocationID with EIdType="doi"
        if (!doi) {
          const elocationNode = doc.querySelector('ELocationID[EIdType="doi"]');
          if (elocationNode) {
            doi = elocationNode.textContent.trim();
            console.log('Found DOI (method 3):', doi);
          }
        }

        meta.doi = doi;
        console.log('Final metadata with DOI:', meta);

        return meta;

      } catch (error) {
        console.error('PubMed fetch error:', error);
        throw new Error(`PubMed lookup failed: ${error.message}`);
      }
    }

    async function fetchCrossRef(doi) {
      console.log(`Fetching CrossRef data for DOI: ${doi}`);

      // Check if offline and queue the request
      if (window.offlineManager && !window.offlineManager.isOnline) {
        window.offlineManager.queueApiCall('doi', doi, null);
        // Return placeholder data immediately
        return {
          doi: doi,
          title: `[QUEUED] Article with DOI ${doi} - Will lookup when online`,
          authors: 'Authors will be retrieved when online',
          journal: 'Journal information pending',
          year: 'Year pending',
          pmid: 'PMID pending'
        };
      }

      try {
        // Normalize DOI (remove URL prefixes)
        const cleanDoi = doi.replace(/^(https?:\/\/)?(dx\.)?doi\.org\//, '').trim();
        console.log('Cleaned DOI:', cleanDoi);

        const url = `https://api.crossref.org/works/${encodeURIComponent(cleanDoi)}`;
        console.log('CrossRef URL:', url);

        const response = await fetch(url, {
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          if (response.status === 404) {
            throw new Error(`DOI not found: ${cleanDoi}`);
          }
          throw new Error(`CrossRef API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log('CrossRef response:', data);

        const work = data.message;
        if (!work) {
          throw new Error('No work data in CrossRef response');
        }

        // Build metadata
        const meta = {
          doi: cleanDoi,
          title: (work.title && work.title[0]) || '',
          authors: (work.author || [])
                  .map(author => `${author.given || ''} ${author.family || ''}`.trim())
                  .filter(name => name)
                  .join('; '),
          journal: (work['container-title'] && work['container-title'][0]) || '',
          year: (work.published && work.published['date-parts'] && work.published['date-parts'][0] && work.published['date-parts'][0][0]) || '',
          pmid: '' // Will be filled by PubMed search
        };

        console.log('CrossRef metadata:', meta);
        return meta;

      } catch (error) {
        console.error('CrossRef fetch error:', error);
        throw new Error(`CrossRef lookup failed: ${error.message}`);
      }
    }

    // === Form Population ===
    function populateForm(meta) {
      const fieldMap = {
        pmid: 'pmid',
        doi: 'doi',
        title: 'title',
        authors: 'authors',
        journal: 'journal',
        year: 'year',
        docline: 'docline',
        'patron-email': 'patronEmail',
        status: 'status',
        tags: 'tags',
        notes: 'notes',
        priority: 'priority'
      };

      Object.entries(fieldMap).forEach(([fieldId, metaKey]) => {
        const el = document.getElementById(fieldId);
        if (el && meta.hasOwnProperty(metaKey)) {
          let value = meta[metaKey];
          if (Array.isArray(value)) {
            value = value.join(', ');
          }
          el.value = value || '';
        }
      });
    }

    // === LOOKUP HANDLERS ===
    async function onLookupPMID() {
      const pmid = els.pmidInput.value.trim();
      if (!pmid) {
        setStatus('Please enter a PMID', 'error');
        return;
      }

      if (!/^\d+$/.test(pmid)) {
        setStatus('PMID must be numeric', 'error');
        return;
      }

      setStatus('Looking up PMID...', 'loading');

      try {
        const pubmedData = await fetchPubMed(pmid);

        // Populate form with PubMed data
        populateForm(pubmedData);

        // Success message with DOI status
        if (pubmedData.doi && !pubmedData.doi.includes('pending')) {
          setStatus(`Metadata populated successfully. DOI found: ${pubmedData.doi}`, 'success');
        } else if (pubmedData.title.includes('[QUEUED]')) {
          setStatus('Request queued for when online. Placeholder data populated.', 'loading');
        } else {
          setStatus('Metadata populated successfully. No DOI found for this article.', 'success');
        }

      } catch (error) {
        console.error('PMID lookup error:', error);
        setStatus(`PMID lookup failed: ${error.message}`, 'error');
      }
    }

    async function onLookupDOI() {
      const doi = els.doiInput.value.trim();
      if (!doi) {
        setStatus('Please enter a DOI', 'error');
        return;
      }

      setStatus('Looking up DOI...', 'loading');

      try {
        const crossrefData = await fetchCrossRef(doi);
        populateForm(crossrefData);

        if (crossrefData.title.includes('[QUEUED]')) {
          setStatus('Request queued for when online. Placeholder data populated.', 'loading');
        } else {
          setStatus('DOI lookup successful!', 'success');
        }
      } catch (error) {
        console.error('DOI lookup error:', error);
        setStatus(`DOI lookup failed: ${error.message}`, 'error');
      }
    }

    // === CRITICAL FIX: Dynamic Status Color Updates ===
    window.quickStatusChange = (index, newStatus) => {
      if (requests[index]) {
        requests[index].status = newStatus;
        requests[index].updatedAt = new Date().toISOString();
        saveAll();
        renderStats();

        // Update the visual status immediately
        const statusSelect = document.querySelector(`[data-index="${index}"] .request-status-select`);
        if (statusSelect) {
          // Remove all status classes
          statusSelect.classList.remove('status-pending', 'status-in-progress', 'status-fulfilled', 'status-cancelled');
          // Add new status class
          statusSelect.classList.add(`status-${newStatus}`);
        }
      }
    };

    // === ENHANCED CARD WITH PRIORITY INDICATORS ===
    function createEnhancedCard(r, index) {
      const tags = (r.tags || []).map(t => {
        const tagColor = globalTags.get(t) || 'default';
        return `<span class="tag tag-color-${tagColor} tag-colorable" onclick="openTagColorPicker('${t}', this)" title="Click to change color">${t}</span>`;
      }).join('');

      const followupCls = needsFollowUp(r) ? ' needs-followup' : '';
      const selectedCls = selectedRequests.has(index) ? ' selected' : '';
      const createdDate = r.createdAt ? new Date(r.createdAt).toLocaleDateString() : '';
      const priorityBadge = r.priority ? `<span class="priority-badge ${r.priority}">${r.priority.toUpperCase()}</span>` : '';

      // Priority indicator for visual scanning - FIXED
      const priorityIndicator = r.priority ? `<div class="priority-indicator ${r.priority}" title="${r.priority.toUpperCase()} Priority" aria-label="${r.priority} priority"></div>` : '<div class="priority-indicator normal" title="Normal Priority" aria-label="normal priority"></div>';

      return `
      <div class="request-card${followupCls}${selectedCls}" data-index="${index}" style="position: relative;">
        ${priorityIndicator}
        <div class="request-header">
          <div class="request-checkbox">
            <input type="checkbox" ${selectedRequests.has(index) ? 'checked' : ''}
                   onchange="toggleRequestSelection(${index}, this.checked)"
                   aria-label="Select request">
          </div>
          <div class="request-main">
            <div class="request-title">${r.title || 'Untitled'} ${priorityBadge}</div>
            <div class="request-meta">
              ${r.authors || ''} • ${r.journal || ''} (${r.year || ''})
              ${r.pmid ? ` • PMID: ${r.pmid}` : ''}
              ${r.doi ? ` • DOI: ${r.doi}` : ''}
            </div>
            <div class="request-details">
              ${r.patronEmail ? `👤 ${r.patronEmail}` : ''}
              ${createdDate ? ` • 📅 ${createdDate}` : ''}
              ${needsFollowUp(r) ? ' • ⚠️ Follow-up needed' : ''}
            </div>
          </div>
          <div class="request-status-container">
            <select class="request-status-select status-${r.status}"
                    onchange="quickStatusChange(${index}, this.value)"
                    value="${r.status}"
                    aria-label="Change request status">
              <option value="pending" ${r.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="in-progress" ${r.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
              <option value="fulfilled" ${r.status === 'fulfilled' ? 'selected' : ''}>Fulfilled</option>
              <option value="cancelled" ${r.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
          </div>
        </div>
        ${tags ? `<div class="request-tags">${tags}</div>` : ''}
        ${r.notes ? `<div class="request-notes">📝 ${r.notes}</div>` : ''}
        <div class="request-actions">
          <button onclick="duplicateRequest(${index})" class="btn btn-secondary btn-small" aria-label="Duplicate request">📋 Duplicate</button>
          <button onclick="editRequest(${index})" class="btn btn-secondary btn-small" aria-label="Edit request">✏️ Edit</button>
          <button onclick="deleteRequest(${index})" class="btn btn-secondary btn-small" aria-label="Delete request">🗑️ Delete</button>
        </div>
      </div>
    `;
    }

    // === TAG COLOR PICKER FUNCTIONALITY ===
    window.openTagColorPicker = (tagName, element) => {
      // Remove any existing color pickers
      document.querySelectorAll('.tag-color-picker').forEach(picker => picker.remove());

      const currentColor = globalTags.get(tagName) || 'default';

      const colorPicker = document.createElement('div');
      colorPicker.className = 'tag-color-picker';
      colorPicker.setAttribute('role', 'dialog');
      colorPicker.setAttribute('aria-label', `Choose color for tag: ${tagName}`);

      // Enhanced color palette with 8 colors + default
      const colors = [
        { id: '1', name: 'Red', hex: '#e74c3c' },
        { id: '2', name: 'Orange', hex: '#f39c12' },
        { id: '3', name: 'Green', hex: '#27ae60' },
        { id: '4', name: 'Blue', hex: '#3498db' },
        { id: '5', name: 'Purple', hex: '#9b59b6' },
        { id: '6', name: 'Pink', hex: '#e91e63' },
        { id: '7', name: 'Cyan', hex: '#00bcd4' },
        { id: '8', name: 'Orange Red', hex: '#ff5722' },
        { id: 'default', name: 'Default', hex: 'transparent' }
      ];

      colorPicker.innerHTML = colors.map(color => `
      <div class="color-option color-${color.id} ${currentColor === color.id ? 'selected' : ''}"
           onclick="setTagColor('${tagName}', '${color.id}')"
           onkeydown="handleColorKeydown(event, '${tagName}', '${color.id}')"
           tabindex="0"
           title="${color.name}"
           aria-label="Set tag color to ${color.name}"
           data-color="${color.id}">
      </div>
    `).join('');

      // Position the picker
      const rect = element.getBoundingClientRect();
      const container = element.closest('.request-card') || element.parentNode;
      container.style.position = 'relative';
      container.appendChild(colorPicker);

      // Position picker relative to tag
      const pickerRect = colorPicker.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();

      // Adjust position to keep picker in viewport
      let top = rect.bottom - containerRect.top + 5;
      let left = rect.left - containerRect.left;

      // Prevent picker from going off-screen
      if (left + pickerRect.width > window.innerWidth - 20) {
        left = rect.right - containerRect.left - pickerRect.width;
      }

      if (top + pickerRect.height > window.innerHeight - 20) {
        top = rect.top - containerRect.top - pickerRect.height - 5;
      }

      colorPicker.style.top = `${top}px`;
      colorPicker.style.left = `${left}px`;

      // Activate with animation
      setTimeout(() => {
        colorPicker.classList.add('active');

        // Focus the current color or first option
        const currentOption = colorPicker.querySelector('.selected') || colorPicker.querySelector('.color-option');
        if (currentOption) {
          currentOption.focus();
        }
      }, 10);

      // Close picker when clicking elsewhere or pressing Escape
      setTimeout(() => {
        const closeHandler = (e) => {
          if (e.type === 'keydown' && e.key !== 'Escape') return;
          if (e.type === 'click' && colorPicker.contains(e.target)) return;

          colorPicker.classList.remove('active');
          setTimeout(() => {
            if (colorPicker.parentNode) {
              colorPicker.remove();
            }
          }, 200);

          document.removeEventListener('click', closeHandler);
          document.removeEventListener('keydown', closeHandler);
        };

        document.addEventListener('click', closeHandler);
        document.addEventListener('keydown', closeHandler);
      }, 100);
    };

    window.setTagColor = (tagName, colorId) => {
      // Validate color ID
      const validColors = ['1', '2', '3', '4', '5', '6', '7', '8', 'default'];
      if (!validColors.includes(colorId)) {
        console.warn('Invalid color ID:', colorId);
        colorId = 'default';
      }

      // Update global tags map
      globalTags.set(tagName, colorId);

      // CRITICAL: Save data to localStorage
      saveAll();

      // CRITICAL: Re-render to apply new colors immediately
      renderRequests();
      renderRecentRequests(); // Also update recent requests if they have tags

      // Show brief feedback to user
      showTagColorFeedback(tagName, colorId);

      // Remove the color picker with animation
      const picker = document.querySelector('.tag-color-picker');
      if (picker) {
        picker.classList.remove('active');
        setTimeout(() => {
          if (picker.parentNode) {
            picker.remove();
          }
        }, 200);
      }

      console.log(`✅ Tag "${tagName}" color changed to ${colorId}`);
    };

    // Keyboard navigation for color picker
    window.handleColorKeydown = (event, tagName, colorId) => {
      const picker = event.target.closest('.tag-color-picker');
      const options = Array.from(picker.querySelectorAll('.color-option'));
      const currentIndex = options.indexOf(event.target);

      let newIndex = currentIndex;

      switch (event.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          event.preventDefault();
          newIndex = (currentIndex + 1) % options.length;
          break;
        case 'ArrowLeft':
        case 'ArrowUp':
          event.preventDefault();
          newIndex = (currentIndex - 1 + options.length) % options.length;
          break;
        case 'Enter':
        case ' ':
          event.preventDefault();
          setTagColor(tagName, colorId);
          return;
        case 'Escape':
          event.preventDefault();
          picker.classList.remove('active');
          setTimeout(() => picker.remove(), 200);
          return;
        default:
          return;
      }

      options[newIndex].focus();
    };

    // Feedback notification for color changes
    function showTagColorFeedback(tagName, colorId) {
      const colorNames = {
        '1': 'Red', '2': 'Orange', '3': 'Green', '4': 'Blue',
        '5': 'Purple', '6': 'Pink', '7': 'Cyan', '8': 'Orange Red',
        'default': 'Default'
      };

      const feedback = document.createElement('div');
      feedback.className = 'tag-color-feedback';
      feedback.innerHTML = `
      <div class="feedback-content">
        <span class="tag tag-color-${colorId}">${tagName}</span>
        <span class="feedback-text">Color changed to ${colorNames[colorId]}</span>
      </div>
    `;

      feedback.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      background: var(--bg-card);
      border: 2px solid var(--primary-color);
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateX(100px);
      transition: all 0.3s ease;
    `;

      document.body.appendChild(feedback);

      // Animate in
      setTimeout(() => {
        feedback.style.opacity = '1';
        feedback.style.transform = 'translateX(0)';
      }, 10);

      // Animate out and remove
      setTimeout(() => {
        feedback.style.opacity = '0';
        feedback.style.transform = 'translateX(100px)';
        setTimeout(() => {
          if (feedback.parentNode) {
            feedback.remove();
          }
        }, 300);
      }, 2000);
    }

    // === PROGRESS STEP NAVIGATION FUNCTIONALITY ===

    // Initialize progress step navigation
    function initProgressStepNavigation() {
      const progressSteps = document.querySelectorAll('.progress-step');
      const progressFill = document.querySelector('.progress-fill');

      if (!progressSteps.length) return;

      // Add click handlers to progress steps
      progressSteps.forEach((step, index) => {
        const stepNumber = index + 1;

        // Make steps clickable
        step.style.cursor = 'pointer';
        step.setAttribute('tabindex', '0');
        step.setAttribute('role', 'button');
        step.setAttribute('aria-label', `Go to step ${stepNumber}: ${step.querySelector('.step-label').textContent}`);

        // Click handler
        step.addEventListener('click', () => {
          navigateToStep(stepNumber);
        });

        // Keyboard handler
        step.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            navigateToStep(stepNumber);
          }
        });

        // Hover effects
        step.addEventListener('mouseenter', () => {
          if (stepNumber !== currentStep) {
            step.style.transform = 'translateY(-2px)';
          }
        });

        step.addEventListener('mouseleave', () => {
          step.style.transform = '';
        });
      });

      // Initialize first step
      updateProgressDisplay();

      // Add form field change listeners to auto-advance
      setupAutoProgress();
    }

    // Navigate to specific step
    function navigateToStep(stepNumber) {
      if (stepNumber < 1 || stepNumber > totalSteps) return;

      const targetSection = getStepSection(stepNumber);
      if (!targetSection) return;

      // Update current step
      currentStep = stepNumber;

      // Smooth scroll to target section
      targetSection.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });

      // Update visual progress
      updateProgressDisplay();

      // Focus management
      setTimeout(() => {
        const firstInput = targetSection.querySelector('input, select, textarea');
        if (firstInput && !firstInput.disabled) {
          firstInput.focus();
        }
      }, 500);

      // Announce to screen readers
      announceStepChange(stepNumber);
    }

    // Get section element for step
    function getStepSection(stepNumber) {
      const stepMappings = {
        1: '#identifiers-section',
        2: '#details-section',
        3: '#request-section'
      };

      const sectionId = stepMappings[stepNumber];
      return sectionId ? document.querySelector(sectionId) : null;
    }

    // Update progress visual display
    function updateProgressDisplay() {
      const progressSteps = document.querySelectorAll('.progress-step');
      const progressFill = document.querySelector('.progress-fill');
      const progressBar = document.querySelector('.form-progress');

      if (!progressSteps.length) return;

      // Update step states
      progressSteps.forEach((step, index) => {
        const stepNumber = index + 1;
        const stepNumberEl = step.querySelector('.step-number');
        const stepLabelEl = step.querySelector('.step-label');

        // Remove all state classes
        step.classList.remove('active', 'completed');
        stepNumberEl.classList.remove('completed');

        if (stepNumber < currentStep) {
          // Completed step
          step.classList.add('completed');
          stepNumberEl.classList.add('completed');
          stepNumberEl.innerHTML = '✓';
          step.setAttribute('aria-label', `Completed step ${stepNumber}: ${stepLabelEl.textContent}`);
        } else if (stepNumber === currentStep) {
          // Current active step
          step.classList.add('active');
          stepNumberEl.innerHTML = stepNumber;
          step.setAttribute('aria-label', `Current step ${stepNumber}: ${stepLabelEl.textContent}`);
        } else {
          // Future step
          stepNumberEl.innerHTML = stepNumber;
          step.setAttribute('aria-label', `Step ${stepNumber}: ${stepLabelEl.textContent} (not yet reached)`);
        }
      });

      // Update progress bar fill
      if (progressFill) {
        const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
        progressFill.style.width = `${progressPercentage}%`;
      }

      // Update progress bar ARIA attributes
      if (progressBar) {
        progressBar.setAttribute('aria-valuenow', currentStep);
        progressBar.setAttribute('aria-valuetext', `Step ${currentStep} of ${totalSteps}`);
      }
    }

    // Auto-progress based on form completion
    function setupAutoProgress() {
      // Monitor identifiers section
      const pmidInput = document.getElementById('pmid');
      const doiInput = document.getElementById('doi');
      const titleInput = document.getElementById('title');

      // Auto-advance from step 1 when PMID/DOI lookup succeeds or title is entered
      const checkStep1Completion = () => {
        if (currentStep === 1) {
          const hasIdentifier = (pmidInput && pmidInput.value.trim()) ||
                  (doiInput && doiInput.value.trim());
          const hasTitle = titleInput && titleInput.value.trim();

          if ((hasIdentifier || hasTitle) && titleInput && titleInput.value.trim()) {
            setTimeout(() => {
              if (currentStep === 1) { // Still on step 1
                navigateToStep(2);
              }
            }, 1000); // Small delay to allow user to see the populated data
          }
        }
      };

      // Auto-advance from step 2 when key details are filled
      const checkStep2Completion = () => {
        if (currentStep === 2) {
          const title = titleInput && titleInput.value.trim();
          const authors = document.getElementById('authors') && document.getElementById('authors').value.trim();
          const journal = document.getElementById('journal') && document.getElementById('journal').value.trim();

          if (title && (authors || journal)) {
            setTimeout(() => {
              if (currentStep === 2) { // Still on step 2
                navigateToStep(3);
              }
            }, 500);
          }
        }
      };

      // Add event listeners
      if (pmidInput) pmidInput.addEventListener('input', checkStep1Completion);
      if (doiInput) doiInput.addEventListener('input', checkStep1Completion);
      if (titleInput) {
        titleInput.addEventListener('input', () => {
          checkStep1Completion();
          checkStep2Completion();
        });
      }

      const authorsInput = document.getElementById('authors');
      const journalInput = document.getElementById('journal');

      if (authorsInput) authorsInput.addEventListener('input', checkStep2Completion);
      if (journalInput) journalInput.addEventListener('input', checkStep2Completion);

      // Monitor successful API lookups
      const originalSetStatus = window.setStatus || setStatus;
      window.setStatus = function(message, type) {
        if (originalSetStatus) originalSetStatus(message, type);

        // Auto-advance on successful lookup
        if (type === 'success' && message.includes('successfully') && currentStep === 1) {
          setTimeout(() => {
            if (currentStep === 1) {
              navigateToStep(2);
            }
          }, 1500);
        }
      };
    }

    // Screen reader announcements
    function announceStepChange(stepNumber) {
      const stepLabels = {
        1: 'Identifiers',
        2: 'Publication Details',
        3: 'Request Details'
      };

      const announcement = document.createElement('div');
      announcement.setAttribute('aria-live', 'polite');
      announcement.setAttribute('aria-atomic', 'true');
      announcement.className = 'sr-only';
      announcement.textContent = `Now on step ${stepNumber}: ${stepLabels[stepNumber]}`;

      document.body.appendChild(announcement);

      setTimeout(() => {
        document.body.removeChild(announcement);
      }, 1000);
    }

    // === ENHANCED SEARCH INCLUDING TAGS ===
    function initEnhancedSearch() {
      if (window.Fuse && requests.length > 0) {
        fuse = new Fuse(requests, {
          keys: [
            { name: 'title', weight: 3 },
            { name: 'authors', weight: 2 },
            { name: 'journal', weight: 2 },
            { name: 'tags', weight: 2 }, // Increased weight for tag search
            { name: 'notes', weight: 1 },
            { name: 'pmid', weight: 2 },
            { name: 'doi', weight: 2 },
            { name: 'patronEmail', weight: 1 },
            { name: 'priority', weight: 1.5 }
          ],
          threshold: 0.3,
          includeScore: true,
          // Enable searching within arrays (for tags)
          ignoreLocation: true,
          useExtendedSearch: true
        });
      }
    }
    function updateProgress(progressDiv, percentage, message, isError = false) {
      if (!progressDiv) return;

      const progressFill = progressDiv.querySelector('.progress-bar-fill');
      const progressText = progressDiv.querySelector('.progress-text');

      if (progressFill) {
        progressFill.style.width = `${Math.min(100, Math.max(0, percentage))}%`;

        // Change color based on status
        if (isError) {
          progressFill.style.background = 'var(--danger-color)';
        } else if (percentage >= 100) {
          progressFill.style.background = 'var(--success-color)';
        } else {
          progressFill.style.background = 'var(--primary-color)';
        }
      }

      if (progressText) {
        progressText.textContent = message;

        // Update text color for errors
        if (isError) {
          progressText.style.color = 'var(--danger-color)';
        } else if (percentage >= 100) {
          progressText.style.color = 'var(--success-color)';
        } else {
          progressText.style.color = 'var(--text-secondary)';
        }
      }
    }
    // === BULK PASTE FUNCTIONALITY ===
    // Enhanced bulk paste with API lookups
    async function handleBulkPasteWithLookup() {
      const textarea = document.getElementById('bulk-paste-data');
      if (!textarea) {
        console.error('Bulk paste textarea not found');
        return;
      }

      const data = textarea.value.trim();

      if (!data) {
        alert('Please paste some data first');
        return;
      }

      // Remove any existing progress indicators
      const existingProgress = document.getElementById('import-progress');
      if (existingProgress) {
        existingProgress.remove();
      }

      // Show progress indicator
      const progressDiv = document.createElement('div');
      progressDiv.id = 'import-progress';
      progressDiv.innerHTML = `
    <div class="progress-container">
      <div class="progress-bar-container">
        <div class="progress-bar-fill" style="width: 0%"></div>
      </div>
      <div class="progress-text">Preparing import...</div>
    </div>
  `;

      // Insert after the textarea
      textarea.parentNode.insertBefore(progressDiv, textarea.nextSibling);

      try {
        updateProgress(progressDiv, 5, 'Parsing data...');

        // Parse the data
        const results = Papa.parse(data, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: true,
          delimitersToGuess: [',', '\t', '|', ';']
        });

        if (!results.data || results.data.length === 0) {
          throw new Error('No valid data found. Check your CSV format and headers.');
        }

        updateProgress(progressDiv, 10, `Found ${results.data.length} rows to process...`);

        const importedRequests = [];
        const total = results.data.length;
        let processed = 0;

        // Process each row with API lookups
        for (let i = 0; i < results.data.length; i++) {
          const row = results.data[i];
          processed++;

          const baseProgress = 10 + ((processed / total) * 80); // 10-90% range
          updateProgress(progressDiv, baseProgress, `Processing row ${processed} of ${total}...`);

          // Build request data with all possible field mappings
          let requestData = {
            pmid: String(row.pmid || row.PMID || '').trim(),
            doi: String(row.doi || row.DOI || '').trim(),
            title: String(row.title || row.Title || '').trim(),
            authors: String(row.authors || row.Authors || '').trim(),
            journal: String(row.journal || row.Journal || '').trim(),
            year: String(row.year || row.Year || '').trim(),
            priority: String(row.priority || row.Priority || 'normal').toLowerCase().trim(),
            status: String(row.status || row.Status || 'pending').toLowerCase().trim(),
            patronEmail: String(row.patronEmail || row.PatronEmail || row['patron-email'] || '').trim(),
            docline: String(row.docline || row.Docline || row.DOCLINE || '').trim(),
            notes: String(row.notes || row.Notes || '').trim(),
            tags: [],
            createdAt: new Date().toISOString()
          };

          // Parse tags from various possible formats
          const tagString = String(row.tags || row.Tags || '').trim();
          if (tagString) {
            requestData.tags = tagString.split(/[,;|]/).map(t => t.trim()).filter(Boolean);
          }

          // Validate priority
          if (!['urgent', 'rush', 'normal'].includes(requestData.priority)) {
            requestData.priority = 'normal';
          }

          // Validate status
          if (!['pending', 'in-progress', 'fulfilled', 'cancelled'].includes(requestData.status)) {
            requestData.status = 'pending';
          }

          // Try to fetch metadata if we have PMID or DOI but missing other data
          const needsMetadata = !requestData.title || !requestData.authors || !requestData.journal;

          if (needsMetadata && (requestData.pmid || requestData.doi)) {
            try {
              let metadata = null;

              if (requestData.pmid) {
                updateProgress(progressDiv, baseProgress, `Fetching PMID ${requestData.pmid}... (${processed}/${total})`);
                metadata = await fetchPubMed(requestData.pmid);

                // Small delay to be API-friendly
                await new Promise(resolve => setTimeout(resolve, 200));
              } else if (requestData.doi) {
                updateProgress(progressDiv, baseProgress, `Fetching DOI ${requestData.doi}... (${processed}/${total})`);
                metadata = await fetchCrossRef(requestData.doi);

                // Small delay to be API-friendly
                await new Promise(resolve => setTimeout(resolve, 200));
              }

              if (metadata) {
                // Merge fetched metadata with existing data (existing data takes precedence)
                requestData = {
                  ...metadata,
                  ...Object.fromEntries(Object.entries(requestData).filter(([_, v]) => v !== ''))
                };
              }
            } catch (error) {
              console.warn(`Failed to fetch metadata for row ${i + 1}:`, error);
              // Continue with the data we have
            }
          }

          // Only add if we have at least a title or identifier
          if (requestData.title || requestData.pmid || requestData.doi) {
            // Update global tags map with any new tags
            requestData.tags.forEach(tag => {
              if (!globalTags.has(tag)) {
                globalTags.set(tag, 'default');
              }
            });

            importedRequests.push(requestData);
          } else {
            console.warn(`Skipping row ${i + 1}: No title or identifier found`);
          }
        }

        updateProgress(progressDiv, 90, 'Saving imported requests...');

        if (importedRequests.length > 0) {
          requests.push(...importedRequests);
          saveAll();
          renderAll();
          textarea.value = '';

          updateProgress(progressDiv, 100, `✅ Successfully imported ${importedRequests.length} requests!`);

          // Auto-remove progress after 5 seconds
          setTimeout(() => {
            if (progressDiv.parentNode) {
              progressDiv.remove();
            }
          }, 5000);

          // Show success alert
          setTimeout(() => {
            alert(`Import complete!\n\n✅ ${importedRequests.length} requests imported\n📊 ${total - importedRequests.length} rows skipped (missing required data)\n\nCheck the Dashboard or All Requests tab to see your imported data.`);
          }, 500);

        } else {
          throw new Error(`No valid requests found in ${total} rows. Please check your data format and ensure you have Title, PMID, or DOI columns.`);
        }

      } catch (error) {
        console.error('Bulk paste error:', error);
        updateProgress(progressDiv, 0, `❌ Error: ${error.message}`, true);

        // Auto-remove progress after 10 seconds on error
        setTimeout(() => {
          if (progressDiv.parentNode) {
            progressDiv.remove();
          }
        }, 10000);

        // Show error alert
        setTimeout(() => {
          alert(`Import failed!\n\n❌ ${error.message}\n\nPlease check your data format and try again. Make sure you have proper CSV headers like:\nPMID, DOI, Title, Authors, Journal, Year`);
        }, 500);
      }
    }

    // === ACCESSIBILITY ENHANCEMENTS ===
    function enhanceAccessibility() {
      // Add ARIA labels to all interactive elements
      document.querySelectorAll('button:not([aria-label])').forEach(btn => {
        if (btn.textContent.trim()) {
          btn.setAttribute('aria-label', btn.textContent.trim());
        }
      });

      // Add role attributes
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.setAttribute('role', 'tab');
      });

      document.querySelectorAll('.section').forEach(section => {
        section.setAttribute('role', 'tabpanel');
      });

      // Add skip navigation
      if (!document.getElementById('skip-nav')) {
        const skipNav = document.createElement('a');
        skipNav.id = 'skip-nav';
        skipNav.href = '#main-content';
        skipNav.textContent = 'Skip to main content';
        skipNav.className = 'sr-only';
        skipNav.style.cssText = `
        position: absolute;
        top: -40px;
        left: 6px;
        background: #000;
        color: #fff;
        padding: 8px;
        text-decoration: none;
        z-index: 9999;
      `;
        skipNav.addEventListener('focus', () => {
          skipNav.style.top = '6px';
        });
        skipNav.addEventListener('blur', () => {
          skipNav.style.top = '-40px';
        });
        document.body.insertBefore(skipNav, document.body.firstChild);
      }

      // Ensure main content has proper ID
      const mainContent = document.querySelector('.main-content');
      if (mainContent) {
        mainContent.id = 'main-content';
      }
    }

    // === Request Selection & Bulk Operations ===
    window.toggleRequestSelection = (index, checked) => {
      if (checked) {
        selectedRequests.add(index);
      } else {
        selectedRequests.delete(index);
      }
      renderRequests();
    };

    window.duplicateRequest = (index) => {
      const original = requests[index];
      if (original) {
        const duplicate = {
          ...original,
          title: `${original.title} (Copy)`,
          status: 'pending',
          createdAt: new Date().toISOString()
        };
        requests.unshift(duplicate);
        saveAll();
        renderAll();
      }
    };

    // === SELECT ALL FUNCTIONALITY ===
    window.toggleSelectAll = (checked) => {
      // Get all currently visible request cards
      const visibleCards = document.querySelectorAll('.request-card[data-index]');

      if (checked) {
        // Select all visible requests
        visibleCards.forEach(card => {
          const index = parseInt(card.dataset.index);
          selectedRequests.add(index);
        });
      } else {
        // Deselect all
        selectedRequests.clear();
      }

      renderRequests();
    };

    function updateSelectAllState() {
      const selectAllCheckbox = document.getElementById('select-all');
      const deleteBtn = document.getElementById('delete-selected-btn');
      const visibleCards = document.querySelectorAll('.request-card[data-index]');
      const visibleCount = visibleCards.length;

      // Count how many visible cards are selected
      let selectedVisibleCount = 0;
      visibleCards.forEach(card => {
        const index = parseInt(card.dataset.index);
        if (selectedRequests.has(index)) {
          selectedVisibleCount++;
        }
      });

      if (selectAllCheckbox) {
        if (selectedVisibleCount === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (selectedVisibleCount === visibleCount) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }
      }

      // Show/hide delete button
      if (deleteBtn) {
        deleteBtn.style.display = selectedRequests.size > 0 ? 'inline-flex' : 'none';
      }

      // Update results count
      const resultsCount = document.getElementById('results-count');
      if (resultsCount) {
        resultsCount.textContent = `${visibleCount} requests`;
        if (selectedRequests.size > 0) {
          resultsCount.textContent += ` (${selectedRequests.size} selected)`;
        }
      }
    }

    // === BULK DELETE FUNCTIONALITY ===
    window.deleteSelectedRequests = () => {
      if (selectedRequests.size === 0) {
        alert('No requests selected');
        return;
      }

      if (!confirm(`Delete ${selectedRequests.size} selected requests? This cannot be undone.`)) {
        return;
      }

      // Convert to array and sort in descending order to avoid index issues
      const indicesToDelete = Array.from(selectedRequests).sort((a, b) => b - a);

      indicesToDelete.forEach(index => {
        requests.splice(index, 1);
      });

      selectedRequests.clear();
      saveAll();
      renderAll();

      alert(`✅ Deleted ${indicesToDelete.length} requests successfully`);
    };

    // === Other Handlers ===
    function onSettingsSave(e) {
      e.preventDefault();
      settings.followupDays = +els.followupDays.value;
      settings.theme = els.theme.value;
      settings.apiKey = els.apiKey.value.trim();
      settings.crossrefEmail = els.crossrefEmail.value.trim();
      saveAll();
      applyTheme();
      setStatus('Settings saved!', 'success');
      renderAll();
    }

    function onFormSubmit(e) {
      e.preventDefault();
      const entry = {
        pmid: els.pmidInput.value.trim(),
        doi: els.doiInput.value.trim(),
        docline: els.doclineInput.value.trim(),
        title: els.titleInput.value.trim(),
        authors: els.authorsInput.value.trim(),
        journal: els.journalInput.value.trim(),
        year: els.yearInput.value.trim(),
        patronEmail: els.patronEmailInput.value.trim(),
        status: els.statusSelect.value,
        tags: els.tagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
        notes: els.notesInput.value.trim(),
        priority: document.getElementById('priority')?.value || 'normal',
        createdAt: new Date().toISOString()
      };

      // Update global tags map with any new tags
      entry.tags.forEach(tag => {
        if (!globalTags.has(tag)) {
          globalTags.set(tag, 'default');
        }
      });

      if (currentEdit != null) {
        requests[currentEdit] = entry;
        currentEdit = null;
      } else {
        requests.unshift(entry);
      }

      saveAll();
      renderAll();
      els.form.reset();
      setStatus('Request saved successfully!', 'success');
    }

    // === Rendering ===
    function initFuse() {
      initEnhancedSearch();
    }

    function needsFollowUp(r) {
      return (Date.now() - new Date(r.createdAt)) / 86400000 > settings.followupDays && r.status === 'pending';
    }

    function renderStats() {
      if (els.stats.total) els.stats.total.textContent = requests.length;
      if (els.stats.pending) els.stats.pending.textContent = requests.filter(r => r.status === 'pending').length;
      if (els.stats.fulfilled) els.stats.fulfilled.textContent = requests.filter(r => r.status === 'fulfilled').length;
      if (els.stats.followup) els.stats.followup.textContent = requests.filter(needsFollowUp).length;
    }

    function renderRequests() {
      if (!els.requestList) return;

      const q = els.search ? els.search.value.trim() : '';
      let filteredRequests = [];

      // Apply search filter
      if (q && fuse) {
        filteredRequests = fuse.search(q).map(result => ({
          request: result.item,
          originalIndex: requests.indexOf(result.item)
        }));
      } else {
        filteredRequests = requests.map((request, index) => ({
          request: request,
          originalIndex: index
        }));
      }

      // Apply status filter
      if (els.statusFilter && els.statusFilter.value) {
        filteredRequests = filteredRequests.filter(item => item.request.status === els.statusFilter.value);
      }

      // Apply priority filter
      const priorityFilter = document.getElementById('priority-filter');
      if (priorityFilter && priorityFilter.value) {
        filteredRequests = filteredRequests.filter(item =>
                (item.request.priority || 'normal') === priorityFilter.value
        );
      }

      // Apply follow-up filter
      if (followupOnly) {
        filteredRequests = filteredRequests.filter(item => needsFollowUp(item.request));
      }

      // Apply sorting
      filteredRequests.sort((a, b) => {
        let aVal = a.request[currentSortField];
        let bVal = b.request[currentSortField];

        // Handle special cases
        if (currentSortField === 'createdAt') {
          aVal = new Date(aVal || 0).getTime();
          bVal = new Date(bVal || 0).getTime();
        } else if (currentSortField === 'priority') {
          // Priority order: urgent > rush > normal
          const priorityOrder = { urgent: 3, rush: 2, normal: 1 };
          aVal = priorityOrder[aVal || 'normal'];
          bVal = priorityOrder[bVal || 'normal'];
        } else if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = (bVal || '').toLowerCase();
        }

        // Handle undefined/null values
        if (aVal === undefined || aVal === null) aVal = '';
        if (bVal === undefined || bVal === null) bVal = '';

        let comparison = 0;
        if (aVal < bVal) comparison = -1;
        if (aVal > bVal) comparison = 1;

        return currentSortDirection === 'desc' ? -comparison : comparison;
      });

      // Render the cards
      els.requestList.innerHTML = filteredRequests.length
              ? filteredRequests.map(item => createEnhancedCard(item.request, item.originalIndex)).join('')
              : '<p class="empty-message">No requests found</p>';

      updateSelectAllState();
    }

    function initSortButtons() {
      const sortButtons = document.querySelectorAll('.sort-btn');

      sortButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const field = btn.getAttribute('data-field');

          // Toggle direction if same field, otherwise default to desc
          if (currentSortField === field) {
            currentSortDirection = currentSortDirection === 'desc' ? 'asc' : 'desc';
          } else {
            currentSortField = field;
            currentSortDirection = 'desc';
          }

          // Update visual indicators
          updateSortButtons();

          // Re-render with new sort
          renderRequests();
        });
      });
    }

    function updateSortButtons() {
      const sortButtons = document.querySelectorAll('.sort-btn');

      sortButtons.forEach(btn => {
        const field = btn.getAttribute('data-field');

        // Remove all sort classes
        btn.classList.remove('sort-asc', 'sort-desc');

        // Add appropriate class for current field
        if (field === currentSortField) {
          btn.classList.add(`sort-${currentSortDirection}`);
        }
      });
    }

    // === RENDER RECENT REQUESTS FOR DASHBOARD ===
    function renderRecentRequests() {
      const recentContainer = document.getElementById('recent-requests');
      if (!recentContainer) return;

      // Get 5 most recent requests
      const recentRequests = requests
              .slice(0, 5)
              .map((r, index) => ({
                request: r,
                originalIndex: index
              }));

      if (recentRequests.length === 0) {
        recentContainer.innerHTML = '<p class="empty-message">No recent requests</p>';
        return;
      }

      recentContainer.innerHTML = recentRequests.map(item => {
        const r = item.request;
        const index = item.originalIndex;
        const createdDate = r.createdAt ? new Date(r.createdAt).toLocaleDateString() : '';
        const priorityBadge = r.priority ? `<span class="priority-badge ${r.priority}">${r.priority.toUpperCase()}</span>` : '';

        return `
        <div class="recent-request-card">
          <div class="recent-title">${r.title || 'Untitled'} ${priorityBadge}</div>
          <div class="recent-meta">
            ${r.authors || ''} • ${r.journal || ''} (${r.year || ''})
            ${createdDate ? ` • ${createdDate}` : ''}
          </div>
          <div class="recent-status status-${r.status}">${r.status.replace('-', ' ').toUpperCase()}</div>
        </div>
      `;
      }).join('');
    }

    function createCard(r, i) {
      return createEnhancedCard(r, i);
    }

    // Global functions for buttons
    window.editRequest = i => {
      const r = requests[i];
      currentEdit = i;
      populateForm(r);

      // Switch to add request tab
      const addTab = document.querySelector('[data-section="add-request"]');
      if (addTab) switchSection(addTab);
    };

    window.deleteRequest = i => {
      if (confirm('Delete this request?')) {
        requests.splice(i,1);
        saveAll();
        renderAll();
      }
    };

    function renderAll() {
      initFuse();
      renderStats();
      renderRequests();
      renderRecentRequests();
    }

    // === Export/Import Handlers ===
    function handleExportCSV() {
      if (requests.length === 0) {
        alert('No requests to export');
        return;
      }

      const headers = ['PMID', 'DOI', 'Title', 'Authors', 'Journal', 'Year', 'Status', 'Priority', 'Tags', 'Notes', 'Created'];
      const rows = requests.map(r => [
        r.pmid || '',
        r.doi || '',
        r.title || '',
        r.authors || '',
        r.journal || '',
        r.year || '',
        r.status || '',
        r.priority || 'normal',
        (r.tags || []).join('; '),
        r.notes || '',
        r.createdAt || ''
      ]);

      const csvContent = [headers, ...rows]
              .map(row => row.map(cell => `"${(cell + '').replace(/"/g, '""')}"`).join(','))
              .join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `silentstacks-requests-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function handleExportJSON() {
      if (requests.length === 0) {
        alert('No requests to export');
        return;
      }

      const blob = new Blob([JSON.stringify(requests, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `silentstacks-requests-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          let importedData = [];

          if (file.name.endsWith('.json')) {
            importedData = JSON.parse(event.target.result);
          } else if (file.name.endsWith('.csv')) {
            const results = Papa.parse(event.target.result, {
              header: true,
              skipEmptyLines: true,
              dynamicTyping: true
            });

            importedData = results.data.map(row => ({
              pmid: String(row.PMID || row.pmid || '').trim(),
              doi: String(row.DOI || row.doi || '').trim(),
              title: String(row.Title || row.title || '').trim(),
              authors: String(row.Authors || row.authors || '').trim(),
              journal: String(row.Journal || row.journal || '').trim(),
              year: String(row.Year || row.year || '').trim(),
              status: String(row.Status || row.status || 'pending').trim(),
              priority: String(row.Priority || row.priority || 'normal').trim(),
              tags: String(row.Tags || row.tags || '').split(';').map(t => t.trim()).filter(Boolean),
              notes: String(row.Notes || row.notes || '').trim(),
              patronEmail: String(row.PatronEmail || row.patronEmail || '').trim(),
              createdAt: row.Created || row.createdAt || new Date().toISOString()
            })).filter(req => req.title);
          }

          if (importedData.length > 0) {
            // Update global tags
            importedData.forEach(req => {
              (req.tags || []).forEach(tag => {
                if (!globalTags.has(tag)) {
                  globalTags.set(tag, 'default');
                }
              });
            });

            requests.push(...importedData);
            saveAll();
            renderAll();

            const importStatus = document.getElementById('import-status');
            if (importStatus) {
              importStatus.textContent = `✅ Successfully imported ${importedData.length} requests!`;
              importStatus.className = 'import-status success';
            }
          } else {
            throw new Error('No valid requests found in file');
          }

        } catch (error) {
          console.error('Import error:', error);
          const importStatus = document.getElementById('import-status');
          if (importStatus) {
            importStatus.textContent = `❌ Import failed: ${error.message}`;
            importStatus.className = 'import-status error';
          }
        }
      };

      reader.readAsText(file);
    }

    // === Event Binding ===
    function bindEvents() {
      // Navigation
      els.navTabs.forEach(tab => {
        tab.addEventListener('click', () => switchSection(tab));
      });

      // Settings form
      const settingsForm = document.getElementById('settings-form');
      if (settingsForm) {
        settingsForm.addEventListener('submit', onSettingsSave);
      }

      // Main form
      if (els.form) {
        els.form.addEventListener('submit', onFormSubmit);
      }

      // Form buttons
      if (els.clearBtn) {
        els.clearBtn.addEventListener('click', () => {
          els.form.reset();
          currentEdit = null;
          setStatus('Form cleared', 'success');
        });
      }

      // Lookup buttons
      const pmidBtn = document.getElementById('lookup-pmid');
      const doiBtn = document.getElementById('lookup-doi');

      if (pmidBtn) pmidBtn.addEventListener('click', onLookupPMID);
      if (doiBtn) doiBtn.addEventListener('click', onLookupDOI);

      // Search and filters - GROUP ALL FILTERS TOGETHER
      if (els.search) els.search.addEventListener('input', renderRequests);
      if (els.statusFilter) els.statusFilter.addEventListener('change', renderRequests);

      // Priority filter - ADD HERE WITH OTHER FILTERS
      const priorityFilter = document.getElementById('priority-filter');
      if (priorityFilter) priorityFilter.addEventListener('change', renderRequests);

      if (els.followupFilter) {
        els.followupFilter.addEventListener('click', () => {
          followupOnly = !followupOnly;
          els.followupFilter.classList.toggle('active', followupOnly);
          els.followupFilter.textContent = followupOnly ? 'Show All' : 'Follow-up Needed';
          renderRequests();
        });
      }

      // Import/Export
      if (els.importFile) els.importFile.addEventListener('change', handleImport);
      if (els.exportCsv) els.exportCsv.addEventListener('click', handleExportCSV);
      if (els.exportJson) els.exportJson.addEventListener('click', handleExportJSON);

      // Bulk paste functionality - UPDATED FUNCTION NAME
      const bulkPasteBtn = document.getElementById('bulk-paste-btn');
      if (bulkPasteBtn) {
        bulkPasteBtn.addEventListener('click', handleBulkPasteWithLookup);
      }
    }

    // === Make fetchPubMed and fetchCrossRef globally available ===
    window.fetchPubMed = fetchPubMed;
    window.fetchCrossRef = fetchCrossRef;

    // === Initialization ===
    function init() {
      loadSettings();
      loadRequests();
      loadGlobalTags();
      applyTheme();
      bindEvents();
      renderAll();
      enhanceAccessibility();
      initProgressStepNavigation();
      initSortButtons();

      console.log('SilentStacks v1.2 initialized with', requests.length, 'requests');
      console.log('Global tags loaded:', globalTags.size, 'tags');
      console.log('Offline support:', window.offlineManager ? 'enabled' : 'pending');
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();

  // v2_features.js
  // This script contains additional functionality for SilentStacks v2.0.
  // It augments the existing application (v1.2 baseline) with new features
  // such as bulk PMID paste/upload with enrichment (PubMed, CrossRef, ClinicalTrials.gov),
  // MeSH chips/cards, extended export options, offline queueing and AAA accessibility helpers.

  (() => {
    // Configuration for rate limits and API endpoints
    const API_CONFIG = {
      pubmedBase: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/',
      crossrefBase: 'https://api.crossref.org/',
      ctgovBase: 'https://clinicaltrials.gov/api/v2/',
      rateLimits: {
        pubmed: 2,      // 2 requests per second
        crossref: 5,     // 5 requests per second
        ctgov: 1         // 1 request per second
      }
    };

    /**
     * Normalize a bulk input string to an array of unique identifiers.
     * Accepts mixed PMID/DOI/NCT tokens separated by whitespace, commas or newlines.
     * @param {string} text Bulk input text
     * @returns {string[]} Normalized unique identifiers
     */
    function parseBulkInput(text) {
      if (!text) return [];
      const tokens = text
              .split(/\s|,|;/)
              .map(t => t.trim())
              .filter(Boolean);
      const unique = new Set();
      const out = [];
      for (const raw of tokens) {
        let norm = raw.trim();
        // Normalize DOI by stripping common prefixes
        norm = norm.replace(/^(https?:\/\/)?(dx\.)?doi\.org\//i, '');
        // Accept PMID (all digits), NCT (NCT followed by digits), or DOI (contains '/')
        const isPMID = /^\d{6,9}$/.test(norm);
        const isNCT  = /^NCT\d{5,}/i.test(norm);
        const isDOI = /^10\.\d{4,9}\/\S+$/.test(norm);
        if (!(isPMID || isNCT || isDOI)) continue;
        const key = norm.toUpperCase();
        if (!unique.has(key)) {
          unique.add(key);
          out.push(norm);
        }
      }
      return out;
    }

    /**
     * Simple rate limiter: returns a promise that resolves after a delay based on the given rate.
     * @param {number} rate Requests per second
     */
    function waitForRate(rate) {
      const delay = 1000 / rate;
      return new Promise(resolve => setTimeout(resolve, delay));
    }

    /**
     * Fetch PubMed metadata for a single PMID.
     * Returns bibliographic info plus up to 5 MeSH terms.
     * @param {string} pmid
     */
    async function fetchPubMedRecord(pmid, apiKey = '') {
      const keyParam = apiKey ? `&api_key=${apiKey}` : '';
      const summaryUrl = `${API_CONFIG.pubmedBase}esummary.fcgi?db=pubmed&id=${pmid}&retmode=json${keyParam}`;
      const fetchUrl = `${API_CONFIG.pubmedBase}efetch.fcgi?db=pubmed&id=${pmid}&retmode=json${keyParam}`;
      const summaryRes = await fetch(summaryUrl);
      const summaryJson = await summaryRes.json();
      const record = summaryJson.result && summaryJson.result[pmid];
      let mesh = [];
      let doi = '';
      if (record) {
        doi = record.elocationid || '';
      }
      // EFetch for MeSH and abstract
      const fetchRes = await fetch(fetchUrl);
      const fetchJson = await fetchRes.json();
      if (fetchJson.result && fetchJson.result[pmid]) {
        const full = fetchJson.result[pmid];
        if (Array.isArray(full.mesh_list)) {
          mesh = full.mesh_list.slice(0, 5).map(item => item.name);
        }
      }
      return {
        pmid,
        title: record?.title || '',
        authors: (record?.authors || []).map(a => a.name).join('; '),
        journal: record?.fulljournalname || record?.source || '',
        year: (record?.pubdate || '').split(' ')[0] || '',
        doi,
        mesh
      };
    }

    // TODO: implement fetchCrossRefRecord and fetchCtGovRecord
    async function fetchCtGovRecord(nctIdOrTitle) {
      // Heuristic: if it looks like NCTid, query by id; else query by title keywords.
      const isId = /^NCT\d{5,}/i.test(nctIdOrTitle);
      // v2 API: studies with fields for Sponsor/AgencyClass, Phase, OverallStatus, OfficialTitle
      const base = API_CONFIG.ctgovBase.replace(/\/$/, '');
      const endpoint = isId
              ? `${base}/studies/${encodeURIComponent(nctIdOrTitle.toUpperCase())}`
              : `${base}/studies?query.term=${encodeURIComponent(nctIdOrTitle)}`;

      // Respect rate limit
      await waitForRate(API_CONFIG.rateLimits.ctgov);

      const res = await fetch(endpoint, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`CT.gov API error: ${res.status}`);
      const data = await res.json();

      // Normalize shape
      let study = null;
      if (isId) {
        study = data?.study || data?.studies?.[0] || null;
      } else {
        study = data?.studies?.[0] || null;
      }
      if (!study) return { ct: {}, ctTags: [] };

      // Try to map common fields safely
      const officialTitle = study?.protocolSection?.identificationModule?.officialTitle
              || study?.official_title || '';
      const id = study?.protocolSection?.identificationModule?.nctId
              || study?.nct_id || nctIdOrTitle;
      const overallStatus = study?.protocolSection?.statusModule?.overallStatus
              || study?.overall_status || '';
      const phase = study?.protocolSection?.designModule?.phases?.[0]
              || study?.phase || '';
      const sponsor = (
              study?.protocolSection?.sponsorCollaboratorsModule?.leadSponsor?.name
              || study?.sponsors?.lead_sponsor?.name
              || ''
      );
      const agencyClass = (
              study?.protocolSection?.sponsorCollaboratorsModule?.leadSponsor?.agencyClass
              || study?.sponsors?.lead_sponsor?.agency_class
              || ''
      );

      // Build color-coded selectable tags
      const ctTags = [];
      if (sponsor) ctTags.push(`Sponsor:${sponsor}`);
      if (agencyClass) ctTags.push(`Agency:${agencyClass}`);
      if (phase) ctTags.push(`Phase:${phase}`);
      if (overallStatus) ctTags.push(`Status:${overallStatus}`);

      return {
        ct: {
          nctId: id || '',
          title: officialTitle || '',
          sponsor: sponsor || '',
          agencyClass: agencyClass || '',
          phase: phase || '',
          status: overallStatus || ''
        },
        ctTags
      };
    }
    //similar to fetchPubMedRecord
    // These functions should return augmentation data and handle rate limiting

    /**
     * Process a list of identifiers sequentially, fetching enrichment data per spec.
     * This function respects API rate limits and offline conditions (queueing when offline).
     * @param {string[]} ids List of normalized identifiers
     */
    async function enrichIdentifiers(ids, apiKey, crossrefEmail) {
      const enriched = [];
      for (const id of ids) {
        const type = /^\d+$/.test(id) ? 'PMID' : /^NCT\d+/i.test(id) ? 'NCT' : 'DOI';
        try {
          if (type === 'PMID') {
            await waitForRate(API_CONFIG.rateLimits.pubmed);
            const rec = await fetchPubMedRecord(id, apiKey);
            // Attempt CT cross-population by title if available
            let ct = {}, ctTags = [];
            if (rec && rec.title) {
              try {
                const ctRes = await fetchCtGovRecord(rec.title);
                ct = ctRes.ct || {};
                ctTags = ctRes.ctTags || [];
              } catch {}
            }
            enriched.push({ seedType: 'PMID', identifiers: { pmid: id, nct: ct.nctId || '' }, ...rec, ct, ctTags });
          } else if (type === 'DOI') {
            await waitForRate(API_CONFIG.rateLimits.crossref);
            const rec = await fetchCrossRef(id);
            // Try PubMed backfill by title
            let backfill = {};
            if (rec && rec.title) {
              try {
                const esearch = await fetch(`${API_CONFIG.pubmedBase}esearch.fcgi?db=pubmed&retmode=json&term=${encodeURIComponent(rec.title)}`);
                const ejson = await esearch.json();
                const match = ejson?.esearchresult?.idlist?.[0];
                if (match) backfill = await fetchPubMedRecord(match, apiKey);
              } catch {}
            }
            enriched.push({ seedType: 'DOI', identifiers: { doi: rec.doi || id, pmid: backfill.pmid || '' }, ...backfill, ...rec });
          } else if (type === 'NCT') {
            const { ct, ctTags } = await fetchCtGovRecord(id);
            enriched.push({ seedType: 'NCT', identifiers: { nct: id }, ct, ctTags });
          }
        } catch (e) {
          console.error('Enrichment error for', id, e);
        }
      }
      return enriched;
    }

    // Expose minimal API on window for integration
    window.silentStacksV2 = {
      parseBulkInput,
      enrichIdentifiers
    };

    /**
     * Hook up bulk paste enrichment to the existing UI.
     *
     * This listener attaches to the "Import Pasted Data" button on the
     * Import/Export section. When clicked, it parses the contents of the
     * textarea (#bulk-paste-data), performs enrichment for each identifier
     * using the enrichment functions defined above, and appends new
     * requests to the global `requests` array used by SilentStacks. After
     * inserting the new records, it saves the state and re-renders the
     * request list. The operation respects the user's stored PubMed API key
     * and CrossRef email where available. Errors are logged but do not
     * interrupt the user workflow.
     */
    document.addEventListener('DOMContentLoaded', () => {
      // Inject simple styles for mesh chips.  This preserves the existing CSS file
      // while providing a visual indicator for MeSH terms in the table view.
      const chipStyle = document.createElement('style');
      chipStyle.textContent = `
      .mesh-chip {
        display: inline-block;
        margin: 0 4px 4px 0;
        padding: 2px 6px;
        background-color: var(--chip-bg, #e6e6fa);
        color: var(--chip-color, #333);
        border-radius: 4px;
        font-size: 0.75rem;
        line-height: 1;
      }
    `;
      document.head.appendChild(chipStyle);

      // Toggle view button handler
      const toggleBtn = document.getElementById('toggle-view');
      const requestListDiv = document.getElementById('request-list');
      const tableContainer = document.getElementById('requests-table-container');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          const showingTable = tableContainer && tableContainer.style.display !== 'none';
          if (!showingTable) {
            // Show table view, hide card view
            if (tableContainer) tableContainer.style.display = '';
            if (requestListDiv) requestListDiv.style.display = 'none';
            toggleBtn.setAttribute('aria-pressed', 'true');
            toggleBtn.textContent = '📇 Card View';
            // Render table rows
            if (typeof renderTable === 'function') {
              renderTable();
            }
          } else {
            // Show card view, hide table
            if (tableContainer) tableContainer.style.display = 'none';
            if (requestListDiv) requestListDiv.style.display = '';
            toggleBtn.setAttribute('aria-pressed', 'false');
            toggleBtn.textContent = '📄 Table View';
          }
        });
      }
      const bulkBtn = document.getElementById('bulk-paste-btn');
      const textarea = document.getElementById('bulk-paste-data');
      const importStatus = document.getElementById('import-status');
      if (!bulkBtn || !textarea) return;
      bulkBtn.addEventListener('click', async () => {
        if (!textarea.value.trim()) return;
        // Parse identifiers from textarea
        const ids = parseBulkInput(textarea.value);
        if (!ids.length) return;
        // Provide immediate feedback
        if (importStatus) importStatus.textContent = 'Enriching ' + ids.length + ' records…';
        // Retrieve API key and CrossRef email from settings/localStorage if present
        let apiKey = '';
        let crossrefEmail = '';
        try {
          const savedSettings = JSON.parse(localStorage.getItem('settings') || '{}');
          apiKey = savedSettings.apiKey || '';
          crossrefEmail = savedSettings.crossrefEmail || '';
        } catch (e) {
          console.warn('Could not parse saved settings', e);
        }
        // Enrich identifiers sequentially (uses internal rate limiting)
        const enriched = await enrichIdentifiers(ids, apiKey, crossrefEmail);
        // Convert enriched results into request objects and append to global requests
        if (Array.isArray(enriched)) {
          enriched.forEach(item => {
            const request = {
              pmid: item.pmid || '',
              doi: item.doi || '',
              title: item.title || '',
              authors: item.authors || '',
              journal: item.journal || '',
              year: item.year || '',
              // Combine mesh terms into a string for display; store as array on request
              mesh: item.mesh || [],
              status: 'pending',
              priority: 'normal',
              createdAt: new Date().toISOString(),
              docline: '',
              patronEmail: '',
              notes: '',
              tags: []
            };
            // Append to global requests array defined in app.js
            if (typeof requests !== 'undefined' && Array.isArray(requests)) {
              requests.push(request);
            }
          });
          // Persist changes and re-render
          if (typeof saveAll === 'function') saveAll();
          if (typeof renderRequests === 'function') renderRequests();
          // If table view is active, re-render it as well
          if (typeof renderTable === 'function') renderTable();
        }
        // Update status and clear textarea
        if (importStatus) importStatus.textContent = 'Imported ' + enriched.length + ' records successfully.';
        textarea.value = '';
      });
    });

    /**
     * Render the table view of requests.  This function populates the
     * `<tbody>` of the requests table with rows representing each request in the
     * global `requests` array.  MeSH terms, if present, are displayed as
     * chips within the Citation column.
     */
    window.renderTable = function() {
      const tbody = document.getElementById('requests-tbody');
      if (!tbody) return;
      // Build rows for each request
      const rows = (Array.isArray(requests) ? requests : []).map((r, idx) => {
        const urgency = (r.priority || 'normal').charAt(0).toUpperCase() + (r.priority || 'normal').slice(1);
        const docline = r.docline || '';
        const pmid = r.pmid || '';
        // Citation: title and authors (year) and DOI if available
        let citationParts = [];
        if (r.title) citationParts.push(`<strong>${escapeHtml(r.title)}</strong>`);
        if (r.authors) citationParts.push(`<span>${escapeHtml(r.authors)}</span>`);
        if (r.year) citationParts.push(`(${escapeHtml(r.year)})`);
        if (r.doi) citationParts.push(`DOI: ${escapeHtml(r.doi)}`);
        // MeSH chips
        let meshHtml = '';
        if (Array.isArray(r.mesh) && r.mesh.length) {
          meshHtml = '<div>' + r.mesh.map(term => `<span class="mesh-chip" title="${escapeHtml(term)}">${escapeHtml(term)}</span>`).join('') + '</div>';
        }
        const citation = citationParts.join(' · ') + meshHtml;
        const patron = r.patronEmail || '';
        const status = r.status || '';
        return `<tr data-index="${idx}">
        <td>${escapeHtml(urgency)}</td>
        <td>${escapeHtml(docline)}</td>
        <td>${escapeHtml(pmid)}</td>
        <td>${citation}</td>
        <td>${escapeHtml(patron)}</td>
        <td>
          <select class="request-status-select" data-index="${idx}">
            <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="in-progress" ${status === 'in-progress' ? 'selected' : ''}>In Progress</option>
            <option value="fulfilled" ${status === 'fulfilled' ? 'selected' : ''}>Fulfilled</option>
            <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
          </select>
        </td>
      </tr>`;
      }).join('');
      tbody.innerHTML = rows;

      // Bind change events for status selects
      tbody.querySelectorAll('select.request-status-select').forEach(sel => {
        sel.addEventListener('change', (e) => {
          const idx = parseInt(sel.getAttribute('data-index'), 10);
          const value = sel.value;
          if (!isNaN(idx) && requests[idx]) {
            requests[idx].status = value;
            if (typeof saveAll === 'function') saveAll();
            if (typeof renderRequests === 'function') renderRequests();
          }
        });
      });
    };

    /**
     * Escape HTML entities for safe insertion into the DOM.
     * @param {string} str
     */
    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/[&<>"']/g, function(tag) {
        const chars = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return chars[tag] || tag;
      });
    }
  })();
</script>

<script>
  (function(){
    // Safe escape for any dynamic text
    window.escapeHtml = window.escapeHtml || function(str) {
      return (str == null ? '' : String(str))
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;');
    };

    // Render CT tags (Sponsor/Phase/Status) alongside existing tags in cards/table
    function renderCtTagsFrag(r) {
      const tags = Array.isArray(r.ctTags) ? r.ctTags : [];
      if (!tags.length) return '';
      return '<div class="request-tags">' + tags.map(t => {
        const parts = t.split(':'); const key = parts[0] || 'Tag'; const val = parts.slice(1).join(':') || '';
        const cls = key === 'Phase' ? 'tag-color-4' : key === 'Status' ? 'tag-color-3' : key === 'Sponsor' ? 'tag-color-2' : 'tag-color-5';
        return '<span class="tag '+cls+' tag-colorable" data-tag="'+window.escapeHtml(t)+'">'+window.escapeHtml(t)+'</span>';
      }).join('') + '</div>';
    }

    // Patch renderTable to append ctTags + mesh chips selectable
    if (window.renderTable) {
      const origRenderTable = window.renderTable;
      window.renderTable = function(){
        origRenderTable();
        const tbody = document.getElementById('requests-tbody');
        if (!tbody) return;
        [...tbody.querySelectorAll('tr')].forEach((tr, idx) => {
          const r = (window.requests || [])[idx];
          if (!r) return;
          // Append ctTags to Citation cell (4th column, index 3)
          const cells = tr.querySelectorAll('td');
          if (cells[3]) {
            const ctFrag = renderCtTagsFrag(r);
            if (ctFrag) cells[3].innerHTML += ctFrag;
          }
          // Make MeSH chips clickable -> filter by tag
          cells[3]?.querySelectorAll('.mesh-chip').forEach(chip => {
            chip.style.cursor = 'pointer';
            chip.addEventListener('click', () => {
              const term = chip.textContent.trim();
              const search = document.getElementById('search');
              if (search) { search.value = term; }
              if (typeof window.renderRequests === 'function') window.renderRequests();
            });
          });
        });
      };
    }

    // Bulk Update / Delete helpers (non-destructive; respects baseline UI)
    window.bulkDeleteSelected = function(){
      const indices = [];
      document.querySelectorAll('.request-checkbox input[type="checkbox"]:checked').forEach(cb => {
        const idx = parseInt(cb.getAttribute('data-index'), 10);
        if (!isNaN(idx)) indices.push(idx);
      });
      if (!indices.length) { alert('No items selected.'); return; }
      if (!confirm('Delete selected ' + indices.length + ' item(s)?')) return;
      // Delete from highest index to lowest to avoid reindexing issues
      indices.sort((a,b)=>b-a).forEach(i => (window.requests||[]).splice(i,1));
      if (typeof window.saveAll==='function') window.saveAll();
      if (typeof window.renderAll==='function') window.renderAll();
    };

    window.bulkUpdateSelected = function(field, value){
      const validFields = new Set(['status','priority']);
      if (!validFields.has(field)) { alert('Unsupported bulk field: ' + field); return; }
      const indices = [];
      document.querySelectorAll('.request-checkbox input[type="checkbox"]:checked').forEach(cb => {
        const idx = parseInt(cb.getAttribute('data-index'), 10);
        if (!isNaN(idx)) indices.push(idx);
      });
      if (!indices.length) { alert('No items selected.'); return; }
      (window.requests||[]).forEach((r,i)=>{
        if (indices.includes(i)) {
          r[field] = value;
          r.updatedAt = new Date().toISOString();
        }
      });
      if (typeof window.saveAll==='function') window.saveAll();
      if (typeof window.renderAll==='function') window.renderAll();
    };

    // Wire default bulk buttons if present
    document.addEventListener('DOMContentLoaded', () => {
      const delBtn = document.getElementById('bulk-delete-selected');
      if (delBtn) delBtn.addEventListener('click', window.bulkDeleteSelected);
      const updBtn = document.getElementById('bulk-update-selected');
      if (updBtn) {
        updBtn.addEventListener('click', () => {
          const sel = document.getElementById('bulk-update-field');
          const val = document.getElementById('bulk-update-value');
          const field = sel ? sel.value : 'status';
          const value = val ? val.value : 'in-progress';
          window.bulkUpdateSelected(field, value);
        });
      }
    });

    // Ensure onLookupPMID cross-populates NCT/CT tags via title search
    if (window.fetchCtGovRecord && typeof window.populateForm === 'function') {
      const origPopulate = window.populateForm;
      window.populateForm = async function(meta){
        origPopulate(meta);
        try {
          const title = meta && meta.title ? meta.title : '';
          if (title) {
            const { ct, ctTags } = await fetchCtGovRecord(title);
            // Attach to transient form fields if present
            if (ct && ct.title) {
              const notes = document.getElementById('notes');
              if (notes && !notes.value.includes('[NCT]')) {
                const add = `\n[NCT] ${ct.nctId || ''} — ${ct.title}`.trim();
                notes.value = (notes.value ? notes.value + '\n' : '') + add;
              }
            }
          }
        } catch(e){ console.warn('CT cross-populate failed', e); }
      };
    }
  })();
</script>


<script>
  // --- Tab wiring (non-destructive; uses existing IDs/classes) ---
  (function(){
    try {
      const tabs = Array.from(document.querySelectorAll('.nav-tab'));
      const sections = Array.from(document.querySelectorAll('.section'));
      function show(id){
        sections.forEach(s => s.classList.toggle('active', s.id === id));
        tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-target') === id));
      }
      tabs.forEach(t => {
        t.addEventListener('click', (e) => {
          const id = t.getAttribute('data-target');
          if (id) { show(id); }
        });
      });
      // Initialize: activate first visible
      const first = tabs.find(t => t.getAttribute('data-target')) || null;
      if (first) { show(first.getAttribute('data-target')); }
    } catch(err) {
      console.error('Tab wiring error:', err);
    }
  })();
</script>

<script>
  // --- Service Worker (inline via Blob to keep monolith single-file) ---
  (function(){
    if ('serviceWorker' in navigator) {
      try {
        const swCode = `self.addEventListener('install', e => { self.skipWaiting(); });
self.addEventListener('activate', e => { self.clients.claim(); });
self.addEventListener('fetch', e => {
  const req = e.request;
  e.respondWith((async () => {
    try { return await fetch(req); } catch (err) { return new Response('<h1>Offline</h1>', { headers: {'Content-Type':'text/html'} }); }
  })());
});`;
        const blob = new Blob([swCode], {type: 'text/javascript'});
        const url = URL.createObjectURL(blob);
        navigator.serviceWorker.register(url).catch(console.warn);
      } catch (e) { console.warn('SW register failed', e); }
    }
  })();
</script>
<script>
  // Tab wiring (no DOM changes required)
  (function () {
    const tabs = document.querySelectorAll('.nav-tab');
    const sections = document.querySelectorAll('.section');

    function show(id) {
      sections.forEach(s => s.classList.toggle('active', s.id === id));
      tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-target') === id));
      // Persist selected tab
      localStorage.setItem('ss.activeTab', id);
    }

    tabs.forEach(t => {
      t.addEventListener('click', (e) => {
        e.preventDefault();
        const id = t.getAttribute('data-target');
        if (id) show(id);
      });
    });

    // Initial mount
    const first = localStorage.getItem('ss.activeTab') || (tabs[0] && tabs[0].getAttribute('data-target')) || (sections[0] && sections[0].id);
    if (first) show(first);
  })();
</script>
<script>
  // Simple MeSH chip renderer (safe, no HTML injection)
  (function () {
    const safeText = (s='') => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const chipClasses = ['tag-color-1','tag-color-2','tag-color-3','tag-color-4','tag-color-5','tag-color-6','tag-color-7','tag-color-8'];

    function render(container, meshArr = []) {
      container.innerHTML = '';
      meshArr.slice(0, 8).forEach((term, i) => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = `tag tag-colorable ${chipClasses[i % chipClasses.length]}`;
        chip.setAttribute('aria-pressed', 'false');
        chip.textContent = safeText(term);
        chip.addEventListener('click', () => {
          const on = chip.getAttribute('aria-pressed') === 'true';
          chip.setAttribute('aria-pressed', String(!on));
          chip.classList.toggle('selected', !on);
          container.dispatchEvent(new CustomEvent('meshToggle', {detail:{term, selected:!on}}));
        });
        container.appendChild(chip);
      });
    }

    document.querySelectorAll('[data-mesh-chips]').forEach(el => {
      try {
        const arr = JSON.parse(el.getAttribute('data-mesh') || '[]');
        render(el, Array.isArray(arr) ? arr : []);
      } catch { render(el, []); }
    });
  })();
</script>
<script>
  // SW registration (no external files; inline blob)
  if ('serviceWorker' in navigator) {
    const swCode = `
self.addEventListener('install', e => {
  self.skipWaiting();
  e.waitUntil(caches.open('ss-v2').then(c => c.addAll(['./'])).catch(()=>{}));
});
self.addEventListener('activate', e => self.clients.claim());
self.addEventListener('fetch', e => {
  const req = e.request;
  e.respondWith(
    caches.match(req).then(hit => hit || fetch(req).then(r => {
      const copy = r.clone();
      caches.open('ss-v2').then(c => c.put(req, copy)).catch(()=>{});
      return r;
    }).catch(()=>hit))
  );
});`;
    const blob = new Blob([swCode], {type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url).catch(()=>{});
  }
</script>



<!-- HOTPATCH: v2.0 P0 fixes — 2025-08-12 -->
<script id="ss-hotpatch-2025-08-12">
(() => {
  'use strict';
  const RX = { PMID:/^\d{6,9}$/, DOI:/^10\.\d{4,9}\/\S+$/, NCT:/^NCT\d{8}$/i };
  window.SS = window.SS || {};
  SS.escape = (s) => (s == null ? '' : String(s)).replace(/[<>&"']/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;','\'':'&#39;'}[m]));
  SS.isPMID = (s) => RX.PMID.test(String(s||'').trim());
  SS.isDOI  = (s) => RX.DOI.test(String(s||'').trim().replace(/^(https?:\/\/)?(dx\.)?doi\.org\//i, ''));
  SS.isNCT  = (s) => RX.NCT.test(String(s||'').trim());
  SS.normDOI = (s) => String(s||'').trim().replace(/^(https?:\/\/)?(dx\.)?doi\.org\//i, '');
  document.addEventListener('DOMContentLoaded', () => {
    const th = document.querySelectorAll('#requests-table thead th');
    const need = ['Urgency','Docline Number','PMID','Citation','Patron Name','Status'];
    if (th && th.length >= 6) { for (let i=0;i<6;i++){ if (th[i]) th[i].textContent = need[i]; } }
  });
  if (typeof window.parseBulkInput === 'function') {
    const oldParse = window.parseBulkInput;
    window.parseBulkInput = function(text){
      const t = String(text||'');
      const tokens = t.split(/[\s,;\n\r]+/).filter(Boolean);
      const out = []; const seen = new Set();
      for (let raw of tokens) {
        let norm = raw.trim();
        norm = SS.normDOI(norm);
        const type = SS.isPMID(norm) ? 'PMID' : SS.isNCT(norm) ? 'NCT' : SS.isDOI(norm) ? 'DOI' : '';
        if (!type) continue;
        const key = (type === 'DOI' ? norm.toLowerCase() : norm.toUpperCase());
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(norm);
      }
      return out;
    };
  }
  SS.formatNLM = (rec={}) => {
    const authors = (rec.authors||'').replace(/\s*;\s*/g, ', ');
    const title = rec.title || '';
    const journal = rec.journal || '';
    const year = rec.year || '';
    const vol = rec.volume || '';
    const issue = rec.issue ? `(${rec.issue})` : '';
    const pages = rec.pages ? `:${rec.pages}` : '';
    const doi = rec.doi ? ` doi:${rec.doi}` : '';
    const pmid = rec.pmid ? ` PMID:${rec.pmid}` : '';
    const parts = [];
    if (authors) parts.push(`${authors}.`);
    if (title) parts.push(`${title}.`);
    if (journal || year || vol) parts.push(`${journal}. ${year};${vol}${issue}${pages}.`);
    const tail = (doi || pmid).trim();
    if (tail) parts.push(tail);
    return parts.join(' ').replace(/\s+/g,' ').trim();
  };
  window.exportNLM = function(records){
    try {
      const recs = Array.isArray(records) ? records : (window.requests || []);
      const txt = recs.map(r => SS.formatNLM(r)).join('\n');
      const blob = new Blob([txt], {type: 'text/plain;charset=utf-8'});
      const a = document.createElement('a'); a.download = 'citations_nlm.txt'; a.href = URL.createObjectURL(blob);
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 250);
    } catch(e){ console.warn('exportNLM failed', e); }
  };
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const politeFetch = async (url, opts={}, minDelay=350) => { const t0 = Date.now(); const res = await fetch(url, opts); const dt = Date.now()-t0; if (dt < minDelay) await sleep(minDelay-dt); return res; };
  window.fetchPubMedRecord = async function(pmid, apiKey=''){
    if (!SS.isPMID(pmid)) throw new Error('Invalid PMID');
    const key = apiKey ? `&api_key=${encodeURIComponent(apiKey)}` : '';
    const sumURL = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${encodeURIComponent(pmid)}&retmode=json${key}`;
    const sumRes = await politeFetch(sumURL, {headers:{'Accept':'application/json'}}, 500);
    if (!sumRes.ok) throw new Error('ESummary failed ' + sumRes.status);
    const sum = await sumRes.json();
    const rec = (sum.result && sum.result[pmid]) || {};
    const efURL = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${encodeURIComponent(pmid)}&retmode=xml${key}`;
    const efRes = await politeFetch(efURL, {headers:{'Accept':'application/xml'}}, 600);
    if (!efRes.ok) throw new Error('EFetch failed ' + efRes.status);
    const xml = await efRes.text();
    const doc = new DOMParser().parseFromString(xml, 'application/xml');
    const getText = (sel) => { const el = doc.querySelector(sel); return el ? (el.textContent||'').trim() : ''; };
    let doi = '';
    const doiNode = doc.querySelector('ArticleIdList > ArticleId[IdType="doi"]') || doc.querySelector('ELocationID[EIdType="doi"]');
    if (doiNode) doi = doiNode.textContent.trim();
    if (!doi) {
      const nodes = doc.querySelectorAll('ArticleIdList > ArticleId');
      for (const n of nodes) { const t = (n.textContent||'').trim(); if (t.startsWith('10.')) { doi = t; break; } }
    }
    const mesh = [];
    doc.querySelectorAll('MeshHeadingList > MeshHeading > DescriptorName').forEach((n)=>{ if (mesh.length<8) mesh.push((n.textContent||'').trim()); });
    const fullText = (getText('Abstract') + ' ' + getText('ArticleTitle')).toUpperCase();
    const nctMatch = fullText.match(/NCT\d{8}/);
    const nct = nctMatch ? nctMatch[0] : '';
    return {
      pmid: String(pmid),
      title: rec.title || getText('ArticleTitle') || '',
      authors: Array.isArray(rec.authors) ? rec.authors.map(a=>a.name).join('; ') : '',
      journal: rec.fulljournalname || rec.source || getText('ISOAbbreviation') || '',
      year: (rec.pubdate || '').split(' ')[0] || getText('PubDate > Year') || '',
      doi, mesh, nct
    };
  };
  window.fetchCrossRefRecord = async function(doi, mailto=''){
    doi = SS.normDOI(doi);
    if (!SS.isDOI(doi)) throw new Error('Invalid DOI');
    const headers = {'Accept':'application/json'};
    const url = `https://api.crossref.org/works/${encodeURIComponent(doi)}${mailto ? `?mailto=${encodeURIComponent(mailto)}`:''}`;
    const res = await politeFetch(url, {headers}, 400);
    if (!res.ok) throw new Error('CrossRef failed ' + res.status);
    const json = await res.json(); const m = json.message || {};
    const authors = Array.isArray(m.author) ? m.author.map(a => [a.family, a.given].filter(Boolean).join(' ')).join('; ') : '';
    const year = (m['published-print']?.['date-parts']?.[0]?.[0]) || (m['issued']?.['date-parts']?.[0]?.[0]) || '';
    let pmid = '';
    try {
      const esURL = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmode=json&term=${encodeURIComponent(doi)}[DOI]`;
      const esRes = await politeFetch(esURL, {headers:{'Accept':'application/json'}}, 500);
      if (esRes.ok) { const es = await esRes.json(); pmid = (es.esearchresult && es.esearchresult.idlist && es.esearchresult.idlist[0]) || ''; }
    } catch {}
    return {
      doi, title: (Array.isArray(m.title) ? m.title[0] : m.title) || '',
      journal: (Array.isArray(m['container-title']) ? m['container-title'][0] : m['container-title']) || '',
      authors, year: String(year||''), pmid
    };
  };
  function fillField(id, val){ const el = document.getElementById(id); if (el) el.value = val || ''; }
  function appendNote(line){ const notes = document.getElementById('notes'); if (notes) { const v = String(notes.value||''); notes.value = (v ? v + '\n' : '') + line; } }
  document.addEventListener('DOMContentLoaded', () => {
    const s = JSON.parse(localStorage.getItem('settings') || '{}'); const apiKey = s.apiKey || ''; const mailto = s.crossrefEmail || '';
    const pmidBtn = document.getElementById('lookup-pmid');
    if (pmidBtn) pmidBtn.addEventListener('click', async () => {
      const pmid = (document.getElementById('pmid')||{}).value || ''; const statusEl = document.getElementById('pmid-status');
      if (!SS.isPMID(pmid)) { if (statusEl) statusEl.textContent = 'Invalid PMID'; return; }
      if (statusEl) statusEl.textContent = 'Looking up PubMed…';
      try {
        const meta = await window.fetchPubMedRecord(pmid, apiKey);
        fillField('title', meta.title); fillField('authors', meta.authors); fillField('journal', meta.journal); fillField('year', meta.year);
        if (meta.doi) fillField('doi', meta.doi);
        if (Array.isArray(meta.mesh) && meta.mesh.length) appendNote('[MeSH] ' + meta.mesh.join('; '));
        if (meta.nct) { try { const {ct} = await window.fetchCtGovRecord(meta.nct); appendNote(`[NCT] ${meta.nct}${ct?.title ? ' — ' + ct.title : ''}`); } catch {} }
        if (statusEl) statusEl.textContent = '✓ PubMed populated';
      } catch(e){ if (statusEl) statusEl.textContent = 'Lookup failed: ' + e.message; }
    });
    const doiBtn = document.getElementById('lookup-doi');
    if (doiBtn) doiBtn.addEventListener('click', async () => {
      let doi = (document.getElementById('doi')||{}).value || ''; doi = SS.normDOI(doi);
      const statusEl = document.getElementById('doi-status');
      if (!SS.isDOI(doi)) { if (statusEl) statusEl.textContent = 'Invalid DOI'; return; }
      if (statusEl) statusEl.textContent = 'Looking up CrossRef…';
      try {
        const meta = await window.fetchCrossRefRecord(doi, mailto);
        if (meta.title) fillField('title', meta.title); if (meta.authors) fillField('authors', meta.authors);
        if (meta.journal) fillField('journal', meta.journal); if (meta.year) fillField('year', meta.year);
        if (meta.pmid) fillField('pmid', meta.pmid);
        if (statusEl) statusEl.textContent = '✓ CrossRef populated' + (meta.pmid ? ' (+PMID)' : '');
      } catch(e){ if (statusEl) statusEl.textContent = 'Lookup failed: ' + e.message; }
    });
    const delBtn = document.getElementById('delete-selected-btn');
    if (delBtn) delBtn.addEventListener('click', () => {
      if (typeof window.bulkDeleteSelected === 'function') window.bulkDeleteSelected();
      else if (typeof window.deleteSelectedRequests === 'function') window.deleteSelectedRequests();
    });
  });
})();
</script>


<!-- SilentStacks v2 bundle augment (2025-08-13C) -->
<script id="ss-v2-bundle-2025-08-13C">
(() => {
  const RX = { PMID:/^\d{6,9}$/, NCT:/^NCT\d{8}$/i };
  const q = (id)=>document.getElementById(id);
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const setText=(id,v)=>{ const el=q(id); if (el) el.textContent=(v&&String(v).trim())||'—'; };
  const setVal=(id,v)=>{ const el=q(id); if (el) el.value=(v||''); };

  window.SS = window.SS || {};
  SS.__state = SS.__state || { lastCtReqId:0, lastPmReqId:0, lastNctHandled:'', enrichedPmids:new Set(), tableScanTimer:0 };

  // ---------- Helpers ----------
  async function json(url){ try{ const r=await fetch(url,{headers:{'Accept':'application/json'}}); if(!r.ok) return null; return await r.json(); }catch{ return null; } }
  async function text(url){ try{ const r=await fetch(url); if(!r.ok) return null; return await r.text(); }catch{ return null; } }
  function first(...vals){ for(const v of vals){ if(v==null) continue; if(Array.isArray(v)){ if(v.length&&String(v[0]).trim()) return v[0]; } else if(String(v).trim()) return v; } return ''; }
  function makeChip(label, cls){
    const s=document.createElement('span'); s.className='chip '+(cls||''); s.tabIndex=0; s.role='button'; s.textContent=label;
    s.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); s.click(); }});
    return s;
  }

  // ---------- PubMed client (robust DOI + MeSH + NCT) ----------
  window.fetchPubMedRecord = async function(pmid, apiKey=''){
    const id = String(pmid||'').trim();
    if (!RX.PMID.test(id)) throw new Error('Invalid PMID');
    const key = apiKey ? `&api_key=${encodeURIComponent(apiKey)}` : '';
    const sumUrl = `https://eutils.ncbi.nlm.nih.gov/eutils/esummary.fcgi?db=pubmed&id=${id}&retmode=json${key}`;
    const xmlUrl = `https://eutils.ncbi.nlm.nih.gov/eutils/efetch.fcgi?db=pubmed&id=${id}&retmode=xml${key}`;
    const js  = await json(sumUrl);
    const x   = await text(xmlUrl);
    const doc = x ? new DOMParser().parseFromString(x,'application/xml') : null;
    // DOI
    let doi = '';
    if (doc){
      let node = doc.querySelector('ArticleIdList > ArticleId[IdType="doi"]') || doc.querySelector('ELocationID[EIdType="doi"]');
      if (node) doi = (node.textContent||'').trim();
      if (!doi){
        const nodes = doc.querySelectorAll('ArticleIdList > ArticleId');
        for (const n of nodes){ const t=(n.textContent||'').trim(); if (t.startsWith('10.')){ doi=t; break; } }
      }
    }
    if (!doi){
      try{
        const rec = js?.result?.[id];
        if (rec?.elocationid && rec.elocationid.startsWith('doi:')) doi = rec.elocationid.replace(/^doi:\s*/i,'');
      }catch{}
    }
    // MeSH (≤8)
    const mesh = [];
    if (doc){
      doc.querySelectorAll('MeshHeadingList > MeshHeading > DescriptorName').forEach(n=>{ if (mesh.length<8) mesh.push((n.textContent||'').trim()); });
    }
    // NCT
    function nctFromXML(d){
      const buck=[];
      try{
        d.querySelectorAll('DataBankList DataBank, SecondarySourceID, OtherID, CommentsCorrections RefSource, Abstract, ArticleTitle')
          .forEach(n => buck.push(n.textContent||''));
      }catch{}
      const m = buck.join(' ').toUpperCase().match(/NCT\d{8}/);
      return m?m[0]:'';
    }
    let nct = doc ? nctFromXML(doc) : '';
    if (!nct){
      const link = await text(`https://eutils.ncbi.nlm.nih.gov/eutils/elink.fcgi?dbfrom=pubmed&db=clinicaltrials&id=${id}${key}`);
      if (link){ const m = link.toUpperCase().match(/NCT\d{8}/); nct = m?m[0]:''; }
    }
    // Bibliographic
    const title = doc ? (doc.querySelector('ArticleTitle')?.textContent||'').trim() : (js?.result?.[id]?.title||'');
    const journal = doc ? ((doc.querySelector('Journal > Title')||doc.querySelector('ISOAbbreviation'))?.textContent||'').trim() : (js?.result?.[id]?.fulljournalname||'');
    const year = doc ? (doc.querySelector('JournalIssue > PubDate > Year')?.textContent || (doc.querySelector('PubDate')?.textContent||'').split(' ')[0]) : (js?.result?.[id]?.pubdate||'').slice(0,4);
    return { pmid:id, doi, mesh, nct, title, journal, year };
  };

  // ---------- CT.gov unified client ----------
  function normV2(st){
    const ps = st?.protocolSection||{};
    const idm= ps.identificationModule||{};
    const des= ps.designModule||{};
    const sta= ps.statusModule||{};
    const spo= ps.sponsorCollaboratorsModule||{};
    const refs= ps.referencesModule?.references||[];
    const refsRes= st?.resultsSection?.referencesModule?.references||[];
    const pmids=[...refs,...refsRes].map(r=>r?.pmid).filter(Boolean).map(String);
    return {
      nctId: idm.nctId||'',
      title: idm.officialTitle||idm.briefTitle||'',
      phase: first(des.phases&&des.phases[0], des.phases),
      overallStatus: sta.overallStatus||'',
      sponsorType: spo?.leadSponsor?.agencyClass||spo?.leadSponsor?.class||'',
      sponsorName: spo?.leadSponsor?.name||'',
      pmids: Array.from(new Set(pmids))
    };
  }
  function normV1(st){
    const p = st?.ProtocolSection||{};
    const idm=p.IdentificationModule||{};
    const des=p.DesignModule||{};
    const sta=p.StatusModule||{};
    const spo=p.Sponsors||{};
    const v1refs = p?.ReferencesModule?.ReferenceList?.Reference || [];
    const v1res  = st?.ResultsReferenceList?.Reference || [];
    const pmids=[...v1refs,...v1res].map(r=>r?.PMID).filter(Boolean).map(String);
    return {
      nctId: idm.NCTId||'',
      title: idm.OfficialTitle||idm.BriefTitle||'',
      phase: first(des.Phase, des.Phases&&des.Phases[0], des.PhaseList&&des.PhaseList.Phase),
      overallStatus: sta.OverallStatus||'',
      sponsorType: spo?.LeadSponsor?.AgencyClass||spo?.LeadSponsor?.LeadSponsorClass||'',
      sponsorName: spo?.LeadSponsor?.LeadSponsorName||'',
      pmids: Array.from(new Set(pmids))
    };
  }
  async function fetchCtGovUnified(nctOrTerm){
    const term=String(nctOrTerm||'').trim();
    // v2 id
    if (RX.NCT.test(term)){
      const v2 = await json(`https://clinicaltrials.gov/api/v2/studies/${encodeURIComponent(term)}`);
      if (v2?.study) return normV2(v2.study);
    }
    // v2 search
    const v2s = await json(`https://clinicaltrials.gov/api/v2/studies?query.term=${encodeURIComponent(term)}`);
    if (v2s?.studies?.length) return normV2(v2s.studies[0]);
    // v1 full_studies
    const v1 = await json(`https://clinicaltrials.gov/api/query/full_studies?expr=${encodeURIComponent(term)}&min_rnk=1&max_rnk=1&fmt=json`);
    const st1 = v1?.FullStudiesResponse?.FullStudies?.[0]?.Study;
    if (st1) return normV1(st1);
    // v1 fields
    const f = await json(`https://clinicaltrials.gov/api/query/study_fields?expr=${encodeURIComponent(term)}&min_rnk=1&max_rnk=1&fields=NCTId,OfficialTitle,Phase,OverallStatus,LeadSponsorClass&fmt=json`);
    const row = f?.StudyFieldsResponse?.StudyFields?.[0];
    if (row) return { nctId:first(row.NCTId), title:first(row.OfficialTitle), phase:first(row.Phase), overallStatus:first(row.OverallStatus), sponsorType:first(row.LeadSponsorClass), sponsorName:'', pmids:[] };
    return null;
  }
  window.fetchCtGovRecord = async function(nctOrTerm){
    const rid = ++SS.__state.lastCtReqId;
    const ct = await fetchCtGovUnified(nctOrTerm);
    if (rid !== SS.__state.lastCtReqId) return { ct:null, stale:true };
    return { ct };
  };

  // ---------- Rendering & chips ----------
  function tagsFromMeta(meta){
    const mesh = (meta?.mesh||[]).slice(0,8);
    const phase = meta?.trial?.phase || meta?.phase;
    const status= meta?.trial?.overallStatus || meta?.overallStatus;
    const sponsor= meta?.trial?.sponsorType || meta?.sponsorType;
    const ct=[]; if (phase) ct.push('Phase:'+phase); if (status) ct.push('Status:'+status); if (sponsor) ct.push('Sponsor:'+sponsor);
    return { mesh, ct };
  }
  SS.pushTagsToUI = function(meta){
    const { mesh, ct } = tagsFromMeta(meta||{});
    const preview = q('gl-chips');
    if (preview){
      preview.querySelectorAll('.chip.mesh, .chip.phase, .chip.status, .chip.sponsor').forEach(n=>n.remove());
      mesh.forEach(m => preview.appendChild(makeChip(m,'mesh')));
      ct.forEach(t => preview.appendChild(makeChip(t, t.startsWith('Phase:')?'phase':t.startsWith('Status:')?'status':'sponsor')));
    }
    const tagsHost = q('tags') || document.querySelector('.request-tags');
    if (tagsHost){
      tagsHost.querySelectorAll('.chip.mesh, .chip.phase, .chip.status, .chip.sponsor').forEach(n=>n.remove());
      mesh.forEach(m => tagsHost.appendChild(makeChip(m,'mesh')));
      ct.forEach(t => tagsHost.appendChild(makeChip(t, t.startsWith('Phase:')?'phase':t.startsWith('Status:')?'status':'sponsor')));
    }
  };
  const prevFill = SS.fillGlance;
  SS.fillGlance = function(meta){
    if (prevFill) try{ prevFill(meta); }catch{}
    try{
      setText('gl-pmid', meta?.pmid);
      setText('gl-doi', meta?.doi);
      setText('gl-title', meta?.title);
      setText('gl-journal', meta?.journal);
      setText('gl-year', meta?.year);
      setText('gl-nct', meta?.trial?.nctId || meta?.nct);
      setText('gl-nct-title', meta?.trial?.title);
      setText('gl-phase', meta?.trial?.phase);
      setText('gl-ct-status', meta?.trial?.overallStatus);
      setText('gl-sponsor', meta?.trial?.sponsorType);
    }catch{}
    SS.pushTagsToUI(meta||{});
    try{ SS.captureEnrichment && SS.captureEnrichment(meta||{}); }catch{}
  };

  // PMID chips from CT.gov
  SS.renderCtPmids = function(pmids){
    const host = q('gl-chips'); const tags = q('tags') || document.querySelector('.request-tags');
    const add = (h)=>{
      Array.from(h.querySelectorAll('.chip.pmid')).forEach(n=>n.remove());
      (pmids||[]).forEach(p => {
        const c = makeChip('PMID:'+p,'pmid');
        c.addEventListener('click', ()=>{ const f=q('pmid'); const b=q('lookup-pmid'); if (f){ if(f.value===p) return; f.value=p; if (b) b.click(); } });
        h.appendChild(c);
      });
    };
    if (host) add(host);
    if (tags) add(tags);
  };

  // ---------- Persistence stores ----------
  function getStore(key){ try{ return JSON.parse(localStorage.getItem(key)||'{}'); }catch{ return {}; } }
  function setStore(key,obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch{} }
  const KEY_TRIAL='ss_trial_enrichment', KEY_MESH='ss_mesh_enrichment';
  SS.captureEnrichment = function(meta){
    const pmid = (meta?.pmid || (q('pmid')?.value||'')).trim();
    if (!RX.PMID.test(pmid)) return;
    if (Array.isArray(meta.mesh) && meta.mesh.length){
      const m = getStore(KEY_MESH); m[pmid] = { mesh: meta.mesh.slice(0,8), updatedAt: new Date().toISOString() }; setStore(KEY_MESH, m);
    }
    const t = meta.trial;
    const nct = meta.nct || t?.nctId;
    if (t || RX.NCT.test(String(nct||''))){
      const s = getStore(KEY_TRIAL);
      s[pmid] = {
        nct: t?.nctId || nct, title: t?.title||'', phase: t?.phase||'',
        overallStatus: t?.overallStatus||'', sponsorType: t?.sponsorType||'',
        sponsorName: t?.sponsorName||'', pmids: Array.from(new Set((t?.pmids||[]).map(String))),
        updatedAt: new Date().toISOString()
      };
      setStore(KEY_TRIAL, s);
    }
  };

  // Save hook to merge persistence into stored records (best-effort)
  function attachSaveHook(){
    const btn = q('btn-save') || Array.from(document.querySelectorAll('button')).find(b=>/save/i.test(b.textContent||''));
    if (!btn || btn.dataset.ssBound) return;
    btn.dataset.ssBound='1';
    btn.addEventListener('click', ()=>{
      try{
        const pmid = (q('pmid')?.value||'').trim();
        if (!RX.PMID.test(pmid)) return;
        const m = getStore(KEY_MESH)[pmid]; const t = getStore(KEY_TRIAL)[pmid];
        for (let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i)||''; let changed=false;
          try{
            const raw = localStorage.getItem(k); if (!raw) continue;
            const obj = JSON.parse(raw);
            if (Array.isArray(obj)){
              obj.forEach(rec => {
                const rid = (rec?.identifiers?.pmid || rec?.pmid || '').trim();
                if (rid === pmid){
                  if (m?.mesh) rec.mesh = m.mesh.slice(0,8);
                  if (t){
                    rec.identifiers = rec.identifiers || {}; rec.identifiers.nct = t.nct || rec.identifiers.nct || '';
                    rec.trial = rec.trial || {};
                    rec.trial.phase = t.phase || rec.trial.phase || '';
                    rec.trial.overallStatus = t.overallStatus || rec.trial.overallStatus || '';
                    rec.trial.sponsorType = t.sponsorType || rec.trial.sponsorType || '';
                    rec.sources = rec.sources || {}; rec.sources.clinicaltrials = rec.sources.clinicaltrials || {};
                    if (t.pmids?.length) rec.sources.clinicaltrials.pmids = t.pmids;
                  }
                  rec.updatedAt = new Date().toISOString(); changed=true;
                }
              });
              if (changed) localStorage.setItem(k, JSON.stringify(obj));
            }
          }catch{}
        }
      }catch(e){ console.warn('save hook merge failed', e); }
    });
  }

  // Export wrapper: merge persistence before exporting
  function wrapExporters(){
    ['exportJSON','exportCSV','exportNLM'].forEach(name=>{
      const fn = window[name];
      if (typeof fn !== 'function' || fn.__wrapped) return;
      window[name] = function(...args){
        try{
          const data = args[0];
          if (Array.isArray(data)){
            const M = getStore(KEY_MESH); const T = getStore(KEY_TRIAL);
            data.forEach(rec => {
              const pmid = (rec?.identifiers?.pmid || rec?.pmid || '').trim();
              if (!RX.PMID.test(pmid)) return;
              if (M[pmid]?.mesh) rec.mesh = M[pmid].mesh.slice(0,8);
              const t = T[pmid];
              if (t){
                rec.identifiers = rec.identifiers || {}; rec.identifiers.nct = t.nct || rec.identifiers.nct || '';
                rec.trial = rec.trial || {};
                rec.trial.phase = t.phase || rec.trial.phase || '';
                rec.trial.overallStatus = t.overallStatus || rec.trial.overallStatus || '';
                rec.trial.sponsorType = t.sponsorType || rec.trial.sponsorType || '';
                rec.sources = rec.sources || {}; rec.sources.clinicaltrials = rec.sources.clinicaltrials || {};
                if (t.pmids?.length) rec.sources.clinicaltrials.pmids = t.pmids;
              }
            });
          }
        }catch{}
        return fn.apply(this, args);
      };
      window[name].__wrapped = true;
    });
  }

  // ---------- Pipeline orchestration ----------
  async function runPubMed(pmid){
    const settings = JSON.parse(localStorage.getItem('settings')||'{}');
    const meta = await window.fetchPubMedRecord(pmid, settings.apiKey||'');
    SS.fillGlance(meta||{pmid});
    // If NCT present, chase CT.gov
    if (meta?.nct && RX.NCT.test(meta.nct)){
      setVal('nct', meta.nct);
      const { ct } = await window.fetchCtGovRecord(meta.nct);
      if (ct){
        SS.fillGlance({ ...meta, nct: ct.nctId||meta.nct, trial: ct });
        SS.renderCtPmids(ct.pmids||[]);
      } else {
        SS.renderCtPmids([]);
      }
    }
  }

  function bindUI(){
    const pmBtn = q('lookup-pmid');
    if (pmBtn && !pmBtn.dataset.ssBound){
      pmBtn.dataset.ssBound='1';
      pmBtn.addEventListener('click', async () => {
        const pmid = (q('pmid')?.value||'').trim();
        if (!RX.PMID.test(pmid)) return;
        await runPubMed(pmid);
      });
    }
    const nctField = q('nct');
    if (nctField && !nctField.dataset.ssBound){
      nctField.dataset.ssBound='1';
      nctField.addEventListener('change', async () => {
        const v = (nctField.value||'').trim().toUpperCase();
        if (!RX.NCT.test(v)) return;
        const { ct } = await window.fetchCtGovRecord(v);
        if (ct){
          const seed = { pmid: (q('pmid')?.value||'').trim(), doi: (q('doi')?.value||'').trim(), title:(q('title')?.value||'').trim(), journal:(q('journal')?.value||'').trim(), year:(q('year')?.value||'').trim() };
          SS.fillGlance({ ...seed, nct: ct.nctId||v, trial: ct });
          SS.renderCtPmids(ct.pmids||[]);
        }
      });
      setTimeout(()=>{ const v=(nctField.value||'').trim().toUpperCase(); if (RX.NCT.test(v)) nctField.dispatchEvent(new Event('change',{bubbles:true})); }, 600);
    }
    attachSaveHook();
    wrapExporters();
  }

  // ---------- Table enrichment for bulk paste/upload ----------
  async function enrichRow(tr){
    const pmid = (tr.cells[2]?.innerText || '').trim();
    if (!RX.PMID.test(pmid)) return;
    if (SS.__state.enrichedPmids.has(pmid)) return;
    SS.__state.enrichedPmids.add(pmid);
    // Merge any persisted first
    const M = getStore(KEY_MESH)[pmid]; const T = getStore(KEY_TRIAL)[pmid];
    const citCell = tr.cells[3]; let host = citCell?.querySelector('.table-chips');
    if (citCell){ if (!host){ host=document.createElement('div'); host.className='table-chips'; citCell.appendChild(host); } host.querySelectorAll('.chip.mesh, .chip.phase, .chip.status, .chip.sponsor').forEach(n=>n.remove()); }
    if (host){
      (M?.mesh||[]).slice(0,8).forEach(x=> host.appendChild(makeChip(x,'mesh')));
      if (T){
        if (T.phase) host.appendChild(makeChip('Phase:'+T.phase, 'phase'));
        if (T.overallStatus) host.appendChild(makeChip('Status:'+T.overallStatus, 'status'));
        if (T.sponsorType) host.appendChild(makeChip('Sponsor:'+T.sponsorType, 'sponsor'));
      }
    }
    // Then live-enrich via PubMed/CT
    try{
      const meta = await window.fetchPubMedRecord(pmid, (JSON.parse(localStorage.getItem('settings')||'{}').apiKey||''));
      let merged = meta;
      if (merged?.nct && RX.NCT.test(merged.nct)){
        const { ct } = await window.fetchCtGovRecord(merged.nct);
        if (ct) merged = { ...merged, trial: ct };
      }
      if (host){
        const { mesh, ct } = (function(meta){ const m=(meta?.mesh||[]).slice(0,8); const c=[]; const ph=meta?.trial?.phase||meta?.phase; const st=meta?.trial?.overallStatus||meta?.overallStatus; const sp=meta?.trial?.sponsorType||meta?.sponsorType; if(ph) c.push('Phase:'+ph); if(st) c.push('Status:'+st); if(sp) c.push('Sponsor:'+sp); return { mesh:m, ct:c }; })(merged);
        host.querySelectorAll('.chip.mesh, .chip.phase, .chip.status, .chip.sponsor').forEach(n=>n.remove());
        mesh.forEach(x=> host.appendChild(makeChip(x,'mesh')));
        ct.forEach(t=> host.appendChild(makeChip(t, t.startsWith('Phase:')?'phase':t.startsWith('Status:')?'status':'sponsor')));
      }
      SS.captureEnrichment(merged);
    }catch{}
    await sleep(520);
  }
  async function enrichVisibleTable(){
    const tables = document.querySelectorAll('table');
    let tbl=null; for(const t of tables){ const h=Array.from(t.querySelectorAll('thead th')).map(th=>th.textContent.trim()); const want=['Urgency','Docline Number','PMID','Citation','Patron Name','Status']; if (want.every((x,i)=>h[i]&&h[i].startsWith(x))){ tbl=t; break; } }
    if (!tbl || !tbl.tBodies[0]) return;
    for (const tr of Array.from(tbl.tBodies[0].rows)) await enrichRow(tr);
  }
  window.enrichVisibleTable = enrichVisibleTable;

  function scheduleScan(){ if (SS.__state.tableScanTimer) clearTimeout(SS.__state.tableScanTimer); SS.__state.tableScanTimer = setTimeout(enrichVisibleTable, 600); }

  document.addEventListener('DOMContentLoaded', () => {
    bindUI();
    scheduleScan();
    document.addEventListener('change', e => {
      const t=e.target;
      if (t && (t.type==='file' || /csv|json/i.test(t.accept||''))) scheduleScan();
      if (t && t.id && /bulk|upload|import/i.test(t.id)) scheduleScan();
    }, true);
    document.addEventListener('paste', e => {
      const t=e.target; if (t && t.tagName==='TEXTAREA' && /bulk|paste|import/i.test(t.id||'')) setTimeout(scheduleScan, 800);
    }, true);
  });
})();
</script>

</body>
</html>
