<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SilentStacks ‚Äî Add Request (v2 fixed)</title>
  <meta name="color-scheme" content="light dark">
  <style>
    @font-face {
      font-family: "Reddit Sans";
      src: url("fonts/RedditSans[wght].woff2") format("woff2");
      font-weight: 100 900;
      font-display: swap;
    }
    :root {
      --brand: oklch(60% 0.2 262);
      --accent: oklch(70% 0.16 200);
      --bg: oklch(98% 0 0);
      --bg-elev: oklch(98% 0 0 / 0.9);
      --panel: oklch(99% 0 0);
      --text: oklch(15% 0.01 270);
      --muted: oklch(45% 0.02 270);
      --border: oklch(88% 0.01 270);
      --focus: color-mix(in oklab, var(--brand) 60%, white 40%);
      --ok: oklch(65% 0.18 150);
      --warn: oklch(75% 0.16 80);
      --err: oklch(65% 0.16 25);
      --chip-blue: oklch(90% 0.06 240);
      --chip-amber: oklch(92% 0.08 80);
      --chip-stone: oklch(92% 0.03 270);
      --r-sm: 10px; --r-md: 14px; --r-lg: 20px;
      --space-1: .375rem; --space-2: .625rem; --space-3: 1rem; --space-4: 1.5rem; --space-5: 2rem;
      --shadow-1: 0 1px 2px rgba(0,0,0,.06), 0 2px 6px rgba(0,0,0,.04);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: oklch(14% 0.02 270);
        --bg-elev: oklch(18% 0.02 270 / .8);
        --panel: oklch(22% 0.02 270);
        --text: oklch(96% 0.02 270);
        --muted: oklch(80% 0.02 270);
        --border: oklch(35% 0.02 270);
        --chip-blue: oklch(30% 0.06 240);
        --chip-amber: oklch(35% 0.08 80);
        --chip-stone: oklch(30% 0.03 270);
      }
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: linear-gradient(120deg, var(--panel), var(--bg)) fixed; color: var(--text);
      font-family: "Reddit Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .app { display: grid; grid-template-columns: 280px 1fr 260px; gap: var(--space-4); min-height: 100vh; padding: var(--space-4); }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: var(--r-lg); box-shadow: var(--shadow-1); }
    .sidenav { position: sticky; top: var(--space-4); height: calc(100vh - var(--space-4)*2); padding: var(--space-4); display: flex; flex-direction: column; gap: var(--space-3); }
    .brand { font-weight: 800; font-size: 1.1rem; letter-spacing: .2px; display: flex; align-items: center; gap: .5rem; }
    .navlist { list-style: none; padding: 0; margin: var(--space-3) 0 0 0; display: grid; gap: .25rem; }
    .navlist a { display: grid; grid-template-columns: 1.4rem 1fr auto; align-items: center; gap: .6rem; padding: .55rem .7rem; border-radius: var(--r-sm); color: var(--text); text-decoration: none; border: 1px solid transparent; }
    .navlist a[aria-current="page"], .navlist a:hover { background: var(--bg-elev); border-color: var(--border); }
    .header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-3) var(--space-4); position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px); background: color-mix(in oklab, var(--panel) 92%, transparent); border-bottom: 1px solid var(--border); border-radius: var(--r-lg) var(--r-lg) 0 0; }
    .header h1 { font-size: 1.1rem; margin: 0; letter-spacing: .3px; }
    .header .tools { display: flex; align-items: center; gap: .5rem; }
    .main { overflow: auto; }
    .section { padding: var(--space-4); border-top: 1px dashed var(--border); }
    .section:first-of-type { border-top: 0; }
    .section h2 { font-size: .95rem; text-transform: uppercase; letter-spacing: .08em; margin: 0 0 .2rem 0; color: var(--muted); }
    .section h3 { margin: .2rem 0 var(--space-3) 0; font-size: 1.35rem; }
    .grid-2 { display: grid; gap: var(--space-3); grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { display: grid; gap: var(--space-3); grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 1100px) { .app { grid-template-columns: 78px 1fr; } .right { display:none; } .sidenav .label{ display:none;} }
    @media (max-width: 720px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    .field { display: grid; gap: .35rem; }
    label { font-size: .85rem; color: var(--muted); }
    input, textarea, select, button { font: inherit; color: var(--text); background: var(--bg); border: 1px solid var(--border); border-radius: var(--r-md); padding: .7rem .85rem; line-height: 1.35; }
    textarea { min-height: 120px; resize: vertical; }
    input:focus, textarea:focus, select:focus, button:focus { outline: 3px solid var(--focus); outline-offset: 1px; }
    .input-row { display: grid; grid-template-columns: 1fr auto; gap: .5rem; align-items: end; }
    .btn { background: var(--brand); color: white; border-color: color-mix(in oklab, var(--brand) 70%, black 30%); cursor: pointer; transition: transform .06s ease, filter .12s ease; }
    .btn:disabled { filter: grayscale(.5) opacity(.7); cursor: not-allowed; }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background: var(--bg); color: var(--text); }
    .btn.ghost { background: transparent; border-color: var(--border); color: var(--text); }
    .toolbar { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; }
    .chips { display:flex; flex-wrap: wrap; gap: .35rem; }
    .chip { padding: .35rem .6rem; border-radius: 999px; font-size: .8rem; border: 1px solid var(--border); }
    .tag-mesh { background: var(--chip-blue); }
    .tag-phase { background: var(--chip-amber); }
    .tag-sponsor { background: var(--chip-stone); }
    .right { position: sticky; top: var(--space-4); height: calc(100vh - var(--space-4)*2); padding: var(--space-4); }
    .toc h4 { margin: 0 0 .5rem 0; font-size: .9rem; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; }
    .toc a { display:block; padding:.4rem .5rem; border-radius: var(--r-sm); color: var(--text); text-decoration: none; border:1px solid transparent; }
    .toc a[aria-current="true"], .toc a:hover { background: var(--bg-elev); border-color: var(--border); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.8rem; border:1px solid var(--border); padding:.1rem .35rem; border-radius:.4rem; background: var(--bg); }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:.6rem .5rem; border-bottom:1px solid var(--border); vertical-align: top; }
    th { font-size:.8rem; text-transform: uppercase; letter-spacing:.06em; color: var(--muted); user-select:none; cursor: pointer; }
    .skip { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }
    .skip:focus { position: static; width:auto; height:auto; padding:.5rem; background: var(--bg); border: 2px dashed var(--brand); }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <a href="#main" class="skip">Skip to main content</a>
  <div class="app">
    <nav class="sidenav card" aria-label="Primary">
      <div class="brand" aria-label="SilentStacks">
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2l7 4v6c0 5-3.5 9-7 10c-3.5-1-7-5-7-10V6z"/></svg>
        <span class="label">SilentStacks</span>
      </div>
      <ul class="navlist">
        <li><a href="#" aria-current="page"><span>üìù</span><span class="label">Add Request</span><small></small></a></li>
        <li><a href="#requests"><span>üìö</span><span class="label">Requests</span><small id="req-count">0</small></a></li>
        <li><a href="#playbook"><span>üìí</span><span class="label">Playbook</span></a></li>
        <li><a href="#settings"><span>‚öôÔ∏è</span><span class="label">Settings</span></a></li>
      </ul>
      <div style="margin-top:auto; font-size:.85rem; color:var(--muted)">
        <div>Tip: <span class="kbd">/</span> focuses PMID</div>
      </div>
    </nav>

    <main id="main" class="card main" role="main" aria-labelledby="pageTitle">
      <header class="header">
        <h1 id="pageTitle">Add Request</h1>
        <div class="tools">
          <input id="table-filter" aria-label="Filter requests" placeholder="Filter requests" />
          <button class="btn ghost" id="theme-toggle" aria-pressed="false" aria-label="Toggle theme">Theme</button>
          <button class="btn secondary" id="save-entry">Save</button>
        </div>
      </header>

      <section id="sec-identifiers" class="section" aria-labelledby="sec-identifiers-h">
        <h2 id="sec-identifiers-h">Section</h2>
        <h3>Identifiers & Lookup</h3>
        <div class="grid-2">
          <div class="field">
            <label for="pmid">PubMed ID</label>
            <div class="input-row">
              <input id="pmid" autocomplete="off" inputmode="numeric" maxlength="9" placeholder="e.g., 18539917" />
              <button class="btn" id="lookup-pmid" type="button">Analyze &amp; Enrich</button>
            </div>
            <div id="pmid-status" class="status" role="status" aria-live="polite"></div>
          </div>
          <div class="field">
            <label for="doi">DOI</label>
            <div class="input-row">
              <input id="doi" placeholder="10.xxxx/xxxxx" />
              <button class="btn" id="lookup-doi" type="button">Lookup DOI</button>
            </div>
            <div id="doi-status" class="status" role="status" aria-live="polite"></div>
          </div>
        </div>
        <div class="grid-2">
          <div class="field">
            <label for="nct">ClinicalTrials.gov NCT</label>
            <div class="input-row">
              <input id="nct" placeholder="NCT00000000" maxlength="11" />
              <button class="btn" id="lookup-nct" type="button">Lookup NCT</button>
            </div>
            <div id="nct-status" class="status" role="status" aria-live="polite"></div>
          </div>
          <div class="field">
            <label for="docline">Docline Number</label>
            <input id="docline" placeholder="Auto or manual" />
          </div>
        </div>
      </section>

      <section id="sec-publication" class="section" aria-labelledby="sec-publication-h">
        <h2 id="sec-publication-h">Section</h2>
        <h3>Publication Details</h3>
        <div class="field">
          <label for="title">Title</label>
          <textarea id="title" placeholder="Article title"></textarea>
        </div>
        <div class="grid-3">
          <div class="field">
            <label for="authors">Authors</label>
            <input id="authors" placeholder="Last F; Last F; ..." />
          </div>
          <div class="field">
            <label for="journal">Journal</label>
            <input id="journal" placeholder="Journal name" />
          </div>
          <div class="field">
            <label for="year">Year</label>
            <input id="year" type="number" min="1900" max="2035" placeholder="YYYY" />
          </div>
        </div>
        <div class="grid-2">
          <div class="field">
            <label for="volume">Volume</label>
            <input id="volume" placeholder="e.g., 12" />
          </div>
          <div class="field">
            <label for="pages">Pages</label>
            <input id="pages" placeholder="e.g., 112‚Äì125" />
          </div>
        </div>
      </section>

      <section id="sec-trial" class="section" aria-labelledby="sec-trial-h">
        <h2 id="sec-trial-h">Section</h2>
        <h3>Clinical Trial (auto‚Äëpopulates)</h3>
        <div class="grid-3">
          <div class="field"><label for="gl-phase">Phase</label><input id="gl-phase" /></div>
          <div class="field"><label for="gl-ct-status">Status</label><input id="gl-ct-status" /></div>
          <div class="field"><label for="gl-sponsor">Sponsor</label><input id="gl-sponsor" /></div>
        </div>
        <div class="field"><label for="nct-title">Trial Title</label><input id="nct-title" /></div>
        <div class="chips" id="mesh-chips" aria-label="Suggested tags"></div>
      </section>

      <section id="sec-management" class="section" aria-labelledby="sec-management-h">
        <h2 id="sec-management-h">Section</h2>
        <h3>Management</h3>
        <div class="grid-3">
          <div class="field"><label for="status">Status</label>
            <select id="status"><option value="New">New</option><option>Pending</option><option>In Progress</option><option>Completed</option></select>
          </div>
          <div class="field"><label for="priority">Priority</label>
            <select id="priority"><option>Low</option><option selected>Normal</option><option>High</option><option>Urgent</option></select>
          </div>
          <div class="field"><label for="patron-email">Patron</label>
            <input type="email" id="patron-email" placeholder="researcher@example.org" />
          </div>
        </div>
        <div class="field"><label for="tags">Tags (comma‚Äëseparated)</label><input id="tags" placeholder="MeSH & custom terms" /></div>
        <div class="field"><label for="notes">Notes</label><textarea id="notes" placeholder="Additional context"></textarea></div>
      </section>

      <section id="sec-review" class="section" aria-labelledby="sec-review-h">
        <h2 id="sec-review-h">Section</h2>
        <h3>Review & Queue</h3>
        <div id="ss-live" class="status" role="status" aria-live="polite">Ready.</div>
        <div class="card" style="padding: var(--space-3); margin-top: var(--space-3);">
          <div class="toolbar" style="justify-content: space-between;">
            <strong>Requests</strong>
            <div class="toolbar">
              <button class="btn ghost" id="bulk-paste-btn" type="button">Process Paste</button>
              <input id="bulk-paste-data" placeholder="Paste PMIDs/DOIs/NCTs ‚Äî mixed ok" style="min-width: 220px;" />
              <label class="btn ghost" for="bulk-upload" id="bulk-upload-btn" role="button" aria-controls="bulk-upload">Upload</label>
              <input id="bulk-upload" type="file" accept=".csv,.json,.txt" class="sr-only" />
            </div>
          </div>
          <div style="overflow:auto; margin-top:.5rem;">
            <table id="requests-table" aria-label="Requests table">
              <thead><tr>
                <th data-key="urgency" aria-sort="none">Urgency</th>
                <th data-key="docline" aria-sort="none">Docline</th>
                <th data-key="pmid" aria-sort="none">PMID</th>
                <th data-key="citation" aria-sort="none">Citation</th>
                <th data-key="patron" aria-sort="none">Patron</th>
                <th data-key="status" aria-sort="none">Status</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="toolbar" style="margin-top: .75rem;">
          <button class="btn ghost" id="run-tests" type="button">Run Acceptance Tests</button>
          <div id="test-status" role="status" aria-live="polite"></div>
        </div>
      </section>
    </main>

    <aside class="right card" aria-label="On this form">
      <div class="toc">
        <h4>On this form</h4>
        <a href="#sec-identifiers" data-spy>Identifiers</a>
        <a href="#sec-publication" data-spy>Publication</a>
        <a href="#sec-trial" data-spy>Clinical Trial</a>
        <a href="#sec-management" data-spy>Management</a>
        <a href="#sec-review" data-spy>Review</a>
        <hr style="border:none;border-top:1px solid var(--border); margin: var(--space-3) 0;">
        <h4 id="playbook">Playbook (key rules)</h4>
        <ul style="margin:0; padding-left: 1.1rem; line-height:1.5">
          <li>Keep v1.2 UI contract; minimal DOM additions only.</li>
          <li>Validators: PMID 6‚Äì9 digits; DOI starts with 10.; NCT is NCT########.</li>
          <li>Bulk paste & upload support PMID/DOI/NCT; dedupe; rate‚Äëlimit; continue on errors.</li>
          <li>A11y (WCAG 2.2 AAA): labels, skip links, aria‚Äëlive, disabled buttons during batch.</li>
        </ul>
      </div>
    </aside>
  </div>

  <script>
    // === Selector map (keys match your official map) ===
    const S = {
      buttons: { lookup_pmid:"#lookup-pmid", lookup_doi:"#lookup-doi", lookup_nct:"#lookup-nct", bulk_paste:"#bulk-paste-btn", bulk_upload:"#bulk-upload-btn" },
      inputs:   { pmid:"#pmid", doi:"#doi", nct:"#nct", title:"#title", authors:"#authors", journal:"#journal", year:"#year", volume:"#volume", pages:"#pages", tags_text:"#tags", patron:"#patron-email", status:"#status", priority:"#priority", docline:"#docline" },
      clinical_trials: { phase:"#gl-phase", status:"#gl-ct-status", sponsor:"#gl-sponsor", nct_title:"#nct-title" },
      chips: { mesh:"#mesh-chips" },
      bulk: { paste_textarea:"#bulk-paste-data", upload_input:"#bulk-upload" },
      table: { requests_tbody:"#requests-table tbody", table:"#requests-table", filter:"#table-filter" },
      status_regions: { live:"#ss-live", pmid:"#pmid-status", doi:"#doi-status", nct:"#nct-status" }
    };
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const setVal = (sel, v) => $$(sel).forEach(el => { if ("value" in el) el.value = v ?? ""; else el.textContent = v ?? ""; });
    const getVal = sel => { const el = $(sel); return el ? ("value" in el ? el.value : el.textContent) : ""; };
    const say = (sel, msg) => setVal(sel, msg);

    // === Engine hookup: prefer real PMIDEnrichmentPipeline from test.html if present ===
    class DemoEngine {
      async enrichPMID(pmid) {
        if (pmid === "18539917") {
          return { status:"complete", unified: {
            pmid:"18539917", doi:"10.1056/NEJMoa0708857",
            title:"Sorafenib in advanced hepatocellular carcinoma",
            authors:[{family:"Llovet"},{family:"Ricci"},{family:"Mazzaferro"}],
            journal:"New England Journal of Medicine", year:"2008",
            mesh:["Carcinoma, Hepatocellular","Antineoplastic Agents","Sorafenib","Drug Therapy"],
            clinicalTrial:{ nctId:"NCT00048516", title:"Sorafenib in Advanced HCC", phase:"III", status:"Completed", sponsor:"Bayer" }
          }};
        }
        if (pmid === "23842776") {
          return { status:"complete", unified: {
            pmid:"23842776", title:"Single-cell RNA-seq reveals dynamic paracrine control of cellular variation",
            authors:[{family:"Shalek"},{family:"Satija"},{family:"Regev"}], journal:"Cell", year:"2013",
            mesh:["Single-Cell Analysis","RNA-Seq","Gene Expression Profiling","Transcriptome"]
          }};
        }
        return { status:"complete", unified: { pmid, title:"Unknown PMID" } };
      }
      async enrichDOI(doi){ return { status:"complete", unified:{ doi, title:"DOI lookup (demo)" } }; }
      async enrichNCT(nct){ return { status:"complete", unified:{ nct, clinicalTrial:{ nctId:nct, title:"NCT lookup (demo)" } } }; }
    }
    const engine = (function(){
      if (window.PMIDEnrichmentPipeline) {
        try {
          const e = new window.PMIDEnrichmentPipeline({ apiKey:"", crossrefEmail:"" });
          // Wrap to a common interface (unified on result.unified)
          return {
            async enrichPMID(pmid){ return e.enrichPMID(pmid); },
            async enrichDOI(doi){ return e.enrichDOI ? e.enrichDOI(doi) : new DemoEngine().enrichDOI(doi); },
            async enrichNCT(nct){ return e.enrichNCT ? e.enrichNCT(nct) : new DemoEngine().enrichNCT(nct); }
          };
        } catch (err) { console.warn("PMIDEnrichmentPipeline present but failed to init; using demo engine.", err); }
      }
      return new DemoEngine();
    })();

    const normAuthors = a => Array.isArray(a) ? a.map(x => x.name || x.family || x.last || x).join("; ") : (a || "");
    const toCitation = u => {
      const list = Array.isArray(u.authors) ? u.authors : [];
      const a = list.slice(0,3).map(x => x.family||x.last||x.name||x).filter(Boolean).join(", ") || (u.authors||"");
      const j = u.journal || u.containerTitle || "";
      const y = u.year || u.publishedYear || "";
      return [a, u.title || "", j, y].filter(Boolean).join(". ");
    };
    const dedupe = arr => Array.from(new Set(arr));
    const sleep = ms => new Promise(r=>setTimeout(r, ms));

    function fillTrial(ct){
      if (!ct) return;
      setVal(S.clinical_trials.phase, ct.phase || "");
      setVal(S.clinical_trials.status, ct.status || "");
      setVal(S.clinical_trials.sponsor, ct.sponsor || "");
      if (ct.title) setVal(S.clinical_trials.nct_title, ct.title);
    }
    function renderChips(tags){
      if (!tags) return;
      const containers = $$(S.chips.mesh);
      if (!containers.length) return;
      const names = dedupe((tags||[]).map(t => (typeof t === "string" ? t : t.name)).filter(Boolean));
      containers.forEach(c => {
        c.querySelectorAll("[data-auto='true']").forEach(x => x.remove());
        names.slice(0,8).forEach(n => {
          const chip = document.createElement("span");
          chip.className = "chip tag-mesh";
          chip.dataset.auto = "true";
          chip.textContent = n;
          c.appendChild(chip);
        });
      });
    }
    function mergeTagsText(existing, incoming){
      const cur = (existing || "").split(",").map(x=>x.trim()).filter(Boolean);
      const inc = (incoming || []).map(t => (typeof t === "string" ? t : t.name)).filter(Boolean);
      return dedupe([...cur, ...inc]).join(", ");
    }
    function fillForm(u){
      setVal(S.inputs.title,   u.title || "");
      setVal(S.inputs.authors, normAuthors(u.authors) || u.authorString || "");
      setVal(S.inputs.journal, u.journal || u.containerTitle || "");
      setVal(S.inputs.year,    u.year || u.publishedYear || "");
      setVal(S.inputs.volume,  u.volume || "");
      setVal(S.inputs.pages,   u.pages || "");
      setVal(S.inputs.doi,     u.doi || "");
      const nctVal = u.nct || (u.clinicalTrial && u.clinicalTrial.nctId) || "";
      setVal(S.inputs.nct, nctVal);
      if (u.clinicalTrial) fillTrial(u.clinicalTrial);
      const merged = mergeTagsText(getVal(S.inputs.tags_text), (u.tags || u.mesh));
      setVal(S.inputs.tags_text, merged);
      renderChips(u.tags || u.mesh);
    }
    function ctChipsHTML(ct){
      if (!ct) return "";
      const items = [];
      if (ct.phase) items.push(`<span class="chip tag-phase">Phase ${ct.phase}</span>`);
      if (ct.status) items.push(`<span class="chip">Status: ${ct.status}</span>`);
      if (ct.sponsor) items.push(`<span class="chip tag-sponsor">${ct.sponsor}</span>`);
      return items.join(" ");
    }
    function addRow(u){
      const tb = $(S.table.requests_tbody); if (!tb) return;
      const tr = document.createElement("tr");
      const urgency = getVal(S.inputs.priority) || "Normal";
      const docline = getVal(S.inputs.docline) || "";
      const pmid = u.pmid || u.PMID || "";
      const citation = toCitation(u);
      const patron = getVal(S.inputs.patron) || "";
      const status = getVal(S.inputs.status) || "New";
      tr.innerHTML = `<td data-key="urgency">${urgency}</td>
                      <td data-key="docline">${docline}</td>
                      <td data-key="pmid">${pmid}</td>
                      <td data-key="citation">${citation}<div>${ctChipsHTML(u.clinicalTrial)}</div></td>
                      <td data-key="patron">${patron}</td>
                      <td data-key="status">${status}</td>`;
      tb.prepend(tr);
      $("#req-count").textContent = String(tb.querySelectorAll("tr").length);
    }
    async function route(token, kind){
      try{
        let res;
        if (kind === "pmid") res = await engine.enrichPMID(token);
        else if (kind === "doi") res = await engine.enrichDOI(token);
        else if (kind === "nct") res = await engine.enrichNCT(token);
        const u = res?.unified || res?.pubmed || res?.crossref || (res?.clinicalTrial ? { clinicalTrial: res.clinicalTrial, nct: res.clinicalTrial.nctId } : {}) || {};
        fillForm(u); addRow(u);
        return true;
      } catch (e) { console.error("Enrichment failed:", kind, token, e); return false; }
    }

    function setBatchDisabled(disabled){
      $$(S.buttons.bulk_paste+", "+S.buttons.bulk_upload).forEach(b => b.closest("label")? ( $("#bulk-upload").disabled = disabled ) : (b.disabled = disabled));
      $$(S.buttons.lookup_pmid+", "+S.buttons.lookup_doi+", "+S.buttons.lookup_nct).forEach(b => b.disabled = disabled);
    }

    // Validators
    function isPMID(v){ return /^[0-9]{6,9}$/.test(v); }
    function isDOI(v){ return /^10\./.test(v); }
    function isNCT(v){ return /^NCT[0-9]{8}$/i.test(v); }

    // Bulk tokenization
    function extractTokens(text){
      const toks = text.match(/\b(NCT\d{8}|10\.[^\s"']+|\d{6,9})\b/gi) || [];
      const seen = new Set(), out = [];
      for (const t of toks) {
        const token = t.trim();
        if (seen.has(token)) continue; seen.add(token);
        const kind = /^NCT/i.test(token) ? "nct" : /^10\./.test(token) ? "doi" : "pmid";
        out.push({ token, kind });
      }
      return out;
    }

    // CSV parsing (minimal but quote-aware for simple cases)
    function parseCSV(text){
      const rows = []; let row = [], cell = "", inQ = false;
      for (let i=0;i<text.length;i++){
        const ch = text[i], nxt = text[i+1];
        if (ch === '"' && inQ && nxt === '"'){ cell += '"'; i++; continue; }
        if (ch === '"'){ inQ = !inQ; continue; }
        if (!inQ && (ch === "," || ch === "\t")){ row.push(cell.trim()); cell = ""; continue; }
        if (!inQ && (ch === "\n" || ch === "\r")){ if (cell.length || row.length){ row.push(cell.trim()); rows.push(row); row = []; cell = ""; } continue; }
        cell += ch;
      }
      if (cell.length || row.length){ row.push(cell.trim()); rows.push(row); }
      return rows.filter(r => r.length && r.some(x=>x));
    }

    function tokensFromCSV(text){
      const rows = parseCSV(text);
      if (!rows.length) return [];
      const header = rows[0].map(h => (h||"").toLowerCase());
      const idx = {
        pmid: header.findIndex(h => /pmid/.test(h)),
        doi: header.findIndex(h => /^doi$/.test(h)),
        nct: header.findIndex(h => /^nct$/.test(h)),
        id: header.findIndex(h => /^id$/.test(h))
      };
      const qs = [];
      for (let i=1;i<rows.length;i++){
        const r = rows[i];
        const candidates = [];
        if (idx.pmid>-1 && r[idx.pmid]) candidates.push(r[idx.pmid]);
        if (idx.doi>-1 && r[idx.doi]) candidates.push(r[idx.doi]);
        if (idx.nct>-1 && r[idx.nct]) candidates.push(r[idx.nct]);
        if (idx.id>-1 && r[idx.id]) candidates.push(r[idx.id]);
        if (!candidates.length) candidates.push(...r);
        qs.push(...extractTokens(candidates.join(" ")));
      }
      return qs;
    }

    async function processQueue(queue){
      setBatchDisabled(true);
      say(S.status_regions.live, "Processing batch‚Ä¶");
      let ok = 0, fail = 0;
      for (const {token, kind} of queue) {
        const good = await route(token, kind);
        good ? ok++ : fail++;
        await sleep(400);
      }
      say(S.status_regions.live, `Processed ${queue.length} item(s): ${ok} ok, ${fail} failed.`);
      setBatchDisabled(false);
    }

    // Wire single lookups
    $(S.buttons.lookup_pmid)?.addEventListener("click", async () => {
      const v = getVal(S.inputs.pmid).trim();
      if (!isPMID(v)) return say(S.status_regions.pmid, "PMID must be 6‚Äì9 digits.");
      say(S.status_regions.pmid, "Looking up‚Ä¶"); const ok = await route(v, "pmid");
      say(S.status_regions.pmid, ok ? "Done" : "Failed");
    });
    $(S.buttons.lookup_doi)?.addEventListener("click", async () => {
      const v = getVal(S.inputs.doi).trim();
      if (!v) return say(S.status_regions.doi, "Enter DOI");
      say(S.status_regions.doi, "Looking up‚Ä¶"); const ok = await route(v, "doi");
      say(S.status_regions.doi, ok ? "Done" : "Failed");
    });
    $(S.buttons.lookup_nct)?.addEventListener("click", async () => {
      const v = getVal(S.inputs.nct).trim();
      if (!isNCT(v)) return say(S.status_regions.nct, "Enter NCT########");
      say(S.status_regions.nct, "Looking up‚Ä¶"); const ok = await route(v, "nct");
      say(S.status_regions.nct, ok ? "Done" : "Failed");
    });

    // Bulk Paste
    $(S.buttons.bulk_paste)?.addEventListener("click", async () => {
      const ta = $(S.bulk.paste_textarea); if (!ta) return;
      const queue = extractTokens(ta.value || "");
      await processQueue(queue);
    });

    // Bulk Upload
    $(S.buttons.bulk_upload)?.addEventListener("click", () => $("#bulk-upload")?.click());
    $(S.bulk.upload_input)?.addEventListener("change", async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const ext = (f.name.split(".").pop() || "").toLowerCase();
      const text = await f.text();
      let queue = [];
      if (ext === "csv" || ext === "tsv") queue = tokensFromCSV(text);
      else if (ext === "json") {
        try {
          const obj = JSON.parse(text);
          const flat = Array.isArray(obj) ? obj : (obj.records || obj.items || []);
          const strs = flat.map(o => [o.pmid, o.doi, o.nct, o.id].filter(Boolean).join(" ")).join("\n");
          queue = extractTokens(strs);
        } catch { queue = extractTokens(text); }
      } else { queue = extractTokens(text); }
      await processQueue(queue);
      // reset file input for subsequent uploads
      e.target.value = "";
    });

    // Scrollspy
    const observer = new IntersectionObserver((entries)=>{
      const m = new Map(entries.map(e=>[e.target.id, e.isIntersecting]));
      $$(".toc [data-spy]").forEach(a => {
        const id = a.getAttribute("href").slice(1);
        a.setAttribute("aria-current", m.get(id) ? "true" : "false");
      });
    }, { rootMargin: "-40% 0% -55% 0%", threshold: 0.01 });
    ["sec-identifiers","sec-publication","sec-trial","sec-management","sec-review"].forEach(id => {
      const el = document.getElementById(id); if (el) observer.observe(el);
    });

    // Theme toggle
    const toggle = $("#theme-toggle");
    toggle?.addEventListener("click", () => {
      const cur = document.documentElement.dataset.theme || "auto";
      const next = cur === "dark" ? "light" : cur === "light" ? "dark" : "dark";
      document.documentElement.dataset.theme = next;
      toggle.setAttribute("aria-pressed", next === "dark");
    });

    // Keyboard helpers
    window.addEventListener("keydown", (e)=>{
      if (e.key === "/" && document.activeElement.tagName !== "INPUT" && document.activeElement.tagName !== "TEXTAREA") {
        e.preventDefault(); $(S.inputs.pmid)?.focus();
      }
    });

    // Table sorting
    function tableRows(){ return Array.from($(S.table.requests_tbody)?.rows || []); }
    function sortBy(key, dir){
      const rows = tableRows();
      rows.sort((a,b)=>{
        const av = (a.querySelector(`[data-key="${key}"]`)?.textContent || "").toLowerCase();
        const bv = (b.querySelector(`[data-key="${key}"]`)?.textContent || "").toLowerCase();
        return dir === "asc" ? av.localeCompare(bv) : bv.localeCompare(av);
      });
      const tb = $(S.table.requests_tbody); rows.forEach(r => tb.appendChild(r));
    }
    let sortState = { key:null, dir:"asc" };
    $$("#requests-table thead th").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.dataset.key;
        const dir = (sortState.key === key && sortState.dir === "asc") ? "desc" : "asc";
        sortState = { key, dir };
        $$("#requests-table thead th").forEach(x => x.setAttribute("aria-sort","none"));
        th.setAttribute("aria-sort", dir === "asc" ? "ascending" : "descending");
        sortBy(key, dir);
      });
    });

    // Table filter
    $(S.table.filter)?.addEventListener("input", (e) => {
      const q = (e.target.value || "").toLowerCase();
      tableRows().forEach(tr => {
        const txt = tr.textContent.toLowerCase();
        tr.style.display = txt.includes(q) ? "" : "none";
      });
    });

    // Acceptance tests
    $("#run-tests")?.addEventListener("click", async ()=>{
      const out = $("#test-status");
      function assert(name, cond){ const p = document.createElement("div"); p.textContent = (cond ? "‚úÖ " : "‚ùå ") + name; out.appendChild(p); return cond; }
      out.textContent = "Running‚Ä¶";
      const before = tableRows().length;
      await processQueue(extractTokens("18539917 23842776 NCT00048516 10.1016/j.cell.2013.06.020"));
      const after = tableRows().length;
      const rowAdded = assert("Rows added", after > before);
      const nctField = getVal(S.inputs.nct);
      const trialFilled = assert("NCT field populated", !!nctField);
      const chips = $("#mesh-chips")?.querySelectorAll(".chip").length || 0;
      const meshRendered = assert("MeSH chips rendered", chips > 0);
      const liveAnnounced = assert("Live region updated", /Processed/.test(getVal(S.status_regions.live)));
      if (rowAdded && trialFilled && meshRendered && liveAnnounced) out.prepend(Object.assign(document.createElement("div"), { textContent: "All acceptance checks passed." }));
    });
  </script>
</body>
</html>
