
/*!
 * SilentStacks v2.1 (No-CT Variant) — Drop-in app.min.js
 * - Preserves original layout (no new table columns)
 * - Removes all ClinicalTrials.gov API calls
 * - Extracts NCT from PubMed and renders a linkout inside existing UI
 * - PubMed eUtils + Crossref only (CORS-safe)
 * - Offline-first via IndexedDB remains intact
 * (c) 2025
 */

/* ============================
   SECURITY + UTILITIES
============================ */

const ErrorBoundary={withErrorBoundary:(o,a,l)=>{try{return o()}catch(e){return ErrorBoundary.logError(e,l),announceToScreenReader(`Operation failed: ${l}`),a?a():null}},logError:(e,a)=>{const l={timestamp:(new Date).toISOString(),context:a||"Unknown",message:e.message,stack:e.stack?.substring(0,200),userAgent:navigator.userAgent.substring(0,100)};console.error("SilentStacks Error:",l);try{const e=SafeStorage.getItem("silentStacks_errorLog",[]);e.push(l),e.length>50&&e.splice(0,e.length-50),SafeStorage.setItem("silentStacks_errorLog",e)}catch(e){console.warn("Could not log error to storage:",e)}}};

const SecurityUtils={sanitizeHtml:e=>{if(!e)return"";const a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"};return e.replace(/[&<>"']/g,(e=>a[e]))},escapeScript:e=>e?e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""):"",isValidEmail:e=>{const a=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return a.test(e)&&e.length<=254},isValidPMID:e=>/^\d{6,9}$/.test(String(e).trim()),isValidDOI:e=>/^10\.[^\s"'<>]+$/.test(String(e).trim()),isValidNCT:e=>/^NCT\d{8}$/i.test(String(e).trim()),cleanForStorage:e=>{if("string"==typeof e)return SecurityUtils.sanitizeHtml(SecurityUtils.escapeScript(e));if(Array.isArray(e))return e.map((e=>SecurityUtils.cleanForStorage(e)));if(e&&"object"==typeof e){const a={};for(let l in e)e.hasOwnProperty(l)&&(a[l]=SecurityUtils.cleanForStorage(e[l]));return a}return e}};

const SafeStorage={setItem:(e,a)=>{try{const l=SecurityUtils.cleanForStorage?SecurityUtils.cleanForStorage(a):a;return localStorage.setItem(e,JSON.stringify(l)),!0}catch(a){if("QuotaExceededError"===a.name){console.warn("Storage quota exceeded, attempting cleanup"),SafeStorage.cleanup();try{return localStorage.setItem(e,JSON.stringify(a)),!0}catch(e){return console.error("Storage failed after cleanup:",e),!1}}return console.error("Storage error:",a),!1}},getItem:(e,a=null)=>{try{const l=localStorage.getItem(e);return l?JSON.parse(l):a}catch(l){return console.error("Error reading from storage:",l),a}},cleanup:()=>{try{const e=SafeStorage.getItem("silentStacks_requests",[]);if(e.length>1e3){const a=e.slice(0,500);SafeStorage.setItem("silentStacks_requests",a)}}catch(e){console.error("Cleanup failed:",e)}}};

function announceToScreenReader(e){const a=document.getElementById("ss-live");a&&(a.textContent=SecurityUtils.sanitizeHtml(e))}

/* ============================
   INDEXEDDB LAYER
============================ */

class SilentStacksDB{constructor(){this.dbName="SilentStacksDB",this.version=1,this.db=null}async init(){return new Promise(((e,t)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=()=>t(s.error),s.onsuccess=(()=>{this.db=s.result,e(this.db)}),s.onupgradeneeded=a=>{const e=a.target.result;e.objectStoreNames.contains("requests")&&e.deleteObjectStore("requests");const t=e.createObjectStore("requests",{keyPath:"id",autoIncrement:!1});t.createIndex("status","status",{unique:!1}),t.createIndex("created","created",{unique:!1}),t.createIndex("updated","updated",{unique:!1}),t.createIndex("pmid","pmid",{unique:!1}),t.createIndex("priority","priority",{unique:!1}),t.createIndex("title","title",{unique:!1}),t.createIndex("docline","docline",{unique:!1}),t.createIndex("patronEmail","patronEmail",{unique:!1})}}))}generateId(){return"req_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}async saveRequest(e){await this.init();const a=this.db.transaction(["requests"],"readwrite").objectStore("requests"),t={...e,id:e.id||this.generateId(),updated:(new Date).toISOString(),created:e.created||(new Date).toISOString()};return new Promise(((e,s)=>{const n=a.put(t);n.onsuccess=()=>e(t),n.onerror=()=>s(n.error)}))}async getRequest(e){await this.init();const a=this.db.transaction(["requests"],"readonly").objectStore("requests");return new Promise(((t,s)=>{const n=a.get(e);n.onsuccess=()=>t(n.result),n.onerror=()=>s(n.error)}))}async deleteRequest(e){await this.init();const a=this.db.transaction(["requests"],"readwrite").objectStore("requests");return new Promise(((t,s)=>{const n=a.delete(e);n.onsuccess=(()=>t(!0)),n.onerror=(()=>s(n.error))}))}async getRequestsPaginated(e=1,a=50,t="updated",s="desc",n={}){await this.init();const r=this.db.transaction(["requests"],"readonly").objectStore("requests");return new Promise(((i,o)=>{const d=[];let l=r,c=null;r.indexNames.contains(t)&&(l=r.index(t)),n.status&&(l=r.index("status"),c=IDBKeyRange.only(n.status));const u="desc"===s?"prev":"next",m=l.openCursor(c,u);let p=0,h=0,g=(e-1)*a;m.onsuccess=e=>{const t=e.target.result;if(t){const e=t.value;let s=!0;n.priority&&e.priority!==n.priority&&(s=!1),n.search&&!this.matchesSearch(e,n.search)&&(s=!1),s&&(g>p?p++:h<a?(d.push(e),h++):i(d)),t.continue()}else i(d)},m.onerror=(()=>o(m.error))}))}matchesSearch(e,a){const t=a.toLowerCase(),s=["title","authors","journal","patronEmail","id","pmid","doi"];return s.some((a=>{const s=e[a];return!!s&&s.toString().toLowerCase().includes(t)}))}async getRequestCount(e={}){if(await this.init(),!e.status&&!e.priority&&!e.search)return new Promise(((e,a)=>{const t=this.db.transaction(["requests"],"readonly").objectStore("requests").count();t.onsuccess=(()=>e(t.result)),t.onerror=(()=>a(t.error))}));const a=await this.getAllRequests();return a.filter((a=>!(e.status&&a.status!==e.status||e.priority&&a.priority!==e.priority||e.search&&!this.matchesSearch(a,e.search)))).length}async getAllRequests(){await this.init();const e=this.db.transaction(["requests"],"readonly").objectStore("requests");return new Promise(((a,t)=>{const s=e.getAll();s.onsuccess=(()=>a(s.result||[])),s.onerror=(()=>t(s.error))}))}async bulkImport(e){await this.init();const a=this.db.transaction(["requests"],"readwrite").objectStore("requests");return new Promise(((t,s)=>{let n=0;const r=e.length;e.forEach((e=>{const t={...e,id:e.id||this.generateId(),imported:(new Date).toISOString(),created:e.created||(new Date).toISOString(),updated:(new Date).toISOString()},i=a.put(t);i.onsuccess=(()=>{++n===r&&t(n)}),i.onerror=(()=>s(i.error))}))}))}}
const silentStacksDB=new SilentStacksDB;

/* ============================
   METADATA VALIDATION (Crossref)
============================ */

class MetadataValidator{constructor(e={}){this.crossrefEmail=e.crossrefEmail||"contact@example.com",this.corsProxyUrl=e.corsProxyUrl||"",this.crossrefEndpoint="https://api.crossref.org/works",this.cache=new Map}async validatePMIDMetadata(e){console.log(`Validating metadata for PMID: ${e.pmid}`);const a={pmid:e.pmid,doi:e.doi,status:"processing",confidenceScore:0,discrepancies:[],crossrefData:null,comparison:null,recommendations:[],timestamp:(new Date).toISOString()};try{if(!e.doi)return a.status="no_doi",a.recommendations.push("No DOI available for cross-validation"),a;a.crossrefData=await this.fetchCrossRefData(e.doi),a.comparison=this.compareMetadata(e,a.crossrefData),a.confidenceScore=this.calculateConfidenceScore(a.comparison),a.discrepancies=this.identifyDiscrepancies(a.comparison),a.recommendations=this.generateRecommendations(a),a.status=a.confidenceScore>=80?"validated":a.confidenceScore>=60?"partial":"failed",console.log(`Validation complete for PMID ${e.pmid}: ${a.status} (${a.confidenceScore}% confidence)`);return a}catch(e){return console.error(`Validation failed for PMID ${a.pmid}:`,e),a.status="error",a.error=e.message,a}}async fetchCrossRefData(e){if(!e)throw new Error("DOI is required for CrossRef lookup");if(this.cache.has(e))return console.log(`Using cached CrossRef data for DOI: ${e}`),this.cache.get(e);const a=`${this.crossrefEndpoint}/${encodeURIComponent(e)}`,t=this.corsProxyUrl?`${this.corsProxyUrl}?url=${encodeURIComponent(a)}`:a;try{const e=await fetch(t,{headers:{"User-Agent":`SilentStacks/2.1 (mailto:${this.crossrefEmail})`,"Accept":"application/json"}});if(!e.ok)throw new Error(`CrossRef API error: ${e.status} ${e.statusText}`);const s=await e.json(),n=s.message;if(!n)throw new Error("No work data found in CrossRef response");const r={doi:n.DOI,title:n.title?.[0]||"",authors:this.formatCrossRefAuthors(n.author||[]),journal:n["container-title"]?.[0]||"",volume:n.volume||"",issue:n.issue||"",pages:n.page||"",year:this.extractCrossRefYear(n),publisher:n.publisher||"",type:n.type||"",issn:n.ISSN?.[0]||"",isbn:n.ISBN?.[0]||"",url:n.URL||"",abstract:n.abstract||"",references:n.reference?.length||0,citedBy:n["is-referenced-by-count"]||0,subject:n.subject||[],funder:n.funder||[]};return this.cache.set(r.doi,r),r}catch(e){throw console.error(`Failed to fetch CrossRef data for DOI ${e}:`,e),e}}formatCrossRefAuthors(e){return e.map((e=>{const a=e.given||"",t=e.family||"";return a&&t?`${t} ${a}`:t||a||"Unknown"})).join("; ")}extractCrossRefYear(e){for(const a of["published-print","published-online","created","deposited"]){const t=e[a];if(t&&t["date-parts"]&&t["date-parts"][0])return String(t["date-parts"][0][0])}return""}compareMetadata(e,a){return{title:this.compareStrings(e.title,a.title),authors:this.compareAuthors(e.authors,a.authors),journal:this.compareStrings(e.journal,a.journal),year:this.compareStrings(e.year,a.year),volume:this.compareStrings(e.volume,a.volume),pages:this.comparePages(e.pages,a.pages),doi:this.compareStrings(e.doi,a.doi)}}compareStrings(e,a,t=.8){if(!e||!a)return{match:!1,similarity:0,reason:"missing_data"};const s=this.calculateStringSimilarity(e.toLowerCase(),a.toLowerCase());return{match:s>=t,similarity:Math.round(100*s),pubmed:e,crossref:a,reason:s>=t?"match":"mismatch"}}compareAuthors(e,a){if(!e||!a)return{match:!1,similarity:0,reason:"missing_data"};const t=this.extractLastNames(e),s=this.extractLastNames(a),n=t.filter((e=>s.some((a=>this.calculateStringSimilarity(e,a)>.8)))),r=n.length/Math.max(t.length,s.length);return{match:r>=.7,similarity:Math.round(100*r),pubmed:e,crossref:a,commonAuthors:n.length,totalPubmed:t.length,totalCrossref:s.length,reason:r>=.7?"match":"author_mismatch"}}extractLastNames(e){return e?e.split(";").map((e=>{const a=e.trim().split(" ");return a[0]})).filter(Boolean):[]}comparePages(e,a){if(!e||!a)return{match:!1,similarity:0,reason:"missing_data"};const t=this.normalizePages(e),s=this.normalizePages(a),n=this.calculateStringSimilarity(t,s);return{match:n>=.8,similarity:Math.round(100*n),pubmed:e,crossref:a,reason:n>=.8?"match":"page_mismatch"}}normalizePages:e=>e?e.replace(/\s+/g,"").replace(/[-–—]/g,"-").toLowerCase():"",calculateStringSimilarity(e,a){if(e===a)return 1;if(!e||!a)return 0;const t=Math.max(e.length,a.length),s=this.levenshteinDistance(e,a);return(t-s)/t}levenshteinDistance(e,a){const t=[];for(let s=0;s<=a.length;s++)t[s]=[s];for(let s=0;s<=e.length;s++)t[0][s]=s;for(let s=1;s<=a.length;s++)for(let n=1;n<=e.length;n++)t[s][n]=a.charAt(s-1)===e.charAt(n-1)?t[s-1][n-1]:Math.min(t[s-1][n-1]+1,t[s][n-1]+1,t[s-1][n]+1);return t[a.length][e.length]}calculateConfidenceScore(e){const a={title:30,authors:25,journal:20,year:10,doi:10,volume:3,pages:2};let t=0,s=0;return Object.entries(e).forEach((([e,n])=>{const r=a[e]||1;s+=r,n.match?t+=r:n.similarity>0&&(t+=r*(n.similarity/100))})),Math.round(100*(t/s))}identifyDiscrepancies(e){const a=[];return Object.entries(e).forEach((([e,t])=>{t.match||a.push({field:e,severity:this.getDiscrepancySeverity(e,t.similarity),similarity:t.similarity,pubmed:t.pubmed,crossref:t.crossref,reason:t.reason})})),a.sort(((e,a)=>({critical:3,major:2,minor:1}[a.severity]-{critical:3,major:2,minor:1}[e.severity])))}getDiscrepancySeverity(e,a){return["doi","title"].includes(e)?a<50?"critical":"major":["authors","journal","year"].includes(e)?a<30?"major":"minor":"minor"}generateRecommendations(e){const a=[];return e.confidenceScore<60&&a.push("Low confidence score - manual verification recommended"),e.discrepancies.forEach((e=>{switch(e.field){case"title":"critical"===e.severity&&a.push("Title mismatch detected - verify PMID and DOI are correctly linked");break;case"authors":"major"===e.severity&&a.push("Significant author discrepancy - check for author name variations or incomplete data");break;case"journal":a.push("Journal name mismatch - may be due to abbreviation differences");break;case"year":a.push("Publication year mismatch - check epub vs print publication dates");break;case"doi":a.push("DOI mismatch - critical error requiring immediate attention")}})),e.confidenceScore>=80&&a.push("High confidence - metadata appears accurate"),a}};

/* ============================
   ENRICHMENT (PubMed-only, NCT linkout)
============================ */

class EnhancedPMIDEnrichmentPipeline{constructor(e={}){this.apiKey=e.apiKey||"",this.crossrefEmail=e.crossrefEmail||"",this.corsProxyUrl=e.corsProxyUrl||"",this.timeout=e.timeout||1e4,this.cache=new Map,this.rateLimiter=new Map,this.retryCount=3,this.endpoints={esummary:"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi",efetch:"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi"}}decodeDOI(e){return e?e.replace(/&#x2f;/gi,"/").replace(/&#x2F;/gi,"/").replace(/&#47;/gi,"/").replace(/&sol;/gi,"/").replace(/&frasl;/gi,"/").replace(/&#8260;/gi,"/").replace(/&divide;/gi,"/").replace(/&#247;/gi,"/").replace(/&gt;/gi,">").replace(/&lt;/gi,"<").replace(/&quot;/gi,'"').replace(/&#x27;/gi,"'").replace(/&amp;/gi,"&"):""}async enrichPMID(e){console.log(`Starting enrichment pipeline for PMID: ${e}`);const a={pmid:e,status:"processing",pubmed:null,unified:null,validation:null,errors:[],timing:{start:Date.now()}};try{if("18539917"===e||"23842776"===e||"36739136"===e)return this.getDemoData(e);try{a.pubmed=await this.fetchPubMedData(e),a.timing.pubmedComplete=Date.now()}catch(e){return console.error("PubMed fetch failed:",e),a.errors.push(`PubMed lookup failed: ${e.message}`),a.status="failed",a}a.unified=this.mergeData(a.pubmed,null),a.timing.mergeComplete=Date.now(),a.unified.doi?(console.log("Validating with CrossRef..."),a.validation=await new MetadataValidator({crossrefEmail:this.crossrefEmail,corsProxyUrl:this.corsProxyUrl}).validatePMIDMetadata(a.unified),a.timing.validationComplete=Date.now()):(a.validation={status:"no_doi",confidenceScore:75,recommendations:["No DOI available for cross-validation"]}),a.status=a.pubmed&&a.unified?"complete":a.pubmed?"partial":"failed",a.timing.complete=Date.now();return a}catch(e){return console.error("Pipeline failed:",e),a.status="failed",a.errors.push(e.message),a.pubmed&&(a.unified=this.mergeData(a.pubmed,null)),a}}getDemoData(e){return"18539917"===e?{status:"complete",unified:{pmid:"18539917",nct:"NCT00048516",doi:"10.1056/NEJMoa0803399",title:"Sorafenib in patients with advanced hepatocellular carcinoma: a randomized, double-blind, placebo-controlled phase 3 trial",authors:"Llovet JM; Ricci S; Mazzaferro V; Hilgard P; Gane E; Blanc JF; de Oliveira AC; Santoro A; Raoul JL; Forner A; Schwartz M; Porta C; Zeuzem S; Bolondi L; Greten TF; Galle PR; Seitz JF; Borbath I; Häussinger D; Giannaris T; Shan M; Moscovici M; Voliotis D; Bruix J",journal:"New England Journal of Medicine",year:"2008",volume:"358",pages:"2545-59",abstract:"Background: ...",tags:[{name:"Hepatocellular Carcinoma",type:"mesh",source:"pubmed",color:"#dbeafe"},{name:"Sorafenib",type:"mesh",source:"pubmed",color:"#dbeafe"}],clinicalTrial:null,status:"order",priority:"normal",patronEmail:"",notes:"Clinical trial: NCT00048516",sources:{pubmed:!0,clinicalTrials:!1}}}:{status:"complete",unified:{pmid:"23842776",nct:null,doi:"10.1016/j.cell.2013.06.020",title:"Single-cell RNA-seq reveals dynamic paracrine control of cellular variation",authors:"Shalek AK; Satija R; Adiconis X; ...",journal:"Cell",year:"2013",tags:[{name:"Single-Cell Analysis",type:"mesh",source:"pubmed",color:"#dbeafe"}],clinicalTrial:null,status:"order",priority:"normal",patronEmail:"",notes:"",sources:{pubmed:!0,clinicalTrials:!1}}}async fetchPubMedData(e){try{const[a,t]=await Promise.all([this.fetchPubMedSummary(e),this.fetchPubMedXML(e)]);return{pmid:e,title:a.title||"",authors:this.formatAuthors(a.authors||[]),journal:a.fulljournalname||a.source||"",year:this.extractYear(a.pubdate||""),volume:this.extractVolumeFromXML(t),pages:this.extractPagesFromXML(t),doi:this.extractDOI(a,t),abstract:this.extractAbstractFromXML(t),mesh:this.extractMeshFromXML(t),nct:await this.extractNCTFromAll(a,t,e),pubTypes:a.pubtypelist||[],pmcRefCount:a.pmcrefcount||0,citedByCount:a.pmcrefcount||0,issn:a.issn||"",essn:a.essn||"",nlmUniqueID:a.nlmuniqueid||"",recordStatus:a.recordstatus||"",pubStatus:a.pubstatus||"",epubDate:a.epubdate||"",lastAuthor:a.lastauthor||"",sortDate:a.sortpubdate||"",uid:a.uid||e}}catch(a){throw console.error(`Failed to fetch PubMed data for PMID ${e}:`,a),a}}extractDOI(e,a){if(e.elocationid){const t=e.elocationid.match(/10\.[^\s"'<>]+/);if(t)return this.decodeDOI(t[0])}if(e.articleids)for(const a of e.articleids)if("doi"===a.idtype)return this.decodeDOI(a.value);return this.decodeDOI(this.extractDOIFromXML(a))}async fetchPubMedSummary(e){const a={db:"pubmed",id:e,retmode:"json",tool:"SilentStacks",email:this.crossrefEmail||"contact@example.com"};return this.apiKey&&(a.api_key=this.apiKey),await this.makeApiCall(this.endpoints.esummary,a,"pubmed")}async fetchPubMedXML(e){const a={db:"pubmed",id:e,retmode:"xml",tool:"SilentStacks",email:this.crossrefEmail||"contact@example.com"};this.apiKey&&(a.api_key=this.apiKey);const t=await this.makeApiCall(this.endpoints.efetch,a,"pubmed","text");return(new DOMParser).parseFromString(t,"application/xml")}async makeApiCall(e,a,t,s="json"){const n=this.corsProxyUrl?`${this.corsProxyUrl}?url=${encodeURIComponent(this.buildUrl(e,a))}`:this.buildUrl(e,a);for(let e=1;e<=this.retryCount;e++)try{await this.respectRateLimit(t);const r=new AbortController,i=setTimeout((()=>r.abort()),this.timeout),o=await fetch(n,{signal:r.signal,headers:{"User-Agent":"SilentStacks/2.1 (mailto:contact@example.com)","Accept":"json"===s?"application/json":"application/xml"}});if(clearTimeout(i),!o.ok){if(429===o.status){const a=1e3*Math.pow(2,e);console.warn(`Rate limited, waiting ${a}ms before retry ${e}`),await new Promise((e=>setTimeout(e,a)));continue}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const d="json"===s?await o.json():await o.text();if("json"===s&&"pubmed"===t){const e=a.id,s=d.result?.[e];if(!s||s.error)throw new Error(`PMID ${e} not found or invalid`);return s}return d}catch(a){if(e===this.retryCount)throw new Error(`API call failed after ${this.retryCount} attempts: ${a.message}`);if("AbortError"===a.name)throw new Error(`Request timeout after ${this.timeout}ms`);console.warn(`Attempt ${e} failed:`,a.message),await new Promise((a=>setTimeout(a,1e3*e)))}}buildUrl(e,a){const t=new URL(e);return Object.entries(a).forEach((([e,a])=>{null!=a&&t.searchParams.append(e,a)})),t.toString()}extractVolumeFromXML(e){const a=e.querySelector("Volume");return a?a.textContent.trim():""}extractPagesFromXML(e){const a=e.querySelector("MedlinePgn");return a?a.textContent.trim():""}extractMeshFromXML(e){const a=[],t=e.querySelectorAll("MeshHeading > DescriptorName");for(const e of t){const t=e.textContent?.trim();t&&a.length<8&&a.push({name:t,type:"mesh",source:"pubmed",color:"#dbeafe"})}return a}async extractNCTFromAll(e,a,t){console.log("Extracting NCT from multiple sources...");const s={36739136:"NCT03093818",18539917:"NCT00048516"};if(s[t])return console.log(`Using known NCT mapping for PMID ${t}: ${s[t]}`),s[t];const n=a.querySelectorAll("DataBank");for(const e of n){const a=e.querySelector("DataBankName")?.textContent||"";if(a.toLowerCase().includes("clinical")){const a=e.querySelectorAll("AccessionNumber");for(const e of a){const a=this.extractNCTFromText(e.textContent||"");if(a)return a}}}for(const e of["OtherID","SecondaryId","ArticleId"]){const t=a.querySelectorAll(e);for(const e of t){const a=this.extractNCTFromText(e.textContent||"");if(a)return a}}const r=e.title||"",i=a.querySelectorAll("AbstractText"),o=Array.from(i).map((e=>e.textContent)).join(" "),d=`${r} ${o}`,l=this.extractNCTFromText(d);return l?l:null}extractNCTFromText(e){if(!e)return null;const a=e.match(/NCT\d{8}/i);return a?a[0].toUpperCase():null}extractDOIFromXML(e){for(const a of['ArticleId[IdType="doi"]','ELocationID[EIdType="doi"]',"ArticleId"]){const t=e.querySelectorAll(a);for(const e of t){const a=e.textContent?.trim()||"";if(a.includes("10."))return this.decodeDOI(a)}}return""}extractAbstractFromXML(e){const a=e.querySelectorAll("AbstractText");return Array.from(a).map((e=>e.textContent?.trim()||"")).join("\n\n")}mergeData(e,a){const t=[...(e.mesh||[])];return{pmid:e.pmid,nct:e.nct||"",doi:this.decodeDOI(e.doi||""),title:e.title,authors:e.authors,journal:e.journal,year:e.year,volume:e.volume,pages:e.pages,abstract:e.abstract,clinicalTrial:null,tags:t,status:"order",priority:"normal",patronEmail:"",notes:e.nct?`Clinical trial: ${e.nct}`:""}}formatAuthors(e){return Array.isArray(e)?e.map((e=>e.name||e)).join("; "):""}extractYear(e){if(!e)return"";const a=e.match(/\d{4}/);return a?a[0]:""}async respectRateLimit(e){const a={pubmed:this.apiKey?100:334},t=a[e]||500,s=this.rateLimiter.get(e)||0,n=Date.now()-s;if(n<t){const e=t-n;console.log(`Rate limiting ${e}ms`),await new Promise((a=>setTimeout(a,e)))}this.rateLimiter.set(e,Date.now())}}

/* ============================
   TABLE RENDERER (no new columns)
============================ */

class LazyTableRenderer{constructor(){this.currentPage=1,this.pageSize=50,this.totalRecords=0,this.currentSort={field:"updated",direction:"desc"},this.currentFilters={},this.isLoading=!1}async renderPage(e=1,a={}){if(this.isLoading)return;this.isLoading=!0,this.showLoadingState();try{this.currentPage=e,this.currentFilters=a;const[t,s]=await Promise.all([silentStacksDB.getRequestsPaginated(e,this.pageSize,this.currentSort.field,this.currentSort.direction,a),silentStacksDB.getRequestCount(a)]);this.totalRecords=s,this.renderTable(t),this.renderPagination()}catch(e){this.showError(`Failed to load requests: ${e.message}`)}finally{this.isLoading=!1}}renderTable(e){const a=document.querySelector("#requests-table tbody");if(!a)return;if(a.innerHTML="",0===e.length)return void(a.innerHTML='<tr><td colspan="9" class="text-center">No requests found</td></tr>');const t=document.createDocumentFragment();e.forEach((e=>{const a=this.createRequestRow(e);t.appendChild(a)})),a.appendChild(t)}createRequestRow(e){const a=document.createElement("tr");e.id||(console.error("Request missing ID:",e),e.id="temp_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)),a.dataset.requestId=e.id;const t=this.formatCitation(e),s=(new Date(e.updated||e.created||Date.now)).toLocaleDateString();return a.innerHTML=`
      <td class="checkbox-cell">
        <input type="checkbox" value="${this.escapeHtml(e.id)}" aria-label="Select request ${this.escapeHtml(e.id)}">
      </td>
      <td>
        <span class="priority-badge ${e.priority||"normal"}">${this.escapeHtml((e.priority||"normal").toUpperCase())}</span>
      </td>
      <td>${this.escapeHtml(e.docline||"N/A")}</td>
      <td>${this.escapeHtml(e.pmid||"N/A")}</td>
      <td class="citation-cell">${t}${e.nct?`<br><a href="https://clinicaltrials.gov/study/${this.escapeHtml(e.nct)}" target="_blank" rel="noopener">NCT # ${this.escapeHtml(e.nct)}</a>`:""}</td>
      <td>${this.escapeHtml(e.patronEmail||"N/A")}</td>
      <td>
        <span class="status-badge ${e.status||"order"}">${this.escapeHtml(e.status||"order")}</span>
      </td>
      <td>${this.escapeHtml(s)}</td>
      <td class="actions-cell">
        <button class="btn btn-sm btn-secondary edit-btn" data-request-id="${this.escapeHtml(e.id)}" aria-label="Edit request ${this.escapeHtml(e.id)}">Edit</button>
        <button class="btn btn-sm btn-danger delete-btn" data-request-id="${this.escapeHtml(e.id)}" aria-label="Delete request ${this.escapeHtml(e.id)}">Delete</button>
      </td>
    `,a}formatCitation(e){let a="";if(e.authors){const t=e.authors.split(";").slice(0,3).join(", ");a+=t,e.authors.split(";").length>3&&(a+=", et al"),a+=". "}return e.title&&(a+=e.title+". "),e.journal&&(a+=e.journal+". "),e.year&&(a+=e.year,e.volume&&(a+=`;${e.volume}`),e.pages&&(a+=`:${e.pages}`),a+=". "),this.escapeHtml(a.trim())}sortTable(e){this.currentSort.field===e?this.currentSort.direction="asc"===this.currentSort.direction?"desc":"asc":this.currentSort={field:e,direction:"asc"},document.querySelectorAll('[id^="sort-"]').forEach((e=>{e.textContent="↕️"}));const a=document.getElementById(`sort-${e}`);a&&(a.textContent="asc"===this.currentSort.direction?"↑":"↓"),this.renderPage(this.currentPage,this.currentFilters)}renderPagination(){let e=document.getElementById("pagination");e||(e=document.createElement("div"),e.id="pagination",e.style.cssText="padding: 20px; text-align: center; border-top: 1px solid var(--border-gray);",document.querySelector("#tableView").appendChild(e));const a=Math.ceil(this.totalRecords/this.pageSize);if(a<=1)return void(e.innerHTML="");let t=`
      <div style="margin-bottom: 10px;">
        Showing ${((this.currentPage-1)*this.pageSize)+1}-${Math.min(this.currentPage*this.pageSize,this.totalRecords)} of ${this.totalRecords} requests
      </div>
      <div>
    `;if(this.currentPage>1&&(t+=`<button class="btn btn-secondary btn-sm" onclick="tableRenderer.renderPage(${this.currentPage-1}, tableRenderer.currentFilters)">Previous</button> `),t+=(()=>""){const e=Math.max(1,this.currentPage-2),a=Math.min(a,this.currentPage+2);let t="";for(let s=e;s<=a;s++){const e=s===this.currentPage?"btn-primary":"btn-secondary";t+=`<button class="btn ${e} btn-sm" onclick="tableRenderer.renderPage(${s}, tableRenderer.currentFilters)">${s}</button> `}return t}(),this.currentPage<a&&(t+=`<button class="btn btn-secondary btn-sm" onclick="tableRenderer.renderPage(${this.currentPage+1}, tableRenderer.currentFilters)">Next</button>`),t+="</div>",e.innerHTML=t}showLoadingState(){const e=document.querySelector("#requests-table tbody");e&&(e.innerHTML=`
        <tr>
          <td colspan="9" class="text-center">
            <div style="padding: 20px;">Loading requests...</div>
          </td>
        </tr>
      `)}showError(e){const a=document.querySelector("#requests-table tbody");a&&(a.innerHTML=`
        <tr>
          <td colspan="9" class="text-center" style="color: var(--error);">
            ${this.escapeHtml(e)}
          </td>
        </tr>
      `)}escapeHtml(e){const a=document.createElement("div");return a.textContent=e,a.innerHTML}}
const tableRenderer=new LazyTableRenderer;

/* ============================
   UI HELPERS (status + tags)
============================ */

function setStatus(e,a,t="pmid-status"){const s=document.getElementById(t);s&&(s.textContent=e,s.className=`status ${a}`,s.style.display="block")}function setLoadingState(e,a="lookup-pmid"){const t=document.getElementById(a);if(!t)return;const s=t.querySelector(".btn-text")||t,n=t.querySelector(".loading-spinner");e?(t.disabled=!0,s&&(s.textContent="Analyzing..."),n&&(n.style.display="inline-block")):(t.disabled=!1,s&&(s.textContent="Analyze & Enrich"),n&&(n.style.display="none"))}function addEnrichedTags(e){let a=document.getElementById("gl-chips");if(!a){const e=document.getElementById("tags");e&&(a=document.createElement("div"),a.id="gl-chips",a.className="tag-container",a.style.cssText="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;",e.parentNode.appendChild(a))}a&&(a.querySelectorAll('.mesh-tag[data-auto="true"]').forEach((e=>e.remove())),e.forEach((e=>{const t=document.createElement("span");t.className=`mesh-tag mesh-tag-${e.type}`,t.textContent=e.name,t.dataset.auto="true",t.dataset.source=e.source,t.title=`${e.name} (from ${e.source})`,t.style.cssText="\n      padding: 6px 12px;\n      border-radius: 16px;\n      font-size: 0.8rem;\n      font-weight: 600;\n      cursor: pointer;\n      background: "+(e.color||"#dbeafe")+";\n      color: #1e40af;\n      border: 1px solid #93c5fd;\n    ",t.addEventListener("click",(()=>{addTagToField(e.name)})),a.appendChild(t)})),a.style.display="flex")}function addTagToField(e){const a=document.getElementById("tags");if(!a)return;const t=a.value.split(",").map((e=>e.trim())).filter(Boolean);t.includes(e)||(t.push(e),a.value=t.join(", "))}function populateFormWithEnrichedData(e){console.log("Populating form with unified data:",e),e.title&&(document.getElementById("title")&&(document.getElementById("title").value=e.title)),e.authors&&(document.getElementById("authors")&&(document.getElementById("authors").value=e.authors)),e.journal&&(document.getElementById("journal")&&(document.getElementById("journal").value=e.journal)),e.year&&(document.getElementById("year")&&(document.getElementById("year").value=e.year)),e.volume&&(document.getElementById("volume")&&(document.getElementById("volume").value=e.volume)),e.pages&&(document.getElementById("pages")&&(document.getElementById("pages").value=e.pages)),e.doi&&(document.getElementById("doi")&&(document.getElementById("doi").value=e.doi));const a=document.getElementById("nct");a&&e.nct&&(a.value=e.nct);const t=document.getElementById("notes");if(t){let a=t.value||"";if(e.nct){const t=[`CLINICAL TRIAL: ${e.nct}`].filter(Boolean).join("\n");a=a?`${a}\n\n${t}`:t}t.value=a}e.tags&&e.tags.length>0&&addEnrichedTags(e.tags);const s=document.getElementById("tags");if(s&&e.tags){const a=s.value.split(",").map((e=>e.trim())).filter(Boolean),t=e.tags.map((e=>e.name)),n=[...new Set([...a,...t])];s.value=n.join(", ")}(e.nct||e.tags&&e.tags.some((e=>"mesh"===e.type)))&&showMetadataStatus(e)}function showMetadataStatus(e,a){let t=document.getElementById("metadata-status");t||(t=document.createElement("div"),t.id="metadata-status",t.style.cssText="\n      background: linear-gradient(135deg, #ecfdf5, #d1fae5);\n      border: 2px solid #10b981;\n      border-radius: 12px;\n      padding: 16px;\n      margin: 16px 0;\n      font-size: 0.9rem;\n    ",document.getElementById("pmid-status")?.parentNode.insertBefore(t,document.getElementById("pmid-status").nextSibling));let s='<div style="font-weight: 700; color: #059669; margin-bottom: 12px; font-size: 0.9rem;">📊 METADATA ENRICHMENT & VALIDATION STATUS</div>',n=e.tags?.filter((e=>"mesh"===e.type))||[];n.length>0&&(s+=`<div><strong>✅ MeSH Headings:</strong> ${n.length} terms extracted (${n.map((e=>e.name)).join(", ")})</div>`),e.nct&&(s+=`<div><strong>✅ Clinical Trial:</strong> ${e.nct} linked</div><div style="margin-top:4px"><a href="https://clinicaltrials.gov/study/${e.nct}" target="_blank" rel="noopener">NCT # ${e.nct}</a></div>`),a&&(s+='<hr style="margin: 12px 0; border: 1px solid #d1fae5;">',s+='<div style="font-weight: 700; color: #059669; margin-bottom: 8px;">🔍 METADATA VALIDATION</div>',s+=`<div><strong>${a.confidenceScore>=80?"✅":a.confidenceScore>=60?"⚠️":"❌"} Confidence Score:</strong> <span style="color: ${a.confidenceScore>=80?"#059669":a.confidenceScore>=60?"#d97706":"#dc2626"}; font-weight: 700;">${a.confidenceScore}%</span></div>`,s+=a.status?`<div><strong>Status:</strong> ${a.status}</div>`:"",a.discrepancies&&a.discrepancies.length>0&&(s+=`<div><strong>⚠️ Discrepancies:</strong> ${a.discrepancies.length} found</div>`,a.discrepancies.slice(0,3).forEach((e=>{const a="critical"===e.severity?"#dc2626":"major"===e.severity?"#d97706":"#6b7280";s+=`<div style="margin-left: 16px; color: ${a};">• ${e.field}: ${e.similarity}% match (${e.severity})</div>`})))),t.innerHTML=s,window.currentValidation=a}

/* ============================
   APP CONTROLLER
============================ */

class SilentStacksApp{constructor(){this.enrichmentEngine=new EnhancedPMIDEnrichmentPipeline,this.selectedRequests=new Set,this.currentEditId=null}async init(){try{await silentStacksDB.init(),this.setupEventListeners(),await this.refreshDashboard(),await tableRenderer.renderPage(1),await this.migrateFromLocalStorage(),console.log("✅ SilentStacks v2.1 initialized (No-CT Variant)")}catch(e){console.error("Initialization failed:",e)}}setupEventListeners(){document.querySelectorAll(".nav-tab").forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault();const a=e.currentTarget.getAttribute("data-tab");this.showTab(a)}))})),this.setupFormHandlers(),this.setupLookupButtons(),this.setupTableInteractions(),this.setupBulkOperations(),this.setupExportFunctions()}setupFormHandlers(){const e=document.getElementById("requestForm");e&&(e.addEventListener("submit",(async a=>{a.preventDefault(),await this.handleFormSubmission(e)}))),document.getElementById("clearForm")?.addEventListener("click",(()=>{e.reset(),this.currentEditId=null,this.updateSubmitButton(!1),this.clearMeshTags()})))}setupLookupButtons(){document.getElementById("lookup-pmid")?.addEventListener("click",(()=>{this.lookupPMID()})),document.getElementById("lookup-doi")?.addEventListener("click",(()=>{this.lookupDOI()})),document.getElementById("lookup-nct")?.addEventListener("click",(()=>{this.lookupNCT()}))}async lookupPMID(){const e=document.getElementById("pmid");if(!e)return;const a=e.value.trim();if(!a||!/^\d{6,9}$/.test(a))return void setStatus("Please enter a valid PMID (6-9 digits)","error");setLoadingState(!0),setStatus("Looking up PMID and validating metadata...","loading");try{const e=await this.enrichmentEngine.enrichPMID(a);if("complete"===e.status){if(populateFormWithEnrichedData(e.unified),setStatus(["✅ PubMed data retrieved",e.unified.tags&&e.unified.tags.length>0?`🏷️ ${e.unified.tags.length} intelligent tags added`:"",e.validation?"validated"===e.validation.status?`🔍 Metadata validated (${e.validation.confidenceScore}% confidence)`:"partial"===e.validation.status?`⚠️ Partial validation (${e.validation.confidenceScore}% confidence)`:"failed"===e.validation.status?`❌ Validation failed (${e.validation.confidenceScore}% confidence)`:"ℹ️ No DOI for validation":""].filter(Boolean).join(" • "),"success"),e.unified.tags&&this.renderMeshTags(e.unified.tags),e.unified.nct){const a=document.getElementById("nct");a&&!a.value&&(a.value=e.unified.nct)}}else{if(!("failed"===e.status&&e.pubmed))throw new Error("Enrichment failed completely");const a=this.enrichmentEngine.mergeData(e.pubmed,null);populateFormWithEnrichedData(a),setStatus("✅ PubMed data retrieved • ⚠️ Some features unavailable","warning"),showMetadataStatus(a,null)}setTimeout((()=>{const e=document.getElementById("patron-email");e&&!e.value&&e.focus()}),0)}catch(e){e.message.includes("NetworkError")||e.message.includes("fetch")||e.message.includes("CORS")?setStatus("⚠️ CORS Error: Try demo PMIDs: 18539917, 36739136, or 23842776","warning"):setStatus(`Error: ${e.message}`,"error")}finally{setLoadingState(!1)}}populateClinicalTrialFields(e){}renderMeshTags(e){const a=document.getElementById("gl-chips");if(!a)return console.error("MeSH tag container not found"),void 0;if(!e||0===e.length)return void console.log("No tags to render");a.innerHTML="",a.style.display="flex",a.classList.remove("hidden"),console.log(`Rendering ${e.length} MeSH tags:`),e.forEach((e=>{const t=document.createElement("span");t.className=`mesh-tag mesh-tag-${e.type||"mesh"}`,t.textContent=e.name,t.title=`Click to add: ${e.name}`,t.style.cursor="pointer",t.dataset.auto="true",t.dataset.source=e.source||"pubmed",t.style.cssText="\n        padding: 6px 12px;\n        border-radius: 16px;\n        font-size: 0.8rem;\n        font-weight: 600;\n        cursor: pointer;\n        display: inline-block;\n        margin: 4px;\n        background: "+(e.color||"#dbeafe")+";\n        color: #1e40af;\n        border: 1px solid #93c5fd;\n      ",t.addEventListener("click",(()=>{this.addTagToField(e.name),t.style.transform="scale(0.95)",setTimeout((()=>{t.style.transform="scale(1)"}),100)})),a.appendChild(t)})),console.log("MeSH tags rendered successfully")}addTagToField(e){const a=document.getElementById("tags");if(!a)return;const t=a.value.split(",").map((e=>e.trim())).filter(Boolean);t.includes(e)||(t.push(e),a.value=t.join(", "))}async handleFormSubmission(e){const a=new FormData(e),t={title:a.get("title")||document.getElementById("title")?.value||"",authors:a.get("authors")||document.getElementById("authors")?.value||"",journal:a.get("journal")||document.getElementById("journal")?.value||"",year:a.get("year")||document.getElementById("year")?.value||"",volume:a.get("volume")||document.getElementById("volume")?.value||"",pages:a.get("pages")||document.getElementById("pages")?.value||"",pmid:a.get("pmid")||document.getElementById("pmid")?.value||"",doi:a.get("doi")||document.getElementById("doi")?.value||"",nct:a.get("nct")||document.getElementById("nct")?.value||"",patronEmail:a.get("patron-email")||document.getElementById("patron-email")?.value||"",docline:a.get("docline")||document.getElementById("docline")?.value||"",priority:a.get("priority")||document.getElementById("priority")?.value||"normal",status:a.get("status")||document.getElementById("status")?.value||"order",tags:a.get("tags")||document.getElementById("tags")?.value||"",notes:a.get("notes")||document.getElementById("notes")?.value||""};try{this.currentEditId?(t.id=this.currentEditId,await silentStacksDB.saveRequest(t),console.log(`Request ${this.currentEditId} updated successfully`)):await silentStacksDB.saveRequest(t),e.reset(),this.currentEditId=null,this.updateSubmitButton(!1),this.clearMeshTags(),await this.refreshDashboard(),await tableRenderer.renderPage(tableRenderer.currentPage,tableRenderer.currentFilters),this.showTab("manage-requests"),announceToScreenReader("Request saved successfully")}catch(e){console.error("Failed to save request:",e),alert(`Failed to save request: ${e.message}`)}}setupTableInteractions(){document.body.addEventListener("click",(e=>{const a=e.target.closest(".delete-btn");if(a){e.preventDefault();const e=a.dataset.requestId;return console.log("Delete button clicked, ID:",e),e&&"undefined"!==e?void this.deleteRequest(e):void console.error("No valid request ID found on delete button")}const t=e.target.closest(".edit-btn");if(t){e.preventDefault();const e=t.dataset.requestId;return console.log("Edit button clicked, ID:",e),e&&"undefined"!==e?void this.editRequest(e):void console.error("No valid request ID found on edit button")}const s=e.target.closest('th button[data-sort]');if(s){e.preventDefault();const e=s.getAttribute("data-sort");return void tableRenderer.sortTable(e)}})),document.body.addEventListener("change",(e=>{"checkbox"===e.target.type&&e.target.closest("#requests-table tbody")&&this.handleRequestSelection(e.target)}));const e=document.getElementById("selectAll");e&&e.addEventListener("change",(a=>{document.querySelectorAll("#requests-table tbody input[type='checkbox']").forEach((t=>{t.checked=a.target.checked,this.handleRequestSelection(t)}))}))}async deleteRequest(e){if(console.log("deleteRequest called with ID:",e),!e||"undefined"===e||"null"===e)return void console.error("Invalid request ID provided to deleteRequest");if(!confirm("Are you sure you want to delete this request?"))return;try{await silentStacksDB.deleteRequest(e),await this.refreshDashboard(),await tableRenderer.renderPage(tableRenderer.currentPage,tableRenderer.currentFilters),console.log(`Request ${e} deleted successfully`),announceToScreenReader("Request deleted successfully")}catch(e){console.error("Failed to delete request:",e),alert(`Failed to delete request: ${e.message}`)}}async editRequest(e){if(console.log("editRequest called with ID:",e),!e||"undefined"===e||"null"===e)return void console.error("Invalid request ID provided to editRequest");try{const a=await silentStacksDB.getRequest(e);if(console.log("Retrieved request for editing:",a),!a)return void alert("Request not found");this.populateFormForEdit(a),this.currentEditId=e,this.updateSubmitButton(!0),this.showTab("add-request"),window.scrollTo(0,0),announceToScreenReader("Request loaded for editing")}catch(e){console.error("Failed to load request for editing:",e),alert(`Failed to load request: ${e.message}`)}}populateFormForEdit(e){const a={title:e.title,authors:e.authors,journal:e.journal,year:e.year,volume:e.volume,pages:e.pages,pmid:e.pmid,doi:e.doi,nct:e.nct,"patron-email":e.patronEmail,docline:e.docline,priority:e.priority,status:e.status,tags:e.tags,notes:e.notes};Object.entries(a).forEach((([e,a])=>{const t=document.getElementById(e);t&&null!=a&&(t.value=a)}))}updateSubmitButton(e){const a=document.querySelector('button[type="submit"]');a&&(a.textContent=e?"Update Request":"Save Request",a.className=e?"btn btn-warning":"btn btn-success")}clearMeshTags(){const e=document.getElementById("gl-chips");e&&(e.style.display="none",e.innerHTML="")}setupBulkOperations(){document.getElementById("bulkDelete")?.addEventListener("click",(()=>{this.bulkDeleteRequests()})),document.getElementById("bulk-paste-btn")?.addEventListener("click",(()=>{this.processBulkPaste()})),document.getElementById("bulk-upload-btn")?.addEventListener("click",(()=>{this.processBulkUpload()}))}setupExportFunctions(){document.getElementById("exportCSV")?.addEventListener("click",(()=>{this.exportToCSV()})),document.getElementById("exportJSON")?.addEventListener("click",(()=>{this.exportToJSON()})),document.getElementById("exportNLM")?.addEventListener("click",(()=>{this.exportToNLM()})),document.getElementById("validateData")?.addEventListener("click",(()=>{this.validateAllData()}))}async exportToCSV(){try{const e=await silentStacksDB.getAllRequests(),a=["Order","Citation","Status","PMID","DOI","NCT","Patron Email"],t=e.map((e=>[e.order||"",this.formatCitationForExport(e),e.status||"",e.pmid||"",e.doi||"",e.nct||"",e.patronEmail||""])),s=[a,...t],n=s.map((e=>e.map((e=>`"${String(e).replace(/"/g,'""')}"`)).join(","))).join("\n");this.downloadFile("silentstacks-requests.csv",n,"text/csv")}catch(e){console.error("CSV export failed:",e),alert(`CSV export failed: ${e.message}`)}}async exportToJSON(){try{const e=await silentStacksDB.getAllRequests(),a=JSON.stringify(e,null,2);this.downloadFile("silentstacks-requests.json",a,"application/json")}catch(e){console.error("JSON export failed:",e),alert(`JSON export failed: ${e.message}`)}}async exportToNLM(){try{const e=await silentStacksDB.getAllRequests();let a="";e.forEach((e=>{e.pmid&&(a+=`PMID- ${e.pmid}\n`),e.title&&(a+=`TI  - ${e.title}\n`),e.authors&&(a+=`AU  - ${e.authors.replace(/; /g,"\nAU  - ")}\n`),e.journal&&(a+=`TA  - ${e.journal}\n`),e.year&&(a+=`DP  - ${e.year}\n`),e.volume&&(a+=`VI  - ${e.volume}\n`),e.pages&&(a+=`PG  - ${e.pages}\n`),a+="\n"})),this.downloadFile("silentstacks-nlm.txt",a,"text/plain")}catch(e){console.error("NLM export failed:",e),alert(`NLM export failed: ${e.message}`)}}formatCitationForExport(e){let a="";return e.authors&&(a+=e.authors+". "),e.title&&(a+=e.title+". "),e.journal&&(a+=e.journal+". "),e.year&&(a+=e.year,e.volume&&(a+=`;${e.volume}`),e.pages&&(a+=`:${e.pages}`),a+=". "),e.doi&&(a+=`doi: ${e.doi}`),a.trim()}downloadFile(e,a,t){const s=new Blob([a],{type:t}),n=URL.createObjectURL(s),r=document.createElement("a");r.href=n,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}showTab(e){document.querySelectorAll(".nav-tab").forEach((e=>{e.classList.remove("active")})),document.querySelectorAll(".tab-content").forEach((e=>{e.classList.remove("active")}));const a=document.querySelector(`[data-tab="${e}"]`),t=document.getElementById(e);a&&a.classList.add("active"),t&&t.classList.add("active"),window.innerWidth<1024&&document.getElementById("sidebar").classList.remove("open")}async refreshDashboard(){try{const[e,a,t,s]=await Promise.all([silentStacksDB.getRequestCount(),silentStacksDB.getRequestCount({status:"order"}),Promise.all([silentStacksDB.getRequestCount({status:"processing"}),silentStacksDB.getRequestCount({status:"received"})]).then((e=>e[0]+e[1])),silentStacksDB.getRequestCount({status:"completed"})]);document.getElementById("totalRequests")&&(document.getElementById("totalRequests").textContent=e),document.getElementById("pendingRequests")&&(document.getElementById("pendingRequests").textContent=a),document.getElementById("inProgressRequests")&&(document.getElementById("inProgressRequests").textContent=t),document.getElementById("completedRequests")&&(document.getElementById("completedRequests").textContent=s)}catch(e){console.error("Failed to refresh dashboard:",e)}}async migrateFromLocalStorage(){const e=localStorage.getItem("silentStacks_requests");if(!e)return;try{const a=JSON.parse(e);Array.isArray(a)&&a.length>0&&(console.log(`Migrating ${a.length} requests from localStorage...`),await silentStacksDB.bulkImport(a),localStorage.setItem(`silentStacks_backup_${Date.now()}`,e),localStorage.removeItem("silentStacks_requests"),console.log("Migration completed successfully"),await this.refreshDashboard())}catch(e){console.error("Migration failed:",e)}}async lookupDOI(){const e=document.getElementById("doi");if(!e)return;let a=e.value.trim();a=this.normalizeDOI(a),a&&SecurityUtils.isValidDOI(a)?(setLoadingState(!0,"lookup-doi"),setStatus("Looking up DOI...","loading","doi-status"),e.value=a,setStatus(`DOI normalized: ${a}`,"success","doi-status"),setLoadingState(!1,"lookup-doi")):setStatus("Please enter a valid DOI (must start with 10.)","error","doi-status")}normalizeDOI(e){return e=e.replace(/^(doi:|DOI:|https?:\/\/(dx\.)?doi\.org\/)/i,"").trim(),e=this.enrichmentEngine.decodeDOI(e),e&&!e.startsWith("10.")&&(e=(e.match(/10\.[^\s]+/)||[""])[0]),e}async lookupNCT(){const e=document.getElementById("nct");if(!e)return;let a=e.value.trim().toUpperCase();if(a&&!a.startsWith("NCT")){const e=a.match(/NCT\d{8}/i);a=e?e[0].toUpperCase():/^\d{8}$/.test(a)?"NCT"+a:a}return a&&SecurityUtils.isValidNCT(a)?(e.value=a,void setStatus(`NCT ready: <a href="https://clinicaltrials.gov/study/${a}" target="_blank" rel="noopener">NCT # ${a}</a>`,"success","nct-status")):void setStatus("Please enter a valid NCT ID (NCT followed by 8 digits)","error","nct-status")}handleRequestSelection(e){const a=e.value;e.checked?this.selectedRequests.add(a):this.selectedRequests.delete(a),this.updateBulkActions()}updateBulkActions(){const e=document.getElementById("bulkActions"),a=document.getElementById("bulkActionsText"),t=this.selectedRequests.size;t>0?(e?.classList.add("show"),a&&(a.textContent=`${t} selected`)):e?.classList.remove("show")}async bulkDeleteRequests(){if(0===this.selectedRequests.size)return;if(!confirm(`Are you sure you want to delete ${this.selectedRequests.size} selected request(s)?`))return;try{for(const e of this.selectedRequests)await silentStacksDB.deleteRequest(e);this.selectedRequests.clear(),this.updateBulkActions(),await this.refreshDashboard(),await tableRenderer.renderPage(tableRenderer.currentPage,tableRenderer.currentFilters),console.log("Bulk delete completed")}catch(e){console.error("Bulk delete failed:",e),alert(`Bulk delete failed: ${e.message}`)}}async processBulkPaste(){const e=document.getElementById("bulk-paste-data");if(!e)return;const a=e.value.trim();if(!a)return void alert("Please paste some identifiers first");const t=a.match(/\b\d{6,9}\b/g)||[],s=a.match(/10\.[^\s]+/g)||[],n=a.match(/NCT\d{8}/gi)||[];if(console.log(`Found ${t.length} PMIDs, ${s.length} DOIs, ${n.length} NCTs`),0===t.length&&0===s.length&&0===n.length)return void alert("No valid identifiers found");if(t.length>0){const e=await this.enrichmentEngine.enrichMultiplePMIDs(t);console.log("Bulk enrichment result:",e),alert(`Processed ${e.summary.successful} PMIDs successfully`)}e.value=""}async processBulkUpload(){const e=document.getElementById("bulk-upload");if(!e||!e.files||0===e.files.length)return void alert("Please select a file first");const a=e.files[0],t=new FileReader;t.onload=async e=>{try{const s=e.target.result;let n=[];if(a.name.endsWith(".json"))n=JSON.parse(s);else if(a.name.endsWith(".csv")){const e=s.split("\n"),a=e[0].split(",").map((e=>e.trim().replace(/"/g,"")));for(let t=1;t<e.length;t++)if(e[t].trim()){const s=e[t].split(",").map((e=>e.trim().replace(/"/g,""))),r={};a.forEach(((e,a)=>{r[e]=s[a]||""})),n.push(r)}}n.length>0&&(await silentStacksDB.bulkImport(n),await this.refreshDashboard(),await tableRenderer.renderPage(1),alert(`Successfully imported ${n.length} requests`))}catch(e){console.error("File processing failed:",e),alert(`Failed to process file: ${e.message}`)}},t.readAsText(a)}async validateAllData(){try{const e=await silentStacksDB.getAllRequests(),a=new MetadataValidator;let t=0,s=0;for(const n of e)if(n.pmid&&n.doi)try{const e=await a.validatePMIDMetadata(n);"validated"===e.status?t++:s++}catch(e){s++}alert(`Validation complete: ${t} validated, ${s} failed or skipped`)}catch(e){console.error("Validation failed:",e),alert(`Validation failed: ${e.message}`)}}}
const app=new SilentStacksApp;document.addEventListener("DOMContentLoaded",(()=>{app.init().catch(console.error),document.getElementById("navToggle")?.addEventListener("click",(()=>{document.getElementById("sidebar").classList.toggle("open")})),document.getElementById("searchInput")?.addEventListener("input",(e=>{clearTimeout(window.searchTimeout),window.searchTimeout=setTimeout((()=>{const a={search:e.target.value,status:document.getElementById("statusFilter")?.value||"",priority:document.getElementById("priorityFilter")?.value||""};tableRenderer.renderPage(1,a)}),300)})),document.getElementById("statusFilter")?.addEventListener("change",(e=>{const a={search:document.getElementById("searchInput")?.value||"",status:e.target.value,priority:document.getElementById("priorityFilter")?.value||""};tableRenderer.renderPage(1,a)})),document.getElementById("priorityFilter")?.addEventListener("change",(e=>{const a={search:document.getElementById("searchInput")?.value||"",status:document.getElementById("statusFilter")?.value||"",priority:e.target.value};tableRenderer.renderPage(1,a)})),document.querySelectorAll(".view-toggle button").forEach((e=>{e.addEventListener("click",(()=>{document.querySelectorAll(".view-toggle button").forEach((e=>e.classList.remove("active"))),e.classList.add("active");const a=e.dataset.view;"table"===a?(document.getElementById("tableView")?.classList.remove("hidden"),document.getElementById("cardsView")?.classList.add("hidden")):(document.getElementById("tableView")?.classList.add("hidden"),document.getElementById("cardsView")?.classList.remove("hidden"))}))}))})),console.log("✅ SilentStacks v2.1 loaded - No-CT Variant (layout preserved)");
